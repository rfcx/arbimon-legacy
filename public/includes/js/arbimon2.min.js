angular.module("a2.admin",["a2.directives","a2.admin.dashboard","a2.admin.projects","a2.admin.jobs","a2.directive.search-bar"]).controller("AdminCtrl",["$scope","$state",function(e,t){e.$state=t}]);try{angular.module("angularytics")}catch(e){console.error("GA not available, likely adblocker",e),function(){angular.module("angularytics",[]).provider("Angularytics",function(){this.setEventHandlers=function(){},this.$get=[function(){var e={};return e.init=function(){},e}]}).filter("trackEvent",["Angularytics",function(){return function(){return null}}])}()}var a2=angular.module("a2.app",["a2.permissions","templates-arbimon2","a2.app.dashboard","a2.audiodata","a2.visualizer","a2.analysis","a2.citizen-scientist","a2.jobs","a2.directive.sidenav-bar","a2.settings","a2.login","angularytics","ui.router","ct.ui.router.extras","a2.filters","humane","a2.googlemaps","a2.injected.data","a2.directive.search-bar"]).run(["$rootScope","Angularytics","a2UserPermit","notify","$state",function(e,t,i,n,a){e.Math=Math,t.init(),e.$on("$stateChangeStart",function(e,t,r){if(t.name.startsWith("visualizer")?document.getElementsByTagName("body")[0].classList.add("visualizer-page"):document.getElementsByTagName("body")[0].classList.remove("visualizer-page"),angular.isFunction(t.allowAccess)){var o=t.allowAccess(i);void 0===o?(e.preventDefault(),a.go("dashboard")):!1===o&&(e.preventDefault(),n.error("You do not have access to this section"))}})}]).config(["$urlRouterProvider","$locationProvider","AngularyticsProvider","a2GoogleMapsLoaderProvider","a2InjectedData",function(e,t,i,n,a){n.setAPIKey(a.googleAPI.key),i.setEventHandlers(["GoogleUniversal"]),t.html5Mode(!0),e.otherwise("/dashboard")}]).controller("MainCtrl",["$scope","$state","Project","a2UserPermit","$window",function(e,t,i,n,a){e.$state=t,i.getInfo(function(t){e.bioAnalyticsBaseUrl=t.bioAnalyticsBaseUrl,e.reportsEnabled=t.reports_enabled}),e.getUrlFor=function(t){const n=i.getUrl();return"citizen-scientist"==t?"/citizen-scientist/"+n+"/":"reports"==t?e.bioAnalyticsBaseUrl+"/"+n:void 0},e.citizenScientistUser=n.all&&1===n.all.length&&n.all.includes("use citizen scientist interface")&&!n.can("delete project")&&!n.isSuper(),e.isAppPage=a.location.pathname.startsWith("/project/")}]),a2=angular.module("a2.cs-app",["a2.permissions","templates-arbimon2","a2.app.dashboard","a2.audiodata","a2.visualizer","a2.analysis","a2.citizen-scientist","a2.directive.sidenav-bar","a2.settings","a2.login","angularytics","ui.router","ct.ui.router.extras","a2.filters","humane","a2.googlemaps","a2.injected.data","a2.directive.search-bar"]).run(["$rootScope","Angularytics","a2UserPermit","notify","$state",function(e,t,i,n,a){e.Math=Math,t.init(),e.$on("$stateChangeStart",function(e,t,r){if(angular.isFunction(t.allowAccess)){var o=t.allowAccess(i);void 0===o?(e.preventDefault(),a.go("citizen-scientist.patternmatching")):!1===o&&(e.preventDefault(),n.error("You do not have access to this section"))}})}]).config(["$urlRouterProvider","$locationProvider","AngularyticsProvider","a2GoogleMapsLoaderProvider","a2InjectedData",function(e,t,i,n,a){n.setAPIKey(a.googleAPI.key),i.setEventHandlers(["GoogleUniversal"]),t.html5Mode(!0),e.otherwise("/citizen-scientist/patternmatching/")}]).controller("MainCtrl",["$scope","$state","Project",function(e,t,i){e.$state=t,e.onCitizenScientistPage=!0,e.getUrlFor=function(e){if("citizen-scientist"==e)return"/citizen-scientist/"+i.getUrl()+"/"}}]);angular.module("a2.home",["templates-arbimon2","ui.bootstrap","a2.utils","a2.forms","a2.orders","a2.login","humane","angularytics","ui.router","a2.srv.local-storage","a2.filter.time-from-now","a2.directive.search-bar","ngSanitize"]).config(["AngularyticsProvider","$locationProvider",function(e,t){e.setEventHandlers(["GoogleUniversal"])}]).run(["Angularytics",function(e){e.init()}]).service("homeSummaryStatsData",function(){return[{title:"projects created",getData:function(e){return e.get("/api/project/projects-count").then(function(e){return e.data})}},{title:"recordings uploaded",getData:function(e){return e.get("/api/project/recordings-count").then(function(e){return e.data})}},{title:"analyses performed",description:"Number of files processed by pattern matching jobs",getData:function(e){return e.get("/api/project/jobs-count").then(function(e){return e.data})}},{title:"species identified",getData:function(e){return e.get("/api/project/recordings-species-count").then(function(e){return e.data})}}]}).controller("HomeCtrl",["$http","$window","$localStorage","notify","a2order","a2InjectedData","$scope","$q","$injector","homeSummaryStatsData",function(e,t,i,n,a,r,o,s,c,l){function u(e){return s.resolve(e.getData?c.invoke(e.getData):[])}function d(){try{return JSON.parse(i.getItem("home.project.select.cache"))||{}}catch(e){return{}}}function p(e){try{i.setItem("home.project.select.cache",JSON.stringify(e))}catch(e){}}o.summaryDataLoading=!0,o.list_summary_data=l,o.summary_data=o.list_summary_data.map(function(){return[]}),s.all(o.list_summary_data.map(u)).then(function(e){o.summaryDataLoading=!1,o.summary_data=e}.bind(this)),o.isExplorePage="/"===t.location.pathname,this.loadProjectList=function(){const t=o.isAnonymousGuest||o.isExplorePage,i=!o.isAnonymousGuest&&!o.isExplorePage;var n={params:{include_location:!0,publicTemplates:!0}};t&&(n.params.featured=!0),i&&(n.params.type="my");var a=d();this.isLoading=!0,this.projects=[],this.highlightedProjects=[],e.get("/api/user/projectlist",n).success(function(n){n.forEach(function(e){e.lastAccessed=a[e.id]||0;var t=e.lat&&e.lat>=-85.0511&&e.lat<=85.0511?e.lat:37.773972,i=e.lon&&e.lon>=-180&&e.lon<=180?e.lon:-122.431297,n=e.lat&&e.lon?5.33:4;e.mapUrl="https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/"+i+","+t+","+n+",0,60/274x180?access_token="+r.mapbox_access_token}),this.isLoading=!1,t?(this.projects=[],this.highlightedProjects=n.filter(function(e){return 1===e.featured}),this.highlightedProjects.forEach(function(t){t.isLoading=!0,e.get("/api/project/"+t.url+"/templates/count",{params:{projectTemplates:!0}}).success(function(e){t.templatesTotal=e.count||0,t.isLoading=!1}),e.get("/api/project/"+t.url+"/recordings/count").success(function(e){t.recCount=e,t.isLoading=!1}),e.get("/api/project/"+t.url+"/species-count").success(function(e){t.speciesCount=e||0,t.isLoading=!1})})):i&&(this.highlightedProjects=[],this.projects=n)}.bind(this)).error(function(){this.isLoading=!1}.bind(this))},this.createProject=function(){a.createProject({}).result.then(function(e){e&&n.log(e),this.loadProjectList()}.bind(this))},this.selectProject=function(e){if(e.is_enabled){var i=d();i[e.id]=(new Date).getTime(),p(i),t.location.assign("/project/"+e.url+"/")}},o.isAnonymousGuest=!0,e.get("/api/user/info").success(function(e){o.isAnonymousGuest=e.isAnonymousGuest,this.loadProjectList()}.bind(this)),this.valueShortScale=function(e){const t=numeral(e).format("0.0a");return"0"===function(e){return e.split(".")[1].slice(0,1)}(t)?t.replace(".0",""):t}}]),angular.module("a2.login",["humane","ui.bootstrap","templates-arbimon2","g-recaptcha","a2.utils.google-login-button","a2.utils.facebook-login-button"]).controller("LoginCtrl",["$scope","$http","$window","$modal","notify",function(e,t,i,n,a){e.login=function(){var n="/login"+i.location.search;t.post(n,{username:e.username,password:e.password,captcha:e.captchaResp}).success(function(t){if(t.error)return a.error(t.error),t.captchaNeeded&&(e.showCaptcha=!0),e.resetCaptcha(),void(e.captchaResp="");t.success&&i.location.assign(t.redirect)}).error(function(e){a.error(e||"Something went wrong, try again later")})},this.oAuthLogin=function(e,n){var r;if("google"==e)r={type:"google",token:n.getAuthResponse().id_token};else{if("facebook"!=e)return;r={type:"facebook",token:n.authResponse.accessToken}}t.post("/oauth-login"+i.location.search,r).then(function(e){var t=e.data;t.error?a.error(t.error):t.success&&i.location.assign(t.redirect)}).catch(function(e){if(449==e.status)return this.showEnableOAuthModal(r);a.error(e.data||"Something went wrong, try again later")}.bind(this))},this.showEnableOAuthModal=function(e){var r={};n.open({templateUrl:"/common/templates/authorize-enter-credentials-pop-up.html",controller:function(){this.title="User Authorization Required",this.data=r,this.oauthType=e.type,this.messages=["Before using "+e.type+" to sign into your account you must first allow it."],this.authorizeMessage="Authorize "+e.type+" sign-in on my account.",this.btnOk="Confirm",this.btnCancel="Cancel"},controllerAs:"popup"}).result.then(function(){r.authorized?t.post("/oauth-login"+i.location.search,angular.extend({},e,{authorize:1,username:r.username,password:r.password})).then(function(e){var t=e.data;t.error?a.error(t.error):t.success&&i.location.assign(t.redirect)}).catch(function(t){if(449==t.status)return this.showEnableOAuthModal(e);a.error(t.data||"Something went wrong, try again later")}.bind(this)):a.error("Login authorization canceled.")})}}]).controller("RedirectToLoginCtrl",["$scope","$window",function(e,t){var i=t.location.pathname+t.location.search+t.location.hash;e.loginUrl="/login?redirect="+encodeURIComponent(i)}]),angular.module("a2.orders",["a2.orders.orders","a2.orders.order-utils","a2.orders.create-project","a2.orders.change-project-plan","a2.orders.order-summary","a2.orders.plan-selection","a2.orders.shipping-form","a2.orders.process-order","a2.orders.directives.plan-capacity","a2.orders.directives.tier-select"]),angular.module("a2.register",["a2.forms","a2.directives","ui.bootstrap","angularytics","g-recaptcha","humane"]).config(["AngularyticsProvider",function(e){e.setEventHandlers(["Console","GoogleUniversal"])}]).run(["Angularytics",function(e){e.init()}]).controller("UserRegisterCtrl",["$scope","$modal","$http","$timeout","$interval","notify",function(e,t,i,n,a,r){e.testUsername=function(){if(e.usernameOk="",e.usernameErr="",e.testUserTimeout&&n.cancel(e.testUserTimeout),!e.regis.username.$error.required)return e.regis.username.$error.pattern?void(e.usernameErr="Username must be at least 4 characters long and can only contain alphanumeric characters, dash(-), underscore(_) and dot(.)."):void(e.testUserTimeout=n(function(){i.get("/api/login_available",{params:{username:e.user.username}}).success(function(t){t.available?e.usernameOk=e.user.username+" is available":e.usernameErr=e.user.username+" is not available"})},1e3))},e.testEmail=function(){if(e.emailOk="",e.emailErr="",e.testEmailTimeout&&n.cancel(e.testEmailTimeout),!e.regis.email.$error.required)return e.regis.email.$error.email?void(e.emailErr="Invalid email"):void(e.testEmailTimeout=n(function(){i.get("/api/email_available",{params:{email:e.user.email}}).success(function(t){t.available?e.emailOk=e.user.email+" is available":t.invalid?e.emailErr=e.user.email+" is not a valid address":e.emailErr=e.user.email+" is not available"})},1e3))},e.register=function(t){e.passResult.valid?e.usernameErr?r.error(e.usernameErr):e.emailErr?r.error(e.emailErr):e.terms_accepted?e.captchaResp||e.captchaNotNeeded?(e.loading=!0,i.post("/register",{user:e.user,captcha:e.captchaResp,newsletter:e.newsletter}).success(function(t){e.loading=!1,t.success&&(e.completed=!0)}).error(function(t){if(e.loading=!1,t.error)return e.resetCaptcha(),e.captchaResp="",r.error(t.error);r.error("something went wrong, please try again later")})):r.log("Please complete the captcha"):r.log("To register you must agree with our terms of service"):r.error(e.passResult.msg)}}]),angular.module("a2.reset-password",["a2.directives","a2.forms","humane"]).controller("ResetPassCtrl",["$scope","$http","$window","notify",function(e,t,i,n){e.changePassword=function(){e.passResult.valid||n.error(e.passResult.msg);var a=i.location.pathname;t.post(a,{password:e.password}).success(function(t){e.completed=!0})}}]).controller("ResetRequestCtrl",["$scope","$http","notify",function(e,t,i){e.request=function(){e.loading=!0,t.post("/forgot_request",{email:e.email}).success(function(t){if(e.loading=!1,t.error)return i.error(t.error);e.requestComplete=!0})}}]),angular.module("a2.user-settings",["templates-arbimon2","a2.forms","ui.bootstrap","humane","angularytics"]).config(["AngularyticsProvider",function(e){e.setEventHandlers(["Console","GoogleUniversal"])}]).run(["Angularytics",function(e){e.init()}]).controller("UserSettingsCtrl",["$scope","$modal","$http","notify",function(e,t,i,n){this.data={},i.get("/api/user/info").then(function(t){e.user=t.data,this.user=t.data,this.reset()}.bind(this)),this.reset=function(){this.data=angular.copy(this.user)},this.save=function(){var e=this.data;return i.post("/api/user/update",{userData:{name:e.name,lastname:e.lastname,oauth:e.oauth}}).then(function(e){e.data.error?n.error(e.data.error):n.log(e.data.message)}).catch(function(e){console.log("err",e),n.serverError()})}}]);var a2=angular.module("a2.visualizer-app",["a2.permissions","templates-arbimon2","a2.visualizer","angularytics","ui.router","ct.ui.router.extras","a2.filters","humane","a2.googlemaps","a2.injected.data","a2.directive.search-bar"]).run(["$rootScope","Angularytics","a2UserPermit","notify","$state",function(e,t,i,n,a){e.Math=Math,t.init(),e.$on("$stateChangeStart",function(e,t,a){if(angular.isFunction(t.allowAccess)){t.allowAccess(i)||(e.preventDefault(),n.error("You do not have access to this section"))}})}]).config(["$urlRouterProvider","$locationProvider","AngularyticsProvider","a2GoogleMapsLoaderProvider","a2InjectedData",function(e,t,i,n,a){n.setAPIKey(a.googleAPI.key),i.setEventHandlers(["GoogleUniversal"]),t.html5Mode(!0),e.otherwise("/visualizer")}]).controller("MainCtrl",["$scope","$state","Project","$http","$window",function(e,t,i,n,a){e.$state=t,e.getUrlFor=function(e){if("visualizer"==e)return"/visualizer/"+i.getUrl()+"/"}}]);angular.module("a2.srv.api",[]).factory("a2APIServiceClass",["$location","$q","$http",function(e,t,i){function n(e){return e.data}var a=function(e){this.prefix=e};return a.prototype={getUrl:function(e){return this.prefix+e},get:function(e,a){return t.when(i.get(this.prefix+e,a)).then(n)},post:function(e,a){return t.when(i.post(this.prefix+e,a)).then(n)},delete:function(e,a){return t.when(i.delete(this.prefix+e)).then(n)},put:function(e,a){return t.when(i.put(this.prefix+e,a)).then(n)}},a}]).factory("a2APIService",["$location","$q","a2APIServiceClass",function(e,t,i){var n=/\/?(project|citizen-scientist|visualizer)\/([\w\_\-]+)/.exec(e.absUrl()),a=n?n[2]:"",r="/api/project/"+a,o=new i(r);return o.api=new i("/api"),o.project=new i("/project/"+a),o.getProjectName=function(){return a},o}]),angular.module("a2.service.audio-event-detection",["a2.srv.api"]).factory("AudioEventDetectionService",["a2APIService",function(e){return{getList:function(){return e.get("/audio-event-detections/")},getAlgorithmsList:function(){return e.get("/audio-event-detections/algorithms")},getStatisticsList:function(){return e.get("/audio-event-detections/statistics")},getDataStatisticsList:function(){return e.get("/audio-event-detections/data/statistics")},getDataAggregatesList:function(){return e.get("/audio-event-detections/data/aggregates")},getDataFor:function(t,i,n,a){var r=[];return e.get("/audio-event-detections/data/"+[t,i.statistic,n.statistic,a.statistic].map(encodeURIComponent).join("/")+"?"+r.join("&"))},savePlotFor:function(t,i,n,a){var r={x:i.statistic,y:n.statistic,z:a.statistic};return e.post("/audio-event-detections/default-plot/"+[t].map(encodeURIComponent).join("/"),r)},new:function(t){t=t||{};var i={name:t.name||t.defaultName,algorithm:t.algorithm.id,parameters:t.parameters,statistics:t.statistics.map(function(e){return e.id}),playlist:t.playlist.id};return e.post("/audio-event-detections/new",i)}}}]),angular.module("a2.srv.audio-event-detections-clustering",["a2.srv.project","humane"]).factory("a2AudioEventDetectionsClustering",["$http","Project","notify",function(e,t,i){return{list:function(n,a){const r={params:n};return e.get("/api/project/"+t.getUrl()+"/audio-event-detections-clustering",r).then(function(e){return e.data}).catch(i.serverError)},count:function(){return e.get("/api/project/"+t.getUrl()+"/audio-event-detections-clustering/total-recordings").then(function(e){return e.data})},create:function(i){return e.post("/api/project/"+t.getUrl()+"/audio-event-detections-clustering/new",i).then(function(e){return e.data})},validate:function(i){return e.post("/api/project/"+t.getUrl()+"/audio-event-detections-clustering/validate",i).then(function(e){return e.data})},unvalidate:function(i){return e.post("/api/project/"+t.getUrl()+"/audio-event-detections-clustering/unvalidate",i).then(function(e){return e.data})},delete:function(n){return e.post("/api/project/"+t.getUrl()+"/audio-event-detections-clustering/"+n+"/remove").then(function(e){return e.data}).catch(i.serverError)}}}]),angular.module("a2.srv.citizen-scientist-admin",["a2.srv.api"]).factory("a2CitizenScientistAdminService",["a2APIService","Project","notify",function(e,t,i){return{getClassificationStats:function(t){return e.get("/citizen-scientist/stats/classification"+(t?"/"+t:"")).catch(i.serverError)},getUserStats:function(t){return e.get("/citizen-scientist/stats/user"+(t?"/"+t:"")).catch(i.serverError)},getUserStatsExportUrl:function(){return"/api/project/"+t.getUrl()+"/citizen-scientist/stats/export/user-stats.csv"},getCSExportUrl:function(e,i){var n=i?"export-per-user.csv":"export.csv";return"/api/project/"+t.getUrl()+"/citizen-scientist/pattern-matchings/"+e+"/"+n},getSettings:function(){return e.get("/citizen-scientist/settings").catch(i.serverError)},setSettings:function(t){return e.post("/citizen-scientist/settings",t).catch(i.serverError)}}}]),angular.module("a2.srv.citizen-scientist-expert",["a2.srv.api"]).factory("a2CitizenScientistExpertService",["a2APIService","Project","notify",function(e,t,i){return{getPatternMatchings:function(){return e.get("/citizen-scientist/pattern-matchings/expert").catch(i.serverError)},getPatternMatchingDetailsFor:function(t){return e.get("/citizen-scientist/pattern-matchings/"+t+"/expert/details").catch(i.serverError)},getPatternMatchingRoisFor:function(t,n,a,r){var o=Object.keys(r||{}).map(function(e){return e+"="+encodeURIComponent(r[e])}).join("&");return e.get("/citizen-scientist/pattern-matchings/"+t+"/expert-rois/"+(a||0)+"_"+(n||0)+(o?"?"+o:"")).catch(i.serverError)},validatePatternMatchingRois:function(t,n,a){return e.post("/citizen-scientist/pattern-matchings/"+t+"/expert-validate",{rois:n,validation:a}).catch(i.serverError)},getCSExportUrl:function(e){return e=e||{},"/api/project/"+t.getUrl()+"/citizen-scientist/pattern-matchings/"+(0|e.patternMatching)+"/export.csv"}}}]),angular.module("a2.srv.citizen-scientist",["a2.srv.api"]).factory("a2CitizenScientistService",["a2APIService","notify",function(e,t){return{getMyStats:function(i){return e.get("/citizen-scientist/stats/mine").catch(t.serverError)},getPatternMatchings:function(){return e.get("/citizen-scientist/pattern-matchings").catch(t.serverError)},getPatternMatchingDetailsFor:function(i){return e.get("/citizen-scientist/pattern-matchings/"+i+"/details").catch(t.serverError)},getPatternMatchingRoisFor:function(i,n,a){return e.get("/citizen-scientist/pattern-matchings/"+i+"/rois/"+(a||0)+"_"+(n||0)).catch(t.serverError)},validatePatternMatchingRois:function(i,n,a){return e.post("/citizen-scientist/pattern-matchings/"+i+"/validate",{rois:n,validation:a}).catch(t.serverError)}}}]),angular.module("a2.srv.classi",["a2.srv.project","humane"]).factory("a2Classi",["$http","Project","notify",function(e,t,i){var n=null;return{saveState:function(e){n=e},getState:function(){return n},list:function(n){return e.get("/api/project/"+t.getUrl()+"/classifications").then(function(e){return n&&n(e.data),e.data}).catch(i.serverError)},getDetails:function(n,a){e.get("/api/project/"+t.getUrl()+"/classifications/"+n).success(a).error(i.serverError)},getResultDetails:function(n,a,r,o){return e.get("/api/project/"+t.getUrl()+"/classifications/"+n+"/more/"+a+"/"+r).then(function(e){return o&&o(e.data),e.data}).catch(i.serverError)},getRecVector:function(i,n){return e.get("/api/project/"+t.getUrl()+"/classifications/"+i+"/vector/"+n)},create:function(n,a){e.post("/api/project/"+t.getUrl()+"/classifications/new",n).success(a).error(i.serverError)},delete:function(n,a){e.get("/api/project/"+t.getUrl()+"/classifications/"+n+"/delete").success(a).error(i.serverError)}}}]),angular.module("a2.srv.clustering-jobs",["a2.srv.project","humane"]).factory("a2ClusteringJobs",["$http","Project","notify","$httpParamSerializer",function(e,t,i,n){return{list:function(n){const a={params:n};return e.get("/api/project/"+t.getUrl()+"/clustering-jobs",a).then(function(e){return e.data}).catch(i.serverError)},getJobDetails:function(n){return e.get("/api/project/"+t.getUrl()+"/clustering-jobs/"+n+"/job-details").then(function(e){return e.data}).catch(i.serverError)},getClusteringDetails:function(n){var a={params:n};return e.get("/api/project/"+t.getUrl()+"/clustering-jobs/"+n.job_id+"/clustering-details",a).then(function(e){return e.data}).catch(i.serverError)},getRoisDetails:function(n){var a={};return n.aed&&(a.aed=n.aed),n.rec_id&&(a.rec_id=n.rec_id),n.search&&"per_site"==n.search?a.perSite=!0:n.search&&"per_date"==n.search?a.perDate=!0:a.all=!0,e.post("/api/project/"+t.getUrl()+"/clustering-jobs/"+n.jobId+"/rois-details",a).then(function(e){return e.data}).catch(i.serverError)},exportClusteringROIs:function(n){const a={params:n};return e.post("/api/project/"+t.getUrl()+"/clustering-jobs/"+n.jobId+"/rois-export",a).then(function(e){return e.data}).catch(i.serverError)},getAudioUrlFor:function(e,i){return"/api/project/"+t.getUrl()+"/clustering-jobs/"+e+"/audio/"+i},audioEventDetections:function(n){var a={params:{}};return n.completed&&(a.params.completed=n.completed),e.get("/api/project/"+t.getUrl()+"/clustering-jobs/audio-event-detections",a).then(function(e){return e.data}).catch(i.serverError)},create:function(n){return e.post("/api/project/"+t.getUrl()+"/clustering-jobs/new",n).then(function(e){return e.data}).catch(i.serverError)},delete:function(n){return e.post("/api/project/"+t.getUrl()+"/clustering-jobs/"+n+"/remove").then(function(e){return e.data}).catch(i.serverError)}}}]),angular.module("a2.srv.cnn",["a2.srv.project","humane"]).factory("a2CNN",["$q","$http","Project","notify",function(e,t,i,n){var a=null;return{listROIs:function(e,a,r,o,s,c,l){if(!a)var a=100;if(!r)var r=0;return o||(o=0),s||(s=0),c||(c="all"),t.get("/api/project/"+i.getUrl()+"/cnn/rois/"+e+"/"+o+"/"+s+"/"+c+"/"+r+"_"+a).then(function(e){return e.data}).catch(n.serverError)},listROIsBySpecies:function(e,a,r){return t.get("/api/project/"+i.getUrl()+"/cnn/roisBySpecies/"+e+"/"+a).then(function(e){return e.data}).catch(n.serverError)},listResults:function(e,a){return t.get("/api/project/"+i.getUrl()+"/cnn/results/"+e).then(function(e){return e.data}).catch(n.serverError)},listModels:function(e){return t.get("/api/project/"+i.getUrl()+"/cnn/models").then(function(e){return e.data}).catch(n.serverError)},saveState:function(e){a=e},getState:function(){return a},list:function(e){return t.get("/api/project/"+i.getUrl()+"/cnn").then(function(e){return e.data}).catch(n.serverError)},getDetailsFor:function(e){return t.get("/api/project/"+i.getUrl()+"/cnn/"+e+"/details").then(function(e){return e.data})},getRoisFor:function(e,n,a){return t.get("/api/project/"+i.getUrl()+"/cnn/"+e+"/rois/"+(a||0)+"_"+(n||0)).then(function(e){return e.data})},countROIsBySpecies:function(e){return t.get("/api/project/"+i.getUrl()+"/cnn/"+e+"/countROIsBySpecies")},countROIsBySites:function(e){return t.get("/api/project/"+i.getUrl()+"/cnn/"+e+"/countROIsBySites")},countROIsBySpeciesSites:function(e,n){var a="all";return n.search&&(a=n.search),t.get("/api/project/"+i.getUrl()+"/cnn/"+e+"/countROIsBySpeciesSites/"+a)},getExportUrl:function(e){return"/api/project/"+i.getUrl()+"/cnn/"+e.cnnId+"/rois.csv"},getAudioUrlFor:function(e){return"/api/project/"+i.getUrl()+"/cnn/"+e.job_id+"/audio/"+e.cnn_result_roi_id},validateRois:function(e,n,a){return t.post("/api/project/"+i.getUrl()+"/cnn/"+e+"/validate",{rois:n,validation:a}).then(function(e){return e.data})},create:function(e){return t.post("/api/project/"+i.getUrl()+"/cnn/new",e).then(function(e){return e.data})},delete:function(e){return t.post("/api/project/"+i.getUrl()+"/cnn/"+e+"/remove").then(function(e){return e.data})}}}]),angular.module("a2.service.download-resource",[]).service("$downloadResource",["$window",function(e){return function(t){var i=angular.element("<a></a>").attr("target","_blank").attr("href",t).appendTo("body");e.setTimeout(function(){i[0].click(),i.remove()},0)}}]),angular.module("a2.services",["a2.srv.classi","a2.srv.models","a2.srv.playlists","a2.srv.project","a2.srv.sites","a2.srv.soundscapes","a2.srv.species","a2.srv.users","a2.srv.training-sets","a2.srv.templates","a2.srv.audio-event-detections-clustering","a2.srv.clustering-jobs"]),angular.module("a2.srv.local-storage",[]).service("$localStorage",["$window",function(e){return{getItem:function(t){if(e.localStorage)return e.localStorage.getItem(t)},setItem:function(t,i){e.localStorage&&e.localStorage.setItem(t,i)}}}]),angular.module("a2.srv.models",["a2.srv.project","humane"]).factory("a2Models",["$http","Project","notify",function(e,t,i){var n=null,a=!1;return{modelState:function(e){a=e},isModelOpen:function(){return a},saveState:function(e){n=e},getState:function(){return n},list:function(n){e.get("/api/project/"+t.getUrl()+"/models").success(n).error(i.serverError)},getFormInfo:function(n){e.get("/api/project/"+t.getUrl()+"/models/forminfo").success(n).error(i.serverError)},findById:function(i){return e.get("/api/project/"+t.getUrl()+"/models/"+i)},create:function(i){return e.post("/api/project/"+t.getUrl()+"/models/new",i)},delete:function(n,a){e.get("/api/project/"+t.getUrl()+"/models/"+n+"/delete").success(a).error(i.serverError)},getValidationResults:function(n,a){e.get("/api/project/"+t.getUrl()+"/models/"+n+"/validation-list/").success(a).error(i.serverError)},getRecVector:function(i,n,a){return e.get("/api/project/"+t.getUrl()+"/models/"+i+"/training-vector/"+n)},setThreshold:function(i,n){var a={m:i,t:n};return e.post("/api/project/"+t.getUrl()+"/models/savethreshold",a)}}}]),angular.module("a2.srv.news",["a2.srv.api"]).service("a2NewsService",["$q","a2APIService",function(e,t){return{loadPage:function(e){return t.api.get("/user/feed/"+(0|e))},loadFormats:function(){return t.api.get("/user/feed/formats")}}}]),angular.module("a2.srv.open-modal",["ui.bootstrap.modal"]).provider("$openModal",function(){var e={defs:{},define:function(t,i){e.defs[t]=angular.extend({},i)},$get:["$modal",function(t){return function(i,n){var a=angular.extend({},e.defs[i]);return n&&(n.resolve&&(console.log("overrides.resolve",n.resolve),a.resolve=angular.extend(a.resolve,n.resolve),console.log("options.resolve",a.resolve),delete n.resolve),a=angular.extend(a,n)),t.open(a)}}]};return e}),angular.module("a2.srv.patternmatching",["a2.srv.project","humane"]).factory("a2PatternMatching",["$q","$http","a2APIService","Project","notify",function(e,t,i,n,a){var r=null;return{saveState:function(e){r=e},getState:function(){return r},list:function(e,i){const r={params:e};return t.get("/api/project/"+n.getUrl()+"/pattern-matchings",r).then(function(e){return e.data}).catch(a.serverError)},getDetailsFor:function(e){return t.get("/api/project/"+n.getUrl()+"/pattern-matchings/"+e+"/details").then(function(e){return e.data})},getPatternMatchingsTotal:function(e){t.get("/api/project/"+n.getUrl()+"/pattern-matchings/count").success(function(t){e(t)})},getRoisFor:function(e,t,n,r){var o=Object.keys(r||{}).map(function(e){return e+"="+encodeURIComponent(r[e])}).join("&");return i.get("/pattern-matchings/"+e+"/rois/"+(n||0)+"_"+(t||0)+(o?"?"+o:"")).catch(a.serverError)},getSitesListFor:function(e,t){var n=Object.keys(t||{}).map(function(e){return e+"="+encodeURIComponent(t[e])}).join("&");return i.get("/pattern-matchings/"+e+"/site-index"+(n?"?"+n:"")).catch(a.serverError)},getExportUrl:function(e){return"/api/project/"+n.getUrl()+"/pattern-matchings/"+e.patternMatching+"/"+e.jobName+".csv"},getAudioUrlFor:function(e){return"/api/project/"+n.getUrl()+"/pattern-matchings/"+e.pattern_matching_id+"/audio/"+e.id+".mp3"},validateRois:function(e,i,a,r){return t.post("/api/project/"+n.getUrl()+"/pattern-matchings/"+e+"/validate",{rois:i,validation:a,cls:r}).then(function(e){return e.data})},create:function(e){return t.post("/api/project/"+n.getUrl()+"/pattern-matchings/new",e).then(function(e){return e.data})},update:function(e,i){return t.post("/api/project/"+n.getUrl()+"/pattern-matchings/"+e+"/update",i).then(function(e){return e.data})},delete:function(e){return t.post("/api/project/"+n.getUrl()+"/pattern-matchings/"+e+"/remove").then(function(e){return e.data})}}}]),angular.module("a2.srv.playlists",["a2.srv.project"]).factory("a2Playlists",["Project","a2APIService","$rootScope","$http",function(e,t,i,n){var a=e.getUrl();return{getList:function(e){return e&&(e={params:e}),e&&e.filterPlaylistLimit&&(e.params.filterPlaylistLimit=e.filterPlaylistLimit),n.get("/api/project/"+a+"/playlists",e).then(function(e){return e.data})},create:function(e,t){n.post("/api/project/"+a+"/playlists/create",e).success(function(e){i.$emit("a2Playlists-invalidate-list"),t(e)})},combine:function(e){return t.post("/playlists/combine",e).then(function(e){return i.$emit("a2Playlists-invalidate-list"),e})},getRecordingPosition:function(e,t,i){var r=n.get("/api/project/"+a+"/playlists/"+e+"/"+t+"/position");return i&&r.success(i),r},getPreviousRecording:function(e,t,i){return n.get("/api/project/"+a+"/playlists/"+e+"/"+t+"/previous").success(function(e){i(e)})},getNextRecording:function(e,t,i){return n.get("/api/project/"+a+"/playlists/"+e+"/"+t+"/next").success(function(e){i(e)})},rename:function(e,t){n.post("/api/project/"+a+"/playlists/rename",e).success(function(e){i.$emit("a2Playlists-invalidate-list"),t(e)})},remove:function(e,t){n.post("/api/project/"+a+"/playlists/delete",{playlists:e}).success(function(e){i.$emit("a2Playlists-invalidate-list"),t(e)})},getInfo:function(e,t){n({method:"GET",url:"/api/project/"+a+"/playlists/info/"+e}).success(function(e){t(e)})},getData:function(e,t,i){n.post("/api/project/"+a+"/playlists/"+e,t).success(function(e){i(e)})},$on:function(e,t){return i.$on("a2Playlists-"+e,t)},attachAedToPlaylist:function(e,t){n.post("/api/project/"+a+"/playlists/"+e.playlist_id+"/aed",{aed:e.aed}).success(function(e){t(e)})}}}]),angular.module("a2.srv.project",["a2.srv.api"]).factory("Project",["$location","$http","$q","$httpParamSerializer","a2APIService","notify",function(e,t,i,n,a,r){var o=/\/?(project|citizen-scientist|visualizer)\/([\w\_\-]+)/,s=o.exec(e.absUrl()),c=s?s[2]:"";return{getUrl:function(){return c},getInfo:function(e){t.get("/api/project/"+c+"/info").success(function(t){e(t)})},getProjectById:function(e,i){var n={params:{}};e&&(n.params.project_id=e),t.get("/api/project/"+c+"/info/source-project",n).success(function(e){i(e)})},updateInfo:function(e,i){t.post("/api/project/"+c+"/info/update",e).success(function(e){i(null,e)}).error(function(e){i(e)})},getUsage:function(){return t.get("/api/project/"+c+"/usage")},getSites:function(e,n){return"function"==typeof e&&(n=e,e={}),i.when(t.get("/api/project/"+c+"/sites",{params:e})).then(function(e){return n&&n(e.data),e.data})},getClasses:function(e,n){return"function"==typeof e&&(n=e,e={}),i.when(t.get("/api/project/"+c+"/classes",{params:e})).then(function(e){return n&&n(e.data),e.data})},getRecs:function(e,i){"function"==typeof e&&(i=e,e={}),e&&e.tags&&(e["tags[]"]=e.tags.flat(),delete e.tags),t.get("/api/project/"+c+"/recordings/search",{params:e}).success(function(e){i(e)})},getRecCounts:function(e){return e&&e.project_url&&delete e.project_url,a.get("/recordings/search-count",{params:e||{}})},getRecordingData:function(e,i){e.tags&&(e.tags=e.tags.flat());var a={filters:e,show:i}
;Object.keys(a).forEach(function(e){Object.keys(a[e]||{}).length||delete a[e]});var o=n(a);const s="/api/project/"+c+"/recordings/"+(i&&i.species?"occupancy-models-export/"+i.species_name:i&&i.grouped?"grouped-detections-export":"recordings-export")+(o.length?"?"+o:"");return t.get(s).then(function(e){return e.data}).catch(r.serverError)},getSitesExportUrl:function(){return"/api/project/"+c+"/sites-export.csv"},getRecTotalQty:function(e){return a.get("/recordings/count").then(function(t){return e&&e(t),t})},getProjectTotalSpecies:function(e,i){t.get("/api/project/"+c+"/species-count",{project_id:e}).success(function(e){i(e)})},getProjectTimeBounds:function(e){return a.get("/recordings/time-bounds").then(function(t){return e&&e(t),t})},getRecordings:function(e,i,n){i instanceof Function&&(n=i,i={}),t.get("/api/project/"+c+"/recordings/"+e,{params:i}).success(function(e){n(e)})},getRecordingAvailability:function(e,t){return a.get("/recordings/available/"+e).then(function(e){return t&&t(e),e})},getOneRecording:function(e,i){t.get("/api/project/"+c+"/recordings/find/"+e).success(function(e){i(e)})},getRecordingInfo:function(e,i){t.get("/api/project/"+c+"/recordings/info/"+e).success(function(e){i(e)}).error(function(e){i(e)})},getNextRecording:function(e,i){t.get("/api/project/"+c+"/recordings/next/"+e).success(function(e){i(e)})},getPreviousRecording:function(e,i){t.get("/api/project/"+c+"/recordings/previous/"+e).success(function(e){i(e)})},validateRecording:function(e,i,n){t.post("/api/project/"+c+"/recordings/validate/"+e,i).success(function(e){n(e)})},recExists:function(e,i,n){t.get("/api/project/"+c+"/recordings/exists/site/"+e+"/file/"+i).success(function(e){n(e.exists)})},downloadRecording:function(e,i){t.get("/api/project/"+c+"/recordings/download/"+e).success(function(e){i(e)})},addClass:function(e,i){return t.post("/api/project/"+c+"/class/add",e)},removeClasses:function(e,i){return t.post("/api/project/"+c+"/class/del",e)},getUsers:function(e){t.get("/api/project/"+c+"/users").success(function(t){e(null,t)}).error(function(t){e(t)})},getRoles:function(e){t.get("/api/project/"+c+"/roles").success(function(t){e(null,t)}).error(function(t){e(t)})},addUser:function(e,i){t.post("/api/project/"+c+"/user/add",e).success(function(e){i(null,e)}).error(function(e){i(e)})},removeUser:function(e,i){t.post("/api/project/"+c+"/user/del",e).success(function(e){i(null,e)}).error(function(e){i(e)})},changeUserRole:function(e,i){t.post("/api/project/"+c+"/user/role",e).success(function(e){i(null,e)}).error(function(e){i(e)})},getModels:function(e){t.get("/api/project/"+c+"/models").success(function(t){e(null,t)}).error(function(t){e(t)})},getClassi:function(e){t.get("/api/project/"+c+"/classifications").success(function(t){e(null,t)}).error(function(t){e(t)})},validationsCount:function(e){t.get("/api/project/"+c+"/validations/count").success(function(t){e(t.count)})},validationBySpeciesSong:function(e,i,n){t.get("/api/project/"+c+"/validations",{params:{species_id:e,sound_id:i}}).success(n)},getProjectsList:function(e,i){var n={params:{}};e&&(n.params.type=e),t.get("/api/user/projectlist",n).success(function(e){i(e)})},removeProject:function(e){return t.post("/api/project/"+c+"/remove",e)}}}]),angular.module("a2.srv.resolve",[]).factory("$promisedResolve",["$q","$injector",function(e,t){return function(i,n){return n=n||{},e.all(Object.keys(i).map(function(a){return e.resolve().then(function(){return t.invoke(i[a])}).then(function(e){n[a]=e})})).then(function(){return n})}}]),angular.module("a2.service.serialize-promised-fn",[]).service("serializePromisedFn",["$q",function(e){return function(t){var i=e.resolve();return function(){var e=this,n=Array.prototype.slice.call(arguments);return i=i.then(function(){return t.apply(e,n)})}}}]),angular.module("a2.srv.sites",["a2.srv.project","humane"]).factory("a2Sites",["$http","$q","Project","notify",function(e,t,i,n){return{listPublished:function(t){e.get("/api/sites/published").success(function(e){t(e)})},import:function(t,n){e.post("/api/project/"+i.getUrl()+"/sites/import",{site:t}).success(n)},update:function(t,a){e.post("/api/project/"+i.getUrl()+"/sites/update",{site:t}).success(a).error(n.serverError)},create:function(t,a){e.post("/api/project/"+i.getUrl()+"/sites/create",{site:t}).success(a).error(n.serverError)},delete:function(t,a){e.post("/api/project/"+i.getUrl()+"/sites/delete",{sites:t}).success(a).error(n.serverError)},getLogFiles:function(t,n){return e.get("/api/project/"+i.getUrl()+"/sites/"+t+"/logs")},getSiteLogDataDates:function(n,a){var r=t.defer();return e.get("/api/project/"+i.getUrl()+"/sites/"+n+"/log/data.txt?get=dates").success(r.resolve.bind(r)).error(r.reject.bind(r)),r.promise},getSiteLogDataUrl:function(e,n,a,r,o){var s="q="+o+"&from="+a.getTime()+"&to="+r.getTime();return/uploads/.test(n)?t.resolve("/api/project/"+i.getUrl()+"/sites/"+e+"/uploads.txt?"+s):/recordings/.test(n)?t.resolve("/api/project/"+i.getUrl()+"/sites/"+e+"/data.txt?"+s):t.resolve("/api/project/"+i.getUrl()+"/sites/"+e+"/log/data.txt?stat="+n+"&"+s)},getSiteLogData:function(i,n,a,r,o){return this.getSiteLogDataUrl(i,n,a,r,o).then(function(i){return t.when(e.get(i))}).then(function(e){var t={};return e.data&&(t.rows=e.data.trim().split("\n").map(function(e){return e.split(",")})),t})},getListOfAssets:function(n){var a=t.defer();return e.get("/api/project/"+i.getUrl()+"/streams/"+n+"/assets").success(a.resolve.bind(a)).error(a.reject.bind(a)),a.promise},generateToken:function(t){return e.post("/api/project/"+i.getUrl()+"/sites/generate-token",{site:t.id})},revokeToken:function(t){return e.post("/api/project/"+i.getUrl()+"/sites/revoke-token",{site:t.id})}}}]),angular.module("a2.srv.soundscape-composition",["a2.srv.api"]).factory("a2SoundscapeCompositionService",["$q","a2APIService",function(e,t){return{getClassList:function(e){e=e||{};var i={};return e.tally&&(i.tally=1),e.isSystemClass&&(i.isSystemClass=1),t.get("/soundscape-composition/classes",{params:i}).then(function(t){return e.groupByType?t.reduce(function(e,t){return e.index[t.typeId]||e.list.push(e.index[t.typeId]={type:t.type,typeId:t.typeId,list:[]}),e.index[t.typeId].list.push(t),e},{list:[],index:{}}).list:t})},addClass:function(e,i){return t.post("/soundscape-composition/add-class",{name:e,type:i})},removeClass:function(e){return t.post("/soundscape-composition/remove-class",{id:e})},getAnnotationsFor:function(i){return i&&/^recording$/.test(i.type)?t.get("/soundscape-composition/annotations/"+(0|i.id)):e.resolve([])},annotate:function(i,n){return i&&/^recording$/.test(i.type)?t.post("/soundscape-composition/annotate/"+(0|i.id),n):e.reject(new Error("Cannot add soundscape composition annotation"+(i?" to "+i.type:"")+"."))}}}]),angular.module("a2.srv.soundscapes",["a2.srv.project","humane"]).factory("a2Soundscapes",["Project","$http","$q","notify",function(e,t,i,n){var a=null;return{saveState:function(e){a=e},getState:function(){return a},getAmplitudeReferences:function(){return i.resolve([{value:"absolute",caption:"Absolute",description:"The threshold is taken as an absolute value of the amplitude of each peak."},{value:"relative-to-peak-maximum",caption:"Relative to maximum",description:"The threshold is taken as a relative proportion of the maximum amplitude of the peaks in the soundscape."}])},get:function(i,n){var a=e.getUrl();t.get("/api/project/"+a+"/soundscapes/"+i).success(function(e){n(e)})},getSCIdx:function(n,a,r){a instanceof Function&&(r=a,a=void 0),a||(a={});var o=i.defer(),s=e.getUrl();return t.get("/api/project/"+s+"/soundscapes/"+n+"/scidx",{params:a}).success(function(e){r&&r(e),o.resolve(e)}),o.promise},getNormVector:function(n,a){var r=i.defer(),o=e.getUrl();return t.get("/api/project/"+o+"/soundscapes/"+n+"/norm-vector").success(function(e){a&&a(e),r.resolve(e)}),r.promise},getList:function(i,n){i instanceof Function&&(n=i,i={});var a=e.getUrl();t.get("/api/project/"+a+"/soundscapes/",{params:i}).success(function(e){n(e)})},getList2:function(i){t.get("/api/project/"+e.getUrl()+"/soundscapes/details").success(i).error(n.serverError)},setVisualizationOptions:function(i,n,a){var r=e.getUrl();t.post("/api/project/"+r+"/soundscapes/"+i+"/scale",n).success(function(e){a(e)})},addRegion:function(i,n,a,r){var o=e.getUrl();a.bbox=n,t.post("/api/project/"+o+"/soundscapes/"+i+"/regions/add",a).success(function(e){r(e)})},sampleRegion:function(i,n,a,r){var o=e.getUrl();t.post("/api/project/"+o+"/soundscapes/"+i+"/regions/"+n+"/sample",a).success(function(e){r(e)})},getExportUrl:function(t){var n=t.soundscape.soundscape_id,a=i.defer(),r=e.getUrl(),o=[];return t.raw&&o.push("raw=1"),a.resolve("/api/project/"+r+"/soundscapes/"+n+"/export-list"+(o.length?"?"+o.join("&"):"")),a.promise},getRegion:function(i,n,a){var r=e.getUrl();t.get("/api/project/"+r+"/soundscapes/"+i+"/regions/"+n).success(function(e){a(e)})},getRecordingTags:function(i,n,a,r){var o=e.getUrl();t.get("/api/project/"+o+"/soundscapes/"+i+"/regions/"+n+"/tags/"+a).success(function(e){r(e)})},addRecordingTag:function(i,n,a,r,o){var s=e.getUrl();t.post("/api/project/"+s+"/soundscapes/"+i+"/regions/"+n+"/tags/"+a+"/add",{tag:r}).success(o)},removeRecordingTag:function(i,n,a,r,o){var s=e.getUrl();t.post("/api/project/"+s+"/soundscapes/"+i+"/regions/"+n+"/tags/"+a+"/remove",{tag:r}).success(o)},getRegions:function(i,n,a){n instanceof Function&&(a=n,n=void 0);var r=e.getUrl();t.get("/api/project/"+r+"/soundscapes/"+i+"/regions",{params:n}).success(function(e){a(e)})},getRecordings:function(i,n,a,r){a instanceof Function&&(r=a,a={});var o=e.getUrl();t.get("/api/project/"+o+"/soundscapes/"+i+"/recordings/"+n,{params:a}).success(function(e){r(e)})},findIndices:function(i,n){t.get("/api/project/"+e.getUrl()+"/soundscapes/"+i+"/indices").success(n)},delete:function(i,a){t.get("/api/project/"+e.getUrl()+"/soundscapes/"+i+"/delete").success(a).error(n.serverError)},create:function(i){return t.post("/api/project/"+e.getUrl()+"/soundscape/new",i)}}}]),angular.module("a2.srv.species",[]).factory("Species",["$http",function(e){var t;return{get:function(i){if(t)return i(t);e.get("/api/species/list/100").success(function(e){t=e,i(t)})},search:function(t,i){e.get("/api/species/search",{params:{q:t}}).success(function(e){i(e)})},findById:function(t,i){return e.get("/api/species/"+t).then(function(e){return i&&i(e.data),e.data})}}}]).factory("Songtypes",["$http",function(e){var t,i=function(e,i){var n=t.filter(function(t){return t.id===e});null!==n&&i(n[0])};return{get:function(i){if(t)return i(t);e.get("/api/songtypes/all").success(function(e){t=e,i(t)})},findById:function(n,a){if(t)return void i(n,a);e.get("/api/songtypes/all").success(function(e){t=e,i(n,a)})}}}]),angular.module("a2.srv.tags",["a2.srv.api"]).factory("a2Tags",["$q","a2APIService","notify",function(e,t,i){function n(e){return/^recording$/.test(""+e)}function a(e){return e&&n(e.type)&&e.id}return{getFor:function(i){return a(i)?t.get("/tags/"+i.type+"/"+(0|i.id)):e.resolve([])},getForType:function(i){return n(i)?t.get("/tags/"+i):e.resolve([])},deleteFor:function(i,n){return a(i)?t.delete("/tags/"+i.type+"/"+(0|i.id)+"/"+n):e.resolve([])},addFor:function(n,r){if(a(n)){var o={};return r.tag_id?o.id=r.tag_id:o.text=r.tag,void 0!==r.t0&&(o.t0=r.t0,o.f0=r.f0,o.t1=r.t1,o.f1=r.f1),t.put("/tags/"+n.type+"/"+(0|n.id),o).catch(i.serverError)}return e.resolve([])},search:function(e){return t.get("/tags/?q="+e)}}}]),angular.module("a2.srv.templates",["a2.srv.project"]).factory("a2Templates",["Project","$http","notify",function(e,t,i){return{getList:function(i){var n=e.getUrl(),a={params:{}};return i&&i.showRecordingUri&&(a.params.showRecordingUri=i.showRecordingUri),i&&i.projectTemplates&&(a.params.projectTemplates=i.projectTemplates),i&&i.publicTemplates&&(a.params.publicTemplates=i.publicTemplates),i&&i.q&&(a.params.q=i.q),i&&i.limit&&(a.params.limit=i.limit),i&&void 0!==i.offset&&(a.params.offset=i.offset),t.get("/api/project/"+n+"/templates",a).then(function(e){return e.data})},count:function(i){var n={params:{}};return i&&i.publicTemplates&&(n.params.publicTemplates=i.publicTemplates),t.get("/api/project/"+e.getUrl()+"/templates/count",n).then(function(e){return e.data})},add:function(n){var a=e.getUrl();return t.post("/api/project/"+a+"/templates/add",n).then(function(e){return e.data}).catch(i.serverError)},getAudioUrlFor:function(t){return"/api/project/"+e.getUrl()+"/templates/audio/"+t.id+".mp3"},delete:function(i){var n=e.getUrl();return t.post("/api/project/"+n+"/templates/"+i+"/remove")},getImage:function(i){var n=e.getUrl();return t.get("/api/project/"+n+"/templates/data/"+i+"/image").then(function(e){return e.data})}}}]),angular.module("a2.srv.training-sets",["a2.srv.project"]).factory("a2TrainingSets",["Project","$http",function(e,t){return{getList:function(i){var n=e.getUrl();t.get("/api/project/"+n+"/training-sets").success(function(e){i(e)})},add:function(i,n){var a=e.getUrl();t.post("/api/project/"+a+"/training-sets/add",i).success(function(e){n(e)})},edit:function(i,n){var a=e.getUrl();return t.post("/api/project/"+a+"/training-sets/edit/"+i,n)},delete:function(i){var n=e.getUrl();return t.post("/api/project/"+n+"/training-sets/remove/"+i)},addData:function(i,n,a){var r=e.getUrl();t.post("/api/project/"+r+"/training-sets/add-data/"+i,n).success(function(e){a(e)})},getData:function(i,n,a){n instanceof Function&&(a=n,n="");var r=e.getUrl();t.get("/api/project/"+r+"/training-sets/list/"+i+"/"+n).success(function(e){a(e)})},getDataImage:function(i,n,a){var r=e.getUrl();t.get("/api/project/"+r+"/training-sets/data/"+i+"/get-image/"+n).success(function(e){a(e)})},getTypes:function(i){var n=e.getUrl();t.get("/api/project/"+n+"/training-sets/types").success(function(e){i(e)})},getRois:function(i,n){var a=e.getUrl();t.get("/api/project/"+a+"/training-sets/rois/"+i).success(function(e){n(e)})},getExportUrl:function(t){return"/api/project/"+e.getUrl()+"/training-sets/rois/"+t+"?export=1"},getSpecies:function(i,n){var a=e.getUrl();t.get("/api/project/"+a+"/training-sets/species/"+i).success(function(e){n(e)})},removeRoi:function(i,n,a){var r=e.getUrl();t.get("/api/project/"+r+"/training-sets/"+i+"/remove-roi/"+n).success(function(e){a(e)})}}}]),angular.module("a2.srv.uploads",["a2.srv.api"]).factory("a2UploadsService",["a2APIService",function(e){return{getProcessingList:function(t){const i={params:t};return e.get("/uploads/processing",i).then(function(e){return e})},checkStatus:function(t){const i={params:t};return e.get("/uploads/check",i).then(function(e){return e.items})}}}]),angular.module("a2.srv.users",[]).factory("Users",["$http",function(e){return{getInfoForId:function(t){return e.get("/api/user/info/"+t).then(function(e){return e.data.user})}}}]),angular.module("a2.filters",["a2.filter.as-csv","a2.filter.caps","a2.filter.a2-page-number-to-title","a2.filter.a2-page-title-to-number","a2.filter.project-url","a2.filter.range","a2.filter.round","a2.filter.time-from-now"]),angular.module("a2.filter.as-csv",[]).filter("asCSV",function(){return function(e,t,i){return e instanceof Array||(e="object"==typeof e?Object.keys(e).map(function(t){return t+"="+(void 0===e[t]?"":e[t])}):[e]),i&&(e=e.filter(function(e){return!!e})),e.join(t||", ")}}),angular.module("a2.filter.caps",[]).filter("caps",function(){return function(e,t){if(e)switch(t||"title"){case"title-case":return e.replace(/\b\w/g,function(e){return e.toUpperCase()});default:return e}}}),angular.module("a2.filter.a2-page-number-to-title",[]).filter("a2PageNumberToTitle",function(){return function(e){return e+1}}),angular.module("a2.filter.a2-page-title-to-number",[]).filter("a2PageTitleToNumber",function(){return function(e){return isFinite(e)&&""!==e?"0"==e?9:e-1:""}}),angular.module("a2.filter.project-url",[]).filter("projectUrl",["a2APIService",function(e){return function(t){return e.project.getUrl(t)}}]),angular.module("a2.filter.range",[]).filter("a2Range",function(){return function(e,t,i){t||(t=e,e=0),i||(i=Math.sign(t-e));var n=Math.sign(i),a=[];if(0!=i)for(var r=e;(r-t)*n<0;r+=i)a.push(r);return a}}),angular.module("a2.filter.round",[]).filter("round",function(){return function(e,t){return t=t||1,(e/t|0)*t||0}}),angular.module("a2.filter.time-from-now",[]).filter("timeFromNow",function(){return function(e,t){if(e)return moment(e).fromNow()}}),angular.module("a2.orders.change-project-plan",["a2.orders.order-utils","a2.orders.orders","ui.bootstrap","humane","a2.directives","a2.services"]).controller("ChangeProjectPlanCtrl",["$scope","orderData","Project","$window","a2order","$modalInstance","notify","a2orderUtils",function(e,t,i,n,a,r,o,s){e.today=new Date,console.log(t),e.recorderQty=t.recorderQty,s.getOrdersContact().then(function(t){e.ordersContact=t.data}),s.paymentsStatus().then(function(t){e.autoPaymentsEnabled=t.data.payments_enable}),i.getInfo(function(n){if(e.project=n,e.currentPlan={storage:n.storage_limit,processing:n.processing_limit,duration:n.plan_period,tier:n.tier,activation:n.plan_activated,creation:n.plan_created},e.currentPlan.activation&&e.currentPlan.duration){var a=new Date(e.currentPlan.activation);a.setFullYear(a.getFullYear()+e.currentPlan.duration),e.currentPlan.due=a}e.currentPlan.due&&e.currentPlan.due<e.today?e.mode="renew":e.currentPlan.duration?e.mode="upgrade":e.mode="new",e.project.plan=t.project&&t.project.plan||{},i.getUsage().success(function(t){e.minUsage=t.min_usage})}),e.upgrade=function(){if(!e.autoPaymentsEnabled)return o.log("Payments are unavailable");if("renew"==e.mode){if(e.project.plan.storage<e.minUsage)return void o.error("Please select a plan with more capacity or delete recordings from the project")}else if(e.currentPlan.storage&&e.project.plan.storage-e.currentPlan.storage<=0)return void o.error("To upgrade select a plan with more capacity than the current");t={action:"update-project",project:e.project,recorderQty:e.recorderQty,mode:e.mode},e.recorderQty>0&&"paid"==e.project.plan.tier?a.enterShippingAddress(t):a.reviewOrder(t),r.dismiss()}}]),angular.module("a2.orders.create-project",["a2.orders.orders","a2.orders.order-utils","a2.orders.plan-selection","a2.orders.project-order-service","ui.bootstrap","humane"]).controller("CreateProjectCtrl",["$scope","$http","$modalInstance","$modal","notify","a2order","orderData","a2orderUtils","ProjectOrderService",function(e,t,i,n,a,r,o,s,c){e.project=o.project,e.recorderQty=o.recorderQty,s.getOrdersContact().then(function(t){e.ordersContact=t.data}),s.paymentsStatus().then(function(t){e.autoPaymentsEnabled=t.data.payments_enable}),e.create=function(){if(console.log(e.isValid),e.isValid)return c.makeOrder("create-project",e.project,e.recorderQty,{autoPaymentsEnabled:e.autoPaymentsEnabled}).then(function(e){if(console.log(e),e.hasCoupon||!e.isPaidProject)return c.placeOrder(e.data).then(function(){return i.close()});e.isPaidProject&&e.data.recorderQty>0?(r.enterShippingAddress(e.data),i.dismiss()):(r.reviewOrder(e.data),i.dismiss())})}}]),angular.module("a2.orders.order-summary",["a2.orders.orders","a2.orders.order-utils","a2.orders.project-order-service","ui.bootstrap","humane"]).controller("OrderSummaryCtrl",["$scope","$http","$modalInstance","orderData","notify","$window","a2order","a2orderUtils","ProjectOrderService",function(e,t,i,n,a,r,o,s,c){n.address&&(e.address=n.address),e.type="upgrade"==n.mode?"upgrade":"new",e.info=s.info,e.shipping=n.shipping||0,e.project=n.project,e.plan=n.project.plan,e.recorderQty=n.recorderQty||0,e.changeItems=function(){"create-project"==n.action?o.createProject(n):o.changePlan(n),i.dismiss()},e.editAddress=function(){o.enterShippingAddress(n),i.dismiss()},e.submit=function(){return e.waiting=!0,console.log(n),c.placeOrder(n).then(function(t){console.log(t),t.message?i.close():t.approvalUrl&&r.location.assign(t.approvalUrl),e.waiting=!1}).catch(function(t){e.waiting=!1})}}]),angular.module("a2.orders.order-utils",[]).service("a2orderUtils",["$http",function(e){return{monthsUntilDue:function(e,t){for(var i,n=new Date(e),a=12*t,r=new Date,o=0;o<=a;o++){if(r<=new Date(n.getFullYear(),n.getMonth()+o,n.getDate())){i=o-1;break}}return a-i},paymentsStatus:function(){return e.get("/api/orders/payments-status",{cache:!0})},checkCouponCode:function(t,i){return e.post("/api/orders/check-coupon",{hash:t,project:i}).then(function(e){return e.data})},getOrdersContact:function(){return e.get("/api/orders/contact",{cache:!0})},info:{recorder:{name:"Arbimon Recorder",description:"includes an Android device preset for acoustic monitoring, waterproof case(IP67), microphone, 6500mAh lithium-ion battery and USB charger",priceWithPlan:125,priceNoPlan:300},plan:{new:{name:"Project data plan",description:function(e){return"includes storage for "+e.storage+" minutes of audio and capacity to process "+e.processing+" minutes of audio per year, for a term of "+e.duration+" year(s)"}},upgrade:{name:"Project data plan upgrade",description:function(e){return"upgrade your plan storage to "+e.storage+" minutes of audio and capacity to process "+e.processing+" minutes of audio per year, until this plan due"}}}}}}]),angular.module("a2.orders.orders",["a2.orders.create-project","a2.orders.change-project-plan","a2.orders.shipping-form","a2.orders.order-summary","ui.bootstrap"]).service("a2order",["$modal",function(e){var t=function(t,i){var n={resolve:{orderData:function(){return t}},backdrop:"static",templateUrl:i.templateUrl,controller:i.controller};return e.open(n)};return{createProject:function(e){return t(e,{templateUrl:"/orders/create-project.html",controller:"CreateProjectCtrl"})},changePlan:function(e){return t(e,{templateUrl:"/orders/change-plan.html",controller:"ChangeProjectPlanCtrl"})},enterShippingAddress:function(e){return t(e,{templateUrl:"/orders/shipping-address.html",controller:"ShippingFormCtrl"})},reviewOrder:function(e){return t(e,{templateUrl:"/orders/order-summary.html",controller:"OrderSummaryCtrl"})}}}]),angular.module("a2.orders.directives.plan-capacity",["a2.orders.plan-selection","countries-list","ui.bootstrap","humane","a2.directives","a2.services"]).directive("planCapacity",function(){return{restrict:"E",scope:{disabled:"=",minutes:"="},templateUrl:"/orders/plan-capacity.html",link:function(e,t,i){i.enabled||(e.enabled=!0)}}}),angular.module("a2.orders.plan-selection",["countries-list","ui.bootstrap","humane","a2.orders.directives.plan-capacity","a2.orders.directives.tier-select","a2.directives","a2.services"]).controller("PlanSelectionCtrl",["$scope","a2orderUtils",function(e,t){const i={tier:"free",cost:0,storage:1e5,processing:1e7};this.coupon={code:"",validation:null},this.checkCouponCode=function(){if(this.coupon.code)return this.coupon.validation={class:"fa fa-spinner fa-spin"},delete this.coupon.payload,delete e.plan.coupon,t.checkCouponCode(this.coupon.code,this.project).then(function(t){t.valid?(e.plan.coupon=t,this.coupon.payload=t.payload,this.coupon.validation={valid:!0,class:"fa fa-check text-success"}):this.coupon.validation={valid:!1,class:"fa fa-times text-danger"}}.bind(this),function(){this.coupon.validation={valid:!1,class:"fa fa-times text-danger"}}.bind(this));delete this.coupon.validation},e.plan=i,e.recorderOptions=0,e.planMinutes=e.planMinutes||i.storage,e.planYears=e.planYears||1,e.upgradeOnly=!1,e.recorderQty=e.recorderQty||0,console.log(e.plan),this.hasCouponCode=!1,this.planData={yearOptions:[1,2,3,4,5,6,7,8,9,10]},e.$watch("currentPlan",function(){if(e.currentPlan){var t=new Date(e.currentPlan.activation);t.setFullYear(t.getFullYear()+e.currentPlan.duration),e.planYears=e.currentPlan.duration||1,e.planMinutes=e.currentPlan.storage>=i.storage?e.currentPlan.storage:i.storage,"paid"==e.currentPlan.tier&&(!e.currentPlan.activation||new Date<t)&&(e.upgradeOnly=!0,e.plan.tier="paid")}}),e.$watch("plan",function(t){e.plan&&(e.plan.storage&&(e.planMinutes=e.plan.storage),e.plan.duration&&(e.planYears=e.plan.duration))}),e.$watch("plan.tier",function(t){e.plan&&("paid"==e.plan.tier?(e.plan.cost=.03*e.planMinutes*e.planYears,e.plan.storage=+e.planMinutes,e.plan.processing=100*e.planMinutes,e.plan.duration=e.planYears,console.log(e.plan)):"free"==e.plan.tier&&(e.plan.cost=i.cost,e.plan.storage=i.storage,e.plan.processing=i.processing,e.plan.duration=void 0))});var n=function(){if(e.plan=e.plan||{},e.upgradeOnly){e.currentPlan.storage>e.planMinutes&&(e.planMinutes=e.currentPlan.storage);var i=e.currentPlan.activation||e.currentPlan.creation,n=t.monthsUntilDue(i,e.currentPlan.duration);console.log("planStarts",i),console.log("monthsLeft",n),e.plan.cost=(e.planMinutes-e.currentPlan.storage)*n*.0025,e.plan.storage=+e.planMinutes,e.plan.processing=100*e.planMinutes,e.plan.duration=e.planYears}else{e.usage&&e.usage>e.planMinutes&&(e.planMinutes=5e3*Math.ceil(e.usage/5e3)),e.plan.cost=e.planMinutes*e.planYears*.03,e.plan.storage=+e.planMinutes,e.plan.processing=100*e.planMinutes,e.plan.duration=e.planYears;var a=Math.floor(e.planMinutes/1e4)*e.planYears;e.recorderQty=e.recorderQty||0,e.recorderQty>a&&(e.recorderQty=a),e.recorderOptions=new Array(a+1)}};this.updatePlan=n,e.$watch("planMinutes",n),e.$watch("planYears",n)}]).directive("planSelect",function(){return{restrict:"E",scope:{project:"=",plan:"=",recorderQty:"=",availablePlans:"=",ordersContact:"=",autoPaymentsEnabled:"=",currentPlan:"=?",usage:"=?"},templateUrl:"/orders/select-plan.html",controller:"PlanSelectionCtrl as controller",link:function(e,t,i,n){e.$watch("project",function(e){n.project=e})}}}),angular.module("a2.orders.process-order",[]).controller("ProcessOrderCtrl",["$scope","$http","$window","$location",function(e,t,i,n){var a=/\/process-order\/([\w\-\d]+)/,r=a.exec(i.location.pathname),o=null!==r?r[1]:"";console.log("orderId:",o),e.processing=!0,t.post("/api/orders/process/"+o+i.location.search).success(function(t){console.log("data",t),e.invoice={items:t.invoice.item_list.items,amount:t.invoice.amount,number:t.orderNumber,user:t.user},t.invoice.item_list.shipping_address&&(e.invoice.address=t.invoice.item_list.shipping_address),e.action=t.action,e.processing=!1,e.success=!0}).error(function(t,i){404==i?e.notFound=!0:400==i&&"APPROVAL_NEEDED"==t.error?(e.needApproval=!0,e.approvalLink=t.approvalLink):400==i&&"ALREADY_PROCESSED"==t.error?e.alreadyProcessed=!0:e.errorOcurred=!0,e.processing=!1})}]),angular.module("a2.orders.project-order-service",["humane"]).factory("ProjectOrderService",["$q","$filter","$http","notify",function(e,t,i,n){var a=t("currency");return{placeOrder:function(t){return/(create|update)-project/.test(t.action)?(delete angular.merge({},t).action,i.post("/api/orders/"+t.action,t).then(function(e){var t=e.data;return t.message&&n.log(t.message),t}).catch(function(e){var i=e.data;throw console.log("err",i),console.log("err resp",e),i&&(i.freeProjectLimit?n.error("You already have own a free project, the limit is one per user."):i.nameExists?n.error("Name <b>"+t.project.name+"</b> not available."):i.urlExists?n.error("URL <b>"+t.project.url+"</b> is taken, choose another one."):n.serverError()),i})):e.reject("Invalid action "+t.action)},makeOrder:function(t,i,n,r){if(console.log("makeOrder",t,i,n,r),!i||!i.plan)return e.reject(new Error("You need to select a plan"));var o="paid"==i.plan.tier,s=i.plan.coupon&&i.plan.coupon.valid?i.plan.coupon:void 0;if(r.recorderCost=r.recorderCost||125,r.projectCostLimit=r.projectCostLimit||1e4,s)i=angular.merge({},i),delete i.plan;else if(o){if(!r.autoPaymentsEnabled)return e.reject(new Error("Payments are unavailable"));if(i.plan.cost+n*r.recorderCost>r.projectCostLimit)return e.reject(new Error("Cannot process order greater than "+a(r.projectCostLimit)))}return e.resolve({hasCoupon:!!s,isPaidProject:o,data:{action:t,coupon:s?s.hash:void 0,project:i,recorderQty:n}})}}}]),angular.module("a2.orders.shipping-form",["a2.orders.orders","countries-list","ui.bootstrap"]).controller("ShippingFormCtrl",["$scope","$http","$modalInstance","$modal","orderData","countries","a2order",function(e,t,i,n,a,r,o){a.address?e.address=a.address:t.get("/api/user/address").success(function(t){e.address=t.address||{}}),r.get(function(t){e.countries=t}),e.verify=function(){t.post("/api/orders/calculate-shipping",{address:e.address,recorderQty:a.recorderQty}).success(function(e){a.shipping=e.shipping_cost,a.address=e.address,o.reviewOrder(a),i.dismiss()})}}]),angular.module("a2.orders.directives.tier-select",[]).directive("tierSelect",function(){return{restrict:"E",scope:{tier:"=",disableFree:"="},templateUrl:"/orders/tier-select.html"}}),angular.module("a2.directive.a2-auto-close-on-outside-click",[]).directive("a2AutoCloseOnOutsideClick",["$document","$rootScope",function(e,t){function i(e){var t=[];for(e=e;e;)t.push(e),e=e.parentElement;return t}return{restrict:"A",require:"?dropdown",link:function(n,a,r,o){function s(a){if(a&&o.isOpen()){var r=i(a.target),s=r.indexOf(e[0].documentElement),c=r.indexOf(o.toggleElement[0]),l=r.indexOf(o.dropdownMenu[0]);-1==c&&-1==l&&-1!=s&&(o.toggle(!1),t.$$phase||n.$apply())}}r.$set("autoClose","disabled"),e.bind("click",s),n.$on("$destroy",function(){e.unbind("click",s)})}}}]),angular.module("arbimon2.directive.a2-dropdown",[]).directive("a2Dropdown",["$compile",function(e){var t=angular.element('<div dropdown dropdown-append-to-body><button class="btn btn-sm btn-default dropdown-toggle" dropdown-toggle><span></span> <i class="fa fa-caret-down"></i></button><ul class="dropdown-menu dropup" role="menu"><li ng-repeat="$item in list" ng-class="{active: $item == $selectedItem}"><a ng-click="select($item)"><span></span></a></li></ul></div>');return{restrict:"E",require:"ngModel",scope:!0,compile:function(i,n){var a=angular.element(t[0].cloneNode(!0)),r=a.children("ul").children("li").children("a").children("span"),o=a.children("button").children("span"),s=i.html();r.append(s),o.append(s.replace(/\$item\b/g,"$selectedItem")),i.empty();var c=e(a.clone());return function(e,t,i,n){t.append(c(e)),e.$watch(i.list,function(t){e.list=t||[]}),e.select=function(t){e.$selectedItem=t,n.$setViewValue(t,!0)},n.$render=function(){e.$selectedItem=n.$viewValue}}}}}]),angular.module("a2.directive.on-resize",[]).service("a2OnResizeService",["$window","$rootScope",function(e,t){function i(e,t){this.element=e,this.handler=t,this.value=null,a.push(this),n.scheduleAnimationFrame()}function n(){r=!1;var e=[];a.forEach(function(t){var i=t.element[0].clientWidth,n=t.element[0].clientHeight;t.value&&t.value.width==i&&t.value.height==n||(t.value={width:i,height:n},e.push(t))}),e.length&&t.$apply(function(){e.forEach(function(e){try{e.handler(e.value)}catch(e){console.error(e)}})}),n.scheduleAnimationFrame()}var a=[],r=!1;return i.prototype.destroy=function(){var e=a.indexOf(this);e>=0&&a.splice(e,1)},n.scheduleAnimationFrame=function(){a.length&&!r&&(r=!0,e.requestAnimationFrame(n))},{newWatcher:function(e,t){return new i(e,t)}}}]).directive("a2OnResize",["$parse","a2OnResizeService",function(e,t){return{restrict:"A",link:function(i,n,a){var r=e(a.a2OnResize),o=t.newWatcher(n,function(e){r(e,i)});i.$on("$destroy",function(){o.destroy()})}}}]),angular.module("a2.directive.a2-palette-drawer",[]).directive("a2PaletteDrawer",["a2Soundscapes",function(e){return{restrict:"E",template:'<canvas class="palette"></canvas>',replace:!0,scope:{palette:"&"},link:function(e,t,i){var n=function(){var i=e.palette()||[],n=0|i.length;t.attr("width",n),t.attr("height",1);for(var a=t[0].getContext("2d"),r=0;r<n;++r)a.fillStyle=i[r],a.fillRect(r,0,1,1)};e.$watch("palette()",n)}}}]),angular.module("a2.directive.percentage-bars",["a2.utils"]).directive("a2PercentageBars",["a2SidenavBarService","$parse",function(e,t){return{restrict:"E",templateUrl:"/directives/a2-percentage-bars.html",scope:{data:"=",total:"=",colors:"="},controller:"a2PercentageBarsCtrl as bars"}}]).controller("a2PercentageBarsCtrl",["$scope","$filter",function(e,t){var i=["0","1","2"],n=t("number");e.getColorClass=function(t){var n=e.colors||i;return"bar-"+n[t%n.length]},e.getTotal=function(){return e.total||e.data.reduce(function(e,t){
return e+t})},e.asPercent=function(t,i){return n(100*t/e.getTotal(),i)+"%"}}]),angular.module("a2.directive.require-non-empty",[]).directive("requireNonEmpty",function(){return{restrict:"A",require:"?ngModel",link:function(e,t,i,n){n&&(i.required=!0,n.$validators.required=function(e,t){return!i.required||!(n.$isEmpty(t)||t instanceof Array&&!t.length)},i.$observe("required",function(){n.$validate()}))}}}),angular.module("a2.directive.sidenav-bar",["a2.utils"]).directive("a2SidenavBar",["a2SidenavBarService","$parse",function(e,t){return{restrict:"E",compile:function(t,i){t.addClass("sidenav");var n=i.name,a=t.clone();return function(t,i,r){e.enableSidenavBar(n,a,t),r.enabled&&t.$watch(r.enabled,function(i){i?e.enableSidenavBar(n,a,t):e.disableSidenavBar(n)}),t.$on("$destroy",function(){e.disableSidenavBar(n)})}}}}]).service("a2SidenavBarService",["$q","$log","a2EventEmitter",function(e,t,i){function n(){this.enabled=!1,this.events=new i}function a(e){return r[e]||(r[e]=new n)}var r={};return n.prototype={enable:function(t,i){return this.enabled?e.resolve():(this.enabled=!0,this.template=t,this.scope=i,this.events.emit("enabled",this))},disable:function(){return this.enabled?(this.enabled=!1,delete this.template,delete this.scope,this.events.emit("disabled",this)):e.resolve()},on:function(e,t){this.events.on(e,t)},off:function(e,t){this.events.off(e,t)}},a2SidenavBarService={enableSidenavBar:function(e,t,i){return a(e).enable(t,i)},disableSidenavBar:function(e){return a(e).disable()},registerAnchor:function(t,i,n){var r=a(t);return r.on("enabled",i),r.on("disabled",n),r.enabled&&e.resolve().then(i),function(){r.off("enabled",i),r.off("disabled",n)}}},a2SidenavBarService}]).directive("a2SidenavBarAnchor",["a2SidenavBarService","$compile",function(e,t){return{restrict:"A",link:function(i,n,a){function r(e){var i=e.template.clone();n.empty().append(t(i.children())(e.scope))}function o(e){n.empty()}var s,c;n[0].nodeName.toLowerCase();a.$observe("a2SidenavBarAnchor",function(t){s=t,c&&(c(),c=null),c=e.registerAnchor(s,r,o)}),i.$on("$destroy",function(){c&&(c(),c=null)})}}}]),angular.module("a2.directive.a2-table",[]).directive("a2Table",["$window","$filter","$templateCache","$compile",function(e,t,i,n){function a(e){return e.children("field").toArray().map(function(e){e=angular.element(e);var t=e.clone();return e.detach(),{title:t.attr("title"),key:t.attr("key"),tdclass:t.attr("tdclass"),width:t.attr("width"),filter:void 0!==t.attr("filter")?t.attr("filter")||t.attr("key"):void 0,content:t.html(),show:t.attr("show"),tooltip:t.attr("tooltip")}})}function r(e,t){var i=e.children("expand-select");if(i.length){var n=i.clone(!0);return i.detach(),i=angular.element('<tr ng-show="selected"><td colspan="'+t.fieldCount+'"></td></tr>'),i.find("td").append(n),i}}e.$;return{restrict:"E",scope:{rows:"=",selected:"=?",onSelect:"&",onCheck:"&",checked:"=?",search:"=?",dateFormat:"@",numberDecimals:"@"},controller:"a2TableCtrl as a2TableController",compile:function(e,t){var o=angular.element(i.get("/directives/a2-table.html")),s=o.find("thead tr.headers"),c=o.find("thead tr.filters"),l=o.find("tbody tr"),u={},d=!1;return u.fields=a(e),u.hasCheckbox=void 0===t.noCheckbox,u.hasSelection=void 0===t.noSelect,u.fieldCount=u.fields.length+(u.hasCheckbox?1:0),u.selectExpand=r(e,u),u.fields.forEach(function(e,t){s.append(angular.element('<th ng-click="a2TableController.sortBy('+t+')" class="cs-pointer"'+(e&&void 0!==e.tooltip?' title="'+e.tooltip+'"':"")+(e&&void 0!==e.show?' ng-if="'+e.show+'"':"")+"></th>").addClass(e.tdclass).text(e.title).append(e.key?'    <i ng-if="sortKey == '+t+'" class="fa" ng-class="reverse ? \'fa-chevron-up\': \'fa-chevron-down\'"></i>\n':"")),d|=void 0!==e.filter,c.append(angular.element("<th"+(e&&void 0!==e.show?' ng-if="'+e.show+'"':"")+"></th>").append(void 0!==e.filter?'   <input type="text" class="a2-table-filter form-control" ng-model="a2TableController.filter['+t+']" ng-change="a2TableController.onFilterChanged('+t+')">\n':"")),l.append(angular.element("<td "+(["Project","Species"].includes(e.title)?'title="'+e.content+'"':"")+(e.width?'width="'+e.width+'"':"")+(e&&void 0!==e.show?' ng-if="'+e.show+'"':"")+">").addClass(e.tdclass).html(e.content))}),function(e,t,i,a){var r=e.$parent.$new(!1,e);u.scope=e,u.tableScope=r,u.onSelect=e.onSelect&&function(t){return e.onSelect({row:t})},u.onCheck=e.onCheck&&function(t){return e.onCheck({row:t})},a.initialize(u),r.a2TableController=a,a.fields=u.fields,u.selectExpand&&(a.selectExpand=n(u.selectExpand)(r)),a.noCheck=!u.hasCheckbox,a.noSelect=!u.hasSelection,r.sortKey=i.defaultSort||r.sortKey,i.search&&e.$watch("search",function(t){r.query=e.search,a.updateChecked()}),a.setRows(e.rows),e.$watch("rows",function(e){a.setRows(e)},!0);var s=n(o.clone())(r);t.append(s),e.$on("$destroy",function(){r.$destroy()})}}}}]).controller("a2TableCtrl",["$filter",function(e){var t,i;this.initialize=function(e){t=e.scope,i=e.tableScope,this.options=e,this.__onSelect=e.onSelect,this.__onCheck=e.onCheck,this.hasFilters=e.fields.reduce(function(e,t){return e||void 0!==t.filter},!1),this.filter={}},this.setRows=function(e){this.rows=e,this.updateChecked()},this.onFilterChanged=function(e){var t=i.query||(i.query={}),n=this.options.fields[e].filter.split("."),a=this.filter[e];if(""==a){for(;n.length>1;)t=(t||{})[n.shift()];delete t[n.shift()]}else{for(;n.length>1;){var r=n.shift();t=t[r]||(t[r]={})}t[n.shift()]=a}},this.updateChecked=function(){if(this.rows){var n=e("filter")(this.rows,i.query);t.checked=n.filter(function(e){return!1|e.checked})}},this.toggleAll=function(){var e=this.rows.reduce(function(e,t){return e&&!t.checked},!0);this.rows.forEach(function(t){t.checked=e}),i.checkall=e},this.check=function(e,t){if(this.lastChecked&&e.shiftKey&&this.lastChecked){var i;i=this.lastChecked>t?this.rows.slice(t,this.lastChecked):this.rows.slice(this.lastChecked,t),i.forEach(function(e){e.checked=!0})}this.lastChecked=t},this.keyboardSel=function(e,t,i){" "!==i.key&&"Enter"!==i.key||this.sel(e,t)},this.sel=function(e,n,a){this.noSelect||(i.selected===e&&(e=void 0),i.selected=e,t.selected=e,this.selectExpand&&angular.element(a.currentTarget).after(this.selectExpand),this.__onSelect&&this.__onSelect(e))},this.onCheck=function(e,t,i){this.__onCheck&&this.__onCheck(e)},this.sortBy=function(e){var t=this.fields[e];i.sortKey!==e?(i.sortKey=e,i.sort=t.key,i.reverse=!1):i.reverse=!i.reverse}}]),function(){var e=angular.module("a2.directive.a2-tags",["templates-arbimon2"]);["classi","classes","model","playlist",{tag:"project",linkTo:function(e){return"/project/?id="+e}},"site","species","song","soundscape","training_set"].forEach(function(t){"string"==typeof t&&(t={tag:t}),t.tcTag=t.tag.replace(/(^|\b|-)(\w)/,function(e,t,i){return i.toUpperCase()}),e.directive("a2Tag"+t.tcTag,function(e){return{restrict:"EAC",scope:{tag:"=a2Tag"+t.tcTag},link:function(i,n,a){var r,o,s;n.find("a"),n.addClass("a2-tag a2-tag-"+t.tag),i.$watch("tag",function(i){i instanceof Array?(o=i[0],r=i[1],o&&t.linkTo&&(s=e.invoke(t.linkTo,null,{tagId:o}))):(o=null,r=i);var a=angular.element(s?"<a></a>":"<span></span>").appendTo(n.empty());a.text(r),s&&a.attr("href",s)})}}})})}(),angular.module("a2.directives",["a2.services","a2.directive.a2-table","arbimon.directive.a2-switch","a2.directive.percentage-bars","templates-arbimon2"]).run(["$window",function(e){var t=e.$;t(document).click(function(e){t(e.target).closest(".calendar.popup:visible").length||t(".calendar.popup:visible").hide()}),t.expr.filter.UP_PARENT_SPECIAL=function(e){var i=e&&e.length||1;return t.expr.createPseudo(function(e,t,n,a){var r=[];return e.forEach(function(n,a){for(var o=n,s=i;s>0;--s)o=o&&(9==o.nodeType||9==o.parentNode.nodeType?o:o.parentNode);if(o){for(var c=0,l=r.length;c<l;++c)if(r[c]===o){o=null;break}o&&r.push(o)}t[a]=o,e[a]=!o}),!0})},t.expr.match.needsContext=new RegExp(t.expr.match.needsContext.source+"|^(\\^)"),t.expr.match.UP_PARENT_SPECIAL=/^(\^+)/}]).directive("a2GlobalKeyup",["$window","$timeout",function(e,t){var i=e.$;return{restrict:"A",scope:{onkeyup:"&a2GlobalKeyup"},link:function(e,n,a){var r=function(i){t(function(){e.onkeyup({$event:i})})};i(document).on("keyup",r),n.on("$destroy",function(){i(document).off("keyup",r)})}}}]).directive("a2Scroll",["$parse","$window",function(e,t){var i=function(t,i){var n=e(i);return function(e){return e.console=console,n(t,e)}};return{scope:{a2InfiniteScrollDistance:"=?",a2InfiniteScrollDisabled:"=?",a2InfiniteScrollImmediateCheck:"=?"},link:function(e,n,a,r){var o=e.$parent,s="on",c="off";a.a2Scroll&&(r.a2Scroll=i(o,a.a2Scroll)),r.element=n,a.a2ScrollOn?"window"==a.a2ScrollOn?(r.scrollElement=t,s="addEventListener",c="removeEventListener"):r.scrollElement=$(a.a2ScrollOn):r.scrollElement=n,a.a2InfiniteScroll&&(e.a2InfiniteScroll=i(o,a.a2InfiniteScroll)),e.a2InfiniteScrollDistance||(e.a2InfiniteScrollDistance=1),e.a2InfiniteScrollRefraction||(e.a2InfiniteScrollRefraction=1e3),r.scrollHandler=r.scrollHandler.bind(r),r.scrollElement[s]("scroll",r.scrollHandler),r.element.bind("$destroy",function(){r.scrollElement[c]("scroll",r.scrollHandler),r.dispose()})},controller:"a2ScrollController"}}]).controller("a2ScrollController",["$scope",function(t){Object.assign(this,{anchors:{},addAnchor:function(e,t){this.anchors[e]=t},removeAnchor:function(e){delete this.anchors[e]},scrollHandler:function(i){try{if(this.a2Scroll&&this.a2Scroll({$event:i,$controller:this}),t.a2InfiniteScroll&&!t.a2InfiniteScrollDisabled){if((element[0].scrollHeight-element[0].scrollTop|0)/element.height()<t.a2InfiniteScrollDistance){var n=(new Date).getTime();(!t.refraction||t.refraction<n)&&(t.refraction=n+t.a2InfiniteScrollRefraction,t.a2InfiniteScroll({$event:e}))}}}finally{t.$apply()}},dispose:function(){this.element=null,this.scrollElement=null,this.anchors={}}})}]).directive("a2ScrollAnchor",function(){return{require:"^a2Scroll",link:function(e,t,i,n){var a=i.name;n.addAnchor(a,t),t.bind("$destroy",function(){n.removeAnchor(a)})}}}).directive("a2Persistent",["$rootScope","$compile","$timeout",function(e,t,i){var n=0,a=$("<div></div>");return{restrict:"E",scope:{},compile:function(r,o){var s=r.children().detach(),c=o.name||"persistent-"+n++;return function(n,r,o){e._$persistence_||(e._$persistence_={});var l=e._$persistence_,u=l[c],d=!0;u||(l[c]=u={},u.scope=e.$new(!0),u.scope._$persistence_tag_=c,u.view=t(s)(u.scope),d=!1),r.append(u.view),r.on("$destroy",function(e){e.stopPropagation(),a.append(u.view)}),d&&i(function(){u.scope.$broadcast("a2-persisted")})}}}}]).directive("autoHeight",["$window",function(e){var t=e.$;return{restrict:"A",link:function(i,n,a){var r=function(){var i=t(e).height()-n.offset().top;i<500||e.requestAnimationFrame(function(){n.height(i)})};r(),t(e).resize(function(){r()})}}}]).directive("stopClick",function(){return{restrict:"A",link:function(e,t,i){t.bind("click",function(e){e.stopPropagation()})}}}).directive("loader",function(){return{restrict:"E",scope:{hideText:"@",text:"@"},templateUrl:"/directives/loader.html"}}).directive("yearpick",["$timeout","$window",function(e,t){var i=t.d3,n=t.$;return{restrict:"AE",scope:{ngModel:"=",maxDate:"=?",minDate:"=?",year:"=?",dateCount:"=?",mode:"@",onYearChanged:"&?",onDateChanged:"&?",disableEmpty:"&"},link:function(t,a,r){function o(i){var n=t.year;t.year=i,t.onYearChanged&&n!=i&&e(function(){t.onYearChanged({year:i})})}function s(i){var n=t.ngModel;t.ngModel=i,t.onDateChanged&&n!=i&&e(function(){t.onDateChanged({date:i})})}var c,l=!/yearpick/i.test(a[0].tagName);l?(c=n("<div></div>").insertAfter(a).addClass("calendar popup"),a.click(function(e){e.stopPropagation();var t="none"===c.css("display");n(".calendar.popup:visible").hide(),t&&c.css("display","block")})):c=a.addClass("calendar");var u=function(e){var t=new Date(e.toString());t.setDate(1);var i=t.getDay()-1;return Math.floor((e.getDate()+i+7)/7)-1},d=i.time.format("%B"),p=i.time.format("%Y-%m-%d"),f=function(e){var t=/^(\d+)-(\d+)-(\d+)$/.exec(e);return t&&new Date(0|t[1],0|t[2],0|t[3])},h=!r.maxDate,g=!r.minDate;t.year||o((new Date).getFullYear());var m,v=i.select(c[0]).append("svg").attr("width",600).attr("height",510),y=v.append("g"),b=v.append("g"),_=v.append("g").attr("class","btn"),x=v.append("g").attr("class","btn");if(_.append("text").attr("text-anchor","start").attr("font-family","FontAwesome").attr("font-size",24).attr("x",5).attr("y",24).text(""),_.on("click",function(i){e(function(){o(t.year-1)})}),x.append("text").attr("text-anchor","end").attr("font-family","FontAwesome").attr("font-size",24).attr("x",595).attr("y",24).text(""),x.on("click",function(i){e(function(){o(t.year+1)})}),"density"===t.mode){var w={scale:[1,50,100],labels:["0","1","50","100"]},j=(i.scale.threshold().domain(w.scale).range(w),b.selectAll("g").data(["1","50","100"]).enter().append("g").attr("transform",function(e,t){switch(e){case"50":return"translate(18,0)";default:return"translate(20,0)"}}));j.append("rect").attr("width",11.97).attr("height",11.97).attr("y",498).attr("x",function(e,t){return 45*t+22}).attr("class",function(e){return"cal-level-"+e}),j.append("text").attr("text-anchor","middle").attr("font-size",10).attr("y",508).attr("x",function(e,t){switch(e){case"1":return 45*t+11;case"50":return 45*t+9;case"100":return 45*t+6}}).text(function(e,t){return"+"+e})}var P=function(){if("density"!==t.mode||t.dateCount){t.disableEmpty()&&m.classed("day-disabled",function(e){return n(this).hasClass("cal-oor")||!t.dateCount[p(e)]});m.select("rect").attr("class",function(e){return"cal-level-"+i.scale.threshold().domain([1,50,100]).range(["0","1","50","100"])(t.dateCount[p(e)]||0)})}},S=function(){calendar=y.selectAll("g").data([t.year]);var e=calendar.enter().append("g");e.append("text").attr("text-anchor","middle").attr("font-size",30).attr("x",300).attr("y",30),e.append("line").attr("x1",5).attr("y1",40).attr("x2",595).attr("y2",40).attr("stroke","rgba(0,0,0,0.5)").attr("stroke-width",1),calendar.exit().remove(),calendar.select("text").text(function(e){return e}),_.classed("disabled",t.minDate&&t.minDate.getFullYear()>=t.year),x.classed("disabled",t.maxDate&&t.year>=t.maxDate.getFullYear());var n=calendar.append("g").attr("transform","translate(0,40)").selectAll("g").data(function(e){return i.time.months(new Date(e,0,1),new Date(e+1,0,1))});n.enter().append("g"),n.attr("transform",function(e,t){return"translate("+(e.getMonth()%4*150+5)+","+(150*Math.floor(e.getMonth()/4)+5)+")"}),n.append("text").attr("text-anchor","middle").attr("x",66.5).attr("y",15).text(function(e){return d(e)}),n.exit().remove(),m=n.selectAll("g").data(function(e){return i.time.days(new Date(e.getFullYear(),e.getMonth(),1),new Date(e.getFullYear(),e.getMonth()+1,1))}),m.enter().append("g").attr("class","day"),m.attr("transform",function(){return"translate(0,24)"}).classed("hover",!0).classed("day-disabled cal-oor",function(e){return!!t.minDate&&e<t.minDate||!!t.maxDate&&t.maxDate<e}).classed("selected",function(e){return t.ngModel&&p(e)==p(t.ngModel)}).on("click",function(e){t.$apply(function(){i.event.preventDefault(),s(e),l&&c.css("display","none")})}),m.append("rect").attr("width",19).attr("height",19).attr("y",function(e,t){return 20*u(e)}).attr("x",function(e,t){return 20*e.getDay()}).attr("fill","white"),m.append("text").attr("text-anchor","middle").attr("font-size",10).attr("y",function(e,t){return 20*u(e)+13}).attr("x",function(e,t){return 20*(e.getDay()+1)-10}).text(function(e,t){return e.getDate()}),r.dateCount&&P(),m.exit().remove()};t.$watch("maxDate",function(){t.maxDate&&t.year>t.maxDate.getFullYear()&&o(t.maxDate.getFullYear()),S()}),t.$watch("minDate",function(){t.minDate&&t.year<t.minDate.getFullYear()&&o(t.minDate.getFullYear()),S()}),t.$watch("year",function(){t.year||o((new Date).getFullYear()),S()}),t.$watch("ngModel",function(){t.ngModel&&(o(t.ngModel.getFullYear()),m.classed("selected",function(e){return t.ngModel&&p(e)==p(t.ngModel)}))});var C=function(e,i,n){var a=null;if(e&&(i||n)){for(var r in e){var o=f(r);a?(a.min=Math.min(o,a.min),a.max=Math.max(o,a.max)):a={min:o,max:o}}n&&(t.minDate=new Date(a.min)),i&&(t.maxDate=new Date(a.max))}};(function(){return"density"===t.mode&&r.dateCount})()&&t.$watch("dateCount",function(e){C(e,h,g),P()})}}}]).directive("a2Img",["$compile","$window",function(e,t){var i=t.$;return{restrict:"E",scope:{},link:function(t,n,a){n.addClass("a2-img");var r=(e('<loader hide-text="yes"></loader>')(t).appendTo(n),i("<img>").on("load",function(){n.removeClass("loading")}).appendTo(n));a.$observe("a2Src",function(e){if(!e)return r.hide(),void r.attr("src","");r.show(),n.addClass("loading");var t=new Image;t.onload=function(){r.attr("src",this.src)},t.src=e})}}}]).directive("a2TrainingSetDataImage",["$compile","a2TrainingSets",function(e,t){return{restrict:"E",scope:{trainingSet:"=",datum:"="},template:'<a2-img a2-src="{{datum.uri}}" ng-class="resolving ? \'resolving-uri\' : \'\'" style="width:100%;height:100%;"></a2-img>',link:function(e,i,n){i.addClass("a2-training-set-data-image a2-block-inline");var a=function(){if(e.datum&&e.trainingSet&&!e.datum.url){var i=[e.trainingSet.id,e.datum.id].join("-");e.resolving!=i&&(e.resolving=i,t.getDataImage(e.trainingSet.id,e.datum.id,function(t){e.resolving=!1,e.datum.id==t.id&&(e.datum.uri=t.uri)}))}};e.$watch("datum",a),e.$watch("trainingSet",a)}}}]).directive("a2InsertIn",["$window",function(e){var t=e.$,i=1;return{restrict:"A",link:function(e,n,a){var r=t('<div class="a2-insert-in-anchor"></div>').attr("id","a2InsertInAnchor"+i++),o=function(e){return e&&!/no|false|0/.test(""+e)}(a.a2KeepPosition),s=t(a.a2InsertIn);n[0].parentNode.replaceChild(r[0],n[0]),n.appendTo(s);var c=null;if(o){var l=function(e){return t(e).offset()};c=function(){t(".a2-insert-in-anchor");var e=l(n.offsetParent()),i=l(r);i.position="absolute",i.top-=e.top,i.left-=e.left,n.css(i)},t(".a2-insert-in-anchor").parents().each(function(e,i){var n=t(i);/visible|hidden/.test(n.css("overflow"))||n.scroll(c)}),e.$watch(function(){return r.offset()},c,!0),c()}e.$watch(function(){return r.is(":visible")},function(e){n.css("display",e?"block":"none")}),r.on("$destroy",function(){n.remove()})}}}]).directive("a2LineChart",["$window",function(e){var t=e.d3,i=function(e,i){var n={left:30,right:10,top:10,bottom:20},a=function(e){return e.y},r=function(e){return e.x},o=t.min(e,a),s=t.max(e,a),c=t.min(e,r),l=t.max(e,r),u=i.element,d=i.lineColor||"red",p=i.width,f=i.height,h=t.scale.linear().domain([c,l]).range([n.left,p-n.right]),g=t.scale.linear().domain([o,s]).range([f-n.bottom,n.top]),m=t.svg.line().x(function(e){return h(e.x)}).y(function(e){return g(e.y)}).interpolate("linear"),v=t.svg.symbol().type("circle"),y=t.svg.axis().scale(h).ticks(l-c),b=t.svg.axis().scale(g).orient("left").ticks(3),_=u.append("svg").attr("class","graph").attr("height",f).attr("width",p);_.append("g").attr("class","x axis").attr("transform","translate(0,"+(f-n.bottom)+")").call(y),_.append("g").attr("class","y axis").attr("transform","translate("+n.left+",0)").call(b);var x=_.append("g").datum(e),w=x.append("path").attr("stroke",d).attr("stroke-width","2").attr("fill","none").attr("d",m),j=w.node().getTotalLength();w.attr("stroke-dasharray",j).attr("stroke-dashoffset",j).transition().delay(200).duration(1e3).ease("linear").attr("stroke-dashoffset",0).each("end",function(){w.attr("stroke-dasharray",null).attr("stroke-dashoffset",null)}),x.append("g").selectAll("path").data(function(e){return e}).enter().append("path").attr("fill","transparent").attr("transform",function(e){return"translate("+h(e.x)+","+g(e.y)+")scale(0.7,0.7)"}).attr("d",v).attr("fill",d).on("mouseenter",function(e){var i=t.select("body"),n=t.mouse(i.node());i.append("div").datum(e).attr("class","graph-tooltip").style("top",n[1]-10+"px").style("left",n[0]-10+"px").on("mouseleave",function(){i.selectAll(".graph-tooltip").remove()}).append("p").text(Math.round(1e3*e.y)/1e3)})};return{restrict:"E",scope:{values:"=",height:"@",width:"@",color:"@?"},link:function(e,n,a){e.$watch("values",function(){e.values&&i(e.values,{lineColor:e.color,element:t.select(n[0]),width:Number(e.width),height:Number(e.height)})})}}}]).directive("c3ChartDisplay",["$window",function(e){function t(e){return"object"!=typeof e?{columns:e}:e}var i=e.c3,n=function(e,n,a){var r=e.find("div");if(!n||!a)return void r.remove();r.length||(r=angular.element("<div></div>").appendTo(e));var o={bindto:r[0],data:t(n)};return a&&(o.axis=a),i.generate(o)};return{restrict:"E",scope:{data:"=",axes:"="},template:"<span></span>",link:function(e,i,a){var r;e.$watch("axes",function(t,a){r&&t==a||(r=n(i,e.data,e.axes))}),e.$watch("data",function(a,o){r&&a==o?r&&r.load(t(e.data)):r=n(i,e.data,e.axes)})}}}]).directive("a2Info",function(){return{replace:!0,restrict:"E",template:'<i class="text-info fa fa-info-circle"></i>'}}).directive("a2BsNgModelOnDirtySaveButton",["$parse",function(e){return{restrict:"A",require:"ngModel",link:function(t,i,n,a){function r(){i.wrap('<div class="input-group"></div>');var e=i.parent();s=angular.element('<div class="input-group-btn">    <button class="btn btn-primary"><i class="fa fa-save"></i></button></div>'),s.find("button.btn").on("click",function(){c(t,{$name:a.$name,$modelValue:a.$modelValue,$setPristine:function(){a.$setPristine(),o()}})}),s.appendTo(e)}function o(){s&&s.remove(),i.unwrap(),s=void 0}var s,c=e(n.a2BsNgModelOnDirtySaveButton);a.$viewChangeListeners.push(function(){a.$dirty&&!s?r():s&&o()})}}}]).factory("canvasObjectURL",["$window","$q",function(e,t){function n(t){var n=t.indexOf(";base64,")+";base64,".length,a=t.substring(n),r=e.atob(a),o=r.length,s=new e.Uint8Array(new e.ArrayBuffer(o));for(i=0;i<o;i++)s[i]=r.charCodeAt(i);return s.buffer}function a(i){if(i.toBlob)return t(function(e){i.toBlob(e)});var a,r=n(i.toDataURL("image/png"));if(e.BlobBuilder||e.WebKitBlobBuilder){var o=new WebKitBlobBuilder;o.append(r),a=o.getBlob("image/png")}else a=new e.Blob([r],{type:"image/png"});return t.resolve(a)}var r=e.URL.createObjectURL,o=e.URL.revokeObjectURL;return!r&&e.webkitURL.createObjectURL&&(r=e.webkitURL.createObjectURL,o=e.webkitURL.revokeObjectURL),r||(o=function(){}),{create:function(e){return r?a(e).then(function(e){return r(e)}):t.resolve(e.toDataURL("image/png"))},revoke:o}}]).directive("axis",["canvasObjectURL","$q","$debounce",function(e,t,i){function n(e,t,i,n){return JSON.stringify([e,t,i,n])}function a(i,n,a,r,o){if(!n||!a)return t.reject("Empty canvas size");i.width=n,i.height=a;var s,c=o.prec||1,l=(o.range[0]/c|0)*c,u=(o.range[1]/c|0)*c,d=o.unit,p=o.count||1,f=(((u-l)/c|0)/p|0)*c,h=i.getContext("2d"),g=n-1,m=a-1;h.font=o.font,h.strokeStyle=o.color,h.lineWidth=.5,h.clearRect(0,0,n,a);var v,y,b,_={w:0,h:10},x=o.loopCt||250;for(v=l;x>0&&v<u;v+=f,--x){var w=h.measureText(v+d).width;_.w<w&&(_.w=w)}if("h"==r)for(h.textAlign="left",h.textBaseline="top",s=n/(u-l),h.beginPath(),h.moveTo(0,0),h.lineTo(g,0),h.stroke(),x=o.loopCt||250,v=l;x>0&&v<u;v+=f,--x)y=s*(v-l),v>=u-f&&(h.textAlign="right"),h.beginPath(),h.moveTo(y,3),h.lineTo(y,0),h.stroke(),h.strokeText(v+d,y,3);else if("v"==r)for(h.textAlign="right",h.textBaseline="alphabet",s=a/(u-l),h.beginPath(),h.moveTo(g,0),h.lineTo(g,m),h.stroke(),x=o.loopCt||250,v=l;x>0&&v<u;v+=f,--x)b=a-s*(v-l),v>=u-f&&(h.textBaseline="top"),h.beginPath(),h.moveTo(g-3,b),h.lineTo(g,b),h.stroke(),h.strokeText(v+d,_.w,b,g-3-1);return e.create(i)}function r(e,t,i,r,c){var l=n(t,i,r,c),u=o[l];return u||(u=o[l]=a(s,t,i,r,c)),u.then(function(t){e.src=t})}var o={},s=angular.element("<canvas></canvas>")[0];return{restrict:"E",template:"<img />",scope:{type:"@",data:"="},link:function(e,t,n){function a(){return t.width()*t.height()}var o=t.find("img")[0],s=i(function(){r(o,t.width(),t.height(),e.type,e.data)},500);e.$watch(a,s),e.$watch("type",s),e.$watch("data",s)}}}]).filter("consoleLog",function(){return function(e,t){return console[t||"log"](e),e}}).filter("mouseEventContainerPercent",function(){return function(e,t){var i=angular.element(e.currentTarget);t&&(i=i.closest(t));var n=i.offset();return{x:(e.pageX-n.left)/i.width(),y:(e.pageY-n.top)/i.height()}}}).directive("onErrorSrc",function(){return{link:function(e,t,i){t.bind("error",function(){i.src!=i.onErrorSrc&&i.$set("src",i.onErrorSrc)})}}}),angular.module("a2.forms",["templates-arbimon2"]).run(["$window",function(e){var t=function(){var t,i;return i=e.document.createElement("script"),i.src="/includes/zxcvbn/zxcvbn.js",i.type="text/javascript",i.async=!0,t=e.document.getElementsByTagName("script")[0],t.parentNode.insertBefore(i,t)};e.attachEvent?e.attachEvent("onload",t):e.addEventListener("load",t,!1)}]).directive("passwordInput",["$window",function(e){return{restrict:"E",scope:{password:"=ngModel",validation:"=",userInputs:"=?"},templateUrl:"/directives/password-input.html",controller:["$scope",function(t){function i(){return t.validation||(t.validation={confirm:null,result:{},valid:!1,msg:""})}t.requiredScore=2,t.minLength=6,t.maxLength=32,t.validation=i(),t.userInputs||(t.userInputs=[]),t.testConfirm=function(){var e=i();if(e.result.confirm=null,e.result.pass&&t.password)return e.result.pass.score<t.requiredScore?void(t.validation.msg="password need to be stronger"):void(t.password===e.confirm?(e.result.confirm={ok:!0},e.valid=!0,e.msg=""):(e.result.confirm={err:"Passwords do not match"},e.msg=e.result.confirm.err))},t.testPass=function(){var n=i();if(void 0===e.zxcvbn){if(t.waitForZxcvbn)return;return void(t.waitForZxcvbn=$interval(function(){void 0!==e.zxcvbn&&($interval.cancel(t.waitForZxcvbn),t.testPass())},500))}t.waitForZxcvbn&&$interval.cancel(t.waitForZxcvbn),n.result.pass=null;var a=["#da3939","#da3939","#84b522","#62b522","#31b523"],r=["Very Weak","Weak","Average","Strong","Very strong"];if(t.password)if(t.password.length<6||t.password.length>32){var o=t.password.length<6?"short":"long";n.result.pass={shields:[],color:a[0],msg:"Password is too "+o+", 6-32 characters"},t.validation.msg=n.result.pass.msg}else{var s=e.zxcvbn(t.password,t.userInputs);n.result.pass={score:s.score,shields:new Array(s.score+1),color:a[s.score],msg:r[s.score]},t.testConfirm()}}}]}}]).directive("projectForm",function(){return{restrict:"E",scope:{project:"=ngModel",valid:"="},templateUrl:"/directives/project-form.html",controllerAs:"controller",controller:["$scope",function(e){var t=/^[a-z0-9]+([-_][a-z0-9]+)*$/i;this.deriveUrlFromName=!0,this.nameChanged=function(){this.deriveUrlFromName&&(e.project.url=(e.project.name||"").replace(/[^a-z0-9A-Z-]/g,"-").replace(/-+/g,"-").replace(/(^-)|(-$)/g,"").replace(/[A-Z]/g,function(e){return e.toLowerCase()})),e.verify()},this.urlChanged=function(){this.deriveUrlFromName=!1,e.verify()},e.verify=function(){var i=!0;return e.errorName="",e.errorUrl="",e.project.name?e.project.name.length<6&&e.project.name.length>0?(e.errorName="Name too short, 6 or more characters required",i=!1):e.project.name.length>50&&(e.errorName="Name too long, 50 characters max",i=!1):i=!1,e.project.url?t.test(e.project.url)?e.project.url.length<6?(e.errorUrl="URL too short, 6 or more alphanumeric characters separated by dash(-) or underscore(_)",i=!1):e.project.url.length>50&&(e.errorUrl="URL too long, 50 characters max",i=!1):(e.errorUrl="Invalid project URL alphanumeric characters separated by dash(-) or underscore(_)",i=!1):i=!1,e.valid=i,i},e.project?e.verify():(e.project={is_private:1},e.valid=!1),e.$watch("project",function(){e.verify()})}]}}),angular.module("a2.qr-js",[]).directive("a2QrCode",["$window",function(e){var t=e.qr,i=e.$;return{restrict:"E",scope:{data:"@"},link:function(e,n,a){var r=i("<canvas></canvas>").appendTo(n);a.$observe("data",function(e){t.canvas({canvas:r[0],size:10,level:"Q",value:e})})}}}]),angular.module("c3-charts",[]).directive("c3Chart",["$window",function(e){return{restrict:"E",scope:{columns:"="},link:function(t,i,n){console.log("corri"),e.chart=t.chart=e.c3.generate({bindto:i[0],size:{width:n.width,height:n.height},tooltip:{show:!1},data:{columns:t.columns||[],type:n.type}}),t.$watch("columns",function(){t.columns&&t.chart.load({columns:t.columns||[]})})}}}]),angular.module("a2.directive.error-message",[]).directive("errorMessage",["$http","$window",function(e,t){var i="";return{templateUrl:"/directives/error-message.html",restrict:"E",replace:!0,scope:{message:"="},link:function(e){i=e.message}}}]),angular.module("a2.directive.frequency_filter_range_control",[]).directive("a2VisualizerFrequencyFilterRangeControl",function(){return{restrict:"E",templateUrl:"/directives/frequency_filter_range_control.html",scope:{imgSrc:"=",filterMin:"=",filterMax:"=",maxFreq:"="},link:function(e,t,i){"use strict";function n(e){o=void 0,angular.element(document).off("mousemove",r)}function a(e){1==(void 0===e.buttons?e.which:e.buttons)&&(o=e.target,angular.element(document).on("mousemove",r))}function r(t){if(o){var i=/bottom|top/.exec(o.className);if(i){var n=s.offset(),a=t.pageY-n.top,r=e.maxFreq*Math.max(0,Math.min(1-a/o.parentNode.clientHeight,1));r=100*(r/100|0);var c="top"==i[0]?"filterMax":"filterMin";e[c]=r,e.filterMin>e.filterMax&&(e.filterMax=r,e.filterMin=r),e.$apply()}}}var o,s=t.find(".a2-audio-freq-filter-component");s.find("button").on("mousedown",a),s.on("mousemove",function(e){}),angular.element(document).on("mouseup",n),t.on("$destroy",function(){angular.element(document).off("mouseup",n),angular.element(document).off("mousemove",r)})}}}),angular.module("g-recaptcha",[]).directive("gRecaptcha",["$interval","$timeout","$window",function(e,t,i){return{restrict:"A",scope:{sitekey:"@",theme:"@?",type:"@?",response:"=",resetWidget:"=?"},link:function(n,a,r){var o=e(function(){if(void 0!==i.grecaptcha){e.cancel(o);var r=i.grecaptcha;n.widgetId=r.render(a[0],{sitekey:n.sitekey,theme:n.theme,type:n.type,callback:function(e){n.response=e,n.$apply(),n.resetTimeout=t(function(){r.reset(n.widgetId)},3e4)}}),n.resetWidget=function(){n.resetTimeout&&t.cancel(n.resetTimeout),r.reset(n.widgetId)}}},500)}}}]),angular.module("a2.directive.news-feed-item",["a2.srv.news","templates-arbimon2","a2.directive.a2-tags","a2.filter.time-from-now"]).directive("newsFeedItem",["a2NewsService","$compile",function(e,t){function i(e){for(var t,i,n,a=/%\((\w+)\)s/g,r=[],o=0;t=a.exec(e);)i=o,n=a.lastIndex-t[0].length,i<n&&r.push(e.substr(i,n-i)),r.push("<span a2-tag-"+t[1]+'="news.data.'+t[1]+'" ></span>'),o=a.lastIndex;return o<e.length&&r.push(e.substr(o)),"<span>"+r.join("")+"</span>"}var n=e.loadFormats().then(function(e){return Object.keys(e).reduce(function(t,n){return t[n]=i(e[n]),t},{})});return{restrict:"EAC",scope:{news:"=newsFeedItem"},templateUrl:"/directives/news-feed-item.html",link:function(e,i,a){var r=i.find(".message");e.$watch("news",function(i){n.then(function(n){r.empty().append(t(n[i.type])(e))})})}}}]),angular.module("a2.directive.plotly-plotter",["a2.directive.on-resize","a2.service.plotly-defaults","a2.service.plotly-plot-maker"]).directive("plotlyPlotter",["$window","a2OnResizeService","PlotlyDefaults","plotlyPlotMaker",function(e,t,i,n){return{restrict:"E",scope:{layout:"=?",data:"=?"},link:function(e,a,r){function o(e){return n.mergeData(e,i)}function s(e){return n.mergeLayout(e,i)}Plotly.newPlot(a[0],o(e.data),s(e.layout),i.config);var c=t.newWatcher(a,function(e){Plotly.relayout(a[0],e)});r.layout&&e.$watch("layout",function(e,t){e&&e!=t&&Plotly.relayout(a[0],s(e))}),r.data&&e.$watch("data",function(t,n){t&&t!=n&&(console.log("Plotly plot data ::",t,e.layout),Plotly.newPlot(a[0],o(e.data),s(e.layout),i.config))}),e.$on("$destroy",function(){c.destroy()})}}}]),angular.module("a2.directive.search-bar",[]).directive("searchBar",["$http","$window",function(e,t){var i=[];return{templateUrl:"/directives/search-bar.html",restrict:"E",scope:{projectsLoading:"=?",q:"=?",isUnsafe:"@"},link:function(n){n.q="",n.projectsLoading=void 0,n.projects=i,n.findProject=function(){var t={params:{publicTemplates:!0}};return""!==n.q&&(t.params.q=n.q),n.projectsLoading=!0,e.get("/api/user/projectlist",t).then(function(e){
return n.projectsLoading=!1,n.projects=e.data,e.data})},n.selectProject=function(){!n.q||n.q&&!n.q.is_enabled||t.location.assign("/project/"+n.q.url+"/")}}}}]),angular.module("arbimon2.directive.validation-dropdown",[]).directive("validationDropdown",function(){var e={label:void 0,val:void 0},t=[{label:"Clear",val:2},{label:"Present",val:1},{label:"Absent",val:0}],i=t.reduce(function(e,t){return e[t.val]=t,e},{});return{templateUrl:"/directives/validation-dropdown.html",require:"ngModel",scope:{},link:function(n,a,r,o){function s(t){var a=t<2&&i[t]?i[t]:e;n.val=a.val,n.label=a.label}n.options=t,n.select=function(e){s(e),o.$$lastCommittedViewValue=void 0,o.$modelValue=void 0,o.$setViewValue(e,!0)},o.$render=function(){s(o.$viewValue)}}}}),angular.module("a2.directive.warning-banner",[]).directive("warningBanner",["$http","$window",function(e,t){var i=0;return{templateUrl:"/directives/warning-banner.html",restrict:"E",replace:!0,scope:{message:"="},link:function(e){i=e.message}}}]),angular.module("a2.googlemaps",[]).provider("a2GoogleMapsLoader",function(){function e(e,n){if(t){for(var a="gmcb";e[a];)a+="_";e[a]=function(){t.resolve(e.google)};var r=e.document.createElement("script"),o=["callback="+a];i&&o.push("key="+i),r.src=e.document.location.protocol+"//maps.googleapis.com/maps/api/js?"+o.join("&"),e.document.body.appendChild(r)}}var t,i;return{setAPIKey:function(e){i=e},$get:["$window","$q",function(i,n){return t||(t=n.defer(),e(i,n)),t.promise}]}}),angular.module("a2.heremaps",[]).constant("a2HereMarkerTextIconTemplate",'<div class="map-marker"><svg xmlns="http://www.w3.org/2000/svg" width="28px" height="36px"><path d="M 19 31 C 19 32.7 16.3 34 13 34 C 9.7 34 7 32.7 7 31 C 7 29.3 9.7 28 13 28 C 16.3 28 19 29.3 19 31 Z" fill="#000" fill-opacity=".2"/><path d="M 13 0 C 9.5 0 6.3 1.3 3.8 3.8 C 1.4 7.8 0 9.4 0 12.8 C 0 16.3 1.4 19.5 3.8 21.9 L 13 31 L 22.2 21.9 C 24.6 19.5 25.9 16.3 25.9 12.8 C 25.9 9.4 24.6 6.1 22.1 3.8 C 19.7 1.3 16.5 0 13 0 Z" fill="#fff"/><path d="M 13 2.2 C 6 2.2 2.3 7.2 2.1 12.8 C 2.1 16.1 3.1 18.4 5.2 20.5 L 13 28.2 L 20.8 20.5 C 22.9 18.4 23.8 16.2 23.8 12.8 C 23.6 7.07 20 2.2 13 2.2 Z" fill="#18d"/></svg><span>${text}</span></div>').provider("a2HereMapsLoader",["a2HereMarkerTextIconTemplate",function(e){function t(t,i){function r(e){return i(function(i,n){var a=t.document.createElement("script");a.src=t.document.location.protocol+e,a.addEventListener("load",i),a.addEventListener("error",n),t.document.body.appendChild(a)})}return r("//js.api.here.com/v3/3.0/mapsjs-core.js").then(function(){return i.all([r("//js.api.here.com/v3/3.0/mapsjs-service.js"),r("//js.api.here.com/v3/3.0/mapsjs-ui.js"),r("//js.api.here.com/v3/3.0/mapsjs-mapevents.js")])}).then(function(){var i=t.H;return{api:i,makeTextIcon:function(t){return new H.map.DomIcon(e.replace("${text}",t))},platform:new i.service.Platform({app_id:n,app_code:a,useHTTPS:/https/.test(t.document.location.protocol)})}})}var i,n,a;return{setAPIIdAndCode:function(e,t){n=e,a=t},$get:["$window","$q",function(e,n){return i||(i=t(e,n)),i}]}}]),angular.module("a2.permissions",["a2.services","ng-permissions"]).run(["$rootScope","a2UserPermit",function(e,t){e.userPermit=t}]).service("a2UserPermit",["$http","Project","$q","permits",function(e,t,i,n){var a=n;return{all:a.permissions,isSuper:function(){return a.super},isRfcx:function(){return a.rfcxUser},isAuthorized:function(){return a.isAuthorized},isProjectMember:function(){return a.isAuthorized&&(a.permissions&&a.permissions.length>0||a.super||a.rfcxUser)},getUserEmail:function(){return a.userEmail},has:function(e){return a.features&&a.features[e]},can:function(e){var t;return a.permissions&&(t=(Array.isArray(e)?e:[e]).reduce(function(e,t){return e&&-1!==a.permissions.indexOf(t)},!0)),t||a.super}}}]),angular.module("a2.utils-browser-metrics",[]).service("a2BrowserMetrics",function(){var e={},t={border:"none",height:"200px",margin:"0",padding:"0",width:"200px"},i=$("<div>").css($.extend({},t)),n=$("<div>").css($.extend({left:"-1000px",overflow:"scroll",position:"absolute",top:"-1000px"},t)).append(i).appendTo("body").scrollLeft(1e3).scrollTop(1e3);return e.scrollSize={height:n.offset().top-i.offset().top|0,width:n.offset().left-i.offset().left|0},n.remove(),e}),angular.module("a2.utils",["a2.utils-browser-metrics"]).factory("$templateFetch",["$http","$templateCache",function(e,t){return function(i,n){var a=t.get(i);if(a)a.promise?a.linkers.push(n):n(a);else{var r={linkers:[n],promise:e.get(i).success(function(e){t.put(i,e);for(var n=0,a=r.linkers,o=a.length;n<o;++n)a[n](e)})};t.put(i,r)}}}]).factory("a2EventEmitter",["$q",function(e){function t(){this.list={}}return t.prototype={on:function(e,t){return(this.list[e]||(this.list[e]=[])).push(t),t},off:function(e,t){var i=this.list[e];if(i){var n=i.indexOf(t);n&&i.splice(n,1)}},emit:function(t){var i=Array.prototype.slice.call(arguments,1),n=this.list[t];if(n)for(var a=0,r=n.length;a<r;++a)n[a].apply(null,i);return e.resolve()}},t}]).factory("itemSelection",function(){return{make:function(e){var t={};return void 0===e&&(e="value"),t[e]=null,t.select=function(i){t[e]=i},t}}}).filter("moment",function(){return function(e,t){if(e)return moment(e).format(t)}}).filter("momentUtc",function(){return function(e,t){if(e)return moment(e).utc().format(t)}}).filter("momentTz",function(){return function(e,t,i){if(e)return moment.tz(e,i).format(t)}}).filter("paginate",function(){return function(e,t,i){if(e)return e.slice((t-1)*i,t*i)}}).filter("plural",function(){return function(e,t){if(e)return e+"s"}}).filter("worded",function(){return function(e,t){if(e)return(""+e).replace(/[_-]/g," ")}}).filter("wordCaps",function(){return function(e,t){if(e)return(""+e).replace(/\b(\w)/g,function(e){return e.toUpperCase()})}}).factory("$debounce",["$timeout","$q","$log",function(e,t,i){return function(i,n){var a,r,o;return n=n||100,function(){var s=this,c=Array.prototype.slice.call(arguments);return a&&e.cancel(a),r||(r=t.defer(),o=r.promise.then(function(){return r=null,i.apply(s,c)})),a=e(function(){r.resolve()},n),o}}}]).factory("a2LookaheadHelper",["$q",function(e){var t=function(e){this.options=e||{},e.searchCompare||(e.searchCompare=function(e,t){return e==t})};return t.prototype={search:function(t){var i=this.options;if(i.minLength&&t.length<i.minLength)return e.resolve([]);var n=i.fn(t);return i.includeSearch&&(n=n.then(function(e){return e.filter(function(e){return i.searchCompare(t,e)}).pop()||e.unshift(i.searchPromote?i.searchPromote(t):t),e})),n}},t}]).service("EventlistManager",function(){var e=function(){this.events={}};return e.prototype.get_event_def=function(e){return this.events[e]||(this.events[e]={}),this.events[e]},e.prototype.send=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();"string"==typeof t&&(t={event:t});var i=this.get_event_def(t.event);t.oneTime&&(i.oneTime=!0);var n=t.context,a=i.listeners;i.fired=!0,a&&a.forEach(function(t){t.apply(n,e)})},e.prototype.on=function(e,t){var i=this.get_event_def(e);i.fired&&i.oneTime?t.apply():(i.listeners||(i.listeners=[]),i.listeners.push(t))},e}),angular.module("a2.infotags",["a2.services"]).directive("a2Species",["Species","$timeout",function(e,t){return{restrict:"E",scope:{species:"="},template:"{{data.scientific_name}}",link:function(i,n,a){i.$watch("species",function(n,a){i.data=null,n&&e.findById(n,function(e){t(function(){i.data=e})})})}}}]).directive("a2.songtype",["Songtypes","$timeout",function(e,t){return{restrict:"E",scope:{songtype:"="},template:"{{data.name}}",link:function(i,n,a){i.$watch("songtype",function(n,a){i.data=null,n&&e.findById(n,function(e){t(function(){i.data=e})})})}}}]),angular.module("a2.classy",[]).factory("makeClass",["$inheritFrom",function(e){var t=Array.prototype.slice;return function(i){return i.constructor||(i.constructor=i.super&&i.super.constructor?function(){this.super.constructor.apply(this,t.call(arguments))}:function(){}),i.static&&(angular.extend(i.constructor,i.static),delete i.static),i.super&&(i=e(i.super,i)),i.constructor.prototype=i,(window.qc||(window.qc=[])).push(i),i.constructor}}]).value("$inheritFrom",function(e){var t=function(){};if(t.prototype=e,arguments.length>1){var i=Array.prototype.slice.call(arguments);return i[0]=new t,angular.extend.apply(angular,i)}return new t}),angular.module("a2.srv.app-listings",["a2.srv.api"]).service("AppListingsService",["a2APIService",function(e){return{getFor:function(t){return e.api.get("/app-listings/"+t)}}}]),angular.module("a2.service.colorscale-gradients",[]).service("ColorscaleGradients",function(){for(var e=[],t=0;t<256;++t){var i=255-t;e.push("rgb("+i+","+i+","+i+")")}var n={gradients:[["#4400e5","#4000e5","#3c00e5","#3700e5","#3300e5","#2f00e5","#2a00e5","#2600e5","#2200e5","#1d00e5","#1900e5","#1500e5","#1100e5","#0c00e5","#0800e5","#0400e5","#0000e5","#0004e5","#0008e5","#000de5","#0011e5","#0015e5","#001ae5","#001ee5","#0022e5","#0027e5","#002be5","#002fe5","#0034e5","#0038e5","#003ce5","#0041e5","#0045e5","#0049e5","#004ee5","#0052e5","#0056e5","#005ae5","#005fe5","#0063e5","#0067e5","#006ce5","#0070e5","#0074e5","#0079e5","#007de5","#0081e5","#0086e5","#008ae5","#008ee5","#0093e5","#0097e5","#009be5","#00a0e5","#00a4e5","#00a8e5","#00ade5","#00b1e5","#00b5e5","#00bae5","#00bee5","#00c2e5","#00c6e5","#00cbe5","#00e543","#00e53f","#00e53b","#00e536","#00e532","#00e52e","#00e529","#00e525","#00e521","#00e51c","#00e518","#00e514","#00e50f","#00e50b","#00e507","#00e502","#01e500","#05e500","#09e500","#0ee500","#12e500","#16e500","#1be500","#1fe500","#23e500","#28e500","#2ce500","#30e500","#35e500","#39e500","#3de500","#42e500","#46e500","#4ae500","#4fe500","#53e500","#57e500","#5ce500","#60e500","#64e500","#69e500","#6de500","#71e500","#75e500","#7ae500","#7ee500","#82e500","#87e500","#8be500","#8fe500","#94e500","#98e500","#9ce500","#a1e500","#a5e500","#a9e500","#aee500","#b2e500","#b6e500","#bbe500","#bfe500","#c3e500","#c8e500","#cce500","#e5e401","#e5e303","#e5e106","#e5e008","#e5df0b","#e5de0d","#e5dc10","#e5db12","#e5da15","#e5d917","#e5d81a","#e5d71c","#e5d51f","#e5d422","#e5d324","#e5d227","#e5d229","#e5d12c","#e5d02e","#e5cf31","#e5ce33","#e5cd36","#e5cd38","#e5cc3b","#e5cb3d","#e5cb40","#e5ca42","#e5c945","#e5c947","#e5c84a","#e5c84c","#e5c74f","#e5c751","#e5c754","#e5c656","#e5c659","#e5c65b","#e5c55e","#e5c561","#e5c563","#e5c566","#e5c468","#e5c46b","#e5c46d","#e5c470","#e5c472","#e5c475","#e5c477","#e5c47a","#e5c47c","#e5c57f","#e5c581","#e5c584","#e5c586","#e5c589","#e5c68b","#e5c68e","#e5c690","#e5c793","#e5c795","#e5c898","#e5c89a","#e5c99d","#e5c9a0","#916225","#926328","#93652a","#95672c","#96682f","#986a31","#996c33","#9a6d36","#9c6f38","#9d713a","#9f723d","#a0743f","#a27641","#a37744","#a47946","#a67a48","#a77c4b","#a97e4d","#aa7f4f","#ab8152","#ad8354","#ae8456","#b08659","#b1885b","#b2895d","#b48b60","#b58d62","#b78e64","#b89067","#ba9269","#bb936b","#bc956e","#be9670","#bf9872","#c19a75","#c29b77","#c39d79","#c59f7c","#c6a07e","#c8a280","#c9a483","#caa585","#cca787","#cda98a","#cfaa8c","#d0ac8e","#d2ad91","#d3af93","#d4b195","#d6b298","#d7b49a","#d9b69c","#dab79f","#dbb9a1","#ddbba3","#debca6","#e0bea8","#e1c0aa","#e2c1ad","#e4c3af","#e5c5b1","#e7c6b4","#e8c8b6","#eacab9"],["#ffffff","#fefefe","#fdfdfd","#fcfcfc","#fbfbfb","#fafafa","#f9f9f9","#f8f8f8","#f7f7f7","#f6f6f6","#f5f5f5","#f4f4f4","#f3f3f3","#f2f2f2","#f1f1f1","#f0f0f0","#efefef","#eeeeee","#ededed","#ececec","#ebebeb","#eaeaea","#e9e9e9","#e8e8e8","#e7e7e7","#e6e6e6","#e5e5e5","#e4e4e4","#e3e3e3","#e2e2e2","#e1e1e1","#e0e0e0","#dfdfdf","#dedede","#dddddd","#dcdcdc","#dbdbdb","#dadada","#d9d9d9","#d8d8d8","#d7d7d7","#d6d6d6","#d5d5d5","#d4d4d4","#d3d3d3","#d2d2d2","#d1d1d1","#d0d0d0","#cfcfcf","#cecece","#cdcdcd","#cccccc","#cbcbcb","#cacaca","#c9c9c9","#c8c8c8","#c7c7c7","#c6c6c6","#c5c5c5","#c4c4c4","#c3c3c3","#c2c2c2","#c1c1c1","#c0c0c0","#bfbfbf","#bebebe","#bdbdbd","#bcbcbc","#bbbbbb","#bababa","#b9b9b9","#b8b8b8","#b7b7b7","#b6b6b6","#b5b5b5","#b4b4b4","#b3b3b3","#b2b2b2","#b1b1b1","#b0b0b0","#afafaf","#aeaeae","#adadad","#acacac","#ababab","#aaaaaa","#a9a9a9","#a8a8a8","#a7a7a7","#a6a6a6","#a5a5a5","#a4a4a4","#a3a3a3","#a2a2a2","#a1a1a1","#a0a0a0","#9f9f9f","#9e9e9e","#9d9d9d","#9c9c9c","#9b9b9b","#9a9a9a","#999999","#989898","#979797","#969696","#959595","#949494","#939393","#929292","#919191","#909090","#8f8f8f","#8e8e8e","#8d8d8d","#8c8c8c","#8b8b8b","#8a8a8a","#898989","#888888","#878787","#868686","#858585","#848484","#838383","#828282","#818181","#808080","#7f7f7f","#7e7e7e","#7d7d7d","#7c7c7c","#7b7b7b","#7a7a7a","#797979","#787878","#777777","#767676","#757575","#747474","#737373","#727272","#717171","#707070","#6f6f6f","#6e6e6e","#6d6d6d","#6c6c6c","#6b6b6b","#6a6a6a","#696969","#686868","#676767","#666666","#656565","#646464","#636363","#626262","#616161","#606060","#5f5f5f","#5e5e5e","#5d5d5d","#5c5c5c","#5b5b5b","#5a5a5a","#595959","#585858","#575757","#565656","#555555","#545454","#535353","#525252","#515151","#505050","#4f4f4f","#4e4e4e","#4d4d4d","#4c4c4c","#4b4b4b","#4a4a4a","#494949","#484848","#474747","#464646","#454545","#444444","#434343","#424242","#414141","#404040","#3f3f3f","#3e3e3e","#3d3d3d","#3c3c3c","#3b3b3b","#3a3a3a","#393939","#383838","#373737","#363636","#353535","#343434","#333333","#323232","#313131","#303030","#2f2f2f","#2e2e2e","#2d2d2d","#2c2c2c","#2b2b2b","#2a2a2a","#292929","#282828","#272727","#262626","#252525","#242424","#232323","#222222","#212121","#202020","#1f1f1f","#1e1e1e","#1d1d1d","#1c1c1c","#1b1b1b","#1a1a1a","#191919","#181818","#171717","#161616","#151515","#141414","#131313","#121212","#111111","#101010","#0f0f0f","#0e0e0e","#0d0d0d","#0c0c0c","#0b0b0b","#0a0a0a","#090909","#080808","#070707","#060606","#050505","#040404","#030303","#020202","#010101","#000000"],["#0a0000","#0d0000","#0f0000","#120000","#150000","#170000","#1a0000","#1c0000","#1f0000","#220000","#240000","#270000","#2a0000","#2c0000","#2f0000","#310000","#340000","#370000","#390000","#3c0000","#3f0000","#410000","#440000","#460000","#490000","#4c0000","#4e0000","#510000","#540000","#560000","#590000","#5b0000","#5e0000","#610000","#630000","#660000","#690000","#6b0000","#6e0000","#700000","#730000","#760000","#780000","#7b0000","#7e0000","#800000","#830000","#850000","#880000","#8b0000","#8d0000","#900000","#930000","#950000","#980000","#9a0000","#9d0000","#a00000","#a20000","#a50000","#a80000","#aa0000","#ad0000","#af0000","#b20000","#b50000","#b70000","#ba0000","#bd0000","#bf0000","#c20000","#c40000","#c70000","#ca0000","#cc0000","#cf0000","#d20000","#d40000","#d70000","#d90000","#dc0000","#df0000","#e10000","#e40000","#e70000","#e90000","#ec0000","#ee0000","#f10000","#f40000","#f60000","#f90000","#fc0000","#fe0000","#ff0200","#ff0500","#ff0700","#ff0a00","#ff0c00","#ff0f00","#ff1200","#ff1400","#ff1700","#ff1a00","#ff1c00","#ff1f00","#ff2100","#ff2400","#ff2700","#ff2900","#ff2c00","#ff2f00","#ff3100","#ff3400","#ff3600","#ff3900","#ff3c00","#ff3e00","#ff4100","#ff4400","#ff4600","#ff4900","#ff4b00","#ff4e00","#ff5100","#ff5300","#ff5600","#ff5900","#ff5b00","#ff5e00","#ff6000","#ff6300","#ff6600","#ff6800","#ff6b00","#ff6e00","#ff7000","#ff7300","#ff7500","#ff7800","#ff7b00","#ff7d00","#ff8000","#ff8300","#ff8500","#ff8800","#ff8a00","#ff8d00","#ff9000","#ff9200","#ff9500","#ff9700","#ff9a00","#ff9d00","#ff9f00","#ffa200","#ffa500","#ffa700","#ffaa00","#ffac00","#ffaf00","#ffb200","#ffb400","#ffb700","#ffba00","#ffbc00","#ffbf00","#ffc100","#ffc400","#ffc700","#ffc900","#ffcc00","#ffcf00","#ffd100","#ffd400","#ffd600","#ffd900","#ffdc00","#ffde00","#ffe100","#ffe400","#ffe600","#ffe900","#ffeb00","#ffee00","#fff100","#fff300","#fff600","#fff900","#fffb00","#fffe00","#ffff02","#ffff06","#ffff0a","#ffff0e","#ffff12","#ffff16","#ffff1a","#ffff1e","#ffff22","#ffff26","#ffff2a","#ffff2e","#ffff32","#ffff36","#ffff3a","#ffff3e","#ffff41","#ffff45","#ffff49","#ffff4d","#ffff51","#ffff55","#ffff59","#ffff5d","#ffff61","#ffff65","#ffff69","#ffff6d","#ffff71","#ffff75","#ffff79","#ffff7d","#ffff80","#ffff84","#ffff88","#ffff8c","#ffff90","#ffff94","#ffff98","#ffff9c","#ffffa0","#ffffa4","#ffffa8","#ffffac","#ffffb0","#ffffb4","#ffffb8","#ffffbc","#ffffbf","#ffffc3","#ffffc7","#ffffcb","#ffffcf","#ffffd3","#ffffd7","#ffffdb","#ffffdf","#ffffe3","#ffffe7","#ffffeb","#ffffef","#fffff3","#fffff7","#fffffb","#ffffff"],["#000000","#120102","#240204","#360306","#490408","#5b050a","#6d060c","#7f070e","#920810","#a40912","#b60a14","#c90b16","#db0c18","#ed0d1a","#fe0e1c","#f90f1e","#f41020","#ef1122","#ea1224","#e51326","#e01428","#db152a","#d6162c","#d1172e","#cc1830","#c71932","#c21a34","#bd1b36","#b81c38","#b41d3a","#af1e3c","#aa1f3e","#a52040","#a02041","#9b2244","#962346","#912448","#8c2449","#87264c","#82274e","#7d2850","#782851","#732a54","#6e2b56","#692c58","#642c59","#5f2e5c","#5a2f5e","#553060","#503061","#4b3264","#463366","#413468","#3c3469","#37366c","#32376e","#2d3870","#283871","#233a74","#1e3b76","#193c78","#143c79","#0f3e7c","#0a3f7e","#404080","#414182","#414183","#434386","#444488","#45458a","#46468c","#47478e","#484890","#494992","#494993","#4b4b96","#4c4c98","#4d4d9a","#4e4e9c","#4f4f9e","#5050a0","#5151a2","#5151a3","#5353a6","#5454a8","#5555aa","#5656ac","#5757ae","#5858b0","#5959b2","#5959b3","#5b5bb6","#5c5cb8","#5d5dba","#5e5ebc","#5f5fbe","#6060c0","#6161c2","#6161c3","#6363c6","#6464c8","#6565ca","#6666cc","#6767ce","#6868d0","#6969d2","#6969d3","#6b6bd6","#6c6cd8","#6d6dda","#6e6edc","#6f6fde","#7070e0","#7171e2","#7171e3","#7373e6","#7474e8","#7575ea","#7676ec","#7777ee","#7878f0","#7979f2","#7979f3","#7b7bf6","#7c7cf8","#7d7dfa","#7e7efc","#7f7ffe","#8080fc","#8181f8","#8282f4","#8383f0","#8383eb","#8485e7","#8686e3","#8787df","#8888da","#8989d6","#8a8ad2","#8b8bce","#8c8cc9","#8d8dc5","#8e8ec1","#8f8fbd","#9090b8","#9191b4","#9292b0","#9393ac","#9393a7","#9595a3","#96969f","#97979a","#989896","#999992","#9a9a8e","#9b9b89","#9c9c85","#9d9d81","#9e9e7d","#9f9f78","#a0a074","#a1a170","#a2a26c","#a3a367","#a3a363","#a5a55f","#a6a65b","#a7a756","#a8a852","#a9a94e","#aaaa4a","#abab45","#acac41","#adad3d","#aeae39","#afaf34","#b0b030","#b1b12c","#b2b228","#b3b323","#b3b31f","#b5b51b","#b6b617","#b7b712","#b8b80e","#b9b90a","#baba06","#bbbb01","#bcbc02","#bdbd05","#bebe09","#bfbf0d","#c0c011","#c1c115","#c2c218","#c3c31c","#c3c320","#c4c524","#c5c627","#c7c72b","#c8c82f","#c9c933","#caca37","#cbcb3a","#cbcc3e","#cdcd42","#cece46","#cfcf49","#d0d04d","#d1d151","#d2d255","#d3d358","#d3d35c","#d5d560","#d6d664","#d7d768","#d8d86b","#d9d96f","#dada73","#dbdb77","#dcdc7a","#dddd7e","#dede82","#dfdf86","#e0e08a","#e1e18d","#e2e291","#e3e395","#e3e399","#e5e59c","#e6e6a0","#e7e7a4","#e8e8a8","#e9e9ab","#eaeaaf","#ebebb3","#ececb7","#ededbb","#eeeebe","#efefc2","#f0f0c6","#f1f1ca","#f2f2cd","#f3f3d1","#f3f3d5","#f4f5d9","#f5f6dd","#f7f7e0","#f8f8e4","#f9f9e8","#fafaec","#fbfbef","#fbfcf3","#fdfdf7","#fefefb","#ffffff"],["#000080","#000776","#000e6d","#001563","#001d5a","#002450","#002b47","#00333e","#003a34","#00412b","#004821","#005018","#00570f","#005e05","#005816","#005126","#004a37","#004348","#003d58","#003669","#002f79","#00288a","#00219b","#001bab","#0014bc","#000dcd","#0006dd","#0000ee","#000eff","#001cff","#002aff","#0038ff","#0046ff","#0054ff","#0062ff","#0070ff","#007fff","#008dff","#009bff","#00a9ff","#00b7ff","#00c0ff","#00c5ff","#00caff","#00ceff","#00d2ff","#00d7ff","#00dbff","#00e0ff","#00e4ff","#00e8ff","#00edff","#00f1fe","#00f6f8","#00faf1","#00feeb","#00fee4","#00fede","#00fdd7","#00fdd1","#00fcca","#00fcc3","#00fbbd","#00fbb6","#00fab0","#00faa9","#00faa3","#00fa9c","#00fa92","#00fa87","#00fa7d","#00fa72","#00fb68","#00fb5d","#00fc53","#00fc49","#00fc3e","#00fd34","#00fd29","#00fe1f","#06fe14","#0cfe0a","#13fb00","#19f700","#1ff300","#26ef00","#2cec00","#32e800","#39e400","#3fe000","#46dd00","#4cd900","#52d500","#59d100","#5fce00","#65d100","#67d400","#69d700","#6bdb00","#6dde00","#6fe100","#71e400","#73e800","#75eb00","#77ee00","#79f100","#7bf500","#7df803","#7ffb07","#84fe0b","#88ff0f","#8dff13","#91ff17","#96ff1b","#9aff1f","#9fff23","#a4ff27","#a8ff2b","#adff2f","#b1ff33","#b6ff37","#baff3b","#bfff37","#c3ff33","#c8ff2f","#ccff2b","#d1ff27","#d6ff23","#daff1f","#dfff1b","#e3ff17","#e8ff13","#ecff0f","#f1ff0b","#f5fc07","#fafa03","#fff700","#fff500","#fff200","#fff000","#ffed00","#ffeb00","#ffe800","#ffe600","#ffe300","#ffe100","#ffde00","#ffdc00","#ffda00","#ffd701","#ffd502","#ffd203","#ffd004","#ffcd05","#ffcb06","#ffc807","#ffc608","#ffc309","#ffc10a","#ffbe0b","#ffbc0c","#ffb90d","#ffb10d","#ffa90c","#ffa10b","#ff990a","#ff9109","#ff8808","#ff8007","#ff7806","#ff7005","#ff6804","#ff5f03","#ff5702","#ff4f01","#ff4700","#ff4200","#ff3d00","#ff3900","#ff3400","#ff2f00","#ff2a00","#ff2600","#ff2100","#ff1c00","#ff1700","#ff1300","#ff0e00","#ff0900","#ff0411","#ff0023","#ff0035","#ff0046","#ff0058","#ff006a","#ff007b","#ff008d","#ff009f","#ff00b1","#ff00c2","#ff00d4","#ff00e6","#ff00f8","#f803fb","#f106ff","#ea0aff","#e30dff","#dc11ff","#d514ff","#ce18ff","#c71bff","#c11eff","#ba22ff","#b325ff","#ac29ff","#a52cfe","#9e32fd","#a438fc","#aa3efb","#b044fa","#b64af8","#bc50f7","#c256f6","#c75cf5","#cd61f4","#d367f2","#d96df1","#df73f0","#e579ef","#eb7fee","#ec84ee","#ec88ef","#ed8df0","#ee92f0","#ef96f1","#ef9bf1","#f09ff2","#f1a4f3","#f1a9f3","#f2adf4","#f3b2f4","#f4b7f5","#f4bbf6","#f5c0f6","#f6c5f7","#f6c9f7","#f7cef8","#f8d2f9","#f9d7f9","#f9dcfa","#fae0fa","#fbe5fb","#fbeafc","#fceefc","#fdf3fd","#fef7fe"]],normalize:function(e){var t=n.gradients[e],i=t.length-1;return t.map(function(e,t){return[t/i,e]})}};return n}),angular.module("countries-list",[]).service("countries",["$http",function(e){var t;return{get:function(i){if(t)return i(t);e.get("/api/orders/countries").success(function(e){t=e,i(t)})}}}]),angular.module("humane",[]).factory("notify",["$window",function(e){var t=e.humane;return t.timeout=6e3,t.baseCls="humane-original",t.error=t.spawn({addnCls:t.baseCls+"-error"}),t.info=t.spawn({addnCls:t.baseCls+"-info"}),t.success=t.spawn({addnCls:t.baseCls+"-success"}),t.serverError=function(){t.error("Error communicating with server")},t}]),angular.module("a2.service.plotly-plot-maker",[]).service("plotlyPlotMaker",function(){var e={range:function(e,t,i){for(var n=[],a=0,r=e;a<t;++a,r+=i)n.push(r);return n},mergeData:function(e,t){return(e||[]).map(function(e){return angular.merge(angular.copy(t[e.type]||{}),e)})},mergeLayout:function(e,t){return angular.merge(angular.copy(t.layout),e)},makeHeatmapPlot:function(t,i,n,a,r){var o={data:{type:"heatmap",hoverinfo:"x+y+z",colorbar:{title:n.title}},layout:{title:r,xaxis:{boundsmode:"auto",title:t.title,ticksuffix:t.units||""},yaxis:{boundsmode:"auto",title:i.title,ticksuffix:i.units||""}}};return a.rows?(o.data.x=a.rows.map(function(e){return a.x.min+a.x.step*e.x}),o.data.y=a.rows.map(function(e){return a.y.min+a.y.step*e.y}),o.data.z=a.rows.map(function(e){return e.z})):a.matrix&&(o.data.x=e.range(a.x.min,a.x.bins,a.x.step),o.data.y=e.range(a.y.min,a.y.bins,a.y.step),o.data.z=a.matrix),o},makeBarPlot:function(t,i,n,a){var r={data:{orientation:"v",type:"bar"},layout:{title:a,xaxis:{boundsmode:"auto",title:t.title,ticksuffix:t.units||""},yaxis:{boundsmode:"auto",title:i.title}}};return n.rows?(r.data.x=n.rows.map(function(e){return n.x.min+n.x.step*e.x}),r.data.y=n.rows.map(function(e){return e.z})):n.matrix&&(r.data.x=e.range(n.x.min,n.x.bins,n.x.step),r.data.y=n.matrix[0]),r}};return e}),angular.module("a2-plot-specs",["a2.utils-browser-metrics"]).factory("PlotSpecs",["a2BrowserMetrics",function(e){return{gutter:e.scrollSize.height,axis_sizew:60,axis_sizeh:60,legend_axis_w:45,legend_width:60,legend_gutter:30,axis_lead:15}}]),angular.module("a2.service.plotly-defaults",["a2-plot-specs","a2.service.colorscale-gradients"]).provider("PlotlyDefaults",function(){var e={defaults:{},set:function(t,i){e.defaults=i?angular.merge(defaults,t):t},$get:["PlotlyDefaultDefaults",function(t){return angular.merge(t,e.defaults)}]};return e}).service("PlotlyDefaultDefaults",["PlotSpecs","ColorscaleGradients",function(e,t){var i={titlefont:{family:'"Helvetica Neue", Helvetica, Arial, sans-serif',size:"14px"},tickfont:{family:"sans-serif",size:"11px",color:"#fff"}};return i.config={showLink:!1,sendData:!1,displaylogo:!1,displayModeBar:!0,scrollZoom:!0,modeBarButtonsToRemove:["sendDataToCloud","autoScale2d"]},i.layout={xaxis:{titlefont:i.titlefont,tickfont:i.tickfont,color:"#fff"},yaxis:{titlefont:i.titlefont,tickfont:i.tickfont,color:"#fff"},plot_bgcolor:"#131525",paper_bgcolor:"#131525",dragmode:"pan"},i.colorbar={tickfont:i.tickfont,thickness:e.legend_width-e.legend_axis_w},i.heatmap={colorscale:t.normalize(0),colorbar:i.colorbar},i}]),angular.module("a2.url-update-service",[]).factory("a2UrlUpdate",function(){return{cache:{},prefix:"_t_",clear:function(){this.cache={}},update:function(e){e=this.get(e);var t,i=e.indexOf("?"),n=(new Date).getTime();if(i>=0){var a=new RegExp("(^|&)"+this.prefix+"=(\\d+)"),r=e.substr(i+1);t=a.exec(r)?e.substr(0,i)+"?"+r.replace(a,this.prefix+"="+n):e+"&"+this.prefix+"="+n}else t=e+"?"+this.prefix+"="+n;this.cache[e]=t,$('[src="'+e+'"]').attr("src","").attr("src",t)},get:function(e){for(var t;t=this.cache[e];)e=t;return e}}}).filter("a2UpdatedUrl",["a2UrlUpdate",function(e){return function(t){return e.get(t)}}]),angular.module("a2.utils.external-api-loader",["a2.utils.global-anonymous-function"]).provider("externalApiLoader",function(){var e={apis:{},defaults:{getCachedModule:["$window",function(e){return e[this.def.namespace]}],loader:["$window","$q","globalAnonymousFunction",function(e,t,i){var n=this;return t(function(t,a){var r=n.def.url,o=e.document.createElement("script");angular.element(e.document.head).append(o),n.def.jsonpCallback?r+=(/\?/.test(r)?"&":"?")+n.def.jsonpCallback+"="+i(t,{oneTime:!0}).id:o.onload=t,o.onerror=function(){a()},o.src=r})}]},addApi:function(t,i){e.apis[t]={name:t,def:angular.extend({},e.defaults,i)}},$get:["$q","$injector",function(t,i){var n={load:function(a){var r=e.apis[a];return r?(r.module||(r.module=i.invoke(r.def.getCachedModule,r)),r.promise||(r.module?r.promise=t.resolve(r.module):(r.promise=t.resolve(),r.def.parent&&(r.promise=r.promise.then(function(){return n.load(r.def.parent)}).then(function(){r.parent=e.apis[r.def.parent]})),r.promise=r.promise.then(function(){return i.invoke(r.def.loader,r)}).then(function(){r.module=i.invoke(r.def.getCachedModule,r)}).then(function(){if(r.def.onload)return i.invoke(r.def.onload,r)}).then(function(){return r.module}))),r.promise):t.reject("Cannot load unconfigured external api "+a)}};return n}]};return e}),angular.module("a2.utils.global-anonymous-function",[]).factory("globalAnonymousFunction",["$window",function(e){var t=0;return function(i,n){var a=function(){n&&n.oneTime&&a.remove(),i.apply(this,Array.prototype.slice.call(arguments))};return a.id="__g_a_f_"+t++,e[a.id]=a,a.remove=function(){e[a.id]==a&&delete e[a.id]},a}}]),angular.module("a2.utils.q-promisify",[]).factory("$qPromisify",["$q",function(e){function t(){var t=Array.prototype.slice.call(arguments),i=t.shift();return e(function(e,n){t.push(function(t,i){t?n():e(i)}),i.apply(null,t)})}return t.invoke=function(){var e=Array.prototype.slice.call(arguments),i=e.shift(),n=e.shift();return t(function(t){e.push(t),i[n].apply(i,e)})},t}]),angular.module("a2.admin.jobs",["ui.router","templates-arbimon2"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/dashboard"),e.state("jobs",{url:"/jobs",controller:"AdminJobsCtrl",templateUrl:"/admin/jobs/index.html"})}]).controller("AdminJobsCtrl",["$scope","$http","$interval","Project",function(e,t,i,n){e.findJobs=function(){var i={},n=/(\w+):["'](.+)["']|(\w+):([\w\-]+)/g;e.params.search&&e.params.search.replace(n,function(e,t,n,a,r){var o=t||a,s=n||r;i[o]||(i[o]=[]),i[o].push(s)}),e.params.states&&(i.states=e.params.states.map(function(e){return e.name})),e.params.types&&(i.types=e.params.types.map(function(e){return e.id})),t.get("/admin/jobs",{params:i}).success(function(t){e.activeJobs=t})},e.initParams=function(){e.params={search:"is:visible "}},e.job_types=[],e.states=[{name:"waiting",color:"black",show:!0},{name:"initializing",color:"blue",show:!0},{name:"ready",color:"#007777",show:!0},{name:"processing",color:"olive",show:!0},{name:"completed",color:"green",show:!1},{name:"error",color:"red",show:!0},{name:"canceled",color:"gray",show:!1},{name:"stalled",color:"gray",show:!1}],e.initParams(),function(i){t.get("/admin/job-queue").success(function(t){e.jobsStatus=t})}(),t.get("/api/jobs/types").success(function(t){var i=["#1482f8","#df3627","#40af3b","#9f51bf","#d37528"];e.colors={};for(var n=0;n<t.length;n++){var a=t[n];e.colors[a.name]=i[n%i.length]}e.job_types=t}),e.findJobs()}]),angular.module("a2.admin.dashboard.data-service",[]).service("AdminDashboardDataService",["$q",function(e){return{getPlotData:function(t,i,n,a){return e.when("/admin/plot-data/data.txt?stat="+t+"&q="+a+"&from="+i.getTime()+"&to="+n.getTime())}}}]),angular.module("a2.admin.dashboard",["ui.router","ui.bootstrap","a2.utils","a2.services","a2.directives","templates-arbimon2","humane","ui.select","a2.admin.dashboard.data-service","a2.admin.dashboard.plotter-controller"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/dashboard"),e.state("dashboard",{url:"/dashboard",controller:"AdminDashboardCtrl as controller",templateUrl:"/admin/dashboard/index.html"})}]).controller("AdminDashboardCtrl",["$scope","$http","$q","$controller",function(e,t,i,n){function a(e){for(var t="object"!=typeof e?JSON.parse(e):e,i="",n=0;n<t.length;n++){var a="";for(var r in t[n])""!=a&&(a+=","),a+=t[n][r];i+=a+"\r\n"}return i}function r(e,t,i){e&&t.unshift(e);var n=JSON.stringify(t),r=a(n),o=i+".csv"||"export.csv",s=new Blob([r],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(s,o);else{var c=document.createElement("a");if(void 0!==c.download){var l=URL.createObjectURL(s);c.setAttribute("href",l),c.setAttribute("download",o),c.style.visibility="hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c)}}}function o(e){var t={name:"Name",email:"Email"},i=[];e.forEach(function(e){i.push({name:e.firstname+" "+e.lastname,email:e.email})}),r(t,i,"users")}e.plots=n("AdminDashboardPlotterController",{$scope:e}),e.UserStatsExport=function(){t.get("/admin/all-users").success(function(e){o(e)})},t.get("/admin/dashboard-stats").success(function(t){e.newUsers=t.newUsers,e.newProjects=t.newProjects,e.Jobs=t.jobsStatus,e.allUsers=t.allUsers,e.allSites=t.allSites,e.allProjects=t.allProjects,e.newSites=t.newSites}),e.getSystemSettings=function(){t.get("/admin/system-settings").success(function(t){e.settings=t})},e.getSystemSettings(),e.setSetting=function(n,a){var r=i.defer();return n?t.put("/admin/system-settings",{setting:n,value:a}).success(function(t){e.getSystemSettings(),r.resolve(t[n])}).error(function(t){console.error(t),e.getSystemSettings(),r.reject(t)}):r.resolve(),r.promise},e.toggleSetting=function(t){var i="on"==e.settings[t]?"off":"on";return this.setSetting(t,i)}}]),angular.module("a2.admin.dashboard.plotter-controller",["templates-arbimon2","a2.admin.dashboard.data-service","a2.directive.plotly-plotter"]).controller("AdminDashboardPlotterController",["$scope","$window","$q","AdminDashboardDataService",function(e,t,i,n){function a(e,t){return function(){var i="now"==e?new Date:new Date(e),n=new Date(i.getTime()+t);if(t<0){var a=i;i=n,n=a}return[i,n]}}function r(e,t){return e.filter(function(e){return e.tag==t}).shift()}function o(e){var t=e.data,i=e.sel||t,n=e.def;return function(e){return"string"==typeof e&&(e=r(this.data[t],e)),e||(e=r(this.data[t],n)),this.selected[i]=e,e.apply&&e.apply(this),this.refresh_logs()}}this.data={series:[{tag:"activity",name:"Activity",icon:"fa fa-fw fa-ra"}],time_ranges:[{tag:"1-hour",text:"Last Hour",range:a("now",-36e5)},{tag:"3-hour",text:"Last 3 Hours",range:a("now",-108e5)},{tag:"6-hour",
text:"Last 6 Hours",range:a("now",-216e5)},{tag:"12-hour",text:"Last 12 Hours",range:a("now",-432e5)},{tag:"24-hour",text:"Last 24 Hours",range:a("now",-864e5)},{tag:"3-days",text:"Last 3 Days",range:a("now",-2592e5)},{tag:"1-week",text:"Last Week",range:a("now",-6048e5)},{tag:"2-weeks",text:"Last 2 Weeks",range:a("now",-12096e5)},{tag:"1-month",text:"Last Month",range:a("now",-26784e5)}],periods:[{tag:"1-minute",text:"1 Minute",sampling:"1 min",granularity:6e4},{tag:"5-minutes",text:"5 Minutes",sampling:"5 mins",granularity:3e5},{tag:"10-minutes",text:"10 Minutes",sampling:"10 mins",granularity:6e5},{tag:"30-minutes",text:"30 Minutes",sampling:"30 mins",granularity:18e5},{tag:"1-hour",text:"1 Hour",sampling:"1 hour",granularity:36e5},{tag:"3-hours",text:"3 Hours",sampling:"3 hours",granularity:108e5},{tag:"6-hours",text:"6 Hours",sampling:"6 hours",granularity:216e5},{tag:"1-day",text:"1 Day",sampling:"1 day",granularity:864e5}]},this.loading={},this.selected={series:r(this.data.series,"activity"),time_range:r(this.data.time_ranges,"1-week"),period:r(this.data.periods,"1-day")},this.set_series=o({data:"series",sel:"series",def:"activity"}),this.set_time_range=o({data:"time_ranges",sel:"time_range",def:"1-week"}),this.set_period=o({data:"periods",sel:"period",def:"1-day"}),this.load_data=function(e,t,i){var a=this.loading;return a.data=!0,n.getPlotData(e.tag,t[0],t[1],i.sampling).then(function(e){return a.data=!1,{x:"datetime",url:e}})},this.make_chart_struct=function(e){return i(function(i,n){t.Plotly.d3.csv(e.url,function(e,t){e?n(e):t&&i(t)})}).then(function(e){this.chart={data:[{type:"scatter",mode:"lines",marker:{color:"#31984f"},x:e.map(function(e){return new Date(+e.datetime).toString()}),y:e.map(function(e){return+e.activity})}],layout:{xaxis:{boundsmode:"auto"},yaxis:{boundsmode:"auto"}}},console.log(this.chart)}.bind(this))},this.refresh_logs=function(){var e=i.defer(),t=e.promise;e.resolve();var n=this.selected.series,a=this.selected.time_range,r=this.selected.period;if(n&&a&&r){var o=a.range(),s=r.granularity;t=e.promise.then(function(){return n.data&&(n.data.period==r&&n.data.range[0]-s>=o[0]&&o[1]<=n.data.range[1]+s||(n.data=null)),n.data?n.data.data:this.load_data(n,o,r).then(function(e){return n.data={data:e,range:o,period:r},n.data.data})}.bind(this)).then(function(e){console.log("chart_data : ",e),e&&this.make_chart_struct(e)}.bind(this))}return t},i.when().then(this.refresh_logs.bind(this))}]),angular.module("a2.admin.users.list",["ui.router","ui.bootstrap","a2.utils","a2.services","templates-arbimon2","humane","ui.select"]).service("AdminUsersListService",["$http",function(e){return{getList:function(){return e.get("/admin/users").then(function(e){return e.data})}}}]),angular.module("a2.admin.projects.codes",["ui.router","a2.directives","ui.bootstrap","a2.utils","a2.services","templates-arbimon2","humane","ui.select","a2.admin.projects.list","a2.admin.users.list"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("projects.codes",{url:"/codes",controller:"AdminProjectsCodesCtrl as controller",templateUrl:"/admin/projects/codes.html"})}]).controller("AdminProjectsCodesCtrl",["$modal","notify","LoaderFactory","AdminProjectsCodesService",function(e,t,i,n){var a=i.newInstance();this.loader=a,this.createNewCode=function(){return e.open({templateUrl:"/admin/projects/new-code-modal.html",resolve:{projectsList:["AdminProjectsListService",function(e){return e.getList()}],usersList:["AdminUsersListService",function(e){return e.getList()}]},controller:["projectsList","usersList",function(e,t){this.projectsList=e,this.usersList=t,this.data={lockToUser:void 0,lockProject:void 0,duration:1,recordings:1e4,processing:1e6,tieProcessingWithRecordings:!0},this.computeProcessingAmount=function(){this.data.tieProcessingWithRecordings&&(this.data.processing=100*this.data.recordings)},this.processingCountChanged=function(){this.data.tieProcessingWithRecordings=!1}}],controllerAs:"popup"}).result.then(n.createNewCode).then(function(){a.load(this,"codes",n.loadCodes())}.bind(this))},this.showHash=function(t){return e.open({templateUrl:"/admin/projects/view-hash.html",resolve:{code:function(){return t}},controller:["code",function(e){this.code=e}],controllerAs:"popup"})},a.load(this,"codes",n.loadCodes())}]).service("AdminProjectsCodesService",["$http",function(e){return{loadCodes:function(){return e.get("/admin/projects/codes").then(function(e){return e.data})},createNewCode:function(t){return console.log("createNewCode",t),e.post("/admin/projects/codes",{user:t.lockToUser&&t.lockToUser.id,project:t.lockProject&&t.lockProject.id,recordings:t.recordings,duration:t.duration,processing:t.processing}).then(function(e){return e.response})}}}]).factory("LoaderFactory",["$q",function(e){function t(){this.loading={}}return t.prototype={load:function(e,t,i){return this.loading[t]=!0,i.then(function(i){return this.loading[t]=!1,e&&(e[t]=i),i}.bind(this),function(e){throw this.loading[t]=!1,e}.bind(this))}},{newInstance:function(){return new t}}}]),angular.module("a2.admin.projects",["ui.router","templates-arbimon2","a2.admin.projects.list","a2.admin.projects.codes"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/dashboard"),e.state("projects",{url:"/projects",abstract:!0,templateUrl:"/admin/projects/index.html"})}]),angular.module("a2.admin.projects.list",["ui.router","ui.bootstrap","a2.utils","a2.services","templates-arbimon2","a2.orders.directives.tier-select","humane","ui.select"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("projects.list",{url:"",controller:"AdminProjectsListCtrl as controller",templateUrl:"/admin/projects/list.html"}).state("projects.list.detail",{url:"/:url",views:{detail:{templateUrl:"/admin/projects/list-detail.html",controller:"AdminProjectsListDetailCtrl as controller"}}})}]).controller("AdminProjectsListCtrl",["$scope","$state","AdminProjectsListService",function(e,t,i){this.initialize=function(){i.getList().then(function(e){if(this.projects=e,t.params.url){var i=t.params.url;this.selected=this.projects.reduce(function(e,t){return t.url==i?t:e},null)}}.bind(this))},this.select=function(e){return t.go("projects.list.detail",{url:e.url})},this.notifyProjectUpdated=function(e){var t=this.projects.reduce(function(t,i,n){return i.project_id==e.project_id?e:t},null);angular.merge(t,e)},this.initialize()}]).controller("AdminProjectsListDetailCtrl",["$scope","$state","$q","notify","AdminProjectsListService",function(e,t,i,n,a){this.initialize=function(){console.log("$state",t),this.setProject({url:t.params.url})},this.setProject=function(e){return i.all([a.getProjectInfo(e),a.getProjectSites(e),a.getProjectRecordingCount(e)]).then(function(e){this.project=e[0],this.project.is_enabled=0|this.project.is_enabled,this.sites=e[1],this.recCount=e[2]}.bind(this))},this.close=function(){t.go("projects.list")},this.save=function(){return a.updateProject(this.project).then(function(e){this.project=e,n.log("Project "+e.name+" info updated.")}.bind(this)).catch(function(e){n.error(e)})},this.handleAedToggle=function(){this.project.clustering_enabled=this.project.aed_enabled},this.initialize()}]).service("AdminProjectsListService",["$http",function(e){return{getList:function(){return e.get("/admin/projects").then(function(e){return e.data})},getProjectInfo:function(t){return e.get("/api/project/"+t.url+"/info").then(function(e){var t=e.data;return t.is_enabled=!!t.is_enabled,t})},getProjectSites:function(t){return e.get("/api/project/"+t.url+"/sites").then(function(e){return e.data})},getProjectRecordingCount:function(t){return e.get("/api/project/"+t.url+"/recordings/count").then(function(e){return e.data.count})},updateProject:function(t){var i={project_id:t.project_id,name:t.name,url:t.url,description:t.description,project_type_id:t.project_type_id,is_private:t.is_private,is_enabled:t.is_enabled,current_plan:t.current_plan,storage_usage:t.storage_usage,processing_usage:t.processing_usage,citizen_scientist_enabled:!!t.citizen_scientist_enabled,cnn_enabled:!!t.cnn_enabled,pattern_matching_enabled:!!t.pattern_matching_enabled,aed_enabled:!!t.aed_enabled,clustering_enabled:!!t.clustering_enabled,reports_enabled:!!t.reports_enabled,plan:{tier:t.tier,storage:t.storage_limit,processing:t.processing_limit,activation:t.plan_activated,duration_period:t.plan_period}};return e.put("/admin/projects/"+t.project_id,{project:i}).then(function(e){return e.data})}}}]),angular.module("a2.directive.audio-bar",["a2.utils","a2.srv.local-storage","a2.visualizer.audio-player"]).directive("a2AudioBar",["a2SidenavBarService","$parse",function(e,t){return{restrict:"E",templateUrl:"/directives/a2-audio-bar/a2-audio-bar.html",scope:{},replace:!0,controller:"a2AudioBarCtrl as controller"}}]).factory("a2AudioBarService",["$rootScope",function(e){return{loadUrl:function(t,i){e.$broadcast("a2-audio-load-url",{url:t,play:i})}}}]).controller("a2AudioBarCtrl",["$scope","$filter","a2AudioPlayer","$timeout","$q","$localStorage",function(e,t,i,n,a,r){Object.assign(this,{initialize:function(){this.audio_player=new i(e),this.expanded=!1,this.collapseTimeoutInterval=6e3,this.loading=!1,this.audio_player.setGain(r.getItem("a2-audio-param-gain")||1),this.deregHandlers=[],this.deregHandlers.push(e.$on("a2-audio-load-url",this.onLoadUrl.bind(this))),this.deregHandlers.push(e.$on("$destroy",this.onDestroy.bind(this)))},onLoadUrl:function(e,t){this.loadUrl(t)},onDestroy:function(){(this.deregHandlers||[]).forEach(function(e){e()})},setCollapseTimer:function(){this.collapseTimer&&n.cancel(this.collapseTimer),this.collapseTimeoutInterval&&(this.collapseTimer=n(function(){this.expanded=!1}.bind(this),this.collapseTimeoutInterval))},seekPercent:function(e){return this.audio_player.setCurrentTime(e*this.audio_player.resource.duration)},setGain:function(e){return this.setCollapseTimer(),r.setItem("a2-audio-param-gain",e),this.audio_player.setGain(e)},play:function(){return this.setCollapseTimer(),this.audio_player.play()},pause:function(){return this.setCollapseTimer(),this.audio_player.pause()},stop:function(){return this.setCollapseTimer(),this.audio_player.stop()},toggleExpanded:function(){this.expanded=!this.expanded,this.expanded&&this.setCollapseTimer()},loadUrl:function(e){e=e||{};const t=e.url,i=e.play||void 0===e.play;return t?(this.loading=!0,this.expanded=!0,this.audio_player.load(t).then(function(){if(this.loading=!1,i)return this.play()}.bind(this)).catch(function(e){this.loading=!1,this.error=e,console.error(e)}.bind(this))):a.resolve()}}),this.initialize(this)}]),angular.module("arbimon.directive.a2-switch",[]).directive("a2Switch",function(){return{restict:"E",templateUrl:"/directives/a2-switch/template.html",require:"ngModel",scope:{onText:"@",offText:"@",disabled:"="},link:function(e,t,i,n){e.toggle=function(t){e.value=!e.value,n.$setViewValue(e.value,t&&t.type)},n.$render=function(){e.value=!!n.$viewValue}}}}),angular.module("a2.utils.facebook-login-button",["a2.utils","a2.utils.global-anonymous-function","a2.utils.external-api-loader","a2.injected.data"]).config(["externalApiLoaderProvider",function(e){e.addApi("facebook",{url:"//connect.facebook.net/en_US/sdk.js",namespace:"FB",onload:["a2InjectedData",function(e){this.module.init(e.facebook_api)}]})}]).directive("a2FacebookLoginButton",["$window","$q","$timeout","a2InjectedData","externalApiLoader",function(e,t,i,n,a){return{restrict:"E",templateUrl:"/directives/external/facebook-login-button.html",scope:{onSignedIn:"&?",onError:"&?"},link:function(e,t,i){t.children(".btn-facebook-login").addClass(t[0].className),t[0].className="",e.signIn=function(){a.load("facebook").then(function(t){t.login(function(t){"connected"===t.status?(console.log(t),e.onSignedIn({user:t})):t.status},{scope:"public_profile,email"})})}}}}]),angular.module("a2.utils.google-login-button",["a2.utils","a2.utils.q-promisify","a2.utils.global-anonymous-function","a2.utils.external-api-loader","a2.injected.data"]).config(["externalApiLoaderProvider",function(e){e.addApi("google-api",{url:"https://apis.google.com/js/client.js",namespace:"gapi",jsonpCallback:"onload"}),e.addApi("google-api/auth2",{parent:"google-api",loader:["$qPromisify",function(e){return e.invoke(this.parent.module,"load","auth2")}],onload:["a2InjectedData",function(e){var t=this.module.init({client_id:e.google_oauth_client,cookiepolicy:"single_host_origin"});return t.then(function(){this.module.auth2=t}.bind(this))}],getCachedModule:function(){return this.parent&&this.parent.module&&this.parent.module.auth2}})}]).directive("a2GoogleLoginButton",["$window","$q","$timeout","globalAnonymousFunction","a2InjectedData","externalApiLoader",function(e,t,i,n,a,r){return{restrict:"E",templateUrl:"/directives/external/google-login-button.html",scope:{onSignedIn:"&?",onError:"&?"},link:function(e,t,i){t.children(".btn-google-login").addClass(t[0].className),t[0].className="",e.signIn=function(){r.load("google-api/auth2").then(function(t){t.auth2.signIn().then(function(t){e.onSignedIn({user:t})},function(t){e.onError({error:t})})})}}}}]),angular.module("a2.analysis",["a2.analysis.patternmatching","a2.directive.audio-bar","a2.analysis.random-forest-models","a2.analysis.cnn","a2.analysis.soundscapes","a2.analysis.audio-event-detection","a2.analysis.audio-event-detections-clustering","a2.analysis.clustering-jobs","ui.router","ct.ui.router.extras","a2.srv.api"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/analysis","/analysis/patternmatching","/analysis/clustering-jobs"),e.state("analysis",{url:"/analysis",views:{analysis:{controller:"AnalysisIndexCtrl as controller",templateUrl:"/app/analysis/index.html"}},deepStateRedirect:!0,sticky:!0})}]).controller("AnalysisIndexCtrl",["$scope","Project","a2UserPermit",function(e,t,i){t.getInfo(function(t){e.project=t})}]),angular.module("a2.audiodata",["ui.router","ct.ui.router.extras","a2.directive.sidenav-bar","a2.directive.audio-bar","a2.audiodata.sites","a2.audiodata.species","a2.audiodata.uploads","a2.audiodata.recordings","a2.audiodata.training-sets","a2.audiodata.playlists","a2.audiodata.templates","a2.audiodata.soundscape-composition-classes"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/audiodata","/audiodata/sites"),e.state("audiodata",{url:"/audiodata",views:{audiodata:{controller:"AudiodataIndexCtrl as controller",templateUrl:"/app/audiodata/index.html"}},deepStateRedirect:!0,sticky:!0}).state("audiodata.sites",{url:"/sites?site&show",controller:"SitesCtrl",templateUrl:"/app/audiodata/sites.html"}).state("audiodata.species",{url:"/species",controller:"SpeciesCtrl",templateUrl:"/app/audiodata/species.html"}).state("audiodata.trainingSets",{url:"/training-sets?set&show",controller:"TrainingSetsCtrl as controller",templateUrl:"/app/audiodata/training-sets.html"})}]).controller("AudiodataIndexCtrl",["$scope","Project","a2UserPermit",function(e,t,i){t.getInfo(function(t){e.project=t})}]),angular.module("a2.audiodata.sites",["a2.services","a2.directives","ui.bootstrap","humane","a2.qr-js","a2.googlemaps","a2.srv.project"]).directive("fileChange",["$parse",function(e){return{require:"ngModel",restrict:"A",link:function(t,i,n){var a=e(n.fileChange),r=function(e){t.$apply(function(){a(t,{$event:e,files:e.target.files})})};i[0].addEventListener("change",r,!1)}}}]).controller("SitesCtrl",["$scope","$state","$anchorScroll","Project","$modal","notify","a2Sites","$window","$controller","$q","a2UserPermit","a2GoogleMapsLoader","$downloadResource",function(e,t,i,n,a,r,o,s,c,l,u,d,p){function f(e){var t=e.split(/\r\n|\n/),i=t[0].split(",");if(!(i.includes("name")&&i.includes("lat")&&i.includes("lon")&&i.includes("alt")))return!1;for(var n=[],a=1;a<t.length;a++){var o=t[a].split(",");if(o.length==i.length){for(var s={},c=0;c<i.length;c++){if("lat"===i[c]&&(o[c]>85||o[c]<-85))return r.log("Please enter latitude number between -85 to 85");if("lon"===i[c]&&(o[c]>180||o[c]<-180))return r.log("Please enter longitude number between -180 to 180");s[i[c]]=o[c]}n.push(s)}}return n}function h(e){return Promise.all(e.map(function(e){return new Promise(function(t,i){o.create(e,function(e){e.error?i(e.error):t()})})}))}e.loading=!0,e.markers=[],e.search="",e.editing=!1,e.creating=!1,n.getInfo(function(t){e.project=t});var g={site:t.params.site,show:t.params.show};g.show&&(g.show_path=g.show.split(":"),g.show=g.show_path.shift()),n.getSites({count:!0,logs:!0,deployment:!0},function(t){if(e.sortByLastUpdated(t),e.loading=!1,g.site){var i=t.filter(function(e){return e.id==g.site}).shift();i&&i.id&&e.sel(i).then(function(){g.show&&e.set_show(g.show,g.show_path)})}d.then(function(t){e.map=new t.maps.Map(s.document.getElementById("mapSite"),{center:{lat:0,lng:0},mapTypeId:t.maps.MapTypeId.SATELLITE,zoom:8,minZoom:2}),e.fitBounds()}),e.mapHeader=s.document.getElementById("mapHeader"),e.mapHeaderPosition=mapHeader.getBoundingClientRect()}),e.fitBounds=function(){const t=new google.maps.LatLngBounds;angular.forEach(e.sites,function(i){if(!(i.lat>85||i.lat<-85||i.lon>180||i.lon<-180)){var n;const a=new google.maps.LatLng(i.lat,i.lon);n=e.selected&&e.selected.id===i.id?new google.maps.Marker({position:a,title:i.name,icon:{url:"http://icons.iconarchive.com/icons/paomedia/small-n-flat/48/map-marker-icon.png"}}):new google.maps.Marker({position:a,title:i.name}),(e.editing||e.creating)&&e.temp&&e.temp.id===i.id&&(n.setDraggable(!0),e.map.panTo(a),e.map.setZoom(8),google.maps.event.addListener(n,"dragend",function(t){e.$apply(function(){e.temp.lat=t.latLng.lat(),e.temp.lon=t.latLng.lng()})})),n.addListener("click",function(){e.sel(i),e.scrollTo(i.id)}),e.markers.push(n),t.extend(a)}}),e.map.fitBounds(t),e.markers.length&&e.setMapOnAll(e.map)},e.scrollTo=function(e){const t="site-"+e;i.yOffset=60,console.log(t),i(t)},e.onScroll=function(t,i){this.scrollElement=i.scrollElement,this.scrollPos=i.scrollElement.scrollY,e.scrollPos=this.scrollPos,e.scrolledPastHeader=this.scrollPos<600},e.getMapHeaderTop=function(){if(e.mapHeaderPosition){const t=e.mapHeaderPosition.top+e.mapHeader.offsetHeigh;return t<1?"122px":t}return"122px"},e.scrollMap=function(t,i){return e.show.map&&!1===e.editing&&!1===e.creating&&e.sites&&e.sites.length>15&&e.scrollPos},e.onFilterChanged=function(){e.sites=e.sortByKeywordArray(e.originalSites,e.search)},e.sortByKeywordArray=function(e,t){return e&&!e.length?[]:e.filter(function(e){return e.name.toLowerCase().includes(t.toLowerCase())}).sort(function(e,i){return e.name.toLowerCase().indexOf(t.toLowerCase())>i.name.toLowerCase().indexOf(t.toLowerCase())?1:e.name.toLowerCase().indexOf(t.toLowerCase())<i.name.toLowerCase().indexOf(t.toLowerCase())?-1:e.name>i.name?1:-1})},e.sortByLastUpdated=function(t){e.sites=t.sort(function(e,t){return e.updated_at<t.updated_at?1:-1}),e.originalSites=e.sites},e.setMapOnAll=function(t){for(var i=0;i<e.markers.length;i++)e.markers[i].setMap(t)},e.clearMarkers=function(){e.setMapOnAll(null)},e.showMarkers=function(t){e.setMapOnAll(t)},e.deleteMarkers=function(){e.clearMarkers(),e.markers=[]},e.editing=!1,e.importSite=function(){if(!u.can("manage project sites"))return void r.error("You do not have permission to add sites");a.open({templateUrl:"/app/audiodata/import.html",controller:"ImportSiteInstanceCtrl"}).result.then(function(t){const i=f(t);if(!i)return void r.error("Wrong format of csv file");h(i).then(function(){r.log("Sites created"),n.getSites({count:!0,logs:!0,deployment:!0},function(t){e.sortByLastUpdated(t)})}).catch(function(e){r.error("Error: "+e)})})},e.close=function(){e.creating=!1,e.editing=!1,e.marker&&d.then(function(t){var i=new t.maps.LatLng(e.selected&&e.selected.lat,e.selected&&e.selected.lon);e.marker.setDraggable(!1),e.marker.setPosition(i),e.marker.setTitle(e.selected&&e.selected.name)})},e.exportSites=function(){return u.isSuper()?p(n.getSitesExportUrl()):u.all&&!u.all.length||!u.can("export report")?r.error("You do not have permission to export sites"):void p(n.getSitesExportUrl())},e.status_controller=c("SiteStatusPlotterController",{$scope:e});var m=e.status_controller.on("logs-refreshed",function(i){if(e.show.status){var n=[t.params.show.split(":").slice(0,1)].concat(i).join(":");console.log("logParams",i,n),t.transitionTo(t.current.name,{site:t.params.site,show:n},{notify:!1})}});e.$on("$destroy",function(){e.status_controller.off("logs-refreshed",m)}),e.save=function(){var t=e.editing?"update":"create";if(e.temp.lat>85||e.temp.lat<-85)return void r.log("Please enter latitude number between -85 to 85");if(e.temp.lon>180||e.temp.lon<-180)return void r.log("Please enter longitude number between -180 to 180");if(!e.siteForm.$invalid){var i=Object.assign({},e.temp);if("update"===t){const a=["alt","updated_at"];for(var s=0;s<a.length;s++){var c=a[s];e.temp[c]===e.selected[c]&&delete i[c]}const l=["lat","lon"];e.temp[l[0]]===e.selected[l[0]]&&e.temp[l[1]]===e.selected[l[1]]&&(delete i[l[0]],delete i[l[1]])}o[t]("create"===t?e.temp:i,function(a){if(a.error)return r.error(a.error);"create"===t?e.creating=!1:e.editing=!1,n.getSites({count:!0,logs:!0,deployment:!0},function(n){e.sortByLastUpdated(n),e.sel("create"===t?e.temp:i).then(function(){g.show&&e.set_show(g.show,g.show_path)}),e.deleteMarkers(),e.fitBounds()});var o="update"==t?"Site updated":"Site created";r.log(o)})}},e.del=function(){return e.selected?u.can("delete site")?void a.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.messages=["Are you sure you would like to remove the following site?",e.selected.name],this.btnOk="Delete",this.btnCancel="Cancel"},controllerAs:"popup"}).result.then(function(){o.delete([e.selected.id],function(t){if(t.error)return r.error(t.error);n.getSites({count:!0,logs:!0,deployment:!0},function(t){e.sortByLastUpdated(t),e.deleteMarkers(),e.fitBounds()}),r.log("Site removed")})}):void r.error("You do not have permission to remove sites"):void r.log("Please select site to remove")},e.delAllEmptySites=function(){if(!u.can("manage project settings"))return void r.error("You do not have permission to remove sites");var t=[],i=[];if(e.sites.forEach(function(e,n){0!==e.rec_count||t.includes(e.name)||(t.push(e.name),i.push(e.id))}),!t.length)return void r.log("There is no empty site in your project");if(t.length>3){const s="& "+(t.length-3)+" other sites";t=t.slice(0,3),t.push(s)}a.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.messages=["Are you sure you would like to remove the following sites?"],this.list=t,this.btnOk="Delete",this.btnCancel="Cancel"},controllerAs:"popup"}).result.then(function(){o.delete(i,function(t){if(t.error)return r.error(t.error);n.getSites({count:!0,logs:!0,deployment:!0},function(t){e.sortByLastUpdated(t),e.deleteMarkers(),e.fitBounds()}),r.log("Empty sites removed")})})},e.show={map:!1,status:!1},e.show[g.show||"map"]=!0,e.set_show=function(i,n){var a=l.defer(),r=a.promise;a.resolve();var o=i;return"status"==i&&e.selected&&e.selected.has_logs?(o=[i].concat(n).join(":"),r=r.then(function(){return e.status_controller.activate(e.selected,n)})):r=r.then(function(){i="map"}),r.then(function(){for(var n in e.show)e.show[n]=!1;return e.show[i]=!0,t.transitionTo(t.current.name,{site:t.params.site,show:o},{notify:!1})})},e.create=function(){if(!u.can("manage project sites"))return void r.error("You do not have permission to add sites");e.temp={},e.set_show("map"),e.creating=!0,e.deleteMarkers(),e.fitBounds()},e.edit=function(){if(e.selected){if(!u.can("manage project sites"))return void r.error("You do not have permission to edit sites");e.set_show("map"),e.temp=angular.copy(e.selected),e.temp.published=1===e.temp.published,n.getProjectsList("my",function(t){e.projects=t.map(function(e){return{project_id:e.project_id,name:e.name,url:e.url}})}),n.getInfo(function(t){e.temp.project=t}),e.editing=!0,e.deleteMarkers(),e.fitBounds()}},e.onSelect=function(t){e.temp.project=t},e.showAssetsCarousel=!1,e.showCarousel=function(t){e.images.forEach(function(e){e.active=e.id===t}),e.showAssetsCarousel=!0},e.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},e.sel=function(i){return t.transitionTo(t.current.name,{site:i&&i.id,show:t.params.show},{notify:!1}).then(function(){e.images=[],e.close(),e.selected=i,e.selected&&e.selected.external_id&&o.getListOfAssets(e.selected.external_id).then(function(t){if(e.assets=t,e.assets&&e.selected.external_id){e.assets=e.assets.filter(function(e){return null!==e.meta});for(var i=0;i<e.assets.length;i++){var n="/api/project/"+e.project.url+"/streams/"+e.selected.external_id+"/assets/"+e.assets[i].id;e.images.push({id:i,src:n,active:0===i,label:e.assets[i]&&e.assets[i].meta&&e.assets[i].meta.label?e.capitalizeFirstLetter(e.assets[i].meta.label):"No label image"})}}}).catch(function(e){console.log("\nerr",e)}),e.deleteMarkers(),e.fitBounds(),e.selected&&d.then(function(t){var i=new t.maps.LatLng(e.selected.lat,e.selected.lon);e.map.panTo(i),e.map.setZoom(12)})})}}]).controller("ImportSiteInstanceCtrl",["$scope","$modalInstance",function(e,t){e.files=[],e.handler=function(e,i){var n=new FileReader;n.onload=function(e){t.close(n.result)},n.readAsText(i[0])},e.cancel=function(){t.dismiss()}}]).controller("SitesTokenGenaratorCtrl",["$scope","a2Sites","$modal","notify",function(e,t,i,n){e.site=e.selected,e.loading={};var a=function(t,n){return i.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.title=t,this.messages=["This action will revoke the current token for the site <b>"+e.site.name+"</b>. Are you sure you want to do this?"],this.btnOk=n,this.btnCancel="No"},controllerAs:"popup"})},r=function(){t.generateToken(e.site).success(function(t){if(e.loading.generate=!1,t.error)return n.error(t.error);e.site.token_created_on=new Date(1e3*t.created),e.base64=t.base64token,e.token={type:t.type,name:t.name,created:t.created,expires:t.expires,token:t.token},n.log("New site token generated.")}).error(function(t){e.loading.generate=!1,n.serverError()})};e.generateToken=function(){if(e.loading.generate=!0,e.site.token_created_on){a("<h4>Confirm revoke and generate token</h4>","Yes, revoke and generate a new token").result.then(function(){r()},function(){e.loading.generate=!1})}else r()},e.revokeToken=function(){a("<h4>Confirm revoke token</h4>","Yes, revoke token").result.then(function(){e.loading.revoke=!0,t.revokeToken(e.site).success(function(t){e.loading.revoke=!1,e.site.token_created_on=null,e.token=null,n.log("site token revoked.")}).error(function(t){e.loading.generate=!1,n.serverError()})})}}]).controller("SiteStatusPlotterController",["$scope","$q","a2Sites","$debounce","a2EventEmitter",function(e,t,i,n,a){function r(e,t){return function(){var i="now"==e?new Date:new Date(e),n=new Date(i.getTime()+t);if(t<0){var a=i;i=n,n=a}return[i,n]}}function o(e,t){return e.filter(function(e){return e.tag==t}).shift()}function s(e){var i=e.data,n=e.sel||i,a=e.def;return function(e,r){return"string"==typeof e&&(e=o(this.data[i],e)),e||(e=o(this.data[i],a)),this.selected[n]=e,e.apply&&e.apply(this),r?t.resolve():this.refresh_logs()}}var c=new a;this.on=c.on.bind(c),this.off=c.off.bind(c),this.itemGroup=function(e){return e.group},this.data={series:[{tag:"status",group:"Site",name:"Battery Status",icon:"fa fa-fw fa-plug",axis:{y:{tick:{values:[0,1,2,3],format:function(e){return["unknown","charging","not charging","full"][0|e]}}}}},{tag:"voltage",group:"Site",name:"Voltage",icon:"fa fa-fw fa-bolt"},{tag:"power",group:"Site",name:"Power",icon:"fa fa-fw fa-battery-half"},{tag:"uploads",group:"Data",name:"Uploads",icon:"fa fa-fw fa-upload"},{tag:"recordings",group:"Data",name:"Recordings",icon:"fa fa-fw fa-volume-up"}],time_ranges:[{tag:"1-hour",text:"Last Hour",group:"Hours",range:r("now",-36e5)},{tag:"3-hour",text:"Last 3 Hours",group:"Hours",range:r("now",-108e5)},{tag:"6-hour",text:"Last 6 Hours",group:"Hours",range:r("now",-216e5)},{tag:"12-hour",text:"Last 12 Hours",group:"Hours",range:r("now",-432e5)},{tag:"24-hour",text:"Last 24 Hours",group:"Hours",range:r("now",-864e5)},{tag:"3-days",text:"Last 3 Days",group:"Days",range:r("now",-2592e5)},{tag:"1-week",text:"Last Week",group:"Weeks",range:r("now",-6048e5)},{tag:"2-weeks",text:"Last 2 Weeks",group:"Weeks",range:r("now",-12096e5)},{tag:"1-month",text:"Last Month",group:"Month",range:r("now",-26784e5)}],periods:[{tag:"1-minute",text:"1 Minute",group:"Minutes",sampling:"1 min",granularity:6e4},{tag:"5-minutes",text:"5 Minutes",group:"Minutes",sampling:"5 mins",granularity:3e5},{tag:"10-minutes",text:"10 Minutes",group:"Minutes",sampling:"10 mins",granularity:6e5},{tag:"30-minutes",text:"30 Minutes",group:"Minutes",sampling:"30 mins",granularity:18e5},{tag:"1-hour",text:"1 Hour",group:"Hours",sampling:"1 hour",granularity:36e5},{tag:"3-hours",text:"3 Hours",group:"Hours",sampling:"3 hours",granularity:108e5},{tag:"6-hours",text:"6 Hours",group:"Hours",sampling:"6 hours",granularity:216e5},{tag:"1-day",text:"1 Day",group:"Days",sampling:"1 day",granularity:864e5}]},this.loading={},this.selected={series:o(this.data.series,"power"),time_range:o(this.data.time_ranges,"1-week"),period:o(this.data.periods,"1-hour")},this.set_series=s({data:"series",sel:"series",def:"power"}),this.set_time_range=s({data:"time_ranges",sel:"time_range",def:"1-week"}),this.set_period=s({data:"periods",sel:"period",def:"7-days"}),this.activate=function(e,t){return this.selected.site=e,t&&(t.length&&this.set_series(t.shift()),t.length&&this.set_time_range(t.shift()),t.length&&this.set_period(t.shift())),this.refresh_logs()},this.load_data=function(e,t,n,a){var r=this.loading;return r.data=!0,i.getSiteLogData(e.id,t.tag,n[0],n[1],a.sampling).then(function(e){return r.data=!1,e.x="datetime",e.axis=t.axis,e.empty={label:{text:"No data to show."}},e})},this.make_chart_struct=function(e){var t={x:{tick:{format:function(e){return moment(new Date(e)).utc().format("MM-DD-YYYY HH:mm")}}}};e.axis&&(angular.merge(t,e.axis),delete e.axis),this.chart={data:e,axes:t}},this.refresh_logs=n(function(){var e=t.defer(),i=e.promise;e.resolve();var n=this.selected.site,a=this.selected.series,r=this.selected.time_range,o=this.selected.period;if(n&&a&&r&&o){var s=r.range(),l=o.granularity;i=e.promise.then(function(){return a.data&&(a.data.site==n&&a.data.period==o&&a.data.range[0]-l>=s[0]&&s[1]<=a.data.range[1]+l||(a.data=null)),a.data?a.data.data:this.load_data(n,a,s,o).then(function(e){return a.data={data:e,site:n,range:s,period:o},a.data.data})}.bind(this)).then(function(e){console.log("chart_data : ",e),e&&this.make_chart_struct(e)}.bind(this)).then(function(){c.emit("logs-refreshed",[a.tag,r.tag,o.tag])})}return i},10)}]),angular.module("a2.audiodata.soundscape-composition-classes",["a2.services","a2.directives","ui.bootstrap","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("audiodata.scAnnotationClasses",{url:"/soundscape-annotation-classes",controller:"SoundscapeCompositionClassesScreenCtrl as controller",templateUrl:"/app/audiodata/soundscape-composition-classes.html"})}]).controller("SoundscapeCompositionClassesScreenCtrl",["$modal","notify","Project","a2SoundscapeCompositionService","a2UserPermit",function(e,t,i,n,a){this.initialize=function(){this.loading=!0,this.newClass={},this.canManageClasses=a.can("manage project species"),n.getClassList({tally:1,groupByType:!0,isSystemClass:1}).then(function(e){this.classes=e,this.loading=!1}.bind(this))},this.addNewClass=function(e){var i=this.newClass[e.typeId];if(delete this.newClass[e.typeId],i){if(!a.can("manage project species"))return void t.error("You do not have permission to add soundscape composition classes");n.addClass(i,e.typeId).then(function(t){e.list.push(t)}.bind(this)).catch(function(e){t.error(e.data||e.message)})}},this.removeClass=function(e){if(!e.isSystemClass)return a.can("manage project species")?void n.removeClass(e.id).then(function(){this.classes.forEach(function(t){var i=t.list.indexOf(e);i>=0&&t.list.splice(i,1)})
}.bind(this)).catch(function(e){t.error(e.data||e.message)}):void t.error("You do not have permission to remove soundscape composition classes")},this.add=function(){if(!a.can("manage project species"))return void t.error("You do not have permission to add species");e.open({templateUrl:"/app/audiodata/select-species.html",controller:"SelectSoundscapeCompositionClassesScreenCtrl",size:"lg"}).result.then(function(e){var n={species:e.species.scientific_name,songtype:e.song.name};i.addClass(n).success(function(n){t.log(e.species.scientific_name+" "+e.song.name+" added to project"),i.getClasses(function(e){this.classes=e})}).error(function(e,i){i<500?t.error(e.error):t.serverError()})})},this.del=function(){if(this.checked&&this.checked.length){if(!a.can("manage project species"))return void t.error("You do not have permission to remove species");var n=this.checked.map(function(e){return'"'+e.species_name+" | "+e.songtype_name+'"'}),r=["You are about to delete the following project species: "],o=["Are you sure?"];this.popup={messages:r.concat(n,o),btnOk:"Yes, do it!",btnCancel:"No"};e.open({templateUrl:"/common/templates/pop-up.html",scope:this}).result.then(function(){var e=this.checked.map(function(e){return e.id}),n={project_classes:e};i.removeClasses(n).success(function(e){i.getClasses(function(e){this.classes=e})}).error(function(e,i){i<500?t.error(e.error):t.serverError()})})}},this.initialize()}]),angular.module("a2.audiodata.species",["a2.services","a2.directives","ui.bootstrap","humane"]).controller("SpeciesCtrl",["$scope","Project","$modal","notify","a2UserPermit",function(e,t,i,n,a){e.loading=!0,e.selected={},t.getClasses(function(t){e.classes=t,e.loading=!1}),t.getInfo(function(t){e.project=t}),e.add=function(){if(!a.can("manage project species"))return void n.error("You do not have permission to add species");i.open({templateUrl:"/app/audiodata/select-species.html",controller:"SelectSpeciesCtrl",size:"lg"}).result.then(function(i){var a={species:i.species.scientific_name,songtype:i.song.name};t.addClass(a).success(function(a){n.log(i.species.scientific_name+" "+i.song.name+" added to project"),t.getClasses(function(t){e.classes=t})}).error(function(e,t){t<500?n.error(e.error):n.serverError()})})},e.del=function(){if(e.checked&&e.checked.length){if(!a.can("manage project species"))return void n.error("You do not have permission to remove species");var r=e.checked.map(function(e){return'"'+e.species_name+" | "+e.songtype_name+'"'}),o=["Are you sure you would like to remove the following species call from this project?"],s=["Note: validations for this species call will also be removed from this project."];e.popup={messages:o.concat(s,r),btnOk:"Yes, do it!",btnCancel:"No"};i.open({templateUrl:"/common/templates/pop-up.html",scope:e}).result.then(function(){var i=e.checked.map(function(e){return e.id}),a={project_classes:i};t.removeClasses(a).success(function(i){t.getClasses(function(t){e.classes=t})}).error(function(e,t){t<500?n.error(e.error):n.serverError()})})}}}]).controller("SelectSpeciesCtrl",["$scope","Species","Songtypes",function(e,t,i){var n;i.get(function(t){e.songtypes=t}),e.searchSpecies=function(){if(""===e.search)return void(e.species=[]);clearTimeout(n),n=setTimeout(function(){t.search(e.search,function(t){e.species=t})},500)}}]),angular.module("a2.audiodata.training-sets",["a2.services","a2.directives","ui.bootstrap","a2.visualizer.layers.training-sets","humane"]).factory("a2TrainingSetHistory",function(){var e,t,i,n,a,r,o;return{getLastSet:function(s){s({ls:e,lp:t,lr:i,lrs:n,vs:a,sp:r,sg:o})},setLastSet:function(t){e=t},setLastPage:function(e){t=e},setLastRoi:function(e){i=e},setLastRoiSet:function(e){n=e},setViewState:function(e){a=e},setLastSpecies:function(e,t){r=e,o=t}}}).controller("TrainingSetsCtrl",["$state","a2TrainingSets","Project","$q","$modal","a2TrainingSetHistory","a2UserPermit","notify",function(e,t,i,n,a,r,o,s){var c={set:e.params.set,show:e.params.show};this.selected={roi_index:0,roi:null,page:0},this.total={rois:0,pages:0},this.loading={list:!1,details:!1},this.rois=[],this.species="",this.songtype="",this.detailedView="gallery"!=c.show,this.currentrois=[],this.roisPerpage=100,this.detailedView=!1,this.loaderDisplay=!1,this.getROIVisualizerUrl=function(e){return e?"/project/"+this.projecturl+"/#/visualizer/rec/"+e.recording:""},this.setROI=function(e){return this.total.rois<=0?(this.selected.roi_index=0,this.selected.roi=null):(this.selected.roi_index=Math.max(0,Math.min(0|e,this.total.rois-1)),this.selected.roi=this.rois[this.selected.roi_index]),r.setLastRoi(this.selected.roi),this.selected.roi},this.setPage=function(e){return this.total.rois<=0?(this.selected.page=0,this.selected.currentrois=[]):(this.selected.page=Math.max(0,Math.min(e,this.total.rois/this.roisPerpage|0)),this.currentrois=this.rois.slice(this.selected.page*this.roisPerpage,(this.selected.page+1)*this.roisPerpage)),r.setLastPage(this.selected.page),this.currentrois},this.setROISet=function(e){this.rois=e,r.setLastRoiSet(this.rois)},this.nextROI=function(e){return this.setROI(this.selected.roi_index+(e||1))},this.prevROI=function(e){return this.setROI(this.selected.roi_index-(e||1))},this.nextPage=function(e){return this.setPage(this.selected.page+(e||1))},this.prevPage=function(e){return this.setPage(this.selected.page-(e||1))},this.next=function(e){e||(e=1),this.detailedView?this.nextROI(e):this.nextPage(e)},this.prev=function(e){return e||(e=1),this.next(-e)},this.removeRoi=function(e){if(!o.can("manage training sets"))return void s.error("You do not have permission to edit training sets");a.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.messages=["You are about to delete a ROI. Are you sure?"],this.btnOk="Yes, do it!",this.btnCancel="No"},controllerAs:"popup"}).result.then(function(){t.removeRoi(this.selected.trainingSet.id,e,function(t){if(t.affectedRows){for(var i=0;i<this.rois.length;i++)if(this.rois[i].id==e){this.rois.splice(i,1);break}this.total.rois=this.rois.length,this.setROI(this.selected.roi_index),this.setPage(this.selected.page)}}.bind(this))}.bind(this))},this.closeSetDetails=function(){this.showSetDetails=!1},this.getTrainingSetList=function(){return this.loading.list=!0,t.getList(function(e){if(this.trainingSets=e.map(function(e){return e.date_created=new Date(e.date_created),e}),c.set){var t=this.trainingSets.filter(function(e){return e.id==c.set}).pop();t&&this.selectTrainingSet(t)}this.loading.list=!1}.bind(this))},this.addNewTrainingSet=function(){if(!o.can("manage training sets"))return void s.error("You do not have permission to create training sets");a.open({templateUrl:"/app/visualizer/layers/training-data/add_tset_modal.html",controller:"a2VisualizerAddTrainingSetModalController"}).result.then(this.getTrainingSetList.bind(this))},this.selectTrainingSet=function(n){e.transitionTo(e.current.name,{set:n.id,show:e.params.show},{notify:!1}),this.detailedView="gallery"!=e.params.show,this.loaderDisplay=!0,r.setLastSet(n),this.selected.trainingSet&&this.selected.trainingSet.edit&&delete this.selected.trainingSet.edit,this.selected.trainingSet=n,i.validationBySpeciesSong(n.species,n.songtype,function(e){this.selected.trainingSet.validations=e}.bind(this)),t.getSpecies(n.id,function(e){this.species=e.species,this.songtype=e.songtype,r.setLastSpecies(this.species,this.songtype),t.getRois(n.id,function(e){this.loaderDisplay=!1,this.detailedView=!1,this.total.rois=e.length,this.total.pages=Math.ceil(this.total.rois/this.roisPerpage),this.setROISet(e),this.setROI(0),this.setPage(0),this.selected.page=0}.bind(this))}.bind(this))},this.setupExportUrl=function(){this.selected.trainingSet.export_url=t.getExportUrl(this.selected.trainingSet.id)},this.exportTSReport=function(e){return e.stopPropagation(),o.isSuper()?this.setupExportUrl():o.all&&!o.all.length||!o.can("export report")?s.error("You do not have permission to export Training Set data"):this.setupExportUrl()},this.setDetailedView=function(t){e.transitionTo(e.current.name,{set:e.params.set,show:t?"detail":"gallery"},{notify:!1}),this.detailedView=t,r.setViewState(this.detailedView)},this.editSelectedTrainingSet=function(){if(!o.can("manage training sets"))return void s.error("You do not have permission to edit training sets");if(this.selected.trainingSet){var e=this.selected.trainingSet,a={species:e.species,songtype:e.songtype};a.species_name=this.species,a.songtype_name=this.songtype,i.getClasses().then(function(i){var r=n.defer(),o=i.filter(function(e){return a.species==e.species&&a.songtype==e.songtype}).pop()||a;return e.edit={name:e.name,class:o,projectClasses:i},e.edit.cancel=r.reject.bind(r),e.edit.save=function(){return t.edit(e.id,{name:e.edit.name,class:e.edit.class.id}).then(function(e){r.resolve(e.data)},function(e){s.log(e.data)})},r.promise}).then(function(t){for(var i in t)e[i]=t[i];this.selectTrainingSet(e)}.bind(this)).finally(function(){delete e.edit})}},this.deleteSelectedTrainingSet=function(){var e=this.selected.trainingSet;if(e)return o.can("manage training sets")?void a.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.messages=['You are about to delete a the training set "'+e.name+'". Are you sure?'],this.btnOk="Yes, do it!",this.btnCancel="No"},controllerAs:"popup"}).result.then(function(){t.delete(e.id,function(t){this.trainingSets.splice(this.trainingSets.indexOf(e),1),delete this.selected.trainingSet}.bind(this))}.bind(this)):void s.error("You do not have permission to edit training sets")},this.getTrainingSetList(),this.projecturl=i.getUrl(),r.getLastSet(function(e){e.ls&&(this.showSetDetails=!0,this.selected.trainingSet=e.ls,this.species=e.sp,this.songtype=e.sg,this.detailedView=e.vs,this.total.rois=e.lrs.length,this.total.pages=Math.ceil(this.total.rois/this.roisPerpage),this.selected.page=e.lp,this.setROISet(e.lrs),this.setPage(e.lp),this.setROI(e.lr||0))}.bind(this))}]),angular.module("a2.jobs",["a2.services","a2.permissions"]).config(["$stateProvider",function(e){e.state("jobs",{url:"/jobs",controller:"StatusBarNavController",templateUrl:"/app/jobs/index.html"})}]).controller("StatusBarNavController",["$scope","$http","$modal","$window","Project","JobsData","notify","a2UserPermit",function(e,t,i,n,a,r,o,s){e.show={},e.showClassifications=!0,e.showTrainings=!0,e.showSoundscapes=!0,e.url="",e.successInfo="",e.showSuccesss=!1,e.errorInfo="",e.showErrors=!1,e.infoInfo="Loading...",e.showInfo=!0,e.loading={jobs:!1},e.loading.jobs=!0,e.updateFlags=function(){e.successInfo="",e.showSuccess=!1,e.errorInfo="",e.showError=!1,e.infoInfo="",e.showInfo=!1},a.getInfo(function(t){e.project=t});var c=function(e,i){t.get("/api/project/"+a.getUrl()+"/jobs/hide/"+e).success(function(e){r.updateJobs();const t="Job "+i+" successfully.";o.log(t)}).error(function(e){e.error?o.error(error):o.serverError()})};r.getJobTypes().success(function(t){var i=["#1482f8","#df3627","#40af3b","#9f51bf","#d37528","#ffff00","#5bc0de"],n=[1,2,4,6,7,8,9],a=t.filter(function(e){return n.includes(e.id)});e.job_types={},e.job_types.types=a,e.job_types.show={},e.job_types.for={},e.job_types.types.forEach(function(t,n){e.show[t.id]=!0,e.job_types.for[t.id]=t,t.color=i[n%i.length]})}),e.$watch(function(){return r.getJobs()},function(t){e.jobs=t,e.loading.jobs=!1,r.startTimer(),e.infoInfo="",e.showInfo=!1},!0),e.$on("$destroy",function(){r.cancelTimer()}),e.showActiveJobs=function(){return!e.loading.jobs&&void 0!==e.jobs&&e.jobs.length},e.showEmptyList=function(){return!e.loading.jobs&&void 0!==e.jobs&&!e.jobs.length},e.showLoader=function(){return void 0===e.jobs};var l=function(t,n,a,r,o){var s=i.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.title=t+" running job",this.messages=["This job has not finished yet. Are you sure?"],this.btnOk="Yes, "+n+" it",this.btnCancel="No"},controllerAs:"popup"});s.opened.then(function(){e.infoInfo="",e.showInfo=!1}),s.result.then(function(e){a(r,o)})};e.hide=function(t){if(!s.can("manage project jobs"))return void o.error("You do not have permission to hide or cancel jobs");const i=t.job_id;e.infoInfo="Loading...",e.showInfo=!0,t.percentage<100?l("Cancel","cancel",c,i,"canceled"):c(i,"hidden")},e.isCompleted=function(e){return"completed"===e.state},e.isProcessing=function(e){return"processing"===e.state},e.isWaiting=function(e){return"waiting"===e.state},e.openJob=function(e){n.location.href="/project/"+a.getUrl()+"/analysis/"+e.url}}]).service("JobsData",["$http","$interval","Project","$q",function(e,t,i,n){var a,r,o=i.getUrl(),s=!1;return updateJobs=function(){s||(s=!0,e.get("/api/project/"+o+"/jobs/progress",{params:{last3Months:!0}}).success(function(e){e.forEach(function(e){1===e.job_type_id&&0===e.completed&&"error"===e.state&&(e.state="error: insufficient validations"),2===e.job_type_id&&0===e.completed&&"completed"===e.state&&(e.state="processing")}),a=e,s=!1}))},updateJobs(),{geturl:function(){return o},getJobs:function(){return a},getJobTypes:function(){return e.get("/api/jobs/types")},updateJobs:function(){return updateJobs()},startTimer:function(){t.cancel(r),void 0!==a&&a.length>0&&(r=t(function(){for(var e=!0,i=0;i<a.length;i++)if(a[i].percentage<100){e=!1;break}e?t.cancel(r):a.length<1?t.cancel(r):updateJobs()},1e4))},cancelTimer:function(){t.cancel(r)}}}]),angular.module("a2.citizen-scientist",["a2.citizen-scientist.my-stats","a2.directive.audio-bar","a2.citizen-scientist.patternmatching","a2.citizen-scientist.expert","a2.citizen-scientist.admin","ui.router","ct.ui.router.extras"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/citizen-scientist","/citizen-scientist/patternmatching/"),e.state("citizen-scientist",{url:"/citizen-scientist",views:{"citizen-scientist":{templateUrl:"/app/citizen-scientist/index.html"}},deepStateRedirect:!0,sticky:!0})}]),angular.module("a2.app.dashboard",["a2.services","a2.directives","ui.bootstrap","ui.router","ct.ui.router.extras","a2.forms","humane","a2.googlemaps","a2.directive.warning-banner"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("dashboard",{url:"/dashboard",controller:"SummaryCtrl",templateUrl:"/app/dashboard/index.html"})}]).controller("SummaryCtrl",["$scope","Project","a2Templates","a2GoogleMapsLoader","$timeout","$window","$compile","$templateFetch","a2PatternMatching",function(e,t,i,n,a,r,o,s,c){e.loading=5;var l=function(){e.loading>0&&--e.loading};t.getInfo(function(i){e.project=i,e.isSpeciesLoading=!0,t.getProjectTotalSpecies(i.project_id,function(t){e.speciesQty=t||0,e.isSpeciesLoading=!1}),l()}),t.getSites(function(t){e.sites=t,l(),a(function(){n.then(function(t){e.map=new t.maps.Map(r.document.getElementById("summary-map"),{center:{lat:0,lng:0},mapTypeId:t.maps.MapTypeId.SATELLITE,zoom:8,minZoom:2});var i=new t.maps.LatLngBounds;angular.forEach(e.sites,function(n){if(!(n.lat>85||n.lat<-85||n.lon>180||n.lon<-180)){var a=new t.maps.LatLng(n.lat,n.lon),r=new t.maps.Marker({position:a,title:n.name});i.extend(a),r.setMap(e.map),e.map.fitBounds(i)}})})},100)}),t.getRecTotalQty(function(t){e.recsQty=t,l()}),i.getList().then(function(t){e.templateQty=t.length,l()}),c.getPatternMatchingsTotal(function(t){e.pmQty=t,l()})}]),angular.module("a2.settings",["a2.services","a2.directives","a2.forms","a2.orders","a2.permissions","a2.directive.sidenav-bar","ui.bootstrap","ui.router","ct.ui.router.extras","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/settings","/settings/details");var i=function(e){return e.can("manage project settings")};e.state("settings",{url:"/settings",templateUrl:"/app/settings/index.html",allowAccess:i}).state("settings.details",{url:"/details",controller:"SettingsDetailsCtrl",templateUrl:"/app/settings/details.html",allowAccess:i}).state("settings.users",{url:"/users",controller:"SettingsUsersCtrl",templateUrl:"/app/settings/users.html",allowAccess:i})}]).controller("SettingsDetailsCtrl",["$scope","Project","notify","$window","$timeout","a2order","a2UserPermit","$modal",function(e,t,i,n,a,r,o,s){e.today=new Date,t.getInfo(function(t){t.plan_activated&&t.plan_period&&(t.plan_due=new Date(t.plan_activated),t.plan_due.setFullYear(t.plan_due.getFullYear()+t.plan_period)),e.project=t}),t.getUsage().success(function(t){e.minUsage=t.min_usage}),e.save=function(){console.log(e),e.isValid&&(e.project.description||(e.project.description=""),t.updateInfo({project:e.project},function(e,t){return e?i.serverError():t.error?i.error(t.error):(i.log("Project info updated"),void(t.url&&a(function(){n.location.assign("/project/"+t.url+"/#/settings")},1e3)))}))},e.deleteProject=function(){if(!o.can("delete project"))return void i.error("You do not have permission to delete this project");e.popup={title:"Delete project",messages:["Are you sure you want to delete this project?"],btnOk:"Yes",btnCancel:"No"},s.open({templateUrl:"/common/templates/pop-up.html",scope:e}).result.then(function(){return t.removeProject({external_id:e.project.external_id}).then(function(){i.log("Project deleted"),n.location.href="/projects"})})},e.changePlan=function(){r.changePlan({})}}]).controller("SettingsUsersCtrl",["$scope","$http","Project","$modal","notify",function(e,t,i,n,a){e.userToAdd="",e.curQuery="",i.getInfo(function(t){e.project=t}),i.getUsers(function(t,i){e.users=i}),i.getRoles(function(t,i){e.roles=i}),e.findUser=function(i){return e.curQuery=i,t.get("/api/user/search/"+i).then(function(e){return e.data})},e.inviteUser=function(e){return t.post("/api/user/invite",e).then(function(e){return e.data})},e.add=function(){e.userToAdd&&i.addUser({project_id:e.project.project_id,user_id:e.userToAdd.id,user_email:e.userToAdd.email},function(t){t?a.error(t):(e.curQuery="",a.log("User added to project")),i.getUsers(function(t,i){e.users=i})})},e.invite=function(){e.showInvitationPopup(e.curQuery)},e.showInvitationPopup=function(t){n.open({templateUrl:"/app/settings/invitation.html",controller:"UserInvitationCtrl as controller",resolve:{email:function(){return t},inviteUser:function(){return e.inviteUser}}}).result.then(function(t){e.noResults=!1,e.userToAdd=t,e.userToAdd.id=t.user_id,e.add()})},e.changeRole=function(t){var n=e.roles.filter(function(i){return e.users[t].rolename===i.name})[0];i.changeUserRole({project_id:e.project.project_id,user_id:e.users[t].id,user_email:e.users[t].email,role_id:n.id},function(t){t?a.error(t):a.log("User role updated"),i.getUsers(function(t,i){e.users=i})})};const r=["Are you sure you would like to remove the following user from this project?"];e.del=function(t){const o=e.users[t];e.popup={messages:r.concat(o.firstname+" "+o.lastname+" ("+o.email+")"),btnOk:"Yes, do it!",btnCancel:"No"},n.open({templateUrl:"/common/templates/pop-up.html",scope:e}).result.then(function(){i.removeUser({project_id:e.project.project_id,user_id:e.users[t].id,user_email:e.users[t].email},function(t){t?a.error(t):a.log("User deleted from project"),i.getUsers(function(t,i){e.users=i})})})}}]).controller("UserInvitationCtrl",["$modalInstance","notify","email","inviteUser",function(e,t,i,n){Object.assign(this,{initialize:function(){this.isLoading=!1,this.data={email:i,firstname:"",lastname:""}},submit:function(){var i=this;try{return this.isLoading=!0,n(this.data).then(function(t){e.close(t)}).catch(t.serverError).finally(function(){i.isLoading=!1})}catch(e){console.error("UserInvitationCtrl.submit error: ",e)}},cancel:function(){e.close(null)},isDataValid:function(){return this.data.email.trim().length>0&&this.data.firstname.trim().length>0&&this.data.lastname.trim().length>0}}),this.initialize()}]),angular.module("a2.visualizer.audio-player",[]).service("a2AudioPlayer",["A2AudioObject","$q","notify","a2Playlists","Project","$localStorage","a2UserPermit",function(e,t,i,n,a,r,o){"use strict";var s=function(e,t){if(this.scope=e,this.gain=1,this.gain_levels=[1,2,5,10,15,20,25,30,50],this.freq_filter=void 0,this.is_playing=!1,this.is_muted=!1,this.has_recording=!1,this.has_next_recording=!1,this.has_prev_recording=!1,this.resource=null,this.resource_params={},this.isPopupOpened=!1,this.isSavingPlaylist=!1,this.playlistData={},this.clustersData=null,t&&(t.gain&&(this.gain=Math.min(Math.max(1,0|(t&&t.gain)),this.gain_levels[this.gain_levels.length-1]),this.resource_params.gain=this.gain),t.filter)){var i=t.filter.split("-"),n=0|i.shift(),a=0|i.shift(),r=Math.min(n,a),o=Math.max(n,a);o&&(this.freq_filter={min:r,max:o},this.resource_params.maxFreq=o,this.resource_params.minFreq=r)}e.$on("$destroy",this.discard.bind(this))};return s.prototype={setFrequencyFilter:function(e){return e?(this.resource_params.maxFreq=e.max,this.resource_params.minFreq=e.min):(delete this.resource_params.maxFreq,delete this.resource_params.minFreq),this.load(this.resource_url).then(function(){this.freq_filter=e}.bind(this))},setGain:function(e){return e=Math.max(1,0|e),1!=e?this.resource_params.gain=e:delete this.resource_params.gain,(this.resource_url?this.load(this.resource_url):t.resolve()).then(function(){this.gain=e}.bind(this))},getVolume:function(){return this.resource&&this.resource.audio.volume},setCurrentTime:function(e){this.resource&&this.resource.setCurrentTime(e)},getCurrentTime:function(){return this.resource&&this.resource.audio&&this.resource.audio.currentTime},togglePopup:function(){this.isPopupOpened=!this.isPopupOpened},isPlaylistDataValid:function(){return this.playlistData.playlistName&&this.playlistData.playlistName.trim().length>0},closePopup:function(){this.isPopupOpened=!1},savePlaylist:function(){if(this.isSavingPlaylist=!0,this.clustersData&&this.clustersData.playlist){var e=this;n.create({playlist_name:this.playlistData.playlistName,params:this.clustersData.playlist.recordings,aedIdsIncluded:!0},function(t){e.isSavingPlaylist=!1,e.closePopup(),t&&t.playlist_id&&n.attachAedToPlaylist({playlist_id:t.playlist_id,aed:e.clustersData.aed},function(t){e.playlistData={},i.log("Audio event detections are saved in the playlist.")})})}},_load_resource:function(t,i){if(this.loading=!0,i){var n=Object.keys(i);if(n.length){t+=(/\?/.test(t)?"&":"?")+n.map(function(e){return e+"="+i[e]}).join("&")}}var a=new e(t);return a.onCompleteListeners.push(function(){this.is_playing=!1}.bind(this)),a.load_promise.then(function(){this.loading=!1}.bind(this)).then(function(){return a})},load:function(e){return this.discard(),this.resource=void 0,this._load_resource(e,this.resource_params).then(function(t){this.resource=t,this.duration=t.duration,this.resource_url=e,this.has_recording=!0,this.clustersData=JSON.parse(r.getItem("analysis.clusters")),console.log("clustersData",this.clustersData)}.bind(this))},discard:function(){this.stop(),this.resource&&this.resource.discard(),this.has_recording=!1,this.resource=void 0,this.resource_url=void 0},mute:function(e){this.resource&&this.resource[e?"mute":"unmute"](),this.is_muted=e},play:function(){this.resource&&(this.resource.play(),this.is_playing=!0)},pause:function(){this.resource&&this.resource.pause(),this.is_playing=!1},stop:function(){this.resource&&this.resource.stop(),this.is_playing=!1},prev_recording:function(){this.scope.$broadcast("prev-visobject")},next_recording:function(){this.scope.$broadcast("next-visobject")},download:function(e){return o.isSuper()?this.getExportUrl(e):o.all&&!o.all.length||!o.can("export report")?i.error("You do not have permission to download recording"):this.getExportUrl(e)},getExportUrl:function(e){const t=document.createElement("form");t.style.display="none",t.method="GET";const i="/api/project/"+a.getUrl()+"/recordings/download/"+e.id;t.action=i,document.body.appendChild(t),t.submit(),document.body.removeChild(t)}},s}]).factory("A2AudioObject",["$window","$interval","$q",function(e,t,i){function n(t){var n=i.defer(),a=new e.Audio;return t=t.replace("|","/"),a.addEventListener("error",function(e){console.log("err",e),n.reject()}),a.addEventListener("loadstart",function(){n.resolve(a)}),e.setTimeout(function(){a.src=t},1),n.promise}var a=function(e){i.defer();this.url=e,this.onCompleteListeners=[],this.interval=t(this._check_current_time.bind(this),50),this.load_promise=n(e).then(function(e){this.audio=e,this.audio.addEventListener("canplay",function(){this.duration=this.audio.duration,this.paused=this.audio.paused,this.src=this.audio.src,this.canPlay=!0}.bind(this)),this.audio.addEventListener("error",function(e){this.canPlay=!1,console.log(e)}.bind(this))}.bind(this),function(e){this.error=!0,console.log("Unable to listen to your recordings due to corrupted data")}.bind(this))};return a.prototype={play:function(){return this.audio.play(),this},complete:function(e){this.onCompleteListeners.push(e)},pause:function(){this.audio.pause()},restart:function(){this.audio.pause(),this.audio.currentTime=0},stop:function(){this.restart()},discard:function(){this.discarded||(this.discarded=!0),this.context&&(this.context.close(),this.context=void 0),this.interval&&(t.cancel(this.interval),this.interval=void 0)},setVolume:function(e){this.unmutedVolume=e,this.muted=!1,this.audio.volume=e},setPlaybackRate:function(e){this.audio.playbackRate=e},setMuting:function(e){this.muted=e,this.audio.volume=+this.muted*this.unmutedVolume},setProgress:function(e){this.audio&&this.audio.duration&&isFinite(e)&&(this.audio.currentTime=this.audio.duration*e)},setCurrentTime:function(e){this.audio&&this.audio.duration&&(this.audio.currentTime=e)},_check_current_time:function(){this.audio&&(this.currentTime=this.audio.currentTime,this.currentTime>=this.duration&&this.onCompleteListeners.forEach(function(e){e(this)}))}},a}]),angular.module("visualizer-layers",["visualizer-services","a2.utils"]).directive("a2VisualizerLayerItem",["layer_types","$compile","$templateFetch",function(e,t,i){return{restrict:"E",replace:!0,templateUrl:"/app/visualizer/layer-item/default.html",link:function(n,a,r){var o=!!e[n.layer.type]&&n.layer.type,s=e[o]?e[o].type:null;if(s&&"default"!=s){var c="/app/visualizer/layer-item/"+s+".html";i(c,function(e){var i=t(e)(n);a.append(i.children().unwrap())})}}}}]),angular.module("visualizer-services",["a2.services"]).provider("layer_types",function(){var e=[];return{addLayerType:function(t){return e.push(t),this},$get:function(){var t={};return e.forEach(function(e){t[e.type]=e}),t}}}).service("a2VisualizerLayers",["layer_types","$controller",function(e,t){var i=function(e,t){this.$scope=e,this.VisualizerCtrl=t,this.list=[]};return i.prototype={types:e,__new_layer__:function(e){var i=this.types[e];if(i){var n=function(){};n.prototype=i;var a=new n;if(a.controller&&"string"==typeof a.controller){var r=/^(.*?)( as (.*?))$/.exec(a.controller);r&&(a[r[2]?r[3]:"controller"]=t(r[1],{$scope:this.$scope,VisualizerCtrl:this.VisualizerCtrl}))}return a}return null},add:function(){for(var t=arguments,i=0,n=t.length;i<n;++i){var a=t[i];e[a]?this.list.push(this.__new_layer__(a)):console.warn("Unknown layer of type "+a+".")}},__check_type:function(e,t){if(e instanceof Array){if(-1==e.indexOf(t))return!1}else if(t!=e)return!1;return!0},check_requirements:function(e){var t=this.$scope.visobject_type,i=this.$scope.visobject?this.$scope.visobject.type:t;return!e||!(e.selection&&!this.$scope.visobject)&&(!(e.type&&!this.__check_type(e.type,i))&&(!(e.browsetype&&!this.__check_type(e.browsetype,t))&&!(e.that&&!e.that(this.$scope))))},sidebar_visible:function(e){return!(e.sidebar_visible&&!e.sidebar_visible($scope))&&!!this.check_requirements(e.require)},spectrogram_visible:function(e){return this.check_requirements(e.require)&&e.visible},display_sidebar:function(e){return!e.display||!1!==e.display.sidebar},display_spectrogram:function(e){return!e.display||e&&e.display&&!1!==e.display.spectrogram}},i}]).provider("training_set_types",function(){var e=[];return{add:function(t){return e.push(t),this},$get:function(){return e.reduce(function(e,t){return e[t.type]=t,e},{})}}}).controller("a2ProjectClasses",["Project",function(e){var t=this;e.getClasses(function(e){t.list=e})}]).service("a22PointBBoxEditor",["$timeout","a2TrainingSets","training_set_types",function(e,t,i){var n=function(){this.min_eps=.001,this.scalex=1,this.scaley=.001,this.reset()};return n.prototype={reset:function(){return this.bbox=null,this.points=null,this.tracer=null,this.valid=!1,this},make_new_bbox:function(){this.bbox={},this.points=[],this.valid=!1},add_tracer_point:function(e,t){if(this.bbox&&!this.valid){var i=[e,t];this.tracer=i,this.validate([i])}},add_point:function(e,t,i){i=i||this.min_eps;var n=this.points&&this.points.filter(function(n){var a=(n[0]-e)*this.scalex,r=(n[1]-t)*this.scaley;return a*a+r*r<=i});n&&n.length>0||(this.bbox||this.make_new_bbox(),this.points.length<2&&this.points.push([e,t]),this.validate())},validate:function(e){var t=this.points.map(function(e){return e[0]}),i=this.points.map(function(e){return e[1]});e&&(t.push.apply(t,e.map(function(e){return e[0]})),i.push.apply(i,e.map(function(e){return e[1]}))),this.bbox.x1=Math.min.apply(null,t),this.bbox.y1=Math.min.apply(null,i),this.bbox.x2=Math.max.apply(null,t),this.bbox.y2=Math.max.apply(null,i),this.valid=this.points.length>=2}},n.prototype.super=n.prototype,n}]),angular.module("a2.soundscapeRegionTags",["a2.infotags"]).directive("a2SoundscapeRegionTag",["$injector",function(e){var t=function(t,n,a){var r=n.children(".txt"),o=["default","primary","success","info","warning","danger"],s={species_sound:"blue"};if(a?n.show():n.hide(),t.class="",t.style={},"string"==typeof a)r.text(a),t.class="label-default";else{var c=a.type,l=a.text||a.tag,u=a.color||"default";t.count=void 0===a.count?"":0|a.count,"species_sound"==c?e.invoke(i,this,{element:r,text:l,$scope:t}):(c="normal",r.text(l)),"default"==u&&s[c]&&(u=s[c]),o.indexOf(u)>=0?t.class="label-"+u:t.style["background-color"]=u}},i=function(e,t,i,n){e.empty().append(i('<a2-species species="'+(0|t)+'"></a2-species species>')(n))};return i.$inject=["element","text","$compile","$scope"],{restrict:"E",scope:{tag:"=",closeable:"=?",showCount:"=?",onClose:"&"},replace:!0,templateUrl:"/app/visualizer/soundscape-region-tag.html",link:function(e,i,n){e.$watch("tag",function(n){t(e,i,n)})}}}]),angular.module("visualizer-spectrogram",["visualizer-services","a2.filter.round","a2.utils"]).service("a2AffixCompute",function(){return function(e,t,i){var n,a=t.attr("data-affix-container");a&&(n=i[a]),n||(n={left:0,top:0,width:e.width(),height:e.height()});var r=(t.width(),t.height(),0|t.attr("data-affix-left")),o=t.attr("data-affix-right"),s=t.attr("data-affix-align-h");void 0!==o?r=n.left+n.width-t.width()-(0|o):void 0!==s?r=n.left+(n.width-t.width())*s:r+=n.left;var c=0|t.attr("data-affix-top"),l=t.attr("data-affix-bottom"),u=t.attr("data-affix-align-v");void 0!==l?c=n.top+n.height-t.height()-(0|l):void 0!==u?c=n.top+(n.height-t.height())*u:c+=n.top,t.css({position:"absolute",left:Math.round(r+e.scrollLeft()),top:Math.round(c+e.scrollTop())})}}).directive("a2VisualizerSpectrogram",["a2BrowserMetrics","a2AffixCompute",function(e,t){return{restrict:"E",templateUrl:"/app/visualizer/visualizer-spectrogram.html",replace:!0,link:function(i,n,a){function r(e,t,i,a,r,l){var u=e.l.domain||{},d={visualizer_root:t,spectrogram:t.children(".spectrogram-container"),y_axis:u.y&&t.children(".axis-y"),x_axis:u.x&&t.children(".axis-x"),legend:u.legend&&t.children(".legend")};Object.keys(d).forEach(function(t){var i=d[t];if(i){var n=i,a=e.l[t];a.css&&n.css(a.css),a.attr&&n.attr(a.attr)}}),u.x&&o(e),u.y&&s(e),u.legend&&c(e),l&&(n.scrollTop(Math.min(e.l.scroll_center.top,e.l.spectrogram.css.height-e.viewport.height)),n.scrollLeft(Math.min(e.l.scroll_center.left,e.l.spectrogram.css.width-e.viewport.width))),i.onScrolling()}function o(e){var t=d3.select(n.children(".axis-x").empty()[0]),i=e.spectrogram.height,a=e.l.domain,r=e.l.scale.x;t.style("height",100),t.style("scale","none"),t.append("rect").attr({class:"bg",x:0,y:1,width:e.l.x_axis.attr.width,height:i+l.axis_lead}),t.append("g").attr("class","axis").attr("transform","translate("+l.axis_lead+", 1)").call(u(a.x,r,"bottom"))}function s(e){
var t=d3.select(n.children(".axis-y").empty()[0]),i=e.spectrogram.height,a=e.l.domain,r=e.l.scale.y;t.style("width",61),t.style("scale","none"),t.append("rect").attr({class:"bg",x:0,y:0,width:e.l.y_axis.attr.width+1,height:i+l.axis_lead+1}),t.append("rect").attr({class:"bg",x:0,y:0,width:e.l.y_axis.attr.width-l.axis_lead,height:i+l.axis_lead+l.axis_sizeh}),t.append("g").attr("class","axis").attr("transform","translate("+l.axis_sizew+", "+l.axis_lead+")").call(u(a.y,r,"left"))}function c(e){var t=d3.select(n.children(".legend").empty()[0]),i=e.spectrogram.height,a=e.l.domain;t.append("rect").attr({class:"bg",x:l.axis_lead,y:0,width:e.l.legend.attr.width,height:e.l.legend.attr.height}),t.append("image").attr({class:"legend-image",x:l.legend_axis_w,y:l.axis_lead,width:l.legend_width-l.legend_axis_w,height:i,preserveAspectRatio:"none","xlink:href":a.legend.src}),t.append("rect").attr({class:"border",x:l.legend_axis_w,y:l.axis_lead,width:l.legend_width-l.legend_axis_w,height:i}),t.append("g").attr("class","axis").attr("transform","translate("+l.legend_axis_w+", "+(l.axis_lead+1)+")").call(u(a.legend,e.l.scale.legend,"left"))}var l=i.layout.tmp;n.children(".spectrogram-container");i.onPlaying=function(e){i.layout.y_axis.left=n.scrollLeft(),n.children(".axis-y").css({left:i.layout.y_axis.left+"px"}),i.layout.x_axis.top=Math.min(i.layout.spectrogram.top+i.layout.spectrogram.height,n.scrollTop()+n.height()-l.axis_sizeh),n.children(".axis-x").css({top:i.layout.x_axis.top+"px"})},i.onScrolling=function(a){var r=i.layout,o=r.spectrogram.height-r.viewport.height,s=r.spectrogram.width-r.viewport.width;n.scrollTop()>o&&n.scrollTop(o),n.scrollLeft()>s&&n.scrollLeft(s),r.bbox={s1:(n.scrollLeft()-r.spectrogram.left)/r.scale.sec2px,s2:(n.scrollLeft()-r.spectrogram.left+n.width())/r.scale.sec2px,hz1:(r.spectrogram.top+r.spectrogram.height-n.scrollTop()-n.height())/r.scale.hz2px,hz2:(r.spectrogram.top+r.spectrogram.height-n.scrollTop())/r.scale.hz2px},r.center={s:(n.scrollLeft()-r.spectrogram.left+n.width()/2)/r.scale.sec2px,hz:(r.spectrogram.top+r.spectrogram.height-n.scrollTop()-n.height()/2)/r.scale.hz2px},r.y_axis.left=n.scrollLeft(),n.children(".axis-y").css({left:r.y_axis.left+"px"}),r.x_axis.top=n.scrollTop()+n.height()-l.axis_sizeh-l.gutter,n.children(".axis-x").css({top:r.x_axis.top-1+"px"}),r.legend&&(r.legend.left=n.scrollLeft()+n.width()-e.scrollSize.width-l.legend_width-l.legend_gutter,n.children(".legend").css({left:r.legend.left+"px"})),n.find(".a2-visualizer-spectrogram-affixed").each(function(e,i){t(n,$(i),r)})},i.onMouseMove=function(e){var t=n.offset(),a=e.pageX-t.left+n.scrollLeft()-i.layout.spectrogram.left,r=e.pageY-t.top+n.scrollTop()-i.layout.spectrogram.top;a=Math.min(Math.max(a,0),i.layout.spectrogram.width),r=Math.min(Math.max(r,0),i.layout.spectrogram.height),i.pointer.x=a,i.pointer.y=r,i.pointer.sec=i.layout.x2sec(a),i.pointer.hz=i.layout.y2hz(r)};var u=function(e,t,i){var n=d3.svg.axis();return e.ticks&&n.ticks(e.ticks),e.tick_format?n.tickFormat(e.tick_format):e.unit_format&&n.tickFormat(e.unit_format),n.scale(t).orient(i),n};i.layout.listeners.push(function(e,t,i,n,a,o){r(e,t,i,n,a,o)}),i.getRecordingPlaybackTime=function(){return i.audio_player.getCurrentTime()},i.$watch(function(){return{h:n.height(),w:n.width()}},function(e,t){i.layout.apply(n,i,e.w,e.h,!0)},!0),i.$watch(function(){return i.layout.scale.sec2px*i.getRecordingPlaybackTime()|0},function(e,t){if(i.audio_player.is_playing){var a=l.axis_sizew+e,r=n.scrollLeft(),o=r+n.width()/2,s=a-o;s>0&&n.scrollLeft(r+s)}},!0),i.$watch("visobject",function(e,t){n.scrollLeft(0),n.scrollTop(999999),i.layout.apply(n,i,n.width(),n.height())},!0),n.bind("resize",function(){i.$apply()}),i.$watch("layout.scale.zoom.x",function(e,t){i.layout.apply(n,i,n.width(),n.height(),!0)}),i.$watch("layout.scale.zoom.y",function(e,t){i.layout.apply(n,i,n.width(),n.height(),!0)}),i.$watch("layout.scale.originalScale",function(e,t){i.layout.apply(n,i,n.width(),n.height(),!0)}),i.layout.apply(n,i,n.width(),n.height()),i.onScrolling()}}}]).directive("a2VisualizerSpectrogramLayer",["layer_types","$compile","$templateFetch",function(e,t,i){return{restrict:"E",templateUrl:"/app/visualizer/spectrogram-layer/default.html",replace:!0,link:function(n,a,r){var o=!!e[n.layer.type]&&n.layer.type,s=e[o]?e[o].type:null;if(a.addClass(o),s&&"default"!=s){var c="/app/visualizer/spectrogram-layer/"+s+".html";i(c,function(e){var i=t(e)(n);a.append(i)})}}}}]).directive("a2VisualizerSpectrogramAffixed",["a2AffixCompute","$debounce",function(e,t){return{restrict:"A",link:function(i,n,a){n.addClass("a2-visualizer-spectrogram-affixed");var r=n.closest(".visualizer-root"),o=n.offset(),s=r.offset();s&&(void 0===n.attr("data-affix-left")&&n.attr("data-affix-left",o.left-s.left),void 0===n.attr("data-affix-top")&&n.attr("data-affix-top",o.top-s.top)),a.a2VisualizerSpectrogramAffixed&&(i.$watch(a.a2VisualizerSpectrogramAffixed,function(e,t){var i;if(t)for(i in t)n.attr("data-affix-"+i,null);if(e)for(i in e)n.attr("data-affix-"+i,e[i])}),e(n.offsetParent(),n,i.layout)),e(n.offsetParent(),n,i.layout),i.$watch(function(){return n.width()*n.height()},t(function(){e(n.offsetParent(),n,i.layout)}))}}}]),angular.module("a2.speciesValidator",["a2.utils","a2.infotags"]).directive("a2SpeciesValidator",["Project","a2UserPermit","notify","$filter",function(e,t,i,n){return{restrict:"E",scope:{recording:"=recording"},templateUrl:"/app/visualizer/validator-main.html",link:function(a,r,o){var s=function(e){var t;return(t=/number|string/.test(typeof e)?a.classes.filter(function(t){return t.id==e}).shift():e)&&[t.species,t.songtype].join("-")},c=function(e){var t=[e.species,e.songtype].join("-"),i=Object.values({present:e.present,presentReview:e.presentReview,presentAed:e.presentAed});a.validations[t]=i},l=function(){e.getClasses(function(e){a.classes=e;for(var t={},i=0;i<e.length;i++){var r=e[i];t[r.taxon]||(t[r.taxon]=[]),t[r.taxon].push(r)}for(var o in t)t[o]=n("orderBy")(t[o],["species_name","songtype_name"]);a.byTaxon=t,a.taxons=Object.keys(a.byTaxon).sort()})};a.$on("a2-persisted",l),a.classes=[],a.is_selected={},a.select=function(e,t,i){if(!$(i.target).is("a"))if(i.shiftKey){a.is_selected[t.id]=!0;var n={from:1/0,to:-1/0},r=a.byTaxon[e];r.forEach(function(e,t){a.is_selected[e.id]&&(n.from=Math.min(n.from,t),n.to=Math.max(n.to,t))});for(var o=n.from,s=n.to+1;o<s;++o)a.is_selected[r[o].id]=!0}else i.ctrlKey?a.is_selected[t.id]=!a.is_selected[t.id]:(a.is_selected={},a.is_selected[t.id]=!0)},a.validations={},a.validate=function(n){if(!t.can("validate species"))return void i.error("You do not have permission to validate species");var r,o=[],c={};for(var l in a.is_selected)a.is_selected[l]&&(r=s(l))&&!c[r]&&(c[r]=!0,o.push(r));o.length>0&&e.validateRecording(a.recording.id,{class:o.join(","),val:n,determinedFrom:"visualizer"},function(e){e.forEach(function(e){var t=s(e);2==e.val?delete a.validations[t]:a.validations[t]=Object.values({present:e.val,presentReview:0})})})},a.val_options=[{label:"Clear",val:2},{label:"Present",val:1},{label:"Absent",val:0}],a.val_state=function(e,t){t||(t=a.val_options);var i=s(e),n=a.validations[i];return void 0===n?void 0:1==n[0]||n[1]>0||n[2]>0?(t[1].showDropdown=n[1]>0||n[2]>0,t[1]):null==n[0]&&0==n[1]&&0==n[2]?void 0:t[2]},a.$watch("recording",function(e){a.validations={},e&&e.validations&&e.validations.forEach(c)}),l()}}}]),angular.module("a2.visualizer.directive.sidebar",[]).directive("visualizerSidebar",function(){return{restrict:"E",transclude:!0,templateUrl:"/app/visualizer/visualizer-sidebar.html",scope:{closed:"=?"},link:function(e,t,i){t.addClass("sidebar show"),e.toggleSidebar=function(){e.closed=!e.closed}}}}),angular.module("a2.visualizer",["ui.router","ct.ui.router.extras","a2.services","a2.utils","a2.visobjects","a2.visualizer.dialog","a2.visobjectsbrowser","a2.speciesValidator","visualizer-layers","a2.visualizer.directive.sidebar","a2.visualizer.layers.base-image-layer","a2.visualizer.layers.annotation-layer","a2.visualizer.layers.zoom-input-layer","a2.visualizer.layers.data-plot-layer","a2.visualizer.layers.recordings","a2.visualizer.layers.recording-soundscape-region-tags","a2.visualizer.layers.recording-tags","a2.visualizer.layers.species-presence","a2.visualizer.layers.soundscapes","a2.visualizer.layers.soundscape-composition-tool","a2.visualizer.layers.training-sets","a2.visualizer.layers.templates","a2.visualizer.layers.audio-events-layer","visualizer-spectrogram","visualizer-services","a2.visualizer.audio-player","a2-visualizer-spectrogram-Layout","a2-visualizer-spectrogram-click2zoom","a2.url-update-service","ui.bootstrap"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("visualizer",{url:"/visualizer",views:{visualizer:{controller:"VisualizerCtrl",templateUrl:"/app/visualizer/main.html"}},deepStateRedirect:!0,sticky:!0}).state("visualizer.view",{url:"/:type/:idA/:idB/:idC?gain&filter&a&clusters",params:{type:"",a:null,clusters:null,gain:null,filter:null,idA:{value:"",squash:!0},idB:{value:null,squash:!0},idC:{value:null,squash:!0}},controller:["$state","$scope",function(e,t){var i=e.params,n=[i.type];i.idA&&(n.push(i.idA),i.idB&&(n.push(i.idB),i.idC&&n.push(i.idC)));var a=n.join("/");t.location.whenBrowserIsAvailable(function(){t.$parent.$broadcast("set-browser-location",a,i.a),"rec"===i.type&&t.$parent.$broadcast("set-browser-annotations",i.idA?Number(i.idA):null,i.a?i.a:null)}),t.parseAnnotations&&t.parseAnnotations(i.a)}]})}]).directive("a2Visualizer",function(){return{restrict:"E",replace:!0,scope:{},controller:"VisualizerCtrl",templateUrl:"/app/visualizer/main.html"}}).service("a2VisualizerLocationManager",["$location",function(e){var t=function(e,t,i){this.scope=e,this.state=i,this.prefix=t,this.current="",this.__expected=""};return t.prototype={sync:function(){this.current!=this.__expected&&(this.__expected=this.current,this.scope.$broadcast("set-browser-location",this.current))},update_path:function(){this.set(this.current)},updateParams:function(e){var t=angular.extend({},this.state.params);for(var i in e){var n=e[i];void 0===n?delete t[i]:t[i]=n}console.log(t,this.state.current.name),this.state.transitionTo(this.state.current.name,t,{notify:!1})},set:function(t,i){if(i&&(this.__expected=t),e.path()!=this.prefix+t){console.log("a2VisualizerLocationManager::set_location",this.prefix+t,i);var n=e.search();delete n.a,e.path(this.prefix+t),e.search(n)}},path_changed:function(t){void 0===t&&(t=e.path()),t=""+t,0===t.indexOf(this.prefix)&&(this.current=t.substr(this.prefix.length))},whenBrowserIsAvailable:function(e){this.browserAvailable?e():(this.__onBrowserAvailable__||(this.__onBrowserAvailable__=[])).push(e)},notifyBrowserAvailable:function(){this.browserAvailable=!0,this.__onBrowserAvailable__&&(this.__onBrowserAvailable__.forEach(function(e){e()}),delete this.__onBrowserAvailable__)}},t}]).controller("VisualizerCtrl",["a2VisualizerLayers","$q","$location","$state","$scope","$localStorage","$timeout","itemSelection","Project","$controller","a2UserPermit","a2SpectrogramClick2Zoom","$rootScope","VisualizerObjectTypes","VisualizerLayout","a2AudioPlayer","a2VisualizerLocationManager","a2EventEmitter",function(e,t,i,n,a,r,o,s,c,l,u,d,p,f,h,g,m,v){var y=new v;this.on=y.on.bind(y),this.off=y.off.bind(y);var b=new e(a,this),_=(b.types,{gain:n.params.gain,filter:n.params.filter});a.parseAnnotations=function(e){a.annotations=e?(Array.isArray(e)?e:e.split("|")).map(function(e){var t=e.split(","),i={type:t.shift(),value:[]};return t.forEach(function(e){var t=e.split(":");if(t.length>1){var n=t.shift();i[n]=t[1].join(":")}else i.value.push(e)}),i}):[]},n.params.clusters&&r.setItem("analysis.clusters.playlist",n.params.idA),a.parseAnnotations(n.params.a),a.layers=b.list,a.addLayer=b.add.bind(b),a.fullfillsRequirements=b.check_requirements.bind(b),a.isSidebarVisible=b.sidebar_visible.bind(b),a.isSpectrogramVisible=b.spectrogram_visible.bind(b),a.canDisplayInSidebar=b.display_sidebar.bind(b),a.canDisplayInSpectrogram=b.display_spectrogram.bind(b),u.all&&1===u.all.length&&u.all.includes("use citizen scientist interface")&&!u.can("delete project")&&!u.isSuper()?b.add("base-image-layer","recording-layer","templates","zoom-input-layer"):b.add("base-image-layer","annotation-layer","data-plot-layer","recording-layer","recording-tags-layer","soundscape-info-layer","soundscape-regions-layer","recording-soundscape-region-tags","species-presence","training-data","templates","soundscape-composition-tool","zoom-input-layer","audio-events-layer"),a.visobject=null;var x=new m(a,"/visualizer/",n);a.location=x,a.annotation={},a.set_location=x.set.bind(x),a.layout=new h,a.click2zoom=new d(a.layout),a.Math=Math,a.pointer={x:0,y:0,sec:0,hz:0},a.selection=s.make("layer"),a.getLayers=function(){return a.layers},a.setVisObject=function(e,o,s){if(!a.isUploading)return a.isUploading=!0,t.resolve().then(function(){if(e){a.visobject_location=s,a.location.set(s,!0);var t=f.getLoader(o);return a.loading_visobject=t.getCaptionFor(e),t.load(e,a).then(function(e){if(console.log("VisObject loaded : ",e),a.$parent.$broadcast("clear-recording-data",!0),r.getItem("analysis.clusters.playlist")===n.params.idA){var t=JSON.parse(r.getItem("analysis.clusters"));console.log("clustersData",this.clustersData),t&&t.boxes&&n.params.idB&&this.parseAnnotations(t.boxes[n.params.idB])}else a.removeFromLocalStorage(),this.parseAnnotations(i.search().a);a.loading_visobject=!1,a.visobject=e,a.visobject_type=e.type,a.setYScaleOptions()}.bind(this))}a.visobject=null}.bind(this)).then(function(){y.emit("visobject",a.visobject),a.isUploading=!1})},a.removeFromLocalStorage=function(){r.setItem("analysis.clusters",null),r.setItem("analysis.clusters.playlist",null),n.params.clusters=""},a.getSelectedFrequencyCache=function(){try{return JSON.parse(r.getItem("visuilizer.frequencies.cache"))||{originalScale:!0}}catch(e){return{originalScale:!0}}},a.deselectFrequencyOptions=function(){a.yAxisOptions.forEach(function(e){return e.active=!1})},a.setYScaleOptions=function(){a.scaleCache=a.getSelectedFrequencyCache(),a.convertedScale=a.visobject&&a.visobject.max_freq?+a.visobject.max_freq/1e3:"X",a.yAxisOptions=[{title:"24 kHz scale",value:"24_scale",active:!1},{title:"Original scale ("+a.convertedScale+" kHz)",value:"original_scale",active:!0}],a.scaleCache&&!a.scaleCache.originalScale&&a.convertedScale<24&&(a.deselectFrequencyOptions(),a.yAxisOptions[0].active=!0),a.convertedScale>=24&&(a.deselectFrequencyOptions(),a.yAxisOptions[1].active=!0)},a.resizeYScale=function(e){a.deselectFrequencyOptions(),e.active=!0;var t="original_scale"===e.value;r.setItem("visuilizer.frequencies.cache",JSON.stringify({originalScale:t})),a.layout.scale.originalScale=t;var i=t?a.visobject.sampling_rate/2:24e3;a.visobject.domain.y.to=i,a.visobject.domain.y.span=i},a.audio_player=new g(a,_),a.$on("browser-vobject-type",function(e,t){a.visobject_type=t}),a.$on("browser-available",function(){a.location.notifyBrowserAvailable()}),p.$on("notify-visobj-updated",function(){var e=Array.prototype.slice.call(arguments,1);e.unshift("visobj-updated"),a.$broadcast.apply(a,e)}),a.$on("visobj-updated",function(e){a.setVisObject(a.visobject,a.visobject_type,a.visobject_location)})}]).filter("filterPresentCount",function(){return function(e){if(!e)return 0;var t=0;return e.forEach(function(e){(e.presentReview>0||e.presentAed>0||1==e.present)&&t++}),t}}).filter("filterAbsentCount",function(){return function(e){if(!e)return 0;var t=0;return e.forEach(function(e){0==e.presentReview&&0==e.presentAed&&0==e.present&&t++}),t}}),angular.module("a2-visualizer-spectrogram-Layout",["a2.classy","a2-plot-specs"]).factory("VisualizerLayoutSpecs",["PlotSpecs",function(e){return e}]).factory("VisualizerLayout",["a2BrowserMetrics","makeClass","VisualizerLayoutSpecs","$localStorage",function(e,t,i,n){var a=function(e,t,i){if(void 0!==i&&t&&t.unit_interval){var n=t.from||0,a=t.unit_interval;return(e=Math.floor((e-n)/a)*a+n)+i*a}return e},r=function(e){return e&&e.domain||{x:{from:0,to:60,span:60,ticks:60,unit:"Time ( s )"},y:{from:0,to:22050,span:22050,unit:"Frequency ( kHz )",tick_format:function(e){return e/1e3|0}}}},o=function(e,t){var i;if(e.ordinal){var n=e.to-e.from,a=t[1]-t[0],r=a/n;i=d3.scale.linear().domain([e.from,e.to]).range([r/2+t[0],t[1]-r/2])}else i=d3.scale.linear().domain([e.from,e.to]).range(t);return i},s=function(e,t){var i=e*(t.length-1),n=Math.floor(i),a=Math.ceil(i),r=i-n;return t[n]*(1-r)+t[a]*r},c=s;return t({constructor:function(){this.scale={def_sec2px:100,def_hz2px:.02,max_sec2px:800,max_hz2px:.16,zoom:{x:0,y:0},sec2px:100,hz2px:.02,originalScale:null},this.offset={sec:0,hz:0},this.tmp=i,this.domain={},this.listeners=[]},x2sec:function(e,t){var i=e/this.scale.sec2px;return i+=this.offset.sec,a(+i,this.domain.x,t)},y2hz:function(e,t){var i=0|(this.spectrogram&&this.spectrogram.height),n=(i-e)/this.scale.hz2px;return n+=this.offset.hz,a(+n,this.domain.y,t)},sec2x:function(e,t,i){e=a(e-this.offset.sec,this.domain.x,i);var n=e*this.scale.sec2px;return t?0|n:+n},hz2y:function(e,t,i){e=a(e-this.offset.hz,this.domain.y,i);var n=0|(this.spectrogram&&this.spectrogram.height),r=n-e*this.scale.hz2px;return t?0|r:+r},dsec2width:function(e,t,i,n){n&&(e=a(e,this.domain.x,1));var r=(e-t)*this.scale.sec2px;return i?0|r:+r},dhz2height:function(e,t,i,n){n&&(e=a(e,this.domain.y,1));var r=(e-t)*this.scale.hz2px;return i?0|r:+r},apply:function(e,t,i,n,a){var r=t.visobject&&t.visobject.layout;this.type=r||"spectrogram",this["apply_"+this.type](e,t,i,n,a);for(var o=this.listeners,s=0,c=o.length;s<c;++s)o[s](this,e,t,i,n,a)},apply_spectrogram:function(t,i,n,a,s){var l=this.tmp,u=i.visobject,d=this.domain=r(u),p=n-l.axis_sizew-l.axis_lead;d.legend&&(p-=l.legend_width+l.legend_gutter);var f,h=a-l.axis_sizeh-l.axis_lead-l.gutter,g=(t[0].clientHeight,this.scale.zoom.levelx=[p/d.x.span,this.scale.max_sec2px]),m=this.scale.zoom.levely=[h/d.y.span,this.scale.max_hz2px],v=c(this.scale.zoom.x,g),y=c(this.scale.zoom.y,m),b=Math.max(p,Math.ceil(d.x.span*v)),_=Math.max(h,Math.ceil(d.y.span*y)),x=o(d.x,[0,b]),w=o(d.y,[_,0]),j=this.l={visualizer_root:{css:{overflow:""}}};j.spectrogram={css:{top:l.axis_lead,left:l.axis_sizew,width:b,height:_}},j.y_axis={scale:w,css:{top:0,left:t.scrollLeft()},attr:{width:l.axis_sizew,height:_+l.axis_lead+l.axis_sizeh}},j.x_axis={scale:x,css:{left:l.axis_sizew-l.axis_lead,top:t.scrollTop()+a-l.axis_sizeh-l.gutter},attr:{height:l.axis_sizeh,width:b+2*l.axis_lead}},this.has_legend=i.has_legend=!!d.legend,d.legend?(j.legend={scale:f,css:{top:0,left:t.scrollLeft()+n-e.scrollSize.width-l.legend_width-l.legend_gutter},attr:{width:l.legend_width,height:_+2*l.axis_lead}},f=d3.scale.linear().domain([d.legend.from,d.legend.to]).range([_-2,0])):j.legend={},["spectrogram","y_axis","x_axis","legend"].forEach(function(e){var t=j[e];this[e]=t.css,t.attr&&$.extend(this[e],t.attr),t.scale&&(this[e].scale=t.scale)}.bind(this)),this.offset.sec=d.x.from,this.offset.hz=d.y.from,this.scale.sec2px=b/d.x.span,this.scale.hz2px=_/d.y.span,this.viewport={left:j.spectrogram.css.left,top:j.spectrogram.css.top,width:p,height:h};var P=j.spectrogram.css.height,S=j.spectrogram.css.width;this.root={left:0,top:0,width:n-(h<P?e.scrollSize.width:0),height:a-(p<S?e.scrollSize.height:0)};var C;this.center&&(C={left:this.scale.sec2px*this.center.s+j.spectrogram.css.left-n/2,top:-this.scale.hz2px*this.center.hz-a/2+j.spectrogram.css.top+j.spectrogram.css.height}),j.domain=d,j.scroll_center=C,j.scale={x:x,y:w,legend:f}},apply_plotted:function(e,t,i,n,a){var r=(this.tmp,t.visobject,i),o=n;e[0].clientHeight;this.has_legend=t.has_legend=!1;var s=this.l={visualizer_root:{css:{overflow:"hidden"}}};s.spectrogram={css:{top:0,left:0,width:r,height:o}},s.scroll_center={left:0,top:0},this.spectrogram=s.spectrogram.css,this.viewport=angular.extend(s.spectrogram.css),this.root={left:0,top:0,width:i,height:n}}})}]),angular.module("a2-visualizer-spectrogram-click2zoom",["a2.classy"]).service("a2SpectrogramClick2Zoom",["makeClass","a22PointBBoxEditor",function(e,t){return e({super:t.prototype,toggle_active:function(){this.active=!this.active,this.active&&this.reset()},constructor:function(e){this.super.constructor.call(this),this.layout=e,this.active=!1},add_point:function(e,t,i){this.super.add_point.call(this,e,t),i&&this.zoom()},zoom_out:function(){var e=this.layout;this.active=!1,e.scale.zoom.x=Math.max(0,e.scale.zoom.x-.1),e.scale.zoom.y=Math.max(0,e.scale.zoom.y-.1)},zoom_reset:function(){var e=this.layout;this.active=!1,e.scale.zoom.x=0,e.scale.zoom.y=0},zoom:function(){var e=this.layout,t=this.bbox,i=t.x2-t.x1,n=t.y2-t.y1,a=[(t.x2+t.x1)/2,(t.y2+t.y1)/2],r=e.viewport.height,o=e.viewport.width,s=e.scale.zoom,c=o/i,l=r/n,u=Math.max(0,Math.min((c-s.levelx[0])/(s.levelx[1]-s.levelx[0]),1)),d=Math.max(0,Math.min((l-s.levely[0])/(s.levely[1]-s.levely[0]),1));this.active=!1,e.center={s:a[0],hz:a[1]},e.scale.zoom.x=u,e.scale.zoom.y=d,console.log("zoom :: ",[i,n],a,[u,d])}})}]).directive("a2ZoomControl",function(){return{restrict:"E",scope:{level:"="},templateUrl:"/directives/zoom-ctrl.html",replace:!0,link:function(e,t,i){var n=+i.delta||.1,a=!!(0|i.horizontal||/on|yes|true/.test(i.horizontal+""));e.horizontal=a,e.switched=a,e.step=function(t){e.level=Math.min(1,Math.max(e.level+t*n,0))},e.set_by_mouse=function(i){var n=t.find(".zoom-track"),a=n.offset(),r=(n.width()-(i.pageX-a.left))/n.width(),o=(n.height()-(i.pageY-a.top))/n.height(),s=e.horizontal?r:o;e.level=e.switched?1-s:s}}}}),angular.module("a2.analysis.audio-event-detection",["a2.filter.as-csv","a2.filter.time-from-now","a2.srv.resolve","a2.srv.open-modal","a2.service.audio-event-detection","a2.analysis.audio-event-detection.new-modal"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("analysis.audio-event-detection",{url:"/audio-event-detection",controller:"AudioEventDetectionAnalysisStateCtrl as controller",templateUrl:"/app/analysis/audio-event-detection/index.html"})}]).controller("AudioEventDetectionAnalysisStateCtrl",["$q","$promisedResolve","$openModal","a2UserPermit",function(e,t,i,n){this.initialize=function(){return this.reload()},this.reload=function(){return this.loading=!0,t({audioEventDetectionsList:["AudioEventDetectionService",function(e){return e.getList()}]},this).then(function(){this.loading=!1}.bind(this))},this.new=function(){return n.can("manage soundscapes")?i("audio-event-detection.new-modal",{resolve:{onSubmit:["AudioEventDetectionService",function(e){return e.new}]}}):void notify.error("You do not have permission to create audio event detections.")},this.initialize()}]),angular.module("a2.analysis.audio-event-detection.new-modal",["a2.srv.open-modal","a2.srv.resolve","a2.srv.playlists","humane","a2.directive.require-non-empty","a2.service.audio-event-detection"]).config(["$openModalProvider",function(e){e.define("audio-event-detection.new-modal",{templateUrl:"/app/analysis/audio-event-detection/new-modal.html",controllerAs:"controller",controller:"NewAudioEventDetectionModalCtrl",resolve:{onSubmit:function(){return null}}})}]).constant("AudioEventDetectionParametersEditTemplateUrls",{fltr:"/app/analysis/audio-event-detection/algorithm-fltr-edit-parameters.html"}).controller("NewAudioEventDetectionModalCtrl",["$q","$modalInstance","$promisedResolve","$parse","notify","AudioEventDetectionParametersEditTemplateUrls","onSubmit",function(e,t,i,n,a,r,o){this.playlists=[],this.algorithmsList=[],this.statisticsList=[];var s=n("[(playlist.name || '[Playlist]'), (algorithm.name || '[Algorithm]'), (parameters ? '(' + (parameters  | asCSV) + ')' : ''), (date | moment:'ll')] | asCSV:' / '");this.initialize=function(){return this.reload().then(function(){this.aed={algorithm:this.algorithmsList[0],statistics:this.statisticsList.slice(),playlist:null,date:new Date},this.notifyAedAlgorithmChanged()}.bind(this))},this.reload=function(){return this.loading=!0,i({playlists:["a2Playlists",function(e){return e.getList()}],algorithmsList:function(e){return e.getAlgorithmsList()},statisticsList:function(e){return e.getStatisticsList()}},this).then(function(){this.loading=!1}.bind(this))},this.notifyAedAlgorithmChanged=function(){var e=this.aed.algorithm||{};this.aed.parameters=e.defaults||{},this.algorithmParametersTemplate=r[e.name],this.recomputeDefaultName()},this.recomputeDefaultName=function(){this.aed.defaultName=s(this.aed)},this.ok=function(){return e.resolve().then(function(){return o&&o(this.aed)}.bind(this)).then(function(){return t.close(this.aed)}.bind(this)).catch(function(e){a.error(e)})},this.cancel=function(){t.dismiss("cancel")},this.initialize()}]),angular.module("a2.analysis.audio-event-detections-clustering",["ui.bootstrap","a2.srv.audio-event-detections-clustering","a2.services","a2.permissions","humane","a2.directive.error-message"]).config(["$stateProvider",function(e){e.state("analysis.audio-event-detections-clustering",{url:"/audio-event-detections-clustering",controller:"AudioEventDetectionsClusteringModelCtrl",templateUrl:"/app/analysis/audio-event-detections-clustering/list.html"})}]).controller("AudioEventDetectionsClusteringModelCtrl",["$scope","$modal","$location","JobsData","notify","a2AudioEventDetectionsClustering","Project","$localStorage","$window","a2UserPermit",function(e,t,i,n,a,r,o,s,c,l){e.loadAudioEventDetections=function(){return e.loading=!0,e.showRefreshBtn=!1,e.projectUrl=o.getUrl(),r.list({user:!0,dataExtended:!0,completed:!0,aedCount:!0}).then(function(t){e.audioEventDetectionsOriginal=t,e.audioEventDetectionsData=t,e.loading=!1,t&&t.length&&(e.showRefreshBtn=!0)})},e.loadAudioEventDetections(),e.onSelectedJob=function(e,t,i){s.setItem("analysis.audioEventJob",t),c.location.href="/project/"+o.getUrl()+"/visualizer/playlist/"+e+"/"+i},e.createNewClusteringModel=function(){if(!l.can("manage AED and Clustering job"))return void a.error("You do not have permission to create <br> Audio Event Detection job");t.open({templateUrl:"/app/analysis/audio-event-detections-clustering/new-audio-event-detection-clustering.html",controller:"CreateNewAudioEventDetectionClusteringCtrl as controller"}).result.then(function(t){data=t,data.create?(n.updateJobs(),e.showRefreshBtn=!0,a.log("Your new Audio Event Detection Clustering model is waiting to start processing.<br> Check its status on <b>Jobs</b>.")):data.error?a.error("Error: "+data.error):data.url&&i.path(data.url)})},e.deleteAedJob=function(i,n){if(n.stopPropagation(),!l.can("manage AED and Clustering job"))return void a.error("You do not have permission to delete <br> Audio Event Detection job");t.open({templateUrl:"/app/analysis/audio-event-detections-clustering/delete-audio-event-detection-clustering-job.html",controller:"DeleteAedJobCtrl as controller",resolve:{aedJob:function(){return i}}}).result.then(function(t){if(t.err)a.error("Error: "+t.err);else{const n=angular.copy(e.audioEventDetectionsOriginal),r=n.findIndex(function(e){return e.job_id===i.job_id});r>-1&&(e.audioEventDetectionsOriginal.splice(r,1),a.log("Audio Event Detection Job deleted successfully"))}})}}]).controller("DeleteAedJobCtrl",["$scope","$modalInstance","a2AudioEventDetectionsClustering","aedJob",function(e,t,i,n){this.aedJob=n,e.deletingloader=!1,e.ok=function(){e.deletingloader=!0,i.delete(n.job_id).then(function(e){t.close(e)})},e.cancel=function(){t.dismiss("cancel")}}]).controller("CreateNewAudioEventDetectionClusteringCtrl",["$modalInstance","a2AudioEventDetectionsClustering","a2Playlists","a2UserPermit","notify",function(e,t,i,n,a){Object.assign(this,{initialize:function(){this.loading={playlists:!1},this.details={show:!1};var e=this.list={};this.data={name:null,playlist:null,params:{areaThreshold:1,amplitudeThreshold:1,durationThreshold:.2,bandwidthThreshold:.5,filterSize:10,minFrequency:0,maxFrequency:24}},this.isRfcxUser=n.isRfcx(),this.isSuper=n.isSuper(),this.errorJobLimit=!1,this.loading.playlists=!0,i.getList({filterPlaylistLimit:!0}).then(function(t){this.loading.playlists=!1,e.playlists=t}.bind(this))},isRfcx:function(){return this.isRfcxUser||this.isSuper},checkLimit:function(e){return e>1e4&&!this.isRfcx()},toggleDetails:function(){this.details.show=!this.details.show},newJob:function(){try{return t.create({playlist_id:this.data.playlist.id,name:this.data.name,params:this.data.params}).then(function(t){e.close({create:!0,clusteringModel:t})}).catch(a.serverError)}catch(e){console.error("a2AudioEventDetectionsClustering.create error: "+e)}},create:function(){var e=this;return this.errorJobLimit=!1,this.isRfcx()?this.newJob():t.count().then(function(t){if(e.checkLimit(t.totalRecordings))return void(e.errorJobLimit=!0);e.newJob()})},cancel:function(t){e.close({cancel:!0,url:t})},isJobValid:function(){return this.data&&this.data.name&&this.data.name.length>3&&this.data.playlist&&!this.isNotDefined(this.data.params.maxFrequency)&&!this.isNotDefined(this.data.params.minFrequency)},showNameWarning:function(){return this.data&&this.data.name&&this.data.name.length>1&&this.data.name.length<4},showPlaylistLimitWarning:function(){if(this.data||this.data.playlist)return this.data&&this.data.playlist&&this.data.playlist.count>2e3&&!this.isRfcx()},showFrequencyWarning:function(){return this.data.params.maxFrequency<=this.data.params.minFrequency},isNotDefined:function(e){return void 0===e||null===e}}),this.initialize()}]),angular.module("a2.analysis.cnn",["ui.bootstrap","a2.directive.audio-bar","a2.srv.cnn","a2.services","a2.permissions","humane","c3-charts"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("analysis.disabled-cnn",{url:"/disabled/cnn",templateUrl:"/app/analysis/cnn/disabled.html"}).state("analysis.cnn",{url:"/cnn/",controller:"CNNCtrl",templateUrl:"/app/analysis/cnn/list.html"}).state("analysis.cnn-details",{url:"/cnn/:cnnId",controller:"CNNCtrl",templateUrl:"/app/analysis/cnn/list.html"})}]).controller("CNNCtrl",["$scope","$modal","$filter","$location","Project","ngTableParams","JobsData","a2CNN","a2Playlists","notify","$q","a2UserPermit","$state","$stateParams",function(e,t,i,n,a,r,o,s,c,l,u,d,p,f){console.log("CNN Version 1.0"),e.selectedCNNId=f.cnnId;var h=function(t,n,a,o,s){var c={},l="desc";"+"==a[0]&&(l="asc"),c[a.substring(1)]=l;var u={page:t,count:n,sorting:c,filter:o};e.tableParams=new r(u,{total:s,getData:function(t,n){e.infopanedata="";var a=n.filter()?i("filter")(e.cnnOriginal,n.filter()):e.cnnOriginal,r=n.sorting()?i("orderBy")(a,n.orderBy()):e.cnnOriginal;n.total(r.length),t.resolve(r.slice((n.page()-1)*n.count(),n.page()*n.count())),r.length<1&&(e.infopanedata="No cnn searches found."),e.cnnsData=r.slice((n.page()-1)*n.count(),n.page()*n.count())}})};e.loadCNNs=function(){return e.loading=!0,e.infoInfo="Loading...",e.showInfo=!0,s.list().then(function(t){e.cnnOriginal=t,e.cnnsData=t,e.infoInfo="",e.showInfo=!1,e.loading=!1,e.infopanedata="",t.length>0?e.tableParams?e.tableParams.reload():h(1,10,"-timestamp",{},t.length):e.infopanedata="No cnns found."})},e.selectedCNNId||e.loadCNNs(),e.createNewCNN=function(){if(!d.can("manage cnns"))return void l.error("You do not have permission to create cnn jobs.");t.open({templateUrl:"/app/analysis/cnn/createnewcnn.html",controller:"CreateNewCNNInstanceCtrl as controller"}).result.then(function(e){data=e,data.ok?(o.updateJobs(),l.log("Your new cnn is waiting to start processing.<br> Check its status on <b>Jobs</b>.")):data.error?l.error("Error: "+data.error):data.url&&n.path(data.url)})},e.deleteCNN=function(i,n){if(n.stopPropagation(),!d.can("manage cnns"))return void l.error("You do not have permission to delete cnns.");t.open({templateUrl:"/app/analysis/cnn/deletecnn.html",controller:"DeleteCNNInstanceCtrl as controller",resolve:{cnn:function(){return i}}}).result.then(function(t){t.err?l.error("Error: "+t.err):(l.log("CNN: ("+i.name+") deleted successfully"),e.loadCNNs())})},e.selectItem=function(e){e?p.go("analysis.cnn-details",{cnnId:e}):p.go("analysis.cnn",{})},e.setDetailedView=function(t){e.detailedView=t,
p.transitionTo(p.current.name,{patternMatchingId:e.selectedPatternMatchingId,show:t?"detail":"gallery"},{notify:!1})}}]).controller("DeleteCNNInstanceCtrl",["$scope","$modalInstance","a2CNN","cnn","Project",function(e,t,i,n,a){this.cnn=n,e.project_name=a.getUrl(),e.deletingloader=!1,e.ok=function(){e.deletingloader=!0,i.delete(n.job_id).then(function(e){t.close(e)})},e.cancel=function(){t.dismiss("cancel")}}]).controller("CreateNewCNNInstanceCtrl",["$scope","$modalInstance","a2PatternMatching","a2Templates","a2Playlists","a2CNN","notify",function(e,t,i,n,a,r,o){Object.assign(this,{initialize:function(){this.loading={playlists:!1,models:!1};var e=this.list={};e.lambdas=[{name:"call_id_testing:1 - create fake data",key:"new_cnn_job_test1"},{name:"function_id_driver - test real function",key:"new_cnn_job_v1"}],this.data={name:null,playlist:null,model:null,lambda:e.lambdas[0],params:{}},this.loading.models=!0,r.listModels().then(function(t){this.loading.models=!1,e.models=t}.bind(this)),this.loading.playlists=!0,a.getList().then(function(t){this.loading.playlists=!1,e.playlists=t}.bind(this))},ok:function(){try{return r.create({playlist_id:this.data.playlist.id,cnn_id:this.data.model.id,name:this.data.name,lambda:this.data.lambda.key,params:this.data.params}).then(function(e){t.close({ok:!0,cnn:e})}).catch(o.serverError)}catch(e){console.error("a2CNN.create error: "+e)}},cancel:function(e){t.close({cancel:!0,url:e})}}),this.initialize()}]).directive("a2CnnDetails",function(){return{restrict:"E",replace:!0,scope:{cnnId:"=",detailedView:"=",onSetDetailedView:"&",onGoBack:"&"},controller:"CNNDetailsCtrl",controllerAs:"controller",templateUrl:"/app/analysis/cnn/details.html"}}).controller("CNNDetailsCtrl",["$scope","$state","ngTableParams","a2AudioPlayer","$filter","a2CNN","a2UserPermit","Project","a2AudioBarService","notify",function(e,t,i,n,a,r,o,s,c,l){var u=s.getUrl();e.lists={thumbnails:[{class:"fa fa-th-large",value:""},{class:"fa fa-th",value:"is-small"}],search:[{value:"all",text:"All",description:"Show all matched rois."},{value:"present",text:"Present",description:"Show all rois marked as present."},{value:"not_present",text:"Not Present",description:"Show all rois marked as not present."},{value:"unvalidated",text:"Unvalidated",description:"Show all rois without validation."},{value:"by_score",text:"Score per Species",description:"Show rois ranked by score per species."},{value:"by_score_per_site",text:"Score per Site",description:"Show rois ranked by score per site."}],selection:[{value:"all",text:"All"},{value:"none",text:"None"},{value:"not-validated",text:"Not Validated"}],validation:[{class:"fa val-1",text:"Present",value:1},{class:"fa val-0",text:"Not Present",value:0},{class:"fa val-null",text:"Clear",value:null}],current:{thumbnailClass:"is-small"}},e.total={rois:0,pages:0},e.selected={roi_index:0,roi:null,page:0,search:e.lists.search[4]},e.validation={current:e.lists.validation[2]},e.offset=0,e.limit=100;var d=function(){e.CNNExportUrl=r.getExportUrl({cnnId:e.cnnId})};e.exportCnnReport=function(e){return e.stopPropagation(),o.isSuper()?d():o.all&&!o.all.length||!o.can("export report")?l.error("You do not have permission to export CNN data"):d()};var p=(new n(e),function(t,n,r,o,s){var c={},l="desc";"+"==r[0]&&(l="asc"),c[r.substring(1)]=l;var u={page:t,count:n,sorting:c,filter:o};e.tableParams=new i(u,{total:s,getData:function(t,i){e.infopanedata="";var n=i.filter()?a("filter")(e.cnnOriginal,i.filter()):e.cnnOriginal,r=i.sorting()?a("orderBy")(n,i.orderBy()):e.cnnOriginal;i.total(r.length),t.resolve(r.slice((i.page()-1)*i.count(),i.page()*i.count())),r.length<1&&(e.infopanedata="No cnn searches found."),cnnsData=r.slice((i.page()-1)*i.count(),i.page()*i.count()),"species"==e.viewType?e.species=cnnsData:"recordings"==e.viewType?e.recordings=cnnsData:e.mainResults=cnnsData}})});e.counts={recordings:null},e.onSelect=function(t){e.select(t.value)},e.select=function(t){var i=null;i="all"===t?function(e){e.selected=!0}:"none"===t?function(e){e.selected=!1}:"not-validated"===t?function(e){e.selected=null===e.validated}:function(e){e.selected=e.id===t},(e.resultsROIs||[]).forEach(i)};var f=function(){r.getDetailsFor(e.cnnId).then(function(t){e.job_details=t})};f();var h=function(e){var t={};return e.forEach(function(e){var i=e.species_id;i in t||(t[i]={count:0,species_id:i,scientific_name:e.scientific_name}),1==e.present&&t[i].count++}),t},g=function(e,t){t||(t=.9);var i=[];return e.forEach(function(e){e.over_thresh=e.score>=t,e.present=e.over_thresh,i.push(e)}),i.sort(function(e,t){return e.score<t.score?1:-1}),i},m=function(e,t){return dataOut={},e.forEach(function(e){var i=t?e.site:e.species_id+"_"+e.songtype_id;i in dataOut||(dataOut[i]={count:0,species_id:e.species_id,songtype_id:e.songtype_id,scientific_name:e.scientific_name,songtype:e.songtype,rois:[]},t&&(dataOut[i].site=e.site)),dataOut[i].rois.push(e),dataOut[i].count++}),dataOut},v=function(e){var t={total:0};return e.forEach(function(e){var i=e.recording_id,n=e.species_id;i in t||(t[i]={recording_id:i,thumbnail:e.thumbnail,species:{},total:0,species_list:""}),n in t[i].species||(t[i].species[n]={species_id:n,scientific_name:e.scientific_name,count:0}),1==e.present&&(0==t[i].species[n].count&&(t[i].species_list=t[i].species_list+" "+e.scientific_name),t[i].species[n].count++,t[i].total++)}),t},y=function(e,t){return speciesTimes=[],count=0,speciesName="All",e.forEach(function(e){if("all"==t|e.species_id==t&&(speciesName="all"==t?"All":e.scientific_name,1==e.present)){var i=new Date(e.datetime);i.getHours(),i.getMinutes();speciesTimes.push(new Date(3e3,0,1,i.getHours(),i.getMinutes())),count++}}),{times:speciesTimes,count:count,name:speciesName}},b=!1;e.showHist=function(t){e.speciesInfo=y(e.results,t);var i={x:e.speciesInfo.times,type:"histogram",xbins:{start:32503698e6,end:325037916e5,size:72e5}},n={title:e.speciesInfo.name+" by time of day.",xaxis:{tickformat:"%X",range:[new Date(3e3,0,1).getTime(),new Date(3e3,0,2).getTime()]}},a=[i];b?Plotly.newPlot("speciesHist",a,n):(Plotly.newPlot("speciesHist",a,n),b=!0)},e.getRecordingVisualizerUrl=function(e){return"/project/"+s.getUrl()+"/visualizer/rec/"+e},e.getRoiVisualizerUrl=function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+u+"/#/visualizer/rec/"+e.recording_id+"?a="+t:""},e.getTemplateVisualizerUrl=function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+u+"/visualizer/rec/"+e.recording+"?a="+t:""},e.playRoiAudio=function(e,t){t&&(t.preventDefault(),t.stopPropagation()),c.loadUrl(r.getAudioUrlFor(e),!0)},e.setPage=function(t,i){((t=Math.max(0,Math.min(t,e.total.rois/e.limit|0)))!=e.selected.page||i)&&(e.selected.page=t,e.offset=t*e.limit,_())},e.moveROIPage=function(t){var i=e.selected.page+t;i>e.total.pages-1?e.setPage(0):i<0?e.setPage(e.total.pages-1):e.setPage(i)},e.setSpecies=function(t){e.selected.species=t,e.selected.page=0,e.offset=0;var i="site_"+e.selected.site.site_id+"_"+e.selected.site.name;0==e.selected.site.site_id&&(i=0),e.counts.roi_species_counts=x(i,e.roi_species_sites_counts),e.counts.roi_sites_counts=w(e.selected.species.species_id,e.roi_species_sites_counts);var n=e.counts.roi_species_counts.reduce(function(e,t){return e+=t.N},0);all_species={species_id:0,N:n,scientific_name:"All Species"},e.counts.roi_species_counts.unshift(all_species);var a=e.counts.roi_sites_counts.reduce(function(e,t){return e+=t.N},0),r={site_id:0,N:a,name:"All Sites"};e.counts.roi_sites_counts.unshift(r),e.selected.site=e.counts.roi_sites_counts.find(function(t){return t.site_id==e.selected.site.site_id}),e.selected.species=e.counts.roi_species_counts.find(function(t){return t.species_id==e.selected.species.species_id}),e.total={rois:t.N,pages:Math.ceil(t.N/e.limit)},_()},e.counts={},e.setSite=function(t){e.selected.site=t,e.selected.page=0,e.offset=0;var i="site_"+e.selected.site.site_id+"_"+e.selected.site.name;0==e.selected.site.site_id&&(i=0),e.counts.roi_species_counts=x(i,e.roi_species_sites_counts),e.counts.roi_sites_counts=w(e.selected.species.species_id,e.roi_species_sites_counts);var n=e.counts.roi_species_counts.reduce(function(e,t){return e+=t.N},0);all_species={species_id:0,N:n,scientific_name:"All Species"},e.counts.roi_species_counts.unshift(all_species);var a=e.counts.roi_sites_counts.reduce(function(e,t){return e+=t.N},0),r={site_id:0,N:a,name:"All Sites"};e.counts.roi_sites_counts.unshift(r),e.selected.species=e.counts.roi_species_counts.find(function(t){return t.species_id==e.selected.species.species_id}),e.selected.site=e.counts.roi_sites_counts.find(function(t){return t.site_id==e.selected.site.site_id}),e.total={rois:t.N,pages:Math.ceil(t.N/e.limit)},_()};var _=function(){e.loading=!0,e.infoInfo="Loading...",e.showInfo=!0,r.listROIs(e.cnnId,e.limit,e.offset,e.selected.species.species_id,e.selected.site.site_id,e.selected.search.value).then(function(t){e.resultsROIs=t,e.infoInfo="",e.showInfo=!1,e.loading=!1,e.infopanedata="",e.rois=g(e.resultsROIs),e.rois_species=m(e.rois,"by_score_per_site"===e.selected.search.value)})};e.validate=function(){if(!o.can("validate cnn rois"))return void l.log("You do not have permission to validate the cnn rois.");var t=(e.validation.current||{value:null}).value,i=[];for(var n in e.rois_species)e.rois_species[n].rois.forEach(function(e){e.selected&&i.push(e)});var a=i.map(function(e){return e.cnn_result_roi_id});try{r.validateRois(e.cnnId,a,t).then(function(e){i.forEach(function(e){e.validated=t,e.selected=!1})})}catch(e){console.error("TCL: $scope.validate -> error",e)}f()},e.onScroll=function(e,t){this.scrollElement=t.scrollElement;var i=t.scrollElement.scrollY,n=t.anchors.header.offset().top;this.headerTop=0|n,this.scrolledPastHeader=i>=n};var x=function(e,t){0==e&&(e="total");var i=[];return t.forEach(function(t){i.push({species_id:t.species_id,N:t[e],scientific_name:t.scientific_name})}),i},w=function(e,t){0==e&&(e="total");var i=[];return t.forEach(function(t){if("total"==e|t.species_id==e)for(key in t)split=key.split("_"),site_id=split[1],name=split.slice(2).join("_"),"site"==split[0]&&(row={},row.site_id=site_id,row.N=t[key],row.name=name,i.push(row))}),"total"==e&&(roi_site_counts_dict=i.reduce(function(e,t){return t.site_id in e||(e[t.site_id]={site_id:t.site_id,N:0,name:t.name}),e[t.site_id].N+=t.N,e},{}),i=Object.values(roi_site_counts_dict)),i};e.onSearchChanged=function(){e.switchView("rois")},e.switchView=function(t,i){i&&window.scrollTo(0,0);var n="-cnn_presence_id";"rois"==t?r.countROIsBySpeciesSites(e.cnnId,{search:e.selected.search.value}).then(function(t){var i=t.data;e.roi_species_sites_counts=i,e.counts.roi_species_counts=x(e.selected.site?e.selected.site.site_id:0,e.roi_species_sites_counts),e.counts.roi_sites_counts=w(e.selected.species?e.selected.species.species_id:0,e.roi_species_sites_counts);var n=e.counts.roi_species_counts.reduce(function(e,t){return e+=t.N},0),a={species_id:0,N:n,scientific_name:"All Species"};e.counts.roi_species_counts.unshift(a),e.selected.species?e.selected.species=e.counts.roi_species_counts.find(function(t){return t.species_id==e.selected.species.species_id})||a:e.selected.species=a;var r={site_id:0,N:n,name:"All Sites"};e.counts.roi_sites_counts.unshift(r),e.selected.site?e.selected.site=e.counts.roi_sites_counts.find(function(t){return t.site_id==e.selected.site.site_id})||r:e.selected.site=r,e.total={rois:n,pages:Math.ceil(n/e.limit)},e.viewType="rois",_()}):e.results?function(){"species"==t?(e.species=h(e.results),e.viewType="species",n="-scientific_name",e.showHist(i||"all"),e.cnnOriginal=Object.values(e.species)):"recordings"==t?(e.recordings=v(e.results),e.counts.recordings=Object.keys(e.recordings).length,e.viewType="recordings",n="-recording_id",e.cnnOriginal=Object.values(e.recordings)):(e.viewType="all",e.mainResults=e.results,e.cnnOriginal=Object.values(e.results)),e.cnnOriginal.length>0?p(1,10,n,{},e.cnnOriginal.length):e.infopanedata="No cnn results found."}():(e.loading=!0,e.infoInfo="Loading...",e.showInfo=!0,r.listResults(e.cnnId).then(function(t){e.results=t,e.infoInfo="",e.showInfo=!1,e.loading=!1,e.infopanedata="",e.switchView("rois")}))},e.switchView(t.params.detailType?t.params.detailType:"all")}]),angular.module("a2.analysis.clustering-jobs",["ui.bootstrap","a2.srv.clustering-jobs","a2.srv.playlists","a2.services","a2.permissions","a2.directive.audio-bar","humane","a2.filter.round","a2.directive.frequency_filter_range_control"]).config(["$stateProvider",function(e){e.state("analysis.clustering-jobs",{url:"/clustering-jobs",controller:"ClusteringJobsModelCtrl",templateUrl:"/app/analysis/clustering-jobs/list.html"}).state("analysis.clustering-jobs-details",{url:"/clustering-jobs/:clusteringJobId?freqMin&freqMax",controller:"ClusteringJobsModelCtrl",params:{freqMin:null,freqMax:null},templateUrl:"/app/analysis/clustering-jobs/list.html"}).state("analysis.grid-view",{url:"/clustering-jobs/:clusteringJobId/grid-view",controller:"ClusteringJobsModelCtrl",params:{gridContext:null},templateUrl:"/app/analysis/clustering-jobs/list.html"})}]).controller("ClusteringJobsModelCtrl",["$scope","$state","$stateParams","a2ClusteringJobs","JobsData","notify","$location","$modal","a2UserPermit","$localStorage","Project",function(e,t,i,n,a,r,o,s,c,l,u){e.selectedClusteringJobId=i.clusteringJobId,e.showViewGridPage=!1,e.getProjectData=function(){u.getInfo(function(t){e.isProjectDisabled=1===t.disabled})},e.getProjectData(),e.loadClusteringJobs=function(){return e.loading=!0,e.showRefreshBtn=!1,n.list({completed:!0}).then(function(t){e.clusteringJobsOriginal=t,e.clusteringJobsData=t,e.loading=!1,t&&t.length&&(e.showRefreshBtn=!0)})},e.selectedClusteringJobId||e.loadClusteringJobs();const d=JSON.parse(l.getItem("analysis.gridContext"));i.gridContext||d&&"analysis.grid-view"===t.current.name?(e.showViewGridPage=!0,e.gridContext=i.gridContext?i.gridContext:d):l.setItem("analysis.gridContext",null),e.selectItem=function(e){e?t.go("analysis.clustering-jobs-details",{clusteringJobId:e.clustering_job_id}):t.go("analysis.clustering-jobs",{})},e.createNewClusteringJob=function(){if(!c.can("manage AED and Clustering job"))return void r.error("You do not have permission to create Clustering job");s.open({templateUrl:"/app/analysis/clustering-jobs/new-clustering-job.html",controller:"CreateNewClusteringJobCtrl as controller"}).result.then(function(t){data=t,data.create?(a.updateJobs(),e.showRefreshBtn=!0,r.log("Your new clustering job is waiting to start processing.<br> Check its status on <b>Jobs</b>.")):data.error?r.error("Error: "+data.error):data.url&&o.path(data.url)})},e.deleteClusteringJob=function(t,i){if(i.stopPropagation(),!c.can("manage AED and Clustering job"))return void r.log("You do not have permission to delete Clustering job");s.open({templateUrl:"/app/analysis/clustering-jobs/delete-clustering-job.html",controller:"DeleteClusteringJobCtrl as controller",resolve:{clusteringJob:function(){return t}}}).result.then(function(i){if(i.err)r.error("Error: "+i.err);else{const n=angular.copy(e.clusteringJobsOriginal),a=n.findIndex(function(e){return e.clustering_job_id===t.clustering_job_id});a>-1&&(e.clusteringJobsOriginal.splice(a,1),r.log("Clustering Job deleted successfully"))}})}}]).controller("DeleteClusteringJobCtrl",["$scope","$modalInstance","a2ClusteringJobs","clusteringJob",function(e,t,i,n){this.clusteringJob=n,e.deletingloader=!1,e.ok=function(){e.deletingloader=!0,i.delete(n.clustering_job_id).then(function(e){t.close(e)})},e.cancel=function(){t.dismiss("cancel")}}]).directive("a2ClusteringDetails",function(){return{restrict:"E",replace:!0,scope:{clusteringJobId:"=",detailedView:"=",onSetDetailedView:"&",onGoBack:"&"},controller:"ClusteringDetailsCtrl",controllerAs:"controller",templateUrl:"/app/analysis/clustering-jobs/details.html"}}).controller("ClusteringDetailsCtrl",["$scope","$state","$location","a2ClusteringJobs","$window","Project","a2Playlists","$localStorage","$modal","a2UserPermit",function(e,t,i,n,a,r,o,s,c,l){var u=a.d3;e.loading=!0,e.toggleMenu=!1,e.selectedCluster=null;var d;e.frequencyFilter={min:null,max:null,currentMin:null,currentMax:null},e.decrementClusters=function(){1!==e.selectedCluster&&(e.selectedCluster-=1,e.selectCluster())},e.incrementClusters=function(){e.selectedCluster!==e.layout.shapes.length&&(e.selectedCluster+=1,e.selectCluster())},e.selectCluster=function(){clearTimeout(d),d=setTimeout(function(){if(null!==e.selectedCluster){$("#plotly .select-outline").remove(),e.layout.shapes.forEach(function(e){e.line.color=e.fillcolor,e.line["stroke-width"]=1});e.layout.shapes[e.selectedCluster-1].line.color="#ffffff",Plotly.relayout(document.getElementById("plotly"),{"selection.line.color":"#ff0000","selection.line.opacity":1,"selection.line.stroke-width":4}),e.points=[],e.points[e.selectedCluster-1]=[],e.points[e.selectedCluster-1]=e.getShapePoints(),e.toggleMenu=!0,e.$apply()}},2e3)},e.getShapePoints=function(){var t=[],n=e.isFilteredClusters()?e.sortFilteredData({min:i.search().freqMin,max:i.search().freqMax}):e.clusters,a=Object.values(n)[e.selectedCluster-1].aed;return a&&a.length&&a.forEach(function(e,i){t.push(i)}),t};e.isFilteredClusters=function(){return i.search().freqMin&&i.search().freqMax},e.isEmpty=function(){return void 0!==e.countAudioEventDetected&&0===e.countAudioEventDetected&&!e.loading},e.aedsDetected=function(){return void 0===e.countAudioEventDetected&&e.loading?"":void 0!==e.countAudioEventDetected||e.loading?e.countAudioEventDetected:"no data"},e.clustersDetected=function(){return void 0===e.countClustersDetected&&e.loading?"":void 0!==e.countClustersDetected||e.loading?e.countClustersDetected:"no data"};var p=function(t){function i(e){const t=[0,0,0];for(var i=0;i<24;i++)t[i%3]<<=1,t[i%3]|=1&e,e>>=1;return"#"+t.reduce(function(e,t){return(t>15?t.toString(16):"0"+t.toString(16))+e},"")}var n=document.getElementById("plotly"),a=[],r=[];e.originalData=[];for(var o in t)a.push({x:t[o].x,y:t[o].y,type:"scatter",mode:"markers",hoverinfo:"none",name:o,marker:{size:6}}),r.push({type:"circle",xref:"x",yref:"y",x0:u.min(t[o].x),y0:u.min(t[o].y),x1:u.max(t[o].x),y1:u.max(t[o].y),opacity:.2}),e.originalData.push({x:t[o].x,y:t[o].y,cluster:o,aed:t[o].aed});if(e.layout={shapes:r,height:n?n.offsetWidth-n.offsetWidth/3:800,width:n?n.offsetWidth:1390,showlegend:!0,dragmode:"lasso",legend:{title:{text:"Clusters names",side:"top",font:{size:12}},x:1,xanchor:"right",y:1,itemclick:"toggleothers",font:{color:"white"}},paper_bgcolor:"#232436",plot_bgcolor:"#232436",xaxis:{color:"white",title:"Component 2",side:"top"},yaxis:{color:"white",title:"Component 1"}},e.layout.shapes.forEach(function(e,t){var n=i(t+1);a[t].marker={color:n},e.fillcolor=n,e.line={color:n,"stroke-width":1}}),e.resetSelect=function(){e.toggleMenu=!1,e.$apply(),e.layout.shapes.forEach(function(e){e.line.color=e.fillcolor,e.line["stroke-width"]=1}),Plotly.redraw(n),e.$apply()},n){var s={scrollZoom:!0,displayModeBar:!0,displaylogo:!1,hoverdistance:5};Plotly.newPlot(n,a,e.layout,s),dragLayer=document.getElementsByClassName("nsewdrag")[0],e.xAxisRangeStart=e.layout.xaxis.range[0],n.on("plotly_hover",function(t){"lasso"===e.layout.dragmode&&dragLayer.classList.add("lasso-cursor")}),n.on("plotly_unhover",function(e){dragLayer.classList.remove("lasso-cursor")}),n.on("plotly_relayouting",function(t){t["xaxis.range[0]"]>e.xAxisRangeStart&&(dragLayer.classList.remove("zoom-out-cursor"),dragLayer.classList.add("zoom-in-cursor"),e.xAxisRangeStart=t["xaxis.range[0]"]),t["xaxis.range[0]"]<e.xAxisRangeStart&&(dragLayer.classList.remove("zoom-in-cursor"),dragLayer.classList.add("zoom-out-cursor"),e.xAxisRangeStart=t["xaxis.range[0]"])}),n.on("plotly_relayout",function(e){dragLayer.classList.remove("zoom-out-cursor"),dragLayer.classList.remove("zoom-in-cursor")}),n.on("plotly_click",function(t){console.log("plotly_click",t),$("#plotly .select-outline").remove(),e.resetSelect(),e.points={x:t.points[0].x,y:t.points[0].y,name:t.points[0].fullData.name},e.layout.shapes.forEach(function(t,i){e.points.x>=t.x0&&e.points.x<=t.x1&&e.points.y>=t.y0&&e.points.y<=t.y1&&(e.layout.shapes[i].line.color="#ffffff",Plotly.relayout(n,{"$scope.layout.shapes[i].line.color":"#ff0000","$scope.layout.shapes[i].line.stroke-width":4}),e.toggleMenu=!0,e.$apply())})}),n.on("plotly_selected",function(t){t||$("#plotly .select-outline").remove(),console.log("plotly_selected",t),e.points=[],t&&t.points&&t.points.length&&(t.points.forEach(function(t){var i=t.curveNumber;e.points[i]||(e.points[i]=[]),e.points[i].push(t.pointNumber)}),e.toggleMenu=!0,e.$apply())})}};e.onGridViewSelected=function(){e.toggleMenu=!1,e.selectedCluster=null,e.showViewGridPage=!0,e.points?e.points.length?(e.gridContext={},e.points.forEach(function(t,i){e.gridContext[i]={aed:e.originalData[i].aed.filter(function(e,i){return t.includes(i)}),name:e.originalData[i].cluster}})):e.gridContext=e.originalData.find(function(t){return t.x.includes(e.points.x)&&t.y.includes(e.points.y)}):e.gridContext=e.originalData,t.go("analysis.grid-view",{clusteringJobId:e.clusteringJobId,gridContext:e.gridContext})},e.showClustersInVisualizer=function(){if(e.points.length){e.selectedClusters={aed:[]};for(var t in e.points)e.originalData[t].aed.forEach(function(i,n){e.points[t].includes(n)&&e.selectedClusters.aed.push(i)})}else e.selectedClusters=e.originalData.find(function(t){return t.x.includes(e.points.x)&&t.y.includes(e.points.y)});if(e.selectedClusters&&e.selectedClusters.aed&&e.selectedClusters.aed.length&&void 0!==e.aedDataInfo){e.selectedClusters.boxes={};var i=[];e.selectedClusters.aed.forEach(function(t){const n=e.aedDataInfo.aed_id.findIndex(function(e){return e===t});i.push(e.aedDataInfo.recording_id[n]);var a=["box",e.aedDataInfo.time_min[n],e.aedDataInfo.freq_low[n],e.aedDataInfo.time_max[n],e.aedDataInfo.freq_high[n]].join(",");e.selectedClusters.boxes[e.aedDataInfo.recording_id[n]]?e.selectedClusters.boxes[e.aedDataInfo.recording_id[n]].push(a):e.selectedClusters.boxes[e.aedDataInfo.recording_id[n]]=[a]}),e.removeFromLocalStorage(),tempPlaylistData={},tempPlaylistData.aed=e.selectedClusters.aed,tempPlaylistData.boxes=e.selectedClusters.boxes,tempPlaylistData.playlist={id:0,name:"cluster_"+i.join("_"),recordings:i.filter(function(e,t,i){return i.indexOf(e)===t}),count:i.filter(function(e,t,i){return i.indexOf(e)===t}).length},s.setItem("analysis.clusters",JSON.stringify(tempPlaylistData)),a.location.href="/project/"+r.getUrl()+"/visualizer/playlist/0?clusters"}},e.removeFromLocalStorage=function(){s.setItem("analysis.clusters",null),s.setItem("analysis.clusters.playlist",null),t.params.clusters=""},e.savePlaylist=function(e){if(!l.can("manage AED and Clustering job"))return void notify.error("You do not have permission to manage AED and Clustering job");o.create(e,function(e){e&&e.playlist_id&&(a.location.href="/project/"+r.getUrl()+"/visualizer/playlist/"+e.playlist_id+"?clusters")})},e.showDetailsPage=function(){return!e.loading&&!e.infopanedata&&!e.gridViewSelected},e.openFreqFilterModal=function(){c.open({templateUrl:"/app/analysis/clustering-jobs/frequency-filter.html",controller:"a2ClusterFrequencyFilterModalController",size:"sm",resolve:{data:function(){return{frequency:e.frequencyFilter}}}}).result.then(function(t){t&&e.useFrequencyFilterData(t)})},e.sortFilteredData=function(t){var i={};for(var n in e.clusters)e.clusters[n].aed.length&&(i[n]={},i[n].y=[],i[n].x=[],i[n].aed=[],e.clusters[n].freq_high.forEach(function(a,r){e.clusters[n].freq_low[r]>=t.min&&a<=t.max&&(i[n].y.push(e.clusters[n].y[r]),i[n].x.push(e.clusters[n].x[r]),i[n].aed.push(e.clusters[n].aed[r]))}),i[n].aed.length||delete i[n]);return i},e.useFrequencyFilterData=function(n){e.frequencyFilter.currentMin=n.min,e.frequencyFilter.currentMax=n.max,t.params.freqMin=e.frequencyFilter.currentMin,t.params.freqMax=e.frequencyFilter.currentMax,i.search("freqMin",e.frequencyFilter.currentMin),i.search("freqMax",e.frequencyFilter.currentMax);var a=e.sortFilteredData(n);e.countClustersDetected=Object.keys(a).length,e.countAudioEventDetected=Object.values(a).map(function(e){return e.aed.length}).reduce(function(e,t){return e+t},0),p(a)},function(){e.infopanedata="",n.getJobDetails(e.clusteringJobId).then(function(t){t&&(e.job_details=t)}).catch(function(e){console.log(e)}),n.getClusteringDetails({job_id:e.clusteringJobId}).then(function(t){e.loading=!1,t&&t.aed_id&&(e.countAudioEventDetected=t.aed_id.length,e.clusters={},t.cluster.forEach(function(i,n){e.clusters[i]?(e.clusters[i].x.push(t.x_coord[n]),e.clusters[i].y.push(t.y_coord[n]),e.clusters[i].aed.push(t.aed_id[n])):e.clusters[i]={x:[t.x_coord[n]],y:[t.y_coord[n]],aed:[t.aed_id[n]],freq_low:[],freq_high:[]}}),n.getClusteringDetails({job_id:e.clusteringJobId,aed_info:!0}).then(function(t){if(void 0!==t){e.aedDataInfo=t,e.frequency={freq_low:[],freq_high:[]};for(var n in e.clusters)e.clusters[n]&&e.clusters[n].aed&&e.clusters[n].aed.length&&e.clusters[n].aed.forEach(function(i){const a=t.aed_id.findIndex(function(e){return e===i});-1!==a&&(e.frequency.freq_low.push(t.freq_low[a]),e.frequency.freq_high.push(t.freq_high[a]),e.clusters[n].freq_low.push(t.freq_low[a]),e.clusters[n].freq_high.push(t.freq_high[a]))});e.frequencyFilter.min=Math.min.apply(null,e.frequency.freq_low),e.frequencyFilter.max=Math.max.apply(null,e.frequency.freq_high),e.isFilteredClusters()&&e.useFrequencyFilterData({min:parseInt(i.search().freqMin),max:parseInt(i.search().freqMax)})}}).catch(function(e){console.log(e)}),e.countClustersDetected=Object.keys(e.clusters).length,e.isFilteredClusters()||p(e.clusters))}).catch(function(t){console.log(t),e.loading=!1,e.infopanedata="No data for clustering job found."})}()}]).controller("a2ClusterFrequencyFilterModalController",["$scope","$modalInstance","data","Project",function(e,t,i,n){e.filterData={},e.filterData.max_freq=i.frequency.max,e.filterData.src="/api/project/"+n.getUrl()+"/recordings/tiles/3298382/0/0",e.has_previous_filter=!0,e.frequency=i.frequency&&i.frequency.currentMax?{min:angular.copy(i.frequency.currentMin),max:i.frequency.currentMax}:{min:0,max:e.filterData.max_freq},e.remove_filter=function(){t.close({min:i.frequency.min,max:i.frequency.max})},e.apply_filter=function(){t.close(e.frequency)}}]).controller("CreateNewClusteringJobCtrl",["$modalInstance","a2ClusteringJobs","notify",function(e,t,i){Object.assign(this,{initialize:function(){this.loading={jobs:!1,saving:!1};var e=this.list={};this.data={name:null,aed_job:{},params:{minPoints:3,distanceThreshold:.1,maxClusterSize:100}},this.timeout,this.loading.jobs=!0,t.audioEventDetections({completed:!0}).then(function(t){this.loading.jobs=!1,e.jobs=t.map(function(e){return{name:e.name,jobId:e.job_id}})}.bind(this))},create:function(){var i=this;this.loading.saving=!0;try{return t.create({name:this.data.name,aed_job:this.data.aed_job,params:this.data.params}).then(function(t){e.close({create:!0,clusteringModel:t})}.bind(this))}catch(e){this.loading.saving=!1,console.error(e)}clearTimeout(timeout),timeout=setTimeout(function(){i.loading.saving=!1},2e3)},cancel:function(t){this.loading.jobs=!1,this.loading.saving=!1,e.close({cancel:!0,url:t})},isJobValid:function(){return this.data&&this.data.name&&this.data.name.length>3&&this.data.aed_job}}),this.initialize()}]).directive("a2GridView",function(){return{restrict:"E",scope:{clusteringJobId:"=",gridContext:"=",onGoBack:"&"},controller:"GridViewCtrl",controllerAs:"controller",templateUrl:"/app/analysis/clustering-jobs/grid-view.html"}}).controller("ExportReportModalCtrl",["$scope","$modalInstance","a2ClusteringJobs","data",function(e,t,i,n){e.userEmail=n.userEmail,e.accessExportReport=function(a){n.userEmail=a,e.isExporting=!0,e.errMess="",i.exportClusteringROIs(n).then(function(i){e.isExporting=!1,i.error?e.errMess=i.error:t.close()})},e.changedUserEmail=function(){e.errMess=null}}]).controller("GridViewCtrl",["$scope","$http","a2UserPermit","a2ClusteringJobs","a2AudioBarService","a2AudioEventDetectionsClustering","Project","Songtypes","a2Playlists","notify","$modal","$localStorage",function(e,t,i,n,a,r,o,s,c,l,u,d){e.loading=!0,e.isSquareSize=!1,e.infopanedata="",e.projectUrl=o.getUrl(),e.allRois=[],e.selectedRois=[],e.paginationSettings={page:1,limit:100,offset:0,totalItems:0,totalPages:0},e.lists={search:[{value:"all",text:"All",description:"Show all matched rois."},{value:"per_cluster",text:"Sort per Cluster",description:"Show all rois ranked per Cluster."},{value:"per_site",text:"Sort per Site",description:"Show all rois ranked per Site."},{value:"per_date",text:"Sort per Date",description:"Show all rois sorted per Date."},{value:"per_species",text:"Sort per Species",description:"Show all rois sorted per Species."}],validation:[{class:"fa val-1",text:"Present",value:1},{class:"fa val-0",text:"Not Present",value:0},{class:"fa val-null",text:"Clear",value:-1}]},e.validation={status:e.lists.validation[2]},e.selectedFilterData=e.lists.search[1],e.playlistData={},e.aedData={count:0,id:[]},e.speciesLoading=!1,e.selected={species:null,songtype:null};var p,f=!1;e.gridContext&&e.gridContext.aed?(e.gridData=[],e.gridData.push(e.gridContext),e.aedData.count=1,e.gridContext.aed.forEach(function(t){return e.aedData.id.push(t)})):(e.gridData=Object.values(e.gridContext),e.aedData.count=e.gridData.length,e.gridData.forEach(function(t){t.aed.forEach(function(t){return e.aedData.id.push(t)})})),d.setItem("analysis.gridContext",JSON.stringify(e.gridContext)),n.getJobDetails(e.clusteringJobId).then(function(t){t&&(e.job_details=t)}).catch(function(e){console.log(e)}),e.onSearchChanged=function(t){e.selectedFilterData=t,e.getRoisDetails(!0).then(function(){clearTimeout(p),p=setTimeout(function(){e.markBoxesAsSelected(),e.updateInputState()},100)})},e.setCurrentPage=function(){this.paginationSettings.offset=e.paginationSettings.page-1,e.getRoisDetails()},e.showPagination=function(){return e.paginationSettings.totalItems&&e.paginationSettings.totalItems>e.paginationSettings.limit},e.getRoisDetails=function(t){if(!e.aedData.id.length)return e.getStatusForEmptyData();e.rows=[];var i;return e.isRoisLoading=!0,t&&(e.paginationSettings.page=1,e.paginationSettings.offset=0),e.paginationSettings.limit=100,e.paginationSettings.totalItems=e.aedData.id.length,i=e.aedData.id.filter(function(t,i,n){return i>=e.paginationSettings.offset*e.paginationSettings.limit&&i<e.paginationSettings.page*e.paginationSettings.limit}),n.getRoisDetails({jobId:e.clusteringJobId,aed:i,search:e.selectedFilterData.value}).then(function(t){const i=[];Object.values(e.gridData).forEach(function(e){Object.entries(e).forEach(function(n){"aed"==n[0]&&n[1].forEach(function(n){const a=t.find(function(e){return e.aed_id===n});a&&(a.cluster=e.name,i.push(a))})})}),e.paginationSettings.totalPages=Math.ceil(e.paginationSettings.totalItems/e.paginationSettings.limit),e.paginationSettings.limit=100,e.loading=!1,e.allRois=i,e.isRoisLoading=!1,e.getRoisDetailsSegment(),e.combineRoisPerCluster()}).catch(function(t){console.log(t),e.getStatusForEmptyData()})},e.getRoisDetails(),e.combineRoisPerCluster=function(){e.roisPerCluster={},e.gridData.forEach(function(t){e.roisPerCluster[t.name]=t.aed})},e.exportReport=function(){if(!i.can("manage AED and Clustering job"))return void l.error("You do not have permission to download Clustering details");var t={jobId:e.clusteringJobId,aed:e.aedData.id,cluster:e.roisPerCluster,search:e.selectedFilterData.value,userEmail:i.getUserEmail()||""};"per_site"==e.selectedFilterData.value?t.perSite=!0:"per_date"==e.selectedFilterData.value?t.perDate=!0:t.all=!0,e.openExportPopup(t)},e.openExportPopup=function(e){u.open({controller:"ExportReportModalCtrl",templateUrl:"/app/analysis/clustering-jobs/export-report.html",resolve:{data:function(){return e}},backdrop:!1}).result.then(function(){l.log("Your report export request is processing <br> and will be sent by email.")})},e.getStatusForEmptyData=function(){e.loading=!1,e.isRoisLoading=!1,e.infopanedata="No data for clustering job found."
},e.getRoisDetailsSegment=function(){const t=e.allRois;if(t&&"per_site"===e.selectedFilterData.value){var i={};t.forEach(function(e){i[e.site_id]?i[e.site_id].species.push(e):i[e.site_id]={id:e.site_id,site:e.site,species:[e]}});const n=Object.values(i).map(function(t){return{id:t.id,site:t.site,species:e.groupRoisBySpecies(t.species)}});e.rows=n}else if(t&&"per_cluster"===e.selectedFilterData.value){if(e.ids={},e.aedData.count>1){var a=[];e.gridData.forEach(function(e){a.push([e])}),a.forEach(function(i,n){e.ids[n]={id:i[0].cluster||i[0].name,cluster:i[0].cluster||i[0].name,species:e.groupRoisBySpecies(t,i[0].aed)}})}else e.ids[0]={id:e.gridData[0].cluster||e.gridData[0].name,cluster:e.gridData[0].cluster||e.gridData[0].name,species:e.groupRoisBySpecies(t)};e.rows=Object.values(e.ids)}else if(t&&"per_species"===e.selectedFilterData.value){var r={};t.forEach(function(e){r[e.species_id]?r[e.species_id].species.push(e):r[e.species_id]={id:e.species_id,speciesName:e.scientific_name,species:[e]}});const n=Object.values(r).map(function(t){return{id:t.id,speciesName:t.speciesName||"Unvalidated ROIs",species:e.groupRoisBySpecies(t.species)}});e.rows=n}else"per_date"===e.selectedFilterData.value&&t.sort(function(e,t){return e.date_created<t.date_created?1:-1}),e.rows=[],e.rows.push({species:[{rois:t}]})},e.groupRoisBySpecies=function(e,t){const i=t?e.filter(function(e,i){return t.includes(e.aed_id)}):e;var n={};return i.forEach(function(e){const t=e.scientific_name?e.scientific_name+"-"+e.songtype:"Unvalidated ROIs";n[t]?n[t].rois.push(e):n[t]={key:t,rois:[e]}}),Object.values(n)},e.playRoiAudio=function(e,t,i){i&&(i.preventDefault(),i.stopPropagation()),a.loadUrl(n.getAudioUrlFor(e,t),!0)},e.getRoiVisualizerUrl=function(e){var t=o.getUrl(),i=["box",e.time_min,e.frequency_min,e.time_max,e.frequency_max].join(",");return e?"/project/"+t+"/#/visualizer/rec/"+e.recording_id+"?a="+i:""},e.togglePopup=function(){e.isPopupOpened=!e.isPopupOpened},e.toggleBoxSize=function(){e.isSquareSize=!e.isSquareSize},e.isPlaylistDataValid=function(){return e.selectedRois&&e.selectedRois.length&&e.playlistData.playlistName&&e.playlistData.playlistName.trim().length>0},e.closePopup=function(){e.isPopupOpened=!1},e.savePlaylist=function(){e.selectedRois.length&&(e.isSavingPlaylist=!0,c.create({playlist_name:e.playlistData.playlistName,params:e.selectedRois,recIdsIncluded:!0},function(t){e.isSavingPlaylist=!1,e.closePopup(),t&&t.playlist_id&&c.attachAedToPlaylist({playlist_id:t.playlist_id,aed:e.selectedRois},function(t){e.playlistData={},l.log("Audio event detections are saved in the playlist. <br> Navigates to the Visualizer page to see Audio Event boxes on the spectrogram")})}))},e.isValidationAccessible=function(){return i.can("manage AED and Clustering job")},e.setValidation=function(){if(!i.can("manage AED and Clustering job"))return void l.error("You do not have permission to manage AED and Clustering job");if(!(1!==e.validation.status.value||e.selected.species&&e.selected.songtype))return void l.error("Please select Species and Song type <br> to validate ROIs with the Present validation");if(!(0!==e.validation.status.value||e.selected.species&&e.selected.songtype))return void l.error("Please select Species and Song type <br> to validate ROIs with the Absent validation");e.speciesLoading=!0;var t={aed:e.selectedRois,validated:e.validation.status.value};const n=-1===e.validation.status.value;t.species_name=n?null:e.selected.species.scientific_name,t.songtype_name=n?null:e.selected.songtype.name,t.species_id=n?null:e.selected.species.id,t.songtype_id=n?null:e.selected.songtype.id,clearTimeout(p),p=setTimeout(function(){r.validate(t).then(function(t){console.info("Validation result",t),e.markBoxesWithCurrentValidation(),e.unselectBoxes(),e.selectedRois=[],1===e.validation.status.value&&l.log("Audio event detections are validated as "+e.selected.species.scientific_name+" "+e.selected.songtype.name),e.selected={species:null,songtype:null},e.updateInputState(),e.getRoisDetails()}).finally(function(){e.speciesLoading=!1})},500)},e.markBoxesWithCurrentValidation=function(){e.rows.forEach(function(t){t.species.forEach(function(t){t.rois.forEach(function(t){e.selectedRois.includes(t.aed_id)&&(t.validated=e.validation.status.value)})})})},e.unselectBoxes=function(){e.rows.forEach(function(e){e.species.forEach(function(e){e.rois.forEach(function(e){e.selected&&(e.selected=!1)})})})},e.markBoxesAsSelected=function(){e.rows.forEach(function(t){t.species.forEach(function(t){t.rois.forEach(function(t){e.selectedRois.includes(t.aed_id)&&(t.selected=!0)})})})},s.get(function(t){e.songtypes=t}),e.searchSpecies=function(i){return e.selected.songtype=null,e.speciesLoading=!0,t.get("/api/species/search",{params:{q:i}}).then(function(t){return e.speciesLoading=!1,t.data})},e.onScroll=function(e,t){this.scrollElement=t.scrollElement;var i=t.scrollElement.scrollY,n=t.anchors.header.offset().top;this.headerTop=0|n,this.scrolledPastHeader=i>n};var h=function(){return e.rows.forEach(function(t){t.species.forEach(function(t){t.rois.forEach(function(t){if(!0!==t.selected||e.selectedRois.includes(t.aed_id)||e.selectedRois.push(t.aed_id),!1===t.selected&&e.selectedRois.includes(t.aed_id)){const i=e.selectedRois.findIndex(function(e){return e===t.aed_id});e.selectedRois.splice(i,1)}})})}),e.selectedRois};e.selectCluster=function(t){const i=t.selected;t.rois=t.rois.map(function(e){return e.selected=!0===i,e}),e.selectedRois=h(),e.updateInputState()};var g=function(){var t=[];return e.rows.forEach(function(e){e.species.forEach(function(e){t=t.concat(e.rois)})}),t};e.toggleDetection=function(t){if(f=t.shiftKey){const i=g(),n=h(),a=i.findIndex(function(e){return e.aed_id===n[0]}),r=i.findIndex(function(e){return e.aed_id===n[n.length-1]}),o=[a,r].sort(function(e,t){return e-t}),s=i.filter(function(e,t){return t>=o[0]&&t<=o[1]}),c=s.map(function(e){return e.aed_id});e.rows.forEach(function(e){e.species.forEach(function(e){e.rois.forEach(function(e){c.includes(e.aed_id)&&(e.selected=!0)})})})}e.selectedRois=h(),clearTimeout(p),p=setTimeout(function(){e.updateInputState()},100)},e.updateInputState=function(){const t=document.querySelectorAll("[id^='inputCluster_']");if(t.length){var i=0;e.rows.forEach(function(e){e.species.forEach(function(e){const n=e.rois.filter(function(e){return e.selected});n.length?n.length===e.rois.length?(t[i].indeterminate=!1,t[i].checked=!0):(t[i].checked=!1,t[i].indeterminate=!0):(t[i].checked=!1,t[i].indeterminate=!1),i++})})}}}]),angular.module("a2.analysis.patternmatching",["ui.bootstrap","a2.directive.audio-bar","a2.srv.patternmatching","a2.services","a2.permissions","humane","c3-charts"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("analysis.disabled-patternmatching",{url:"/disabled/patternmatching",templateUrl:"/app/analysis/patternmatching/disabled.html"}),e.state("analysis.patternmatching",{url:"/patternmatching",controller:"PatternMatchingCtrl",templateUrl:"/app/analysis/patternmatching/list.html"}),e.state("analysis.patternmatching-details",{url:"/patternmatching/:patternMatchingId",controller:"PatternMatchingCtrl",templateUrl:"/app/analysis/patternmatching/list.html"})}]).controller("PatternMatchingCtrl",["$scope","$modal","JobsData","$location","notify","$q","a2PatternMatching","a2UserPermit","$state","$stateParams","Project",function(e,t,i,n,a,r,o,s,c,l,u){e.selectedPatternMatchingId=l.patternMatchingId,e.loading={rows:!1,showRefreshBtn:!1},e.paginationSettings={page:1,limit:10,offset:0,totalJobs:0,totalPages:0},e.search={q:""};var d;e.getTemplateVisualizerUrl=function(e){var t;return e&&e.x1&&(t=["box",e.x1,e.y1,e.x2,e.y2].join(",")),e?"/project/"+e.source_project_uri+"/visualizer/rec/"+e.recording+"?a="+t:""},e.selectItem=function(t){e.selectedPatternMatchingId=t,t?c.go("analysis.patternmatching-details",{patternMatchingId:t}):c.go("analysis.patternmatching",{})},e.setCurrentPage=function(){this.paginationSettings.offset=e.paginationSettings.page-1,e.loadPatternMatchings()},e.update=function(i,n){if(n.stopPropagation(),!s.can("manage pattern matchings"))return void a.error("You do not have permission to edit pattern matchings");e.pmName=i.name,t.open({templateUrl:"/app/analysis/patternmatching/edit-patternmatching.html",scope:e}).result.then(function(t){o.update(i.id,{name:t}).then(function(){e.loadPatternMatchings()})})},e.loadPatternMatchings=function(){return e.loading.rows=!0,e.showInfo=!0,e.splitAllSites=!1,o.list({completed:!0,q:e.search.q,limit:e.paginationSettings.limit,offset:e.paginationSettings.offset*e.paginationSettings.limit}).then(function(t){e.patternmatchingsOriginal=t.list,e.patternmatchingsData=t.list,e.paginationSettings.totalJobs=t.count,e.paginationSettings.totalPages=Math.ceil(e.paginationSettings.totalJobs/e.paginationSettings.limit),e.showInfo=!1,e.loading.rows=!1,t&&t.list.length&&(e.loading.showRefreshBtn=!0)})},e.onFilterChanged=function(){clearTimeout(d),d=setTimeout(function(){e.search.q.trim().length>0&&e.search.q.trim().length<4||(e.resetPagination(),e.loadPatternMatchings())},1e3)},e.isShowSearch=function(){return e.patternmatchingsData&&e.patternmatchingsData.length||e.search.q.trim().length>0},e.resetPagination=function(){e.paginationSettings.page=1,e.paginationSettings.offset=0,e.paginationSettings.totalJobs=0,e.paginationSettings.totalPages=0},e.createNewPatternMatching=function(){if(!s.can("manage pattern matchings"))return void a.error("You do not have permission to create pattern matchings");t.open({templateUrl:"/app/analysis/patternmatching/createnewpatternmatching.html",controller:"CreateNewPatternMatchingInstanceCtrl as controller"}).result.then(function(t){data=t,data.ok?(i.updateJobs(),e.loading.showRefreshBtn=!0,a.log("Your new pattern matching is waiting to start processing.<br> Check its status on <b>Jobs</b>.")):data.error?a.error("Error: "+data.error):data.url&&n.path(data.url)})},e.deletePatternMatching=function(i,n){if(n.stopPropagation(),!s.can("manage pattern matchings"))return void a.error("You do not have permission to delete pattern matchings");t.open({templateUrl:"/app/analysis/patternmatching/deletepatternmatching.html",controller:"DeletePatternMatchingInstanceCtrl as controller",resolve:{patternMatching:function(){return i}}}).result.then(function(t){if(t.err)a.error("Error: "+t.err);else{for(var n=-1,r=angular.copy(e.patternmatchingsOriginal),o=0;o<r.length;o++)if(r[o].id===i.id){n=o;break}n>-1&&(e.patternmatchingsOriginal.splice(n,1),a.log("PatternMatching deleted successfully"))}})},e.selectedPatternMatchingId||e.loadPatternMatchings()}]).directive("a2PatternMatchingDetails",function(){return{restrict:"E",replace:!0,scope:{patternMatchingId:"=",onGoBack:"&"},controller:"PatternMatchingDetailsCtrl",controllerAs:"controller",templateUrl:"/app/analysis/patternmatching/details.html"}}).controller("PatternMatchingDetailsCtrl",["$scope","$q","a2PatternMatching","a2Templates","a2UserPermit","Project","a2AudioBarService","notify","$anchorScroll","$modal",function(e,t,i,n,a,r,o,s,c,l){Object.assign(this,{id:null,initialize:function(e){this.id=e,this.offset=0,this.limit=100,this.selected={roi_index:0,roi:null,page:1},this.sitesList=[],this.sitesListBatchSize=20,this.sitesBatches=[],this.total={rois:0,pages:0},this.paginationTotal=0,this.loading={details:!1,rois:!0},this.validation=this.lists.validation[2],this.thumbnailClass=this.lists.thumbnails[0].value,this.search=this.lists.search[6],this.projecturl=r.getUrl(),this.fetchDetails().then(function(){return this.loadSitesList()}.bind(this)).then(function(){return this.loadData(1)}.bind(this))},lists:{thumbnails:[{class:"fa fa-th-large",value:""},{class:"fa fa-th",value:"is-small"}],search:[{value:"all",text:"All",description:"Show all matched Region of Interest."},{value:"present",text:"Present",description:"Show all Region of Interest marked as present."},{value:"not_present",text:"Not Present",description:"Show all Region of Interest marked as not present."},{value:"unvalidated",text:"Unvalidated",description:"Show all Region of Interest without validation."},{value:"best_per_site",text:"Best per Site",description:"Show the best scored roi per site."},{value:"best_per_site_day",text:"Best per Site, Day",description:"Show the best scored roi per site and day."},{value:"by_score",text:"Score",description:"Show all Region of Interest ranked by score."},{value:"by_score_per_site",text:"Score per Site",description:"Show all Region of Interest ranked by score per site."},{value:"top_200_per_site",text:"200 Top Scores per Site",description:"Show Top 200 Region of Interest ranked by score per each site."}],selection:[{value:"all",text:"All"},{value:"none",text:"None"},{value:"not-validated",text:"Not Validated"}],validation:[{class:"fa val-1",text:"Present",value:1},{class:"fa val-0",text:"Not Present",value:0},{class:"fa val-null",text:"Clear",value:null}]},fetchDetails:function(){return this.loading.details=!0,i.getDetailsFor(this.id).then(function(e){this.loading.details=!1,this.patternMatching=e,this.patternMatching.templateParameters={Threshold:this.patternMatching.parameters.threshold,"Matches/Recording":this.patternMatching.parameters.N,"Matches/Site":this.patternMatching.parameters.persite||"no limit"},this.total={rois:e.matches,pages:Math.ceil(e.matches/this.limit)}}.bind(this)).catch(function(e){return this.loading.details=!1,s.serverError(e)}.bind(this))},onSearchChanged:function(){this.selected.page=1,this.recalculateSiteListBatch(),this.loadData(1)},update:function(t,n){if(n.stopPropagation(),!a.can("manage pattern matchings"))return void s.error("You do not have permission to edit pattern matchings");e.pmName=t.name,l.open({templateUrl:"/app/analysis/patternmatching/edit-patternmatching.html",scope:e}).result.then(function(e){i.update(t.id,{name:e}).then(function(){t.name=e})})},setupExportUrl:function(){this.patternMatchingExportUrl=i.getExportUrl({patternMatching:this.patternMatching.id,jobName:encodeURIComponent(this.patternMatching.name)})},exportPmReport:function(e){return e.stopPropagation(),a.isSuper()?this.setupExportUrl():a.all&&!a.all.length||!a.can("export report")?s.error("You do not have permission to export Pattern Matching data"):this.setupExportUrl()},onScroll:function(e,t){if("by_score_per_site"===this.search.value)return!1;this.scrollElement=t.scrollElement;var i=t.scrollElement.scrollY,n=t.anchors.header.offset().top;this.headerTop=0|n,this.scrolledPastHeader=i>=n},onSelect:function(e){this.select(e.value)},loadSitesList:function(){return i.getSitesListFor(this.id).then(function(e){this.sitesList=e,this.sitesTotal=this.sitesBatches.length,this.splitSitesListIntoBatches()}.bind(this))},splitSitesListIntoBatches:function(){for(var e=[],t=0;t<this.sitesList.length;t+=this.sitesListBatchSize)e.push(this.sitesList.slice(t,t+this.sitesListBatchSize));this.sitesBatches=e},getCountPerSite:function(){return this.rois&&this.rois[0]&&this.rois[0].list[0].countPerSite},recalculateTotalItems:function(){switch(this.search&&this.search.value?this.search.value:void 0){case"present":this.paginationTotal=this.patternMatching.present;break;case"not_present":this.paginationTotal=this.patternMatching.absent;break;case"by_score":this.paginationTotal=this.patternMatching.matches;break;case"by_score_per_site":this.paginationTotal=this.getCountPerSite();break;default:this.paginationTotal=0}},recalculateSiteListBatch:function(){var e=this.search&&this.search.value?this.search.value:void 0,t=!1;["all","unvalidated","top_200_per_site","by_score_per_site"].includes(e)?(1!==this.sitesListBatchSize&&(t=!0),this.sitesListBatchSize=1):["best_per_site","best_per_site_day"].includes(e)&&(10!==this.sitesListBatchSize&&(t=!0),this.sitesListBatchSize=10),t&&this.splitSitesListIntoBatches()},setSiteBookmark:function(e){const t="by_score_per_site"===this.search.value;if(this.shouldGetPerSite()||t)return this.selected.page=t?1:this.getSiteBatchIndexBySiteId(e.site_id)+1,this.loadData();var i="site-"+e.site_id;c.yOffset=$(".a2-page-header").height()+60,c(i)},shouldGetPerSite:function(){return this.search&&["all","unvalidated","top_200_per_site","best_per_site","best_per_site_day"].includes(this.search.value)},getSiteBatchIndexBySiteId:function(e){if(this.sitesBatches&&this.sitesBatches.length)return this.sitesBatches.findIndex(function(t){return!!t.find(function(t){return t.site_id===e})})},getSiteBatchBySiteId:function(e){const t=this.getSiteBatchIndexBySiteId(e);if(void 0!==t)return this.sitesBatches[t]},getSiteBatchByPageNumber:function(e){if(this.sitesBatches&&this.sitesBatches.length)return this.sitesBatches[e-1]},combOpts:function(e){var t=this.search&&this.search.value?this.search.value:void 0,i={search:t};e.site&&(i.site=e.site),e.sites&&(i.sites=e.sites);var n,a;const r=a=(e.pageNumber-1)*this.limit;switch(t){case"top_200_per_site":n=200,a=0;break;case"best_per_site":n=1,a=0;break;case"all":case"unvalidated":n=1e8,a=0;break;default:n=this.limit,a=r}return{limit:n,offset:a,opts:i}},parseRoisResult:function(e){var t=this.search&&this.search.value?this.search.value:void 0;return this.splitAllSites="by_score"===t,this.splitAllSites?[{list:e}]:e.reduce(function(e,t){var i=t.site_id,n=t.site;return e.idx[n]||(e.idx[n]={list:[],idx:{},name:n,id:i},e.list.push(e.idx[n])),e.idx[n].list.push(t),e},{list:[],idx:{}}).list},loadData:function(e){var t;if("by_score_per_site"===this.search.value){const n=this.selected.siteBookmark?this.selected.siteBookmark.site_id:this.sitesBatches[0][0].site_id;t=this.combOpts({sites:n,pageNumber:this.selected.page})}else if(this.shouldGetPerSite()){e=e||this.selected.page;var a=this.getSiteBatchByPageNumber(e),r=a.map(function(e){return e.site_id});t=this.combOpts({sites:r})}else t=this.combOpts({pageNumber:this.selected.page});return this.rois=[],this.loading.rois=!0,i.getRoisFor(this.id,t.limit,t.offset,t.opts).then(function(e){this.loading.rois=!1,this.rois=this.parseRoisResult(e),this.selected.roi=Math.min(),this.recalculateTotalItems()}.bind(this)).catch(function(e){return this.loading.rois=!1,s.serverError(e)}.bind(this))},playRoiAudio:function(e,t){t&&(t.preventDefault(),t.stopPropagation()),console.info("play"),o.loadUrl(i.getAudioUrlFor(e),!0)},playTemplateAudio:function(){o.loadUrl(n.getAudioUrlFor(this.patternMatching.template),!0)},getRoiVisualizerUrl:function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+this.projecturl+"/visualizer/rec/"+e.recording_id+"?a="+t:""},getTemplateVisualizerUrl:function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+e.source_project_uri+"/visualizer/rec/"+e.recording+"?a="+t:""},setRoi:function(e){return this.total.rois<=0?(this.selected.roi_index=0,this.selected.roi=null):(this.selected.roi_index=Math.max(0,Math.min(0|e,this.total.rois-1)),this.selected.roi=this.rois[this.selected.roi_index]),this.selected.roi},setPage:function(e,i){return this.total.rois<=0?(this.selected.page=1,this.rois=[],t.resolve(this.rois)):e!=this.selected.page||i?(this.selected.page=e,this.loadData(e)):t.resolve()},select:function(e){var t=null;t="all"===e?function(e){e.selected=!0}:"none"===e?function(e){e.selected=!1}:"not-validated"===e?function(e){e.selected=null===e.validated}:function(t){t.selected=t.id===e},this.forEachRoi(t)},forEachRoi:function(e){(this.rois||[]).forEach(function(t){t.list.forEach(e)})},validate:function(e,t){if(!a.can("validate pattern matchings"))return void s.error("You do not have permission to validate the matched rois.");void 0===e&&(e=(this.validation||{value:null}).value),void 0===t&&(t=[],this.forEachRoi(function(e){e.selected&&t.push(e)}));var n=t.map(function(e){return e.id}),r={0:0,1:0,null:0},o={species:this.patternMatching.species_name,songtype:this.patternMatching.songtype_name};return i.validateRois(this.id,n,e,o).then(function(){t.forEach(function(t){r[t.validated]-=1,r[e]+=1,t.validated=e,t.selected=!1}),this.patternMatching.absent+=r[0],this.patternMatching.present+=r[1]}.bind(this))}}),this.initialize(e.patternMatchingId)}]).controller("DeletePatternMatchingInstanceCtrl",["$scope","$modalInstance","a2PatternMatching","patternMatching",function(e,t,i,n){this.patternMatching=n,e.deletingloader=!1,e.ok=function(){e.deletingloader=!0,i.delete(n.id).then(function(e){t.close(e)})},e.cancel=function(){t.dismiss("cancel")}}]).controller("CreateNewPatternMatchingInstanceCtrl",["$modalInstance","a2PatternMatching","a2Templates","a2Playlists","notify",function(e,t,i,n,a){var r=this;Object.assign(this,{initialize:function(){this.loading={playlists:!1,templates:!1,createPatternMatching:!1},this.data={name:null,playlist:null,template:null,params:{N:1,threshold:.3}},this.list={},this.loading={templates:!0,playlists:!0},this.isSaving=!1,this.warningMessage="Warning: Large playlist (500,000+ recordings). Save resources by reducing playlist size.",this.getTemplates(),this.getPlaylists()},getTemplates:function(){return r.loading.templates=!0,i.getList().then(function(e){r.loading=!1,r.list.templates=e.filter(function(e){return!e.disabled})}.bind(this)).catch(function(e){r.loading=!1,r.list.templates=[],a.serverError(e)}.bind(this))},getPlaylists:function(){return r.loading.playlists=!0,n.getList().then(function(e){r.playlists=!1,r.list.playlists=e}.bind(this)).catch(function(e){r.playlists=!1,r.list.playlists=[],a.serverError(e)}.bind(this))},ok:function(){return 0===r.data.playlist.count?a.error("Note: The playlist should not be empty."):(r.isSaving=!0,t.create({name:r.data.name,playlist:r.data.playlist.id,template:r.data.template.id,params:r.data.params}).then(function(t){r.isSaving=!1,e.close({ok:!0,patternMatching:t})}).catch(function(e){console.log("err",e),r.isSaving=!1,a.error(e)}))},isJobValid:function(){return r.data&&r.data.name&&r.data.name.length>3&&r.data.playlist&&r.data.template},cancel:function(t){e.close({cancel:!0,url:t})},isWarningMessage:function(){return this.data.playlist&&this.data.playlist.count>5e5}}),this.initialize()}]),angular.module("a2.analysis.random-forest-models",["ui.router","a2.analysis.random-forest-models.models","a2.analysis.random-forest-models.classification"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("analysis.random-forest-models",{url:"/random-forest-models",template:"<ui-view />",abstract:!0})}]),angular.module("a2.audiodata.playlists.playlist-arithmetic",[]).directive("playlistArithmetic",["a2Playlists",function(e){return{restrict:"E",templateUrl:"/app/audiodata/playlists/playlist-arithmetic.html",scope:{onExpressionSelected:"&"},controller:"playlistArithmeticController as controller",requires:"^PlaylistCtrl",link:function(e,t,i){var n=e.controller;n.initialize({onSelected:function(t){e.onExpressionSelected({expression:t})}}),e.$on("$destroy",function(){n.$destroy()})}}}]).controller("playlistArithmeticController",["a2Playlists","$interpolate",function(e,t){this.selected={},this.operations=[{type:"union",text:"Join playlist 1 and 2",icon:"a2-union",nameTemplate:"{{playlist1}} joined with {{playlist2}}"},{type:"intersection",text:"Intersect playlist 1 and 2",icon:"a2-intersect",nameTemplate:"{{playlist1}} intersected with {{playlist2}}"},{type:"subtraction",text:"Remove playlist 2 from playlist 1",icon:"a2-difference",nameTemplate:"{{playlist1}} minus {{playlist2}}"}];var i;this.initialize=function(t){this.options=t||{},i=e.$on("invalidate-list",function(){this.reset()}.bind(this)),this.reset(),this.updateNamePlaceholder()},this.reset=function(){return e.getList().then(function(e){this.playlists=e}.bind(this))},this.$destroy=function(){i()},this.updateNamePlaceholder=function(){var e=(this.selected.operation||{}).nameTemplate||"Playlist 3",i=this.selected.term1||{},n=this.selected.term2||{};this.namePlaceholder=t(e)({playlist1:i.name||"(playlist 1)",playlist2:n.name||"(playlist 2)"})},this.submit=function(){var e=this.selected.operation,t=this.selected.term1,i=this.selected.term2,n=this.selected.name||this.namePlaceholder;e&&t&&i&&n&&this.options.onSelected&&this.options.onSelected({operation:e.type,term1:t.id,term2:i.id,name:n})}}]),angular.module("a2.audiodata.playlists",["a2.services","a2.directives","ui.bootstrap","a2.audiodata.playlists.playlist-arithmetic","humane"]).config(["$stateProvider",function(e){e.state("audiodata.playlists",{url:"/playlists",controller:"PlaylistCtrl as controller",templateUrl:"/app/audiodata/playlists/playlists.html"})}]).controller("PlaylistCtrl",["$scope","a2Playlists","$modal","notify","a2UserPermit","$location",function(e,t,i,n,a,r){this.initialize=function(){removeOnInvalidateHandler=t.$on("invalidate-list",function(){this.reset()}.bind(this)),this.reset()},this.reset=function(){e.loading=!0,t.getList({info:!0}).then(function(t){e.playlists=t,e.loading=!1})},this.operate=function(e){return a.can("manage playlists")?t.combine(e).then(function(){n.log("Playlist created")}).catch(function(e){e=e||{},n.error(e.message||e.data||"Server error")}):void n.error("You do not have permission to combine playlists")},this.edit=function(){if(!e.checked.length||e.checked.length>1)return void n.log("Please select one playlist to edit");if(!a.can("manage playlists"))return void n.error("You do not have permission to edit playlists");e.pname=e.checked[0].name;const r=e.checked[0].id;i.open({templateUrl:"/app/audiodata/edit-playlist.html",scope:e}).result.then(function(e){t.rename({id:r,name:e},function(e){if(e.error)return console.log(e.error)})})},e.del=function(){if(e.checked&&e.checked.length){if(!a.can("manage playlists"))return void n.error("You do not have permission to delete playlists");const r=e.checked.map(function(e){return'"'+e.name+'"'}),o=["You are about to delete the following playlists: "],s=["Are you sure?"];e.popup={messages:o.concat(r,s),btnOk:"Yes",btnCancel:"No"};i.open({templateUrl:"/common/templates/pop-up.html",scope:e}).result.then(function(){const i=e.checked.map(function(e){return e.id});e.loading=!0,t.remove(i,function(a){if(a.error)return n.error(a.error);t.getList().then(function(t){e.playlists=t,e.loading=!1,n.log((i.length>1?"Playlists ":"Playlist ")+"deleted")})})})}},e.create=function(e){r.path(e)},this.initialize()}]),angular.module("a2.analysis.soundscapes",["a2.services","a2.permissions","ui.bootstrap","ui-rangeSlider","ngCsv"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("analysis.soundscapes",{url:"/soundscapes",controller:"SoundscapesCtrl as controller",templateUrl:"/app/analysis/soundscapes/list.html"})}]).controller("SoundscapesCtrl",["$window","$scope","$modal","$filter","Project","JobsData","ngTableParams","a2Playlists","$location","a2Soundscapes","notify","a2UserPermit",function(e,t,i,n,a,r,o,s,c,l,u,d){var p=e.$;t.successInfo="",t.showSuccess=!1,t.errorInfo="",t.showError=!1,t.infoInfo="Loading...",t.showInfo=!0,t.loading=!0,t.infopanedata="",a.getInfo(function(e){t.projectData=e,t.pid=e.project_id,t.url=e.url,t.isProjectDisabled=1===e.disabled}),s.getList().then(function(e){t.playlists=e});var f=function(e,i,a,r,s){var c={},u="desc";"+"==a[0]&&(u="asc"),c[a.substring(1)]=u,t.tableParams=new o({page:e,count:i,sorting:c,filter:r},{total:s,getData:function(e,i){t.infopanedata="";var a=i.filter()?n("filter")(t.soundscapesOriginal,i.filter()):t.soundscapesOriginal,r=i.sorting()?n("orderBy")(a,i.orderBy()):t.soundscapesOriginal;i.total(r.length),e.resolve(r.slice((i.page()-1)*i.count(),i.page()*i.count())),r.length<1&&(t.infopanedata="No classifications found."),t.soundscapesData=r.slice((i.page()-1)*i.count(),i.page()*i.count()),l.saveState({data:t.soundscapesOriginal,filtered:t.soundscapesData,f:i.filter(),o:i.orderBy(),p:i.page(),c:i.count(),t:r.length})}})};t.loadSoundscapes=function(){l.getList2(function(e){t.soundscapesOriginal=e,t.soundscapesData=e,t.infoInfo="",t.showInfo=!1,t.loading=!1,t.infopanedata="",e.length>0?t.tableParams?t.tableParams.reload():f(1,10,"+name",{},e.length):t.infopanedata="No soundscapes found."})};var h=l.getState();null===h?t.loadSoundscapes():(h.data.length>0?(t.soundscapesData=h.filtered,t.soundscapesOriginal=h.data,f(h.p,h.c,h.o[0],h.f,h.filtered.length)):t.infopanedata="No models found.",t.infoInfo="",t.showInfo=!1,t.loading=!1),t.deleteSoundscape=function(e,n){if(!d.can("manage soundscapes"))return void u.error("You do not have permission to delete soundscapes");t.infoInfo="Loading...",t.showInfo=!0,t.loading=!0;var a=i.open({templateUrl:"/app/analysis/soundscapes/deletesoundscape.html",controller:"DeleteSoundscapeInstanceCtrl",resolve:{name:function(){return n},id:function(){return e},projectData:function(){return t.projectData}}});a.opened.then(function(){t.infoInfo="",t.showInfo=!1,t.loading=!1}),a.result.then(function(i){if(i.error)u.error("Error: "+i.error);else{for(var n=-1,a=angular.copy(t.soundscapesOriginal),r=0;r<a.length;r++)if(a[r].soundscape_id===e){n=r;break}n>-1&&(t.soundscapesOriginal.splice(n,1),t.tableParams.reload(),u.log("Soundscape deleted successfully"))}})},t.createNewSoundscape=function(){if(!d.can("manage soundscapes"))return void u.error("You do not have permission to create soundscapes");t.infoInfo="Loading...",t.showInfo=!0,t.loading=!0;var e=i.open({templateUrl:"/app/analysis/soundscapes/createnewsoundscape.html",controller:"CreateNewSoundscapeInstanceCtrl",resolve:{amplitudeReferences:["a2Soundscapes",function(e){return e.getAmplitudeReferences()}],playlists:function(){return t.playlists},projectData:function(){return t.projectData}}});e.opened.then(function(){t.infoInfo="",t.showInfo=!1,t.loading=!1}),e.result.then(function(e){data=e,data.ok&&(r.updateJobs(),u.log("Your new soundscape is waiting to start processing.<br> Check its status on <b>Jobs</b>.")),data.err&&u.error(data.err),data.url&&c.path(data.url)})},t.showDetails=function(e){l.get(e,function(e){s.getInfo(e.playlist_id,function(t){i.open({controller:"SoundscapesDetailsCtrl as controller",templateUrl:"/app/analysis/soundscapes/details.html",resolve:{soundscape:function(){return e},playlist:function(){return t}}})})})},this.exportSoundscape=function(e){return d.isSuper()?this.getExportUrl(e):d.all&&!d.all.length||!d.can("export report")?u.error("You do not have permission to export soundscape data"):void this.getExportUrl(e)},this.getExportUrl=function(t){l.getExportUrl(t).then(function(t){var i=p("<a></a>").attr("target","_blank").attr("href",t).appendTo("body");e.setTimeout(function(){i[0].click(),i.remove()},0)})}}]).controller("DeleteSoundscapeInstanceCtrl",["$scope","$modalInstance","a2Soundscapes","name","id","projectData",function(e,t,i,n,a,r){e.name=n,e.id=a,e.projectData=r;e.projectData.url;e.ok=function(){i.delete(a,function(e){t.close(e)})},e.cancel=function(){t.dismiss("cancel")}}]).controller("CreateNewSoundscapeInstanceCtrl",["$scope","$modalInstance","a2Soundscapes","$timeout","projectData","playlists",function(e,t,i,n,a,r){e.projectData=a,e.playlists=r,e.buttonEnableFlag=!0,e.datasubmit={name:"",playlist:"",aggregation:"",threshold:0,thresholdReference:"absolute",bin:86,bandwidth:0,normalize:!1},e.nameMsg="",e.aggregationValue=function(t){e.$apply(function(){e.datasubmit.aggregation=t})},e.ok=function(){e.projectData.url;e.nameMsg="",i.create({n:e.datasubmit.name,p:e.datasubmit.playlist,a:e.datasubmit.aggregation,t:e.datasubmit.threshold,tr:e.datasubmit.thresholdReference,m:22050,b:e.datasubmit.bin,f:e.datasubmit.bandwidth,nv:e.datasubmit.normalize}).success(function(i){i.name?e.nameMsg="Name exists":t.close(i)}).error(function(e){e.err?t.close({err:"Error: "+e.err}):t.close({err:"Error: Cannot create soundscape job"})})},e.buttonEnable=function(){return 0===e.datasubmit.bin||"string"==typeof e.datasubmit.bin.length||0===e.datasubmit.aggregation.length||"string"==typeof e.datasubmit.threshold.length||"string"==typeof e.datasubmit.bandwidth.length||0===e.datasubmit.name.length||"string"==typeof e.datasubmit.playlist},e.cancel=function(e){t.close({url:e})}}]).directive("a2Aggregationtypeselector",function(){return{restrict:"E",scope:{selected:"="},
templateUrl:"/app/analysis/soundscapes/aggregationtypetelector.html",controller:["$scope",function(e){e.aggregations=[{name:"Hour in Day",scale:["00:00","01:00","......","22:00","23:00"],id:"time_of_day"},{name:"Day in Week",scale:["Sun","Mon","......","Fri","Sat"],id:"day_of_week"},{name:"Day in Month",scale:["1","2","......","30","31"],id:"day_of_month"},{name:"Month in Year",scale:["Jan","Feb","......","Nov","Dec"],id:"month_in_year"},{name:"Day in Year",scale:["1","2","......","365","366"],id:"day_of_year"},{name:"Year",scale:["2010","2011","......","2016","2017"],id:"year"}],e.width=200,e.padding=18,e.height=20,e.select=function(t){e.selected=t.id}}]}}).directive("a2DrawAggregation",["$window",function(e){var t=e.d3;return{restrict:"E",scope:{aggregation:"="},link:function(e,i,n){var a=function(e){var n=t.select(i[0]).append("svg").attr("width",200).attr("height",20),a=t.scale.linear().domain([0,4]).range([18,182]),r=t.svg.axis().scale(a).orient("bottom").ticks(5).tickValues([0,1,2,3,4]).tickFormat(function(t){return e.scale[t]});n.append("g").attr("transform","translate(0,1)").attr("class","aggregationaxis").call(r)};e.$watch("aggregation",function(e){e&&a(e)})}}}]).directive("a2ThresholdSelector",["a2Soundscapes",function(e){return{restrict:"E",scope:{threshold:"=",thresholdReference:"=",bandwidth:"="},templateUrl:"/app/analysis/soundscapes/thresholdselector.html",link:function(t){t.amplitudeReferences=[];var i=e.getAmplitudeReferences().then(function(e){t.amplitudeReferences=e});t.setAmplitudeReference=function(e){console.log("amplitudeReference",e),t.thresholdReference=e.value},t.$watch("thresholdReference",function(e){i.then(function(){console.log("thresholdReference",e,t.amplitudeReferences),t.amplitudeReference=t.amplitudeReferences.reduce(function(t,i){return t||(i.value==e?i:null)})})}),t.$watch("threshold",function(e,i){console.log("threshold",e,i),t.thresholdInvPercent=100*(1-t.threshold)}),t.$watch("thresholdInvPercent",function(e,i){console.log("thresholdInvPercent",e,i);t.threshold=Math.round((100-t.thresholdInvPercent)/.1)/1e3})}}}]).directive("a2DrawPeakThreshold",["$window",function(e){var t=e.d3;return{restrict:"E",scope:{threshold:"=",bandwidth:"="},link:function(e,i,n){for(var a=[.7,1,.1,.55,.1,.6,.9,.01,.15,.1,.4,.1],r=[],o=0;o<a.length;o++)r.push({x:o+1,y:.5*a[o]});var s=[{x:2.6,y:.5,d:999999},{x:4.4,y:.275,d:210},{x:7,y:.45,d:520},{x:9,y:.075,d:750},{x:11,y:.2,d:950}],c={top:10,right:10,bottom:10,left:24},l=t.select(i[0]).append("svg").attr("width",250).attr("height",70),u=t.scale.linear().range([c.left,250-c.right]).domain([t.min(r,function(e){return e.x}),t.max(r,function(e){return e.x})]),d=t.scale.linear().domain([0,1]).range([70-c.top,c.bottom]),p=t.svg.axis().scale(u).ticks(0),f=t.svg.axis().scale(d).ticks(3).tickSize(3).orient("left").tickSubdivide(!0),h=function(t){yval=50*(1-t)+10,l.selectAll("line.movingline").remove(),e.line=l.append("svg:line").attr("x1",c.left).attr("y1",yval).attr("x2",250-c.right).attr("y2",yval).attr("stroke","red").attr("stroke-width",2).attr("fill","none").attr("class","movingline"),l.selectAll("text.peakText").remove();for(var i=1,n=0;n<s.length;n++)s[n].y>=t&&s[n].d>=e.bandwidth&&(e.peakText=l.append("text").attr("x",s[n].x/r.length*250).attr("y",50*(1-s[n].y)+10).attr("font-size","11px").style("text-anchor","middle").attr("class","peakText").text("P"+i),i+=1)};e.$watch("threshold",function(){e.threshold&&h(e.threshold)}),e.$watch("bandwidth",function(){e.banwidthValue=e.bandwidth,xval=Math.floor(s[0].x/r.length*250)-11+e.bandwidth/1e3*190,l.selectAll("line.movingline1").remove(),e.line=l.append("svg:line").attr("x1",xval).attr("y1",12).attr("x2",xval).attr("y2",60).attr("stroke","red").attr("stroke-width",2).attr("fill","none").attr("class","movingline1"),l.selectAll("text.peakText").remove();for(var t=1,i=0;i<s.length;i++)s[i].y>=e.threshold&&s[i].d>e.banwidthValue&&(e.peakText=l.append("text").attr("x",s[i].x/r.length*250).attr("y",50*(1-s[i].y)+10).attr("font-size","11px").style("text-anchor","middle").attr("class","peakText").text("P"+t),t+=1)}),l.append("svg:g").attr("class","thresholdaxis").attr("transform","translate(0,"+(70-c.bottom)+")").call(p),l.append("svg:g").attr("class","thresholdaxis").attr("transform","translate("+c.left+",0)").call(f);var g=t.svg.line().x(function(e){return u(e.x)}).y(function(e){return d(e.y)}).interpolate("linear");l.append("svg:path").attr("d",g(r)).attr("stroke","blue").attr("stroke-width",2).attr("fill","none"),e.line=l.append("svg:line").attr("x1",Math.floor(s[0].x/r.length*250)-11).attr("y1",12).attr("x2",Math.floor(s[0].x/r.length*250)-11).attr("y2",60).attr("stroke","red").attr("stroke-width",2).attr("fill","none"),l.append("text").attr("x",125).attr("y",68).attr("font-size","9px").style("text-anchor","middle").text("Hz")}}}]).controller("SoundscapesDetailsCtrl",["$scope","soundscape","playlist","a2Soundscapes","a2UserPermit",function(e,t,i,n,a){e.showDownload=a.can("manage soundscapes");e.soundscape=t,e.playlist=i,e.chartOptions={lineColor:"#c42",width:400,height:400},n.getAmplitudeReferences().then(function(e){this.amplitudeReferences=e.reduce(function(e,t){return e[t.value]=t,e},{})}.bind(this)),n.findIndices(t.id,function(i){if(i){e.index={H:[],ACI:[],NP:[]},e.indices=[],e.indices.push({time:"TIME",ACI:"ACI",NP:"NP"});for(var n=0;n<i.H.length;n++){var a=n+t.min_t;e.indices.push({time:a,ACI:i.ACI[n],NP:i.NP[n]}),e.index.H.push({x:a,y:i.H[n]}),e.index.ACI.push({x:a,y:i.ACI[n]}),e.index.NP.push({x:a,y:i.NP[n]})}}})}]),angular.module("a2.audiodata.recordings.data-export-parameters",["a2.directive.a2-auto-close-on-outside-click","a2.services","a2.directives","ui.bootstrap","humane","a2.directive.error-message"]).directive("recordingDataExportParameters",["$document","$rootScope",function(e,t){return{restrict:"E",templateUrl:"/app/audiodata/recordings/export-parameters.html",scope:{onExport:"&"},controller:"recordingDataExportParametersController as controller",requires:"^RecsCtrl",link:function(e,t,i,n){n.initialize({onExport:function(t){e.onExport({parameters:t})}})}}}]).service("recordingDataFieldTypes",function(){return[{title:"Recording fields",identifier:"recording",placeholder:"filename, site, ...",list:[{value:"filename",caption:"Filename",tooltip:"The recording filename"},{value:"site",caption:"Site",tooltip:"The recording site"},{value:"day",caption:"Day",tooltip:"The recording day"},{value:"hour",caption:"Hour",tooltip:"The recording hour"},{value:"url",caption:"Url",tooltip:"The recording URl"}],preselected:["filename","site","day"]},{title:"Validations by species/song type",identifier:"validation",placeholder:"Species - Sound...",getList:function(e){return e.getClasses({validations:!0}).then(function(e){return e.map(function(e){return{value:e.id,caption:e.species_name+" - "+e.songtype_name,badges:[{icon:"val-1",value:e.vals_present},{icon:"val-0",value:e.vals_absent}]}})})}},{title:"Soundscape Composition",identifier:"soundscapeComposition",placeholder:"Wind, Birds, ...",getList:function(e){return e.getClassList({isSystemClass:1}).then(function(e){return e.map(function(e){return{value:e.id,caption:e.name,group:e.type}})})}},{title:"Tags",identifier:"tag",placeholder:"Tags...",getList:function(e){return e.getForType("recording").then(function(e){return e.map(function(e){return{value:e.tag_id,caption:e.tag,icon:"fa-tag",badges:[{value:e.count}]}})}.bind(this))}},{title:"Grouping of Detections",identifier:"grouped",placeholder:"Detections grouped by...",list:[{value:"site",caption:"Site",tooltip:"Detections grouped by Site"},{value:"hour",caption:"Hour",tooltip:"Detections grouped by Hour"},{value:"date",caption:"Date",tooltip:"Detections grouped by Date"}]},{title:"Occupancy Model Format",identifier:"species",placeholder:"Species...",getList:function(e){return e.getClasses().then(function(e){var t={};return e.forEach(function(e){const i=e.species_name.split(" ").join("_");t[i]||(t[i]={value:e.species,caption:e.species_name,name:i})}),Object.values(t)})}}]}).controller("recordingDataExportParametersController",["$q","$injector","notify","recordingDataFieldTypes","a2UserPermit",function(e,t,i,n,a){this.initialize=function(i){function a(i){return e.resolve(i.getList?t.invoke(i.getList):i.list||[])}i=i||{},i.onExport&&(this.onExport=i.onExport),this.parameter_set_list=n,this.selected=[],this.lists=this.parameter_set_list.map(function(){return[]}),e.all(this.parameter_set_list.map(a)).then(function(e){this.lists=e,this.selected=this.parameter_set_list.map(function(t,i){if(t.preselected){var n=e[i].reduce(function(e,t){return e[t.value]=t,e},{});return(t.preselected||[]).map(function(e){return n[e]}).filter(function(e){return!!e})}return[]})}.bind(this))},this.isSuper=a.isSuper(),this.isRfcxUser=a.isRfcx(),this.isRfcx=function(){return this.isRfcxUser||this.isSuper},this.checkSelectedValue=function(e){return e&&e.find(function(e){return-1===e.value})},this.onSelected=function(e){e&&-1===e.value&&(this.selected[1]=[e])},this.resetFilters=function(){this.selected=[]},this.isDisabled=function(){return this.selected&&this.selected[1]&&this.selected[1].length&&this.selected[1].length>20},this.isRecordingEmpty=function(){return this.selected&&this.selected[0]&&0===this.selected[0].length},this.exportData=function(){if(this.isRecordingEmpty())return void i.log("At least 1 recording field is required");var e=this.selected;this.onExport(this.parameter_set_list.reduce(function(t,i,n){return e[n]&&e[n].length&&(t[i.identifier]=e[n].map(function(e){return e.value})),e[n]&&"species"===i.identifier&&e[n].value&&(t[i.identifier]=e[n].value,t.species_name=e[n].name),e[n]&&"grouped"===i.identifier&&e[n].value&&(t[i.identifier]=e[n].value,t.grouped=e[n].value),t},{}))},this.onExport=function(e){console.log("export parameters : ",e)}}]),angular.module("a2.audiodata.recordings.filter-parameters",["a2.directive.a2-auto-close-on-outside-click","a2.services","a2.directives","ui.bootstrap","humane"]).directive("recordingFilterParameters",["$document","$rootScope",function(e,t){return{restrict:"E",templateUrl:"/app/audiodata/recordings/filter-parameters.html",scope:{isOpen:"=",maxDate:"=",minDate:"=",recTotal:"=",isLoading:"=",onApplyFilters:"&"},controller:"recordingFilterParametersController as controller",requires:"^RecsCtrl",link:function(e,t,i){var n=e.controller;e.applyFilters=function(){e.onApplyFilters({filters:n.getFilters()})},e.resetFilters=function(){n.params={},e.onApplyFilters({filters:n.getFilters()})},n.fetchOptions()}}}]).controller("recordingFilterParametersController",["$scope","Project","a2Classi","a2SoundscapeCompositionService","a2Playlists","$q","a2Tags","$window",function(e,t,i,n,a,r,o,s){function c(e){return function(t){return t[e]}}function l(e){return function(t){return void 0!==t.length&&t.map(e)}}for(var u=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].map(function(e,t){return{value:t,string:e,count:null}}),d=[],p=1;p<=31;p++)d.push({value:p,count:null});for(var f=[],h=0;h<24;h++)f.push({value:h,string:(h<10?"0":"")+h+":00",count:null});var g=l(c("value")),m=l(c("id")),v=l(c("tag_id")),y=l(c("flags")),b=function(e,t,i){var n=e.filter(function(e){return e[t]===i});return n.length>0?n[0]:null},_={model_only:[{caption:'<i class="fa a2-present"></i> Present',tooltip:"Present",flags:{model:1},equiv:{model_th:[1,3]}},{caption:'<i class="fa a2-absent"></i> Absent',tooltip:"Absent",flags:{model:0},equiv:{model_th:[0,2]}}],model_th:[{caption:'Model: <i class="fa a2-present"></i>, Th: <i class="fa a2-present"></i>',tooltip:"Model: present, Theshold: present",flags:{model:1,th:1},equiv:{model_only:[1]}},{caption:'Model: <i class="fa a2-present"></i>, Th: <i class="fa a2-absent"></i>',tooltip:"Model: present, Theshold: absent",flags:{model:1,th:0}},{caption:'Model: <i class="fa a2-absent"></i>, Th: <i class="fa a2-present"></i>',tooltip:"Model: absent, Theshold: present",flags:{model:0,th:1}},{caption:'Model: <i class="fa a2-absent"></i>, Th: <i class="fa a2-absent"></i>',tooltip:"Model: absent, Theshold: absent",flags:{model:0,th:0},equiv:{model_only:[0]}}]};this.options={classes:[],presence:["present","absent"],sites:[],sites_ids:[],playlists:[],years:[],months:[],days:[],hours:[],tags:[],classifications:[],classification_results:_.model_only,soundscape_composition:[],soundscape_composition_annotation:["present","absent"]},this.params={},this.loading={sites:!1};var x=[{name:"range",map:function(e){return e}},{name:"sites",map:g},{name:"sites_ids",map:m},{name:"hours",map:g},{name:"months",map:g},{name:"years",map:g},{name:"days",map:g},{name:"playlists",map:m},{name:"validations",map:m},{name:"tags",map:v},{name:"presence"},{name:"classifications",map:m},{name:"classification_results",map:y},{name:"soundscape_composition",map:m},{name:"soundscape_composition_annotation"}];this.getFilters=function(){var e={},t=this.params;return x.forEach(function(i){var n=t[i.name],a=n&&i.map?i.map(n):n;if((a instanceof Array?a.length:a)&&(e[i.name]=a),a&&"sites"===i.name){const r=x[2].map(n);e.sites_ids=r}}),e},this.getRecordingsStatsPerSite=function(e,i,n){var a=e.map(function(e){return t.getRecordingAvailability("!q:"+e.id+"---[1:31]")});return r.all(a).then(function(e){return e.reduce(function(e,t){return angular.merge(e,t)},{})}).then(function(t){var a={sites:[],years:[],months:[],days:[],hours:[]},r=Object.keys(a),o=function(t,i,n){var s=0;const c=r[n];for(var l in i)if(!Object.keys(t).length||!t[c]||-1!==t[c].indexOf(l)){var u=b(a[c],"value",l);if(!u){const d="sites"==c?e.find(function(e){return e.name===l}):{};u={value:l,count:0},"sites"==c&&(u.id=d.id),a[c].push(u)}var p;"number"==typeof i[l]?p=i[l]:(0===n&&(s=0),p=o(t,i[l],n+1)),u.count+=p,s+=p}return s};o(i,t,0),n.sites=a.sites,n.years=a.years,n.months=a.months.map(function(e){return e.value=parseInt(e.value),e.value--,{value:e.value,string:s.moment().month(e.value).format("MMM"),count:e.count}}),n.days=a.days.map(function(e){return e.value=parseInt(e.value),e}),n.hours=a.hours.map(function(e){return e.value=parseInt(e.value),{value:e.value,string:s.moment().hour(e.value).minute(0).format("HH:mm"),count:e.count}});var c=function(e,t){return e.value>t.value?1:-1};n.sites.sort(c),n.years.sort(c),n.months.sort(c),n.days.sort(c),n.hours.sort(c)})},this.setRecStatsStatic=function(e,t,i){i.sites=e.map(function(e){return{value:e.name,count:null,id:e.id}});for(var n=[],a=(t.max?new Date(t.max):new Date).getFullYear(),r=t.min?new Date(t.min).getFullYear():"1990",o=a;o>=r;o--)n.push({value:o,count:null});i.years=n,i.months=u,i.days=d,i.hours=f},this.fetchOptions=function(r){var s=this;void 0===r&&(r={});var c,l=this.options,u=this.loading;if(void 0===e.recTotal||void 0===e.minDate||void 0===e.maxDate)return void setTimeout(function(){this.fetchOptions(r)}.bind(this),1e3);u.sites=!0,t.getSites().then(function(t){return c=t,c.length<50&&e.recTotal<1e5?s.getRecordingsStatsPerSite(c,r,l):s.setRecStatsStatic(c,{min:e.minDate.toISOString(),max:e.maxDate.toISOString()},l)}).finally(function(){u.sites=!1}),t.getClasses({validations:!0},function(e){l.classes=e}),a.getList().then(function(e){l.playlists=e}),o.getForType("recording").then(function(e){var t={};e.forEach(function(e){var i=e.tag;t[i]?(t[i].tag_id.push(e.tag_id),t[i].count++):t[i]={tag:i,tag_id:[e.tag_id],count:e.count}}),l.tags=Object.values(t)}.bind(this)),i.list(function(e){l.classifications=e.map(function(e){return e.name=e.cname,e.id=e.job_id,delete e.cname,e})}.bind(this)),n.getClassList({isSystemClass:1}).then(function(e){l.soundscape_composition=e}.bind(this))},this.computeClassificationResultsOptions=function(e){console.log("this.computeClassificationResults = function(classifications){",e);var t=e&&e.reduce(function(e,t){return e||!!t.threshold},!1),i=this.options.classification_results,n=t?"model_th":"model_only",a=_[n];this.options.classification_results=a,i!=a&&(this.params.classification_results=this.params.classification_results.reduce(function(e,t){var i=t.equiv&&t.equiv[n];return i&&i.forEach(function(t){var i=a[t];e.index[i]||(e.index[t]=1,e.list.push(i))}),e},{list:[],index:{}}).list)}}]),angular.module("a2.audiodata.recordings",["a2.directive.a2-auto-close-on-outside-click","a2.service.download-resource","a2.audiodata.recordings.data-export-parameters","a2.audiodata.recordings.filter-parameters","a2.services","a2.directives","ui.bootstrap","humane"]).config(["$stateProvider",function(e){e.state("audiodata.recordings",{url:"/recordings",controller:"RecsCtrl as controller",templateUrl:"/app/audiodata/recordings/recordings.html"})}]).controller("RecsCtrl",["$scope","Project","a2Classi","$http","$modal","notify","a2UserPermit","$downloadResource",function(e,t,i,n,a,r,o,s){e.selectedRecId=[],e.checkedRec=[],this.getSearchParameters=function(t){var i=angular.merge({},e.params);return t=t||["list"],i.output=t,i.limit=e.limitPerPage,i.offset=t.indexOf("list")>=0?(e.currentPage-1)*e.limitPerPage:0,i.sortBy="r.site_id DESC, r.datetime DESC",i.range&&(i.range.from=moment(i.range.from).format("YYYY-MM-DD")+"T00:00:00.000Z",i.range.to=moment(i.range.to).format("YYYY-MM-DD")+"T23:59:59.999Z"),i},this.searchRecs=function(i){e.loading=!0,i=i||["list"];var n=this.getSearchParameters(i),a=i.reduce(function(e,t){return e[t]=!0,e},{});a.list&&(e.recs=[]),a.count&&(e.totalRecs=void 0),t.getRecs(n,function(t){1==i.length&&(t=i.reduce(function(e,i){return e[i]=t,e},{})),a.list&&(e.recs=t.list,e.recs.forEach(function(t){e.selectedRecId.includes(t.id)&&(t.checked=!0)}),e.loading=!1),a.count&&(e.totalRecs=t.count),a.date_range&&t.date_range.min_date&&t.date_range.max_date&&(e.minDate=new Date(new Date(t.date_range.min_date.substr(0,10)+"T00:00:00.000Z").getTime()-864e5),e.maxDate=new Date(new Date(t.date_range.max_date.substr(0,10)+"T23:59:59.999Z").getTime()+864e5))})},this.sortRecs=function(t,i){e.sortKey=t,e.reverse=i,this.searchRecs()},this.applyFilters=function(t){e.currentPage=1,e.params=t,this.searchRecs(["count","list"])},this.reloadList=function(){this.searchRecs(["count","list"])},this.exportPermit=function(){return o.can("manage project recordings")},this.createPlaylist=function(){var t=angular.merge({},e.params);return Object.keys(t).length?0==e.totalRecs?void r.error("You can't create playlist with 0 recording"):o.can("manage playlists")?(t.tags&&t.tags.length&&(t.tags=t.tags.flat()),t.presence&&t.presence.length&&(t.presence=t.presence[0]),t.range&&(t.range.from=moment(t.range.from).format("YYYY-MM-DD")+"T00:00:00.000Z",t.range.to=moment(t.range.to).format("YYYY-MM-DD")+"T23:59:59.999Z"),e.selectedRecId&&e.selectedRecId.length&&(t.recIds=e.selectedRecId),void a.open({controller:"SavePlaylistModalInstanceCtrl",templateUrl:"/app/audiodata/create-playlist.html",resolve:{listParams:function(){return t}},backdrop:!1}).result.then(function(e){"Playlist created"===e.message&&r.log(e.message)})):void r.error("You do not have permission to create playlists"):void r.log("Filter recordings and create a playlist")},this.isDisableDeleteRecs=function(){return!e.checkedRec.length&&!e.checked},this.deleteRecordings=function(){if(!o.can("manage project recordings"))return void r.error("You do not have permission to delete recordings");const i=e.checkedRec.filter(function(e){return!e.imported});if(!i||!i.length)return r.log("There are not any recordings to delete");const s=i.reduce(function(e,t){return e[t.site]=e[t.site]+1||1,e},{}),c=[],l=[];if(c.push("Are you sure you want to delete the following?"),Object.keys(s).forEach(function(e,t){const i=s[e]>1?"s":"";t<3&&l.push(s[e]+" recording"+i+' from "'+e+'"')}),Object.keys(s).length>3){var u=0;Object.keys(s).forEach(function(e,t){t>=3&&(u+=s[e])});const d="& "+u+" recordings from "+(Object.keys(s).length-3)+" other sites";l.push(d)}return a.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.messages=c,this.list=l,this.note="Note: analysis results on these recordings will also be deleted",this.btnOk="Delete",this.btnCancel="Cancel"},controllerAs:"popup"}).result.then(function(){return n.post("/api/project/"+t.getUrl()+"/recordings/delete",{recs:i})}).then(function(e){if(e.data.error)return r.error(e.data.error);this.searchRecs(["count","list"]),r.log(e.data.msg)}.bind(this))},this.deleteAllRecordings=function(){var i=e.params;return o.can("manage project recordings")?e.recs.length?t.getRecCounts(i).then(function(e){var t=[],i=0,n=[],r=[];if(t.push("Are you sure you want to delete the following?"),e.forEach(function(e,t){var a=e.count>1?"s":"";!e.imported&&t<3?r.push(e.count+" recording"+a+' from "'+e.site+'"'):e.imported&&(i+=e.count,n.push('"'+e.site+'"'))}),e.length>3){var o=0;e.forEach(function(e,t){t>=3&&(o+=e.count)});const s="& "+o+" recordings from "+(e.length-3)+" other sites";r.push(s)}return i&&t.push("(The filters matched "+i+" recordings wich come from "+n.join(", ")+". You cannot delete these from your project, they can only be removed from their original project.)"),a.open({templateUrl:"/common/templates/pop-up.html",controller:function(){this.messages=t,this.list=r,this.note="Note: analysis results on these recordings will also be deleted",this.btnOk="Delete",this.btnCancel="Cancel"},controllerAs:"popup"}).result}).then(function(){return n.post("/api/project/"+t.getUrl()+"/recordings/delete-matching",i).error(function(e){return r.error(e)})}).then(function(e){if(e.data.error)return r.error(e.data.error);this.searchRecs(["count","list"]),r.log(e.data.msg)}.bind(this)):void r.error("Recordings not found"):void r.error("You do not have permission to delete recordings")},e.params={},e.loading=!0,e.currentPage=1,e.limitPerPage=10,this.searchRecs(["count","date_range","list"]),e.$watch("checked",function(){e.combineCheckedRecordings()}),e.combineCheckedRecordings=function(){e.recs.forEach(function(t){t.checked&&!e.selectedRecId.includes(t.id)&&(e.selectedRecId.push(t.id),e.checkedRec.push(t))})},e.selectRec=function(t){if(!t.checked){const i=e.selectedRecId.findIndex(function(e){return e===t.id});return e.selectedRecId.splice(i,1),void e.checkedRec.splice(i,1)}e.selectedRecId.includes(t.id)||(e.selectedRecId.push(t.id),e.checkedRec.push(t))},this.setCurrentPage=function(t){e.currentPage=t,this.searchRecs()},this.setLimitPerPage=function(t){e.limitPerPage=t,this.searchRecs()},this.exportRecordings=function(e){return o.isSuper()?this.openExportPopup(e):o.all&&!o.all.length||!o.can("export report")?r.error("You do not have permission to export data"):void this.openExportPopup(e)},this.openExportPopup=function(t){e.params.userEmail=o.getUserEmail()||"",a.open({controller:"ExportRecordingstModalInstanceCtrl",templateUrl:"/app/audiodata/export-report.html",resolve:{data:function(){return{params:e.params,listParams:t}}},backdrop:!1}).result.then(function(){r.log("Your report export request is processing <br> and will be sent by email.")})}}]).controller("SavePlaylistModalInstanceCtrl",["$scope","$modalInstance","a2Playlists","listParams","notify",function(e,t,i,n,a){var r;e.savePlaylist=function(o){e.isSavingPlaylist=!0,i.create({playlist_name:o,params:n},function(i){e.isSavingPlaylist=!1,i.error?e.errMess=i.error:(r=i,t.close({message:"Playlist created"}))});var s;clearTimeout(s),s=setTimeout(function(){e.isSavingPlaylist=!1,t.close({message:"Playlist creating"}),e.errMess||r||a.log("Your playlist is being created. <br> Check it in the project playlists")},6e4)},e.changePlaylistName=function(){e.errMess=null}}]).controller("ExportRecordingstModalInstanceCtrl",["$scope","$modalInstance","Project","data",function(e,t,i,n){e.userEmail=n.params.userEmail,e.exportRecordings=function(a){n.params.userEmail=a,e.isExportingRecs=!0,e.errMess="",i.getRecordingData(n.params,n.listParams).then(function(i){e.isExportingRecs=!1,i.error?e.errMess=i.error:t.close()})},e.changeUserEmail=function(){e.errMess=null}}]).directive("customSrc",function(){return{link:function(e,t,i){var n,a;n=null,a=function(){t[0].src="",n=new Image,n.src=i.customSrc,n.onload=function(){t[0].src=i.customSrc},n.onerror=function(){t[0].src="https://rfcx-web-static.s3.eu-west-1.amazonaws.com/arbimon/unavaliable.png"}},e.$watch(function(){return i.customSrc},function(e,t){t!==e&&a()})}}}),angular.module("a2.audiodata.templates",["a2.services","a2.directives","ui.bootstrap","a2.srv.templates","a2.directive.audio-bar","a2.visualizer.audio-player","humane"]).config(["$stateProvider",function(e){e.state("audiodata.templates",{url:"/templates",controller:"TemplatesCtrl as controller",templateUrl:"/app/audiodata/templates/templates.html"})}]).controller("TemplatesCtrl",["$scope","a2Templates","Project","$localStorage","a2UserPermit","notify","$modal","$window","a2AudioBarService",function(e,t,i,n,a,r,o,s,c){var l=this;Object.assign(this,{initialize:function(){this.loading=!1,this.isAdding=!1,this.templates=[],this.currentTab="projectTemplates",this.pagination={page:1,limit:100,offset:0,totalItems:0,totalPages:0},this.projecturl=i.getUrl(),this.search={q:""},this.getList(),this.timeout},goToSourceProject:function(e){e&&i.getProjectById(e,function(e){e&&(s.location.pathname="/project/"+e.url+"/audiodata/templates")})},setCurrentPage:function(){l.pagination.offset=l.pagination.page-1,this.getList()},getList:function(){l.loading=!0;const e={showRecordingUri:!0,q:l.search.q,limit:l.pagination.limit,offset:l.pagination.offset*l.pagination.limit};return e[l.currentTab]=!0,t.getList(e).then(function(e){l.loading=!1,l.templates=e.list,l.pagination.totalItems=e.count,l.pagination.totalPages=Math.ceil(l.pagination.totalItems/l.pagination.limit)}.bind(this)).catch(function(e){l.loading=!1,l.templates=[],r.serverError(e)}.bind(this))},onSearchChanged:function(){var e=this;clearTimeout(l.timeout),l.timeout=setTimeout(function(){l.search.q.trim().length>0&&l.search.q.trim().length<3||e.reloadPage()},1e3)},reloadPage:function(){this.resetPagination(),this.getList()},getTemplateVisualizerUrl:function(e){const t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+e.project_url+"/#/visualizer/rec/"+e.recording+"?a="+t:""},deleteTemplate:function(i){if(!a.can("manage templates"))return void r.error("You do not have permission to delete templates");e.popup={title:"Delete template",messages:["Are you sure you want to delete this template?"],btnOk:"Yes",btnCancel:"No"},o.open({templateUrl:"/common/templates/pop-up.html",scope:e}).result.then(function(e){if(e)return t.delete(i).then(function(){l.getList()})})},toggleTab:function(e){l.currentTab=e,this.reloadPage()},resetPagination:function(){l.pagination={page:1,limit:100,offset:0,totalItems:0,totalPages:0}},addTemplate:function(e){l.isAdding=!0,t.add({name:e.name,recording:e.recording,species:e.species,songtype:e.songtype,roi:{x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2},source_project_id:e.project}).then(function(e){console.log("new template",e),l.isAdding=!1,0===e.id?r.error("The template already exists in the project templates."):e.error?r.error("You do not have permission to manage templates"):r.log("The template is added to the project.")}).catch(function(e){console.log("err",e),l.isAdding=!1,r.error(e)})},playTemplateAudio:function(e,i){i&&(i.preventDefault(),i.stopPropagation()),n.setItem("a2-audio-param-gain",JSON.stringify(2)),console.info("play"),c.loadUrl(t.getAudioUrlFor(e),!0)}}),this.initialize()}]),angular.module("a2.citizen-scientist.admin",["ui.router","a2.citizen-scientist.admin.classification-stats","a2.citizen-scientist.admin.user-stats","a2.citizen-scientist.admin.settings"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("citizen-scientist.admin",{url:"/admin",template:"<ui-view />",abstract:!0})}]),angular.module("a2.audiodata.uploads",["ui.router","a2.audiodata.uploads.upload","a2.audiodata.uploads.processing"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("audiodata.uploads",{url:"/uploads",template:"<ui-view />",abstract:!0})}]),angular.module("a2.audiodata.uploads.processing",["a2.services","a2.srv.uploads","a2.directives","ui.bootstrap","angularFileUpload","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("audiodata.uploads.processing",{url:"/processing",controller:"A2AudioDataUploadsProcessingCtrl as controller",templateUrl:"/app/audiodata/uploads/processing.html"})}]).controller("A2AudioDataUploadsProcessingCtrl",["$scope","a2UploadsService",function(e,t){this.loadPage=function(){this.loading=!0,t.getProcessingList().then(function(e){this.loading=!1,this.list=e.list,this.count=e.count}.bind(this))},this.loadPage()}]),angular.module("a2.audiodata.uploads.upload",["a2.services","a2.directives","ui.bootstrap","angularFileUpload","a2.srv.app-listings","a2.filter.caps","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("audiodata.uploads.upload",{url:"/",controller:"A2AudioDataUploadsUploadCtrl as controller",templateUrl:"/app/audiodata/uploads/upload.html"})}]).filter("prettyBytes",function(){return function(e){var t,i,n=["B","kB","MB","GB"];for(i=1;e/Math.pow(1024,i)>1;i++)t=e/Math.pow(1024,i);return t=Math.round(100*t)/100,String(t)+" "+n[i-1]}}).controller("A2AudioDataUploadsUploadCtrl",["$scope","uploads","Project","AppListingsService","a2UserPermit","notify","$interval","a2UploadsService",function(e,t,i,n,a,r,o,s){e.verifyAndUpload=function(){if(!a.can("manage project recordings"))return void r.error("You do not have permission to upload recordings");var t=0;e.uploading=!0;var n=function(){var a=e.uploader.queue[t];if(a&&a.file&&!a.file.size)return a.isError=!0,void(a.errorMsg="Error of the file size");var r=function(){t++,n()};return a&&e.uploading?a.isSuccess?r():void i.recExists(e.info.site.id,a.file.name,function(t){if(t)return console.log("duplicated"),a.isDuplicate=!0,r();a.url="/uploads/audio?project="+e.project.project_id+"&site="+e.info.site.id+"&nameformat="+e.info.format.name+"&timezone="+e.info.timezone.format,a.upload(),a.onSuccess=r,a.onError=r}):void(e.uploading=!1)};n()},e.isCheckingStatus=!1,e.queueJobToCheckStatus=function(){e.isCheckingStatus||(e.isCheckingStatus=!0,s.getProcessingList({site:e.info.site.id}).then(function(t){const i=e.getUploadingFiles();if(!i.length)return e.cancelTimer(),void(e.isCheckingStatus=!1);const n=i.map(function(e){return e.file.name});if(t&&t.length){const a=t.filter(function(e){return n.includes(e.name)}),r=a.slice(0,5).map(function(e){return{uploadUrl:e.uploadUrl,uploadId:e.id,filename:e.name}});s.checkStatus({items:r}).then(function(t){t&&(t.forEach(function(t){const n=i.find(function(e){return e.file.name===t.filename});n&&"uploaded"===t.status&&e.makeSuccessItem(n)}),e.isCheckingStatus=!1)})}}))},e.getUploadingFiles=function(){const t=e.uploader.queue.filter(function(e){return!0===e.isSuccess&&!1===e.isUploaded});return t&&t.length?t:[]},e.checkUploadingFiles=function(){e.getUploadingFiles().length&&e.startTimer()},e.startTimer=function(){e.cancelTimer(),e.checkStatusInterval=o(function(){e.queueJobToCheckStatus()},1e4)},e.cancelTimer=function(){e.checkStatusInterval&&o.cancel(e.checkStatusInterval)},e.$on("$destroy",function(){e.cancelTimer()}),n.getFor("arbimon2-desktop-uploader").then(function(e){this.uploaderAppListing=e}.bind(this)),e.stopQueue=function(){e.uploading=!1,angular.forEach(e.uploader.queue,function(e){e.cancel()})},e.uploader=t.getUploader(),e.info={},e.formats=[{name:"Arbimon",format:"(*-YYYY-MM-DD_HH-MM)"},{name:"AudioMoth",format:"(*YYYYMMDD_HHMMSS)"},{name:"AudioMoth legacy",format:"(Unix Time code in Hex)"},{name:"Cornell",format:"(*_YYYYMMDD_HHMMSSZ)"},{name:"Song Meter",format:"(*_YYYYMMDD_HHMMSS)"},{name:"Wildlife",format:"(YYYYMMDD_HHMMSS)"}],e.fileTimezone=[{name:"UTC",format:"utc"},{name:"Site timezone",format:"local"}],i.getSites({utcDiff:!0},function(t){e.sites=t.sort(function(e,t){return new Date(t.updated_at)-new Date(e.updated_at)})}),e.selectSite=function(){const t=e.info&&e.info.site&&e.info.site.utcOffset?e.info.site.utcOffset+" (local)":"Site timezone";e.fileTimezone[1].name=t,
e.info.timezone=e.fileTimezone[1]},e.isStartUploadDisabled=function(){return!e.uploader.queue.length||e.isLimitExceeded()||!e.info.site||!e.info.format||e.uploading},e.isLimitExceeded=function(){return e.uploader.queue.length>1e3};const c=Math.round(1e8*Math.random());this.uploaderApps={mac:"https://rf.cx/ingest-app-latest-mac?r="+c,windows:"https://rf.cx/ingest-app-latest-win?r="+c},i.getInfo(function(t){e.project=t}),e.uploader.filters.push({name:"supportedFormats",fn:function(e){var t=e.name.split(".");return!!/mp3|flac|wav|opus/i.exec(t[t.length-1].toLowerCase())}}),e.uploader.filters.push({name:"notDuplicate",fn:function(t){return!e.uploader.queue.filter(function(e){return e.file.name===t.name}).length}}),e.uploader.onErrorItem=function(e,t,i,n){if(t.error)e.errorMsg=t.error;else{if(i>=500)return void(e.errorMsg="Server error");e.errorMsg="An error ocurred"}},e.uploader.onSuccessItem=function(t,i,n,a){t.isUploaded=!1,console.info("count of uploading files",e.getUploadingFiles().length),e.checkUploadingFiles()},e.makeSuccessItem=function(e){e.status="uploaded",e.isUploading=!1,e.isSuccess=!1,e.isUploaded=!0,e.progress=100},e.getProgress=function(e){return e.isUploading&&100===e.progress?90:e.isSuccess&&!e.isUploaded?90:e.progress},e.removeCompleted=function(){e.uploader.queue.length&&(e.uploader.queue=e.uploader.queue.filter(function(e){return!e.isSuccess}))},e.getCountOfUploaded=function(){return e.uploader&&e.uploader.queue&&e.uploader.queue.length?(e.uploaded=e.uploader.queue.filter(function(e){return!!e.isUploaded&&!e.isError}).length,e.uploaded):0},e.clearQueue=function(){e.uploader.progress=0,e.uploaded=0},e.uploaded=0,e.uploader.onProgressAll=function(){}}]).factory("uploads",["FileUploader",function(e){var t=new e;return window.addEventListener("beforeunload",function(e){if(t.isUploading){return(e||window.event).returnValue="Upload is in progress, Are you sure to exit?","Upload is in progress, Are you sure to exit?"}}),{getUploader:function(){return t}}}]),angular.module("a2.citizen-scientist.my-stats",["a2.services","a2.directives","ui.bootstrap","a2.srv.citizen-scientist-admin","angularFileUpload","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("citizen-scientist.my-stats",{url:"/my-stats",controller:"A2CitizenScientistMyStatsCtrl as controller",templateUrl:"/app/citizen-scientist/my-stats/index.html"})}]).controller("A2CitizenScientistMyStatsCtrl",["$scope","a2CitizenScientistService","$stateParams","$state","Users",function(e,t,i,n,a){this.loadPage=function(){this.loading=!0,t.getMyStats().then(function(e){this.loading=!1;var t=["validated","consensus","non_consensus","pending","reached_th"];this.stats=e.stats.map(function(i,n){return t.forEach(function(t){i["group_"+t]=e.groupStats[n][t]}),i}),this.overall=e.stats.reduce(function(e,i){return t.forEach(function(t){e[t]+=i[t],e["group_"+t]+=i["group_"+t]}),e},t.reduce(function(e,t){return e[t]=0,e["group_"+t]=0,e},{}))}.bind(this))},this.loadPage()}]),angular.module("a2.citizen-scientist.expert",["ui.bootstrap","a2.srv.patternmatching","a2.srv.citizen-scientist","a2.srv.citizen-scientist-expert","a2.visualizer.audio-player","a2.services","a2.permissions","humane","c3-charts"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("citizen-scientist.expert",{url:"/expert/:patternMatchingId?",controller:"CitizenScientistExpertCtrl",templateUrl:"/app/citizen-scientist/expert/list.html"})}]).controller("CitizenScientistExpertCtrl",["$scope","$filter","Project","ngTableParams","a2Playlists","notify","$q","a2CitizenScientistService","a2CitizenScientistExpertService","a2PatternMatching","a2UserPermit","$state","$stateParams",function(e,t,i,n,a,r,o,s,c,l,u,d,p){e.selectedPatternMatchingId=p.patternMatchingId;var f=function(i,a,r,o,s){var c={},l="desc";"+"==r[0]&&(l="asc"),c[r.substring(1)]=l;var u={page:i,count:a,sorting:c,filter:o};e.tableParams=new n(u,{total:s,getData:function(i,n){e.infopanedata="";var a=n.filter()?t("filter")(e.patternmatchingsOriginal,n.filter()):e.patternmatchingsOriginal,r=n.sorting()?t("orderBy")(a,n.orderBy()):e.patternmatchingsOriginal;n.total(r.length),i.resolve(r.slice((n.page()-1)*n.count(),n.page()*n.count())),r.length<1&&(e.infopanedata="No Pattern matchings searches found."),e.patternmatchingsData=r.slice((n.page()-1)*n.count(),n.page()*n.count())}})};e.getTemplateVisualizerUrl=function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+e.source_project_uri+"/visualizer/rec/"+e.recording+"?a="+t:""},e.selectItem=function(e){d.go("citizen-scientist.expert",{patternMatchingId:e||void 0})},e.loadPatternMatchings=function(){return e.loading=!0,e.infoInfo="Loading...",e.showInfo=!0,c.getPatternMatchings().then(function(t){e.patternmatchingsOriginal=t,e.patternmatchingsData=t,e.infoInfo="",e.showInfo=!1,e.loading=!1,e.infopanedata="",t.length>0?e.tableParams?e.tableParams.reload():f(1,10,"+cname",{},t.length):e.infopanedata="No pattern matchings found."})},e.selectedPatternMatchingId||e.loadPatternMatchings()}]).directive("a2CitizenScientistExpertDetails",function(){return{restrict:"E",replace:!0,scope:{patternMatchingId:"=",onGoBack:"&"},controller:"CitizenScientistExpertDetailsCtrl",controllerAs:"controller",templateUrl:"/app/citizen-scientist/expert/details.html"}}).filter("pmValidation",function(){return function(e,t,i){return 1==e?"present":0==e?"not present":null===e||void 0===e?t>0&&i>0?"conflicted":"---":void 0}}).controller("CitizenScientistExpertDetailsCtrl",["$scope","a2PatternMatching","a2Templates","a2CitizenScientistExpertService","a2UserPermit","Project","a2AudioBarService","notify",function(e,t,i,n,a,r,o,s){Object.assign(this,{id:null,initialize:function(e){this.id=e,this.offset=0,this.limit=100,this.selected={roi_index:0,roi:null,page:0},this.total={rois:0,pages:0},this.loading={details:!1,rois:!1},this.validation=this.lists.validation[2],this.thumbnailClass=this.lists.thumbnails[0].value,this.expertSearch=this.lists.search[0],this.projecturl=r.getUrl(),this.fetchDetails().then(function(){this.loadPage(this.selected.page)}.bind(this))},compositeValidation:function(e){var t=e.expert_validated,i=e.consensus_validated,n=e.cs_val_present,a=e.cs_val_not_present;return[t,i,n>0&&a>0?-1:null].reduce(function(e,t){return null===e?t:e},null)},lists:{thumbnails:[{class:"fa fa-th-large",value:""},{class:"fa fa-th",value:"is-small"}],search:[{value:"all",text:"All",description:"Show all matched rois."},{value:"consensus",text:"Consensus",description:"Show only rois where there is a consensus."},{value:"pending",text:"Pending",description:"Show only rois that have not reached a consensus yet."},{value:"conflicted",text:"Conflicted",description:"Show only rois where there is a conflict."},{value:"expert",text:"Expert",description:"Show only rois that have been decided by an expert."}],selection:[{value:"all",text:"All"},{value:"none",text:"None"},{value:"not-validated",text:"Not Validated"}],validation:[{class:"fa val-1",text:"Present",value:1},{class:"fa val-0",text:"Not Present",value:0},{class:"fa val-null",text:"Clear",value:null}]},fetchDetails:function(){return this.loading.details=!0,n.getPatternMatchingDetailsFor(this.id).then(function(e){this.loading.details=!1,this.patternMatching=e,this.setupExportUrl(),this.total={rois:e.matches,pages:Math.ceil(e.matches/this.limit)}}.bind(this)).catch(function(e){return this.loading.details=!1,s.serverError(e)}.bind(this))},onExpertSearchChanged:function(){this.selected.page=0,this.loadPage(0)},setupExportUrl:function(){this.patternMatchingExportUrl=n.getCSExportUrl({patternMatching:this.patternMatching.id})},onScroll:function(e,t){this.scrollElement=t.scrollElement;var i=t.scrollElement.scrollY,n=t.anchors.header.offset().top;this.headerTop=0|n,this.scrolledPastHeader=i>=n},onSelect:function(e){this.select(e.value)},loadPage:function(e){return this.loading.rois=!0,n.getPatternMatchingRoisFor(this.id,this.limit,e*this.limit,{search:this.expertSearch&&this.expertSearch.value}).then(function(e){return this.loading.rois=!1,this.rois=e.reduce(function(e,t){var i=t.site;t.recording;return e.idx[i]||(e.idx[i]={list:[],idx:{},name:i},e.list.push(e.idx[i])),e.idx[i].list.push(t),e},{list:[],idx:{}}).list,this.selected.roi=Math.min(),this.scrollElement&&this.scrollElement.scrollTo(0,0),e}.bind(this)).catch(function(e){return this.loading.rois=!1,s.serverError(e)}.bind(this))},playRoiAudio:function(e,i){i&&(i.preventDefault(),i.stopPropagation()),o.loadUrl(t.getAudioUrlFor(e),!0)},playTemplateAudio:function(){o.loadUrl(i.getAudioUrlFor(this.patternMatching.template),!0)},getRoiVisualizerUrl:function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+this.projecturl+"/visualizer/rec/"+e.recording_id+"?a="+t:""},getTemplateVisualizerUrl:function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+e.source_project_uri+"/visualizer/rec/"+e.recording+"?a="+t:""},setRoi:function(e){return this.total.rois<=0?(this.selected.roi_index=0,this.selected.roi=null):(this.selected.roi_index=Math.max(0,Math.min(0|e,this.total.rois-1)),this.selected.roi=this.rois[this.selected.roi_index]),this.selected.roi},setPage:function(e,t){return this.total.rois<=0?(this.selected.page=0,this.rois=[],this.rois):(e=Math.max(0,Math.min(e,this.total.rois/this.limit|0)))!=this.selected.page||t?(this.selected.page=e,this.loadPage(e)):void 0},select:function(e){var t=null;t="all"===e?function(e){e.selected=!0}:"none"===e?function(e){e.selected=!1}:"not-validated"===e?function(e){e.selected=null===e.cs_validated}:function(t){t.selected=t.id===e},this.forEachRoi(t)},forEachRoi:function(e){(this.rois||[]).forEach(function(t){t.list.forEach(e)})},validate:function(e,t){if(!a.can("validate pattern matchings"))return void s.error("You do not have permission to validate the matched rois.");void 0===e&&(e=(this.validation||{value:null}).value),void 0===t&&(t=[],this.forEachRoi(function(e){e.selected&&t.push(e)}));var i=t.map(function(e){return e.id}),r={conflict_unresolved:0,conflict_resolved:0,null:0,0:0,1:0};return n.validatePatternMatchingRois(this.id,i,e).then(function(){t.forEach(function(t){var i,n;t.cs_val_present>0&&t.cs_val_not_present>0&&(i=null!==t.expert_validated?"conflict_resolved":"conflict_unresolved",n=null!==e?"conflict_resolved":"conflict_unresolved"),r[i]-=1,r[n]+=1,r[t.expert_validated]-=1,r[e]+=1,t.expert_validated=e,t.selected=!1}),this.patternMatching.cs_conflict_resolved+=r.conflict_resolved,this.patternMatching.cs_conflict_unresolved+=r.conflict_unresolved,this.patternMatching.expert_consensus_absent+=r[0],this.patternMatching.expert_consensus_present+=r[1],this.loadPage(this.selected.page)}.bind(this))},nextMatch:function(e){return this.setRoi(this.selected.roi_index+(e||1))},prevMatch:function(e){return this.setRoi(this.selected.roi_index-(e||1))},nextPage:function(e){return this.setPage(this.selected.page+(e||1))},prevPage:function(e){return this.setPage(this.selected.page-(e||1))},next:function(e){e||(e=1),this.nextPage(e)},prev:function(e){return e||(e=1),this.next(-e)}}),this.initialize(e.patternMatchingId)}]),angular.module("a2.citizen-scientist.patternmatching",["ui.bootstrap","a2.srv.patternmatching","a2.srv.citizen-scientist","a2.visualizer.audio-player","a2.services","a2.permissions","humane","c3-charts"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("citizen-scientist.patternmatching",{url:"/patternmatching",controller:"CitizenScientistPatternMatchingCtrl",templateUrl:"/app/citizen-scientist/patternmatching/list.html"}),e.state("citizen-scientist.patternmatching-details",{url:"/patternmatching/:patternMatchingId?",controller:"CitizenScientistPatternMatchingCtrl",templateUrl:"/app/citizen-scientist/patternmatching/list.html"})}]).controller("CitizenScientistPatternMatchingCtrl",["$scope","$filter","Project","ngTableParams","a2Playlists","notify","$q","a2CitizenScientistService","a2PatternMatching","a2UserPermit","$state","$stateParams",function(e,t,i,n,a,r,o,s,c,l,u,d){e.selectedPatternMatchingId=d.patternMatchingId;var p=function(i,a,r,o,s){var c={},l="desc";"+"==r[0]&&(l="asc"),c[r.substring(1)]=l;var u={page:i,count:a,sorting:c,filter:o};e.tableParams=new n(u,{total:s,getData:function(i,n){e.infopanedata="";var a=n.filter()?t("filter")(e.patternmatchingsOriginal,n.filter()):e.patternmatchingsOriginal,r=n.sorting()?t("orderBy")(a,n.orderBy()):e.patternmatchingsOriginal;n.total(r.length),i.resolve(r.slice((n.page()-1)*n.count(),n.page()*n.count())),r.length<1&&(e.infopanedata="No Pattern matchings searches found."),e.patternmatchingsData=r.slice((n.page()-1)*n.count(),n.page()*n.count())}})};e.getTemplateVisualizerUrl=function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+e.source_project_uri+"/visualizer/rec/"+e.recording+"?a="+t:""},e.selectItem=function(t){e.selectedPatternMatchingId=t,t?u.go("citizen-scientist.patternmatching-details",{patternMatchingId:t}):u.go("citizen-scientist.patternmatching",{})},e.loadPatternMatchings=function(){return e.loading=!0,e.infoInfo="Loading...",e.showInfo=!0,s.getPatternMatchings().then(function(t){e.patternmatchingsOriginal=t,e.patternmatchingsData=t,e.infoInfo="",e.showInfo=!1,e.loading=!1,e.infopanedata="",t.length>0?e.tableParams?e.tableParams.reload():p(1,10,"+cname",{},t.length):e.infopanedata="No pattern matchings found."})},e.selectedPatternMatchingId||e.loadPatternMatchings()}]).directive("a2CitizenScientistPatternMatchingDetails",function(){return{restrict:"E",replace:!0,scope:{patternMatchingId:"=",onGoBack:"&"},controller:"CitizenScientistPatternMatchingDetailsCtrl",controllerAs:"controller",templateUrl:"/app/citizen-scientist/patternmatching/details.html"}}).controller("CitizenScientistPatternMatchingDetailsCtrl",["$scope","a2PatternMatching","a2Templates","a2CitizenScientistService","a2UserPermit","Project","a2AudioBarService","notify",function(e,t,i,n,a,r,o,s){Object.assign(this,{id:null,initialize:function(e){this.id=e,this.offset=0,this.limit=100,this.selected={roi_index:0,roi:null,page:0},this.total={rois:0,pages:0},this.loading={details:!1,rois:!1},this.validation=this.lists.validation[2],this.thumbnailClass=this.lists.thumbnails[0].value,this.projecturl=r.getUrl(),this.fetchDetails().then(function(){this.loadPage(this.selected.page)}.bind(this))},lists:{thumbnails:[{class:"fa fa-th-large",value:""},{class:"fa fa-th",value:"is-small"}],selection:[{value:"all",text:"All"},{value:"none",text:"None"}],validation:[{class:"fa val-1",text:"Present",value:1},{class:"fa val-0",text:"Not Present",value:0},{class:"fa val-null",text:"Clear",value:null}]},fetchDetails:function(){return this.loading.details=!0,n.getPatternMatchingDetailsFor(this.id).then(function(e){this.loading.details=!1,this.patternMatching=e,this.setupExportUrl(),this.total={rois:e.cs_total,pages:Math.ceil(e.cs_total/this.limit)}}.bind(this)).catch(function(e){return this.loading.details=!1,s.serverError(e)}.bind(this))},setupExportUrl:function(){this.patternMatchingExportUrl=t.getExportUrl({patternMatching:this.patternMatching.id})},onScroll:function(e,t){this.scrollElement=t.scrollElement;var i=t.scrollElement.scrollY,n=t.anchors.header.offset().top;this.headerTop=0|n,this.scrolledPastHeader=i>=n},onSelect:function(e){this.select(e.value)},loadPage:function(e){return this.loading.rois=!0,n.getPatternMatchingRoisFor(this.id,this.limit,e*this.limit).then(function(e){return this.loading.rois=!1,this.rois=e.reduce(function(e,t){var i=t.site;t.recording;return e.idx[i]||(e.idx[i]={list:[],idx:{},name:i},e.list.push(e.idx[i])),e.idx[i].list.push(t),e},{list:[],idx:{}}).list,this.selected.roi=Math.min(),this.scrollElement&&this.scrollElement.scrollTo(0,0),e}.bind(this)).catch(function(e){return this.loading.rois=!1,s.serverError(e)}.bind(this))},playRoiAudio:function(e,i){i&&(i.preventDefault(),i.stopPropagation()),o.loadUrl(t.getAudioUrlFor(e),!0)},playTemplateAudio:function(){o.loadUrl(i.getAudioUrlFor(this.patternMatching.template),!0)},getRoiVisualizerUrl:function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+this.projecturl+"/visualizer/rec/"+e.recording_id+"?a="+t:""},getTemplateVisualizerUrl:function(e){var t=["box",e.x1,e.y1,e.x2,e.y2].join(",");return e?"/project/"+e.source_project_uri+"/visualizer/rec/"+e.recording+"?a="+t:""},setRoi:function(e){return this.total.rois<=0?(this.selected.roi_index=0,this.selected.roi=null):(this.selected.roi_index=Math.max(0,Math.min(0|e,this.total.rois-1)),this.selected.roi=this.rois[this.selected.roi_index]),this.selected.roi},setPage:function(e,t){return this.total.rois<=0?(this.selected.page=0,this.rois=[],this.rois):(e=Math.max(0,Math.min(e,this.total.rois/this.limit|0)))!=this.selected.page||t?(this.selected.page=e,this.loadPage(e)):void 0},select:function(e){var t=null;t="all"===e?function(e){e.selected=!0}:"none"===e?function(e){e.selected=!1}:"not-validated"===e?function(e){e.selected=null===e.cs_validated}:function(t){t.selected=t.id===e},this.forEachRoi(t)},forEachRoi:function(e){(this.rois||[]).forEach(function(t){t.list.forEach(e)})},validate:function(e,t){if(!a.can("use citizen scientist interface"))return void s.error("You do not have permission to validate the matched rois.");void 0===e&&(e=(this.validation||{value:null}).value),void 0===t&&(t=[],this.forEachRoi(function(e){e.selected&&t.push(e)}));var i=t.map(function(e){return e.id}),r={0:0,1:0,null:0};return t.forEach(function(t){r[t.cs_validated]-=1,r[e]+=1,t.cs_validated=e,t.selected=!1}),this.patternMatching.cs_absent+=r[0],this.patternMatching.cs_present+=r[1],n.validatePatternMatchingRois(this.id,i,e)},nextMatch:function(e){return this.setRoi(this.selected.roi_index+(e||1))},prevMatch:function(e){return this.setRoi(this.selected.roi_index-(e||1))},nextPage:function(e){return this.setPage(this.selected.page+(e||1))},prevPage:function(e){return this.setPage(this.selected.page-(e||1))},next:function(e){e||(e=1),this.nextPage(e)},prev:function(e){return e||(e=1),this.next(-e)}}),this.initialize(e.patternMatchingId)}]),angular.module("a2.visobjectsbrowser",["a2.utils","a2.browser_common","a2.browser_recordings","a2.browser_soundscapes","a2.service.serialize-promised-fn"]).directive("a2VisObjectBrowser",["$window","$timeout",function(e,t){return{restrict:"E",scope:{location:"=?",onVisObject:"&"},templateUrl:"/app/visualizer/browser/main.html",controller:"a2VisObjectBrowserController as browser",link:function(e,i,n,a){a.waitForInitialized.then(function(){e.$emit("browser-available")}),a.events.on("location-changed",function(){e.location=this.location}),a.events.on("browser-vobject-type",function(t){e.$emit("browser-vobject-type",t)}),a.events.on("on-vis-object",function(n,a,r){e.onVisObject({location:n,visobject:a,type:r}),t(function(){var e=i.find(".visobj-list-item.active");if(e.length){var t=e.parent(),n=e.offset(),a=t.offset(),r=n.top-a.top;t.animate({scrollTop:t.scrollTop()+r})}})}),e.selectVisObject=a.selectVisObject.bind(a),e.$on("prev-visobject",a.selectPreviousVisObject.bind(a)),e.$on("next-visobject",a.selectNextVisObject.bind(a)),e.$on("set-browser-location",a.setBrowserLocation.bind(a)),e.$on("set-browser-annotations",a.setBrowserAnnotations.bind(a)),e.$on("clear-recording-data",a.clearRecordingData.bind(a)),e.$on("visobj-updated",a.notifyVisobjUpdated.bind(a)),a.activate(e.location).catch(console.error.bind(console))}}}]).controller("a2VisObjectBrowserController",["$scope","$state","$controller","$q","serializePromisedFn","BrowserLOVOs","BrowserVisObjects","itemSelection","Project","EventlistManager",function(e,t,i,n,a,r,o,s,c,l){var u=this;this.types=r.$grouping,this.visobjectTypes=o,this.loading={sites:!1,dates:!1,times:!1},this.auto={},this.visobj=null,this.lovo=null,this.events=new l;var d=!1,p=n.defer();this.waitForInitialized=p.promise,this.waitForInitialized.then(function(){this.type||this.setBrowserType(r.$list.filter(function(e){return e.default}).shift())}.bind(this)),this.activate=function(t){var i=this.$type;return(i&&i.activate?i.activate().then(function(){return e.browser.currentRecording&&e.browser.annotations?this.setLOVO():i.lovo?this.setLOVO(i.lovo):void 0}.bind(this)):n.resolve()).then(function(){d||(d=!0,p.resolve())}.bind(this))},this.setLOVO=function(t,i){n.defer(),u.lovo;return u.lovo=t,u.lovo&&(u.lovo.loading=!0),n.resolve().then(function(){t&&(u.lovo.loading=!1,t.recordingsBySite&&t.updateRecording(e.browser.currentRecording?e.browser.currentRecording:void 0),t.initialize().then(function(){i&&u.set_location(i)}).then(function(){if(t.recordingsBySite&&t.list&&t.recording_id&&(u.auto.visobject=t.list.find(function(e){return e.id===u.auto.visobject.id})),u.auto.visobject)return t.find(u.auto.visobject).then(function(e){return u.setVisObj(e)})}).then(function(){return n.resolve(t)}))})},this.set_location=function(e){this.location=e,this.events.send({event:"location-changed",context:this},e)},this.setBrowserType=a(function(t){var a,r=u.$type;t&&t.controller&&(t.$controller||(t.$controller=i(t.controller,{$scope:e,a2Browser:u})),a=t.$controller);var o=a!==r;return(o?n.resolve().then(function(){if(o&&r&&r.deactivate)return r.deactivate()}).then(function(){if(o&&a&&a.activate)return u.type=t,u.$type=a,u.activate()}):n.resolve()).then(function(){u.events.send({event:"browser-vobject-type",context:u},t.vobject_type)})}),this.setVisObj=function(e){this.visobj=e;var t=e&&u.$type.get_location(e);this.cachedLocation=t,this.events.send({event:"on-vis-object",context:this},t,e,u.lovo?u.lovo.object_type:null)},this.selectVisObject=function(e){return console.log("this.selectVisObject :: ",e),e?n.resolve().then(function(){return u.lovo&&u.lovo.find(e)}).then(function(t){return t||e}).then(function(t){return u.auto={visobject:t},u.$type.auto_select?u.$type.auto_select(e):u.setVisObj(e)}):n.resolve()},this.selectPreviousVisObject=function(){u.visobj&&u.lovo&&u.lovo.previous(u.visobj.id).then(this.selectVisObject.bind(this))},this.selectNextVisObject=function(){console.log("this.selectNextVisObject = function(){"),u.visobj&&u.lovo&&u.lovo.next(u.visobj.id).then(this.selectVisObject.bind(this))},this.setBrowserAnnotations=function(e,t,i){this.annotations=i,this.currentRecording=t},this.clearRecordingData=function(e,t){this.currentRecording=null},this.setBrowserLocation=function(e,t){var i=/([\w-+]+)(\/(.+))?/.exec(t);if(this.cachedLocation==t)return n.resolve();if(this.cachedLocation=t,i&&r[i[1]]){var a=i[3],o=r[i[1]];this.setBrowserType(o).then(function(){return o.$controller.resolve_location(a)}).then(function(e){if(e)return u.selectVisObject(e)})}},this.notifyVisobjUpdated=function(e,t){u.lovo&&u.lovo.update&&u.lovo.update(t)}}]),angular.module("a2.browser_common",[]).provider("BrowserVisObjects",function(){var e={};return{add:function(t){e[t.type]=angular.extend(e[t.type]||{},t)},$get:function(){return e}}}).provider("BrowserLOVOs",function(){var e={$grouping:[],$list:[]};return{add:function(t){e.$list.push(t)},$get:function(){return e.$grouping=e.$list.reduce(function(t,i){var n=i.group||"";return t.$index[n]||t.groups.push(t.$index[n]=[]),t.$index[n].push(e[i.name]=i),t},{groups:[],$index:{}}).groups,e}}}).service("a2ArrayLOVO",["$q",function(e){var t=function(e,t){this.offset=0,this.setArray(e,t)};return t.prototype={initialize:function(){var t=e.defer();return t.resolve(!0),t.promise},setArray:function(e,t){this.list=e||[],this.count=this.list.length,this.object_type=t},find:function(t){var i=e.defer(),n=t&&t.id||0|t;return i.resolve(this.list.filter(function(e){return e.id==n}).shift()),i.promise},previous:function(t){for(var i=e.defer(),n=t&&t.id||0|t,a=0,r=this.list,o=0,c=r.length;o<c;++o)if(s.id==n){a=Math.min(Math.max(0,o-1,this.list.length-1));break}return i.resolve(this.list[a]),i.promise},next:function(t){for(var i=e.defer(),n=soundscape&&soundscape.id||0|soundscape,a=0,r=this.list,o=0,c=r.length;o<c;++o)if(s.id==n){a=Math.min(Math.max(0,o+1,this.list.length-1));break}return i.resolve(this.list[a]),i.promise}},t}]),angular.module("a2.visualizer.dialog",[]).directive("a2VisualizerDialog",function(){return{restrict:"E",transclude:!0,templateUrl:"/app/visualizer/dialog/dialog.html",scope:{show:"=",x1:"=",y1:"=",x2:"=",y2:"="},controller:"a2VisualizerDialogCtrl"}}).controller("a2VisualizerDialogCtrl",["$scope",function(e){e.layout=e.$parent.layout,e.getXSide=function(t,i){return Math.max(0,Math.min(e.layout.sec2x(i,1)/e.layout.spectrogram.width,1))>.5?"left":"right"},e.getXCoord=function(t,i){return"left"==e.getXSide(t,i)?t:i},e.getTransform=function(t,i,n,a){return"translate("+("left"==e.getXSide(t,i)?"-100%":"0")+", "+e.getYTranslation((n+a)/2,!0)+")"},e.getYTranslation=function(t,i){var n=Math.max(.1,Math.min(e.layout.hz2y(t,1)/e.layout.spectrogram.height,.9));return i&&(n=-n),(100*n|0)+"%"}}]),angular.module("a2.visualizer.layers.recording-tags",["a2.srv.tags"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"recording-tags-layer",title:"",controller:"a2VisualizerRecordingTagsLayerController as controller",require:{type:"recording",selection:!0},visible:!0,hide_visibility:!0})}]).controller("a2VisualizerRecordingTagsLayerController",["VisualizerCtrl","a2Tags","a2LookaheadHelper","a22PointBBoxEditor","$q","$debounce",function(e,t,i,n,a,r){function o(e){return e.reduce(function(e,t){return t.id&&(e[t.id]=!0),e},{})}function s(e){var t=[];return e.reduce(function(e,i){if(i.f0){var n=[i.t0,i.f0,i.t1,i.f1],a=n.join(",");e[a]||t.push(e[a]={bbox:i,tags:[]}),e[a].tags.push(i)}return e},{}),t}var c=new i({fn:t.search,minLength:3,includeSearch:!0,searchPromote:function(e){return{tag:e}},searchCompare:function(e,t){return t.tag==e}});this.tags=[],this.spectrogramTags=[],this.tagsIndex={},this.bboxTags=[],this.bboxTagsIndex={},this.setVisobject=function(e){return this.visobject=e,this.loadTags()},this.loadTags=function(){var e=this.visobject;return e&&/^recording$/.test(e.type)?(this.loading=!0,this.visobject=e,t.getFor(e).then(function(e){return this.tagsIndex=o(e),this.spectrogramTags=s(e),this.tags=e,e}.bind(this)).finally(function(){this.loading=!1}.bind(this))):(this.tags=[],a.resolve(this.tags))},this.searchedTags=[],this.searchTags=function(e){return""!==e&&e||this.getProjectTags(),c.search(e).then(function(e){this.searchedTags=e}.bind(this))},this.onTagListChanged=r(function(){var e=this.determineTagUpdate(this.tags,this.tagsIndex);return this.updateTags(e)},100),this.onBBoxTagListChanged=r(function(){var e=this.determineTagUpdate(this.bboxTags);this.bboxTags=[];var t=this.bbox.bbox;return e.add.forEach(function(e){e.t0=t.x1,e.f0=t.y1,e.t1=t.x2,e.f1=t.y2}),this.updateTags(e).then}),this.getProjectTags=function(){return t.getForType("recording").then(function(e){this.searchedTags=e}.bind(this))},this.getProjectTags(),this.determineTagUpdate=function(e,t){var i=o(e),n=Object.keys(t||{}).filter(function(e){return!i[e]});return{add:e.filter(function(e){return!e.id}),delete:n}},this.updateTags=function(e){var i=this.visobject;return console.log("visobject : ",i),console.log("tag update : ",e),a.all([a.all(e.delete.map(function(e){return t.deleteFor(i,e)})),a.all(e.add.map(function(e){return t.addFor(i,e)}))]).then(function(e){return this.loadTags()}.bind(this)).catch(function(){return this.loadTags()}.bind(this))},this.bbox=angular.extend(new n,{add_tracer_point:function(e){this.super.add_tracer_point.call(this,e.sec,e.hz)},add_point:function(e,t){this.super.add_point.call(this,e.sec,e.hz,t)},resetBboxTags:function(){console.log("resetBboxTags",this.bboxTags),this.bboxTags=[]}.bind(this),reset:function(){this.resetBboxTags(),this.super.reset.call(this)}}),e.on("visobject",this.setVisobject.bind(this))}]).directive("a2Tag",function(){return{restrict:"E",scope:{tag:"="},template:'<span class="fa fa-tag no-text-wrap">{{tag.tag}}</span>'}}),angular.module("a2.visualizer.layers.soundscape-composition-tool",["a2.srv.soundscape-composition","arbimon2.directive.validation-dropdown"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"soundscape-composition-tool",title:"",controller:"a2VisualizerSoundscapeCompositionToolController as controller",display:{spectrogram:!1},require:{type:"recording",selection:!0},visible:!0,hide_visibility:!0})}]).controller("a2VisualizerSoundscapeCompositionToolController",["$q","VisualizerCtrl","a2UserPermit","notify","a2SoundscapeCompositionService",function(e,t,i,n,a){this.initialize=function(){t.on("visobject",this.setVisobject.bind(this)),a.getClassList({groupByType:!0,isSystemClass:1}).then(function(e){this.classTypes=e,this.classesByType=e.reduce(function(e,t){return e[t.type]=t,e},{})}.bind(this)),this.annotations={},this.annotationToolbar=[[{value:1,caption:"Annotate as Present"},{value:0,caption:"Annotate as Absent"}],[{value:2,caption:"Clear Annotation"}]]},this.annotate=function(e,t){if(!i.can("validate species"))return void n.error("You do not have permission to add soundscape composition annotations.");var r=[t];r.length>0&&a.annotate(this.visobject,{class:r.join(","),val:e}).then(function(e){this.is_selected={},e.forEach(function(e){2==e.present?delete this.annotations[e.scclassId]:this.annotations[e.scclassId]=e.present}.bind(this))}.bind(this))},this.setVisobject=function(e){return this.visobject=e,this.loadAnnotations()},this.loadAnnotations=function(){var t=this.visobject;return t&&/^recording$/.test(t.type)?(this.loading=!0,this.visobject=t,a.getAnnotationsFor(t).then(function(e){return this.annotations=e,e}.bind(this)).finally(function(){this.loading=!1}.bind(this))):(this.annotations={},e.resolve(this.annotations))},this.initialize()}]),angular.module("a2.visualizer.layers.templates",["visualizer-services","a2.utils"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"templates",title:"",controller:"a2VisualizerTemplateLayerController as templates",require:{type:"recording",selection:!0},visible:!0})}]).controller("a2VisualizerTemplateLayerController",["$scope","$modal","$controller","$state","$timeout","a2Templates","a2UserPermit","a22PointBBoxEditor","Project","notify",function(e,t,i,n,a,r,o,s,c,l){var u=this;u.selected=null,u.templates=[],u.recordingTemplates=[],u.citizenScientistUser=o.all&&1===o.all.length&&o.all.includes("use citizen scientist interface")&&!o.can("delete project")&&!o.isSuper(),c.getClasses(function(e){u.project_classes=e});var d=r.getList({projectTemplates:!0}).then(function(e){return u.templates=e,e});u.updateState=function(){var t=e.visobject&&"recording"==e.visobject_type&&e.visobject.id;d.then(function(){u.recordingTemplates=u.templates.filter(function(e){return e.recording==t})}),u.editor.reset(),u.editor.recording=t},u.goToSpeciesPage=function(){n.go("audiodata.species",{})},u.editor=angular.extend(new s,{reset:function(){this.super.reset.call(this),this.roi=null},make_new_bbox:function(){this.super.make_new_bbox.call(this),this.roi=this.bbox},make_new_roi:function(){this.make_new_bbox()},add_tracer_point:function(e){this.super.add_tracer_point.call(this,e.sec,e.hz)},add_point:function(e,t){console.log("add_point : function(",e,", ",t,"){"),this.super.add_point.call(this,e.sec,e.hz,t)},get_placeholder_name:function(){return this.project_class?this.project_class.species_name+" "+this.project_class.songtype_name:"Template Name"},submit:function(){if(!o.can("manage templates"))return void l.error("You do not have permission to add a template");(this.project_class.songtype_name||this.project_class.species_name)&&(this.submitting=!0,r.add({name:this.template_name||this.project_class.species_name+" "+this.project_class.songtype_name,recording:this.recording,species:this.project_class.species,songtype:this.project_class.songtype,roi:this.roi}).then(function(e){if(console.log("new_template",e),this.submitting=!1,0===e.id)return l.error("The template with that name already exists for this record.");a(function(){this.reset(),u.templates.push(e),u.updateState()}.bind(this))}.bind(this)))}}),e.$watch("visobject",u.updateState)}]),
angular.module("a2.visobjects.audio-event-detection",["a2.services","a2.visobjects.common","a2.service.plotly-plot-maker"]).config(["VisualizerObjectTypesProvider",function(e){e.add({type:"audio-event-detection",$loader:["VisualizerObjectAudioEventDetectionTypeLoader",function(e){return e}]})}]).service("VisualizerObjectAudioEventDetectionTypeLoader",["$q","AudioEventDetectionService","plotlyPlotMaker","a2UrlUpdate",function(e,t,i,n){var a,r,o=e.resolve().then(function(){return e.all([t.getDataAggregatesList().then(function(e){a=e}),t.getDataStatisticsList().then(function(e){r=e.reduce(function(e,t){return e[t.statistic]=t,e},{})})])}),s=function(e){this.update(e).then(function(){return o}.bind(this)).then(function(){return this.selectData({x:r.tod,y:r.y_max,z:a.reduce(function(e,t){return"count"==t.statistic?t:e},null)})}.bind(this))};return s.fetch=function(t){var i=e.defer();return t=new s(t),i.resolve(t),i.promise},s.load=function(e,t){return s.fetch(e)},s.getCaptionFor=function(e){return e.name},s.prototype={type:"audio-event-detection",layout:"plotted",zoomable:!1,update:function(e){console.log("AED data : ",e);for(var t in e)this[t]=e[t];return this.plot={layout:{title:e.name},data:[]},-1==e.statistics.indexOf("todsec")&&e.statistics.push("todsec","todsecspan","freqspan"),o.then(function(){var t=e.statistics.reduce(function(e,t){return r[t]&&e.push(r[t]),e},[]);this.data_selection={x:t,y:t,z:a,current:{x:r.tod,y:r.y_max,z:a.reduce(function(e,t){return"count"==t.statistic?t:e},null)}}}.bind(this))},selectData:function(e){this.data_selection.current=angular.extend({},this.data_selection.current,e);var n=this.data_selection.current.x,a=this.data_selection.current.y,r=this.data_selection.current.z;return console.log("this.data_selection.current",this.data_selection.current),t.getDataFor(this.id,n,a,r).then(function(e){var t=n==a?i.makeBarPlot(n,r,e,this.name):i.makeHeatmapPlot(n,a,r,e,this.name);this.plot.data=[t.data],this.plot.layout=t.layout}.bind(this))},savePlot:function(){var e=this.data_selection.current.x,i=this.data_selection.current.y,a=this.data_selection.current.z;return t.savePlotFor(this.id,e,i,a).then(function(e){n.update(e.url)})},getCaption:function(){return s.getCaptionFor(this)}},s}]),angular.module("a2.visobjects.common",[]).provider("VisualizerObjectTypes",function(){var e={};return{add:function(t){e[t.type]=angular.extend(e[t.type]||{},t)},$get:["$injector",function(t){return{types:e,getLoader:function(i){if(!e[i])throw new Error("Visualizer Object Type '"+i+"' not found");return t.invoke(e[i].$loader)}}}]}}),angular.module("a2.visobjects.recording",["a2.services","a2.visobjects.common"]).config(["VisualizerObjectTypesProvider",function(e){e.add({type:"recording",$loader:["VisualizerObjectRecordingTypeLoader",function(e){return e}]})}]).service("VisualizerObjectRecordingTypeLoader",["$q","Project","$localStorage",function(e,t,i){var n=function(e){return e/1e3|0},a=function(){try{return JSON.parse(i.getItem("visuilizer.frequencies.cache"))||{originalScale:!0}}catch(e){return{originalScale:!0}}}(),r=function(e,i){for(var r in e)this[r]=e[r];if(this.sampling_rate=this.sample_rate,this.extra=i,this.max_freq=this.sampling_rate/2,this.span=a&&a.originalScale?this.max_freq:this.max_freq>24e3?this.max_freq:24e3,e||(this.span=22050,this.duration=60),this.domain={x:{from:0,to:this.duration,span:this.duration,unit:"Time ( s )",ticks:60},y:{from:0,to:this.span,span:this.span,unit:"Frequency ( kHz )",tick_format:n}},!this.tiles)return void(this.isDisabled=!0);this.tiles.set.forEach(function(i){if(e.legacy)i.src="/api/project/"+t.getUrl()+"/recordings/tiles/"+this.id+"/"+i.i+"/"+i.j;else{var n=e.uri.split("/")[3];const a=e.datetime_utc?e.datetime_utc:e.datetime;var r=new Date(new Date(a).valueOf()+Math.round(1e3*i.s)).toISOString(),o=new Date(new Date(a).valueOf()+Math.round(1e3*(i.s+i.ds))).toISOString();i.src="/api/ingest/recordings/"+n+"_t"+r.replace(/-|:|\./g,"")+"."+o.replace(/-|:|\./g,"")+"_z95_wdolph_g1_fspec_mtrue_d1023.255.png"}}.bind(this))};return r.layers=[],r.fetch=function(i){var n=e.defer();return t.getRecordingInfo(i.id,function(e){"Server error"===e&&(i.isDisabled=!0,e={}),i=new r(e,i.extra),n.resolve(i)}),n.promise},r.load=function(e,t){return r.fetch(e).then(function(e){return e.audioUrl&&t.audio_player.load(e.audioUrl),e})},r.getCaptionFor=function(e){return e.file},r.prototype={type:"recording",zoomable:!0,getCaption:function(){return r.getCaptionFor(this)}},r}]),angular.module("a2.visobjects.soundscape",["a2.services","a2.visobjects.common"]).config(["VisualizerObjectTypesProvider",function(e){e.add({type:"soundscape",$loader:["VisualizerObjectSoundscapeTypeLoader",function(e){return e}]})}]).service("VisualizerObjectSoundscapeTypeLoader",["$q","Project",function(e,t){var i=function(e){return e/1e3|0},n=function(e){return Math.floor(e/10)/100+" kHz"},a={time_of_day:{time_unit:"Time (Hour in Day)",unit_fmt:function(e){return(0|e)+":00"}},day_of_month:{time_unit:"Time (Day in Month)",unit_fmt:function(e){return 0|e}},day_of_year:{time_unit:"Time (Day in Year )",unit_fmt:function(e){return 0|e}},month_in_year:{time_unit:"Time (Month in Year)",unit_fmt:function(e){return moment().localeData()._months[(0|e)-1]}},day_of_week:{time_unit:"Time (Weekday) ",unit_fmt:function(e){return moment().localeData()._weekdays[(0|e)-1]}},year:{time_unit:"Time (Year) ",unit_fmt:function(e){return 0|e}},unknown:{time_unit:"Time",unit_fmt:function(e){return 0|e}}},r=function(e){this.update(e)};return r.fetch=function(t){var i=e.defer();return t=new r(t),i.resolve(t),i.promise},r.load=function(e,t){return r.fetch(e)},r.getCaptionFor=function(e){var t={time_of_day:"Time of day",day_of_month:"Day of Month",day_of_year:"Day of Year",month_in_year:"Month in year",day_of_week:"Day of week",year:"Year "};return e.name+" ("+t[e.aggregation]+")"},r.prototype={type:"soundscape",zoomable:!0,update:function(e){for(var t in e)this[t]=e[t];var r=this.min_t,o=this.max_t,s=this.min_f,c=this.max_f,l=this.min_value,u=this.visual_max_value||this.max_value;this.normalized&&(l=0,u=100);var d=o-r+1,p=c-s,f=u-l,h=a[this.aggregation]||a.unknown,g=h.time_unit;this.domain={x:{from:r,to:o,span:d,ticks:d,ordinal:!0,unit_interval:1,unit_format:h.unit_fmt,unit:g||"Time ( s )"},y:{from:s,to:c,span:p,unit:"Frequency ( kHz )",unit_interval:this.bin_size,unit_format:n,tick_format:i},legend:{from:l,to:u,span:f,ticks:Math.max(2,Math.min(0|f,10)),unit:"Count",src:"/images/palettes/"+this.visual_palette+".png"}},this.normalized&&(this.domain.legend.tick_format=function(e){return e+"%"}),this.tiles={x:1,y:1,set:[{i:0,j:0,s:0,hz:c,ds:d,dhz:p,src:this.thumbnail,crisp:!0}]},this.legend={min:0,max:255}},getCaption:function(){return r.getCaptionFor(this)}},r}]),angular.module("a2.visobjects",["a2.visobjects.common","a2.visobjects.recording","a2.visobjects.soundscape","a2.visobjects.audio-event-detection"]),angular.module("a2.analysis.random-forest-models.classification",["ui.bootstrap","a2.services","a2.permissions","humane","c3-charts"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("analysis.random-forest-models.classification",{url:"/classification",controller:"ClassificationCtrl",templateUrl:"/app/analysis/random-forest-models/classification/list.html"})}]).controller("ClassificationCtrl",["$scope","$modal","$filter","Project","ngTableParams","JobsData","a2Playlists","notify","$location","a2Classi","a2UserPermit",function(e,t,i,n,a,r,o,s,c,l,u){var d=function(t,n,r,o,s){var c={},u="desc";"+"==r[0]&&(u="asc"),c[r.substring(1)]=u;var d={page:t,count:n,sorting:c,filter:o};e.tableParams=new a(d,{total:s,getData:function(t,n){e.infopanedata="";var a=n.filter()?i("filter")(e.classificationsOriginal,n.filter()):e.classificationsOriginal,r=n.sorting()?i("orderBy")(a,n.orderBy()):e.classificationsOriginal;n.total(r.length),t.resolve(r.slice((n.page()-1)*n.count(),n.page()*n.count())),r.length<1&&(e.infopanedata="No classifications found."),e.classificationsData=r.slice((n.page()-1)*n.count(),n.page()*n.count()),l.saveState({data:e.classificationsOriginal,filtered:e.classificationsData,f:n.filter(),o:n.orderBy(),p:n.page(),c:n.count(),t:r.length})}})};e.updateFlags=function(){e.successInfo="",e.showSuccess=!1,e.errorInfo="",e.showError=!1,e.infoInfo="",e.showInfo=!1,e.loading=!1},e.capitalize=function(e){return e.length?e[0].toUpperCase()+e.slice(1):e},e.loadClassifications=function(){l.list(function(t){e.classificationsOriginal=t,t.forEach(function(t){t.muser=e.capitalize(t.firstname)+" "+e.capitalize(t.lastname)}),e.classificationsData=t,e.infoInfo="",e.showInfo=!1,e.loading=!1,e.infopanedata="",t.length>0?e.tableParams?e.tableParams.reload():d(1,10,"+cname",{},t.length):e.infopanedata="No classifications found."})},e.showClassificationDetails=function(i){e.infoInfo="Loading...",e.showInfo=!0,e.loading=!0;var n={id:i.job_id,name:i.cname,modelId:i.model_id,playlist:{name:i.playlist_name,id:i.playlist_id}};t.open({templateUrl:"/app/analysis/random-forest-models/classification/classinfo.html",controller:"ClassiDetailsInstanceCtrl",windowClass:"details-modal-window",backdrop:"static",resolve:{ClassiInfo:function(){return{data:n,project:e.projectData}}}}).opened.then(function(){e.infoInfo="",e.showInfo=!1,e.loading=!1})},e.createNewClassification=function(){if(!u.can("manage models and classification"))return void s.error("You do not have permission to create classifications");e.loading=!0,e.infoInfo="Loading...",e.showInfo=!0;var i=t.open({templateUrl:"/app/analysis/random-forest-models/classification/createnewclassification.html",controller:"CreateNewClassificationInstanceCtrl",resolve:{data:["$q",function(e){var t=e.defer();return n.getModels(function(e,i){e&&console.error(e),t.resolve(i||[])}),t.promise}],playlists:["$q",function(e){var t=e.defer();return o.getList().then(function(e){t.resolve(e||[])}),t.promise}],projectData:function(){return e.projectData}}});i.opened.then(function(){e.infoInfo="",e.showInfo=!1,e.loading=!1}),i.result.then(function(e){data=e,data.ok&&(r.updateJobs(),s.log("Your new classification is waiting to start processing.<br> Check its status on <b>Jobs</b>.")),data.error&&s.error("Error: "+data.error),data.url&&c.path(data.url)})},e.deleteClassification=function(i,n){if(!u.can("manage models and classification"))return void s.error("You do not have permission to delete classifications");e.infoInfo="Loading...",e.showInfo=!0,e.loading=!0;var a=t.open({templateUrl:"/app/analysis/random-forest-models/classification/deleteclassification.html",controller:"DeleteClassificationInstanceCtrl",resolve:{name:function(){return n},id:function(){return i},projectData:function(){return e.projectData}}});a.opened.then(function(){e.infoInfo="",e.showInfo=!1,e.loading=!1}),a.result.then(function(t){if(t.err)s.error("Error: "+t.err);else{for(var n=-1,a=angular.copy(e.classificationsOriginal),r=0;r<a.length;r++)if(a[r].job_id===i){n=r;break}n>-1&&(e.classificationsOriginal.splice(n,1),e.tableParams.reload(),s.log("Classification deleted successfully"))}})},e.loading=!0,e.infoInfo="Loading...",e.showInfo=!0,n.getInfo(function(t){e.projectData=t});var p=l.getState();null===p?e.loadClassifications():(p.data.length>0?(e.classificationsData=p.filtered,e.classificationsOriginal=p.data,d(p.p,p.c,p.o[0],p.f,p.filtered.length)):e.infopanedata="No models found.",e.infoInfo="",e.showInfo=!1,e.loading=!1)}]).controller("DeleteClassificationInstanceCtrl",["$scope","$modalInstance","a2Classi","name","id","projectData",function(e,t,i,n,a,r){e.name=n,e.id=a,e.deletingloader=!1,e.projectData=r;e.projectData.url;e.ok=function(){e.deletingloader=!0,i.delete(a,function(e){t.close(e)})},e.cancel=function(){t.dismiss("cancel")}}]).controller("ClassiDetailsInstanceCtrl",["$scope","$modalInstance","a2Classi","a2Models","notify","a2UserPermit","ClassiInfo",function(e,t,i,n,a,r,o){var s=function(){i.getResultDetails(e.classiData.id,e.currentPage*e.maxPerPage,e.maxPerPage,function(t){i.getRecVector(e.classiData.id,t[0].recording_id).success(function(i){var n=Math.max.apply(null,i.vector);"number"==typeof e.th&&(e.htresDeci=n<e.th?"no":"yes"),e.recVect=i.vector,e.recs=t,e.minv=t[0].stats.minv,e.maxv=t[0].stats.maxv,e.maxvRounded=Math.round(1e3*e.maxv)/1e3})})};e.ok=function(){t.close()},e.next=function(){e.currentPage=e.currentPage+1,e.currentPage*e.maxPerPage>=e.classiData.total?e.currentPage=e.currentPage-1:s()},e.prev=function(){e.currentPage=e.currentPage-1,e.currentPage<0?e.currentPage=0:s()},e.gotoc=function(t){"first"==t&&(e.currentPage=0),"last"==t&&(e.currentPage=Math.ceil(e.classiData.total/e.maxPerPage)-1),s()},e.toggleRecDetails=function(){e.showMore=!e.showMore,e.showMore&&!e.recs&&s()},e.loading=!0,e.htresDeci="-",e.classiData=o.data,e.project=o.project,e.showMore=!1,e.currentPage=0,e.maxPerPage=1,e.csvUrl="/api/project/"+e.project.url+"/classifications/csv/"+e.classiData.id,e.showDownload=r.can("manage models and classification"),console.table(e.classiData),i.getDetails(e.classiData.id,function(i){if(!i)return t.close(),void a.log("No details available for this classification");angular.extend(e.classiData,i),e.totalRecs=Math.ceil(e.classiData.total/e.maxPerPage),console.log(e.classiData),e.results=[["absent",e.classiData.total-e.classiData.present],["present",e.classiData.present],["skipped",e.classiData.errCount]],n.findById(e.classiData.modelId).success(function(t){console.log(t),e.model=t,e.loading=!1}).error(function(t){e.loading=!1})})}]).controller("CreateNewClassificationInstanceCtrl",["$scope","$modalInstance","a2Classi","data","projectData","playlists",function(e,t,i,n,a,r){e.data=n,e.projectData=a,e.recselected="",e.showselection=!1,e.playlists=r,e.nameMsg="",e.datas={name:"",classifier:"",playlist:""},e.$watch("recselected",function(){"selected"===e.recselected?e.showselection=!0:e.showselection=!1}),e.ok=function(){e.nameMsg="";e.projectData.url;if(e.all=0,e.selectedSites=[],e.datas.classifier.enabled){var n={n:e.datas.name,c:e.datas.classifier.model_id,a:e.all,s:e.selectedSites.join(),p:e.datas.playlist};i.create(n,function(i){i.name?e.nameMsg="Name exists":t.close(i)})}},e.buttonEnable=function(){return!("string"!=typeof e.datas.playlist&&e.datas.name.length&&"string"!=typeof e.datas.classifier)},e.cancel=function(e){t.close({url:e})}}]).directive("a2Vectorchart",function(){return{restrict:"E",scope:{vectorData:"=",minvect:"=",maxvect:"="},templateUrl:"/app/analysis/random-forest-models/classification/vectorchart.html",controller:["$scope",function(e){e.loadingflag=!0,e.drawVector=function(){if(e.vectorData){e.loadingflag=!0;var t,i=e.canvas,n=e.vectorData,a=e.width;a>=n.length?(i.width=a,t=a/n.length):(i.width=n.length,t=1),i.height=50,ctx=i.getContext("2d"),ctx.beginPath();var r=0;for(ctx.moveTo(r*t,50*(1-(n[r]-e.minvect)/(e.maxvect-e.minvect)));r<n.length;)r++,ctx.lineTo(r*t,50*(1-(n[r]-e.minvect)/(e.maxvect-e.minvect)));if(ctx.strokeStyle="#000",ctx.stroke(),e.minvect<-.09){for(ctx.beginPath(),r=0,ctx.moveTo(r*t,50*(1-(0-e.minvect)/(e.maxvect-e.minvect)));r<n.length;)r++,ctx.lineTo(r*t,50*(1-(0-e.minvect)/(e.maxvect-e.minvect)));ctx.strokeStyle="#aa0000",ctx.stroke()}e.loadingflag=!1}},e.$watch("vectorData",function(){e.drawVector()})}],link:function(e,t){e.canvas=t.children()[0],e.width=parseInt(t.css("width"))}}}),angular.module("a2.analysis.random-forest-models.models",["a2.services","a2.permissions","a2.utils","ui.bootstrap","ui.select","ngSanitize","ngTable","ngCsv","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("analysis.random-forest-models.models",{url:"/models",controller:"ModelsCtrl",templateUrl:"/app/analysis/random-forest-models/models/list.html"}).state("analysis.modeldetails",{url:"/model/:modelId",controller:"ModelDetailsCtrl",templateUrl:"/app/analysis/random-forest-models/models/modelinfo.html"})}]).controller("ModelsCtrl",["$scope","$modal","$filter","ngTableParams","Project","a2Models","JobsData","$location","notify","a2UserPermit",function(e,t,i,n,a,r,o,s,c,l){e.infoInfo="Loading...",e.showInfo=!0,e.loading=!0,e.updateFlags=function(){e.successInfo="",e.showSuccess=!1,e.errorInfo="",e.showError=!1,e.infoInfo="",e.showInfo=!1,e.loading=!1},a.getInfo(function(t){e.projectData=t});var u=function(t,a,o,s,c){var l={},u="desc";"+"==o[0]&&(u="asc"),l[o.substring(1)]=u,e.tableParams=new n({page:t,count:a,sorting:l,filter:s},{total:c,getData:function(t,n){e.infopanedata="";var a=n.filter()?i("filter")(e.modelsDataOrig,n.filter()):e.modelsDataOrig,o=n.sorting()?i("orderBy")(a,n.orderBy()):a;n.total(o.length),t.resolve(o.slice((n.page()-1)*n.count(),n.page()*n.count())),o.length<1&&(e.infopanedata="No models found."),e.modelsData=o.slice((n.page()-1)*n.count(),n.page()*n.count()),r.saveState({data:e.modelsDataOrig,filtered:e.modelsData,f:n.filter(),o:n.orderBy(),p:n.page(),c:n.count(),t:o.length})}})};e.loadModels=function(){r.list(function(t){e.modelsData=t,e.modelsDataOrig=t,e.showInfo=!1,e.loading=!1,t.length>0?e.tableParams?e.tableParams.reload():u(1,10,"+mname",{},t.length):e.infopanedata="No models found."})};var d=r.getState();null===d?e.loadModels():(d.data.length>0?(e.modelsData=d.filtered,e.modelsDataOrig=d.data,u(d.p,d.c,d.o[0],d.f,d.filtered.length)):e.infopanedata="No models found.",e.infoInfo="",e.showInfo=!1,e.loading=!1),e.deleteModel=function(i,n){if(!l.can("manage models and classification"))return void c.error("You do not have permission to delete models");e.infoInfo="Loading...",e.showInfo=!0,e.loading=!0;var a=t.open({templateUrl:"/app/analysis/random-forest-models/models/deletemodel.html",controller:"DeleteModelInstanceCtrl",resolve:{model_name:function(){return n},model_id:function(){return i},projectData:function(){return e.projectData}}});a.opened.then(function(){e.infoInfo="",e.showInfo=!1,e.loading=!1}),a.result.then(function(t){if(t.error)c.error("Error: "+t.error);else{for(var n=-1,a=angular.copy(e.modelsDataOrig),r=0;r<a.length;r++)if(a[r].model_id===i){n=r;break}n>-1&&(e.modelsDataOrig.splice(n,1),e.tableParams.reload(),c.log("Model deleted successfully"))}})},e.model_id=null,e.validationdata=null,e.newModel=function(){if(!l.can("manage models and classification"))return void c.error("You do not have permission to create models");e.infoInfo="Loading...",e.showInfo=!0,e.loading=!0;e.projectData.url;r.getFormInfo(function(i){var n=t.open({templateUrl:"/app/analysis/random-forest-models/models/newmodel.html",controller:"NewModelInstanceCtrl",resolve:{projectData:function(){return e.projectData},types:function(){return i.types.filter(function(e){return e.enabled})},trainings:function(){return i.trainings}}});n.opened.then(function(){e.infoInfo="",e.showInfo=!1,e.loading=!1}),n.result.then(function(e){e.ok&&(o.updateJobs(),c.log("Your new model training is waiting to start processing.<br> Check its status on <b>Jobs</b>.")),e.error&&c.error("Error "+e.error),e.url&&s.path(e.url)})})}}]).controller("NewModelInstanceCtrl",["$scope","$modalInstance","a2Models","Project","projectData","types","trainings","notify","$http",function(e,t,i,n,a,r,o,s,c){e.types=r,e.projectData=a,e.trainings=o,e.nameMsg="",e.data={training:"",classifier:"",name:"",totalValidations:"Retrieving...",presentValidations:"-",absentsValidations:"-",usePresentTraining:"",useNotPresentTraining:"",usePresentValidation:-1,useNotPresentValidation:-1},c.get("/api/jobs/types").success(function(t){var i=t.filter(function(e){return"Model training"===e.name});if(!i.length)return console.error("training job info not found");e.jobDisabled=!i[0].enabled}),e.totalPresentValidation=0,e.$watch("data.usePresentTraining",function(){var t=e.data.presentValidations-e.data.usePresentTraining;e.data.usePresentValidation=t>-1?t:0,e.data.usePresentTraining>e.data.presentValidations&&(e.data.usePresentTraining=e.data.presentValidations),e.totalPresentValidation=e.data.usePresentValidation}),e.totalNotPresentValidation=0,e.$watch("data.useNotPresentTraining",function(){var t=e.data.absentsValidations-e.data.useNotPresentTraining;e.data.useNotPresentValidation=t>-1?t:0,e.data.useNotPresentTraining>e.data.absentsValidations&&(e.data.useNotPresentTraining=e.data.absentsValidations),e.totalNotPresentValidation=e.data.useNotPresentValidation}),e.$watch("data.usePresentValidation",function(){e.data.usePresentValidation>e.totalPresentValidation&&(e.data.usePresentValidation=e.totalPresentValidation)}),e.$watch("data.useNotPresentValidation",function(){e.data.useNotPresentValidation>e.totalNotPresentValidation&&(e.data.useNotPresentValidation=e.totalNotPresentValidation)}),e.$watch("data.training",function(){""!==e.data.training&&n.validationBySpeciesSong(e.data.training.species_id,e.data.training.songtype_id,function(t){e.data.totalValidations=t.total,e.data.presentValidations=t.present,e.data.absentsValidations=t.absent})}),e.disableCreateButton=function(){return!(e.trainings.length&&e.data.name.length&&e.totalNotPresentValidation>0&&e.totalPresentValidation>0&&e.data.usePresentTraining>0&&e.data.useNotPresentTraining>0&&e.data.usePresentValidation>0&&e.data.useNotPresentValidation>0&&"string"!=typeof e.data.training&&"string"!=typeof e.data.classifier&&!e.jobDisabled)},e.cancel=function(e){t.close({url:e})},e.ok=function(){e.nameMsg="",i.create({n:e.data.name,t:e.data.training.training_set_id,c:e.data.classifier.model_type_id,tp:parseInt(e.data.usePresentTraining),tn:parseInt(e.data.useNotPresentTraining),vp:parseInt(e.data.usePresentValidation),vn:parseInt(e.data.useNotPresentValidation)}).success(function(i){i.name?e.nameMsg="Name exists":t.close(i)}).error(function(){t.close({err:"Could not create job"})})}}]).controller("DeleteModelInstanceCtrl",["$scope","$modalInstance","a2Models","model_name","model_id","projectData","notify",function(e,t,i,n,a,r,o){e.model_name=n,e.model_id=a,e.projectData=r;e.projectData.url;e.ok=function(){i.delete(a,function(e){t.close(e)})},e.cancel=function(){t.dismiss("cancel")}}]).controller("NewClassificationInstanceCtrl",["$scope","$modalInstance","model_name","model_id",function(e,t,i,n){e.model_name=i,e.model_id=n,e.ok=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]).controller("ModelDetailsCtrl",["$scope","a2Models","$stateParams","$location","Project","a2Classi","notify","$window","a2UserPermit",function(e,t,i,n,a,r,o,s,c){var l=!1;e.$on("$destroy",function(e){l=!0,t.modelState(!1)});var u=function(i){if(!l){if(i>=e.validations.length)return e.waitinFunction();var n=e.validations[i];n.date=s.moment(n.date,"MM-DD-YYYY HH:mm"),t.getRecVector(e.model.id,n.id).success(function(t){if(!t.err||"vector-not-found"!=t.err){var a=t.vector,r=Math.max.apply(null,a),o=Math.min.apply(null,a);n.vmax=r,n.vector=a,e.allMax.push(r),e.allMin.push(o),"no"==n.presence?e.vectorNoMax<r&&(e.vectorNoMax=r):"yes"==n.presence&&e.allYesMax.push(r)}u(++i)})}};e.loading=!0,e.showValidationsTable=!0,e.allYesMax=[],e.allMax=[],e.allMin=[],e.vectorNoMax=-1,e.loadingValidations=!0,e.showModelValidations=!0,e.messageSaved="",t.modelState(!0),a.getInfo(function(t){e.project_id=t.project_id}),t.findById(i.modelId).success(function(t){e.model=t,e.loading=null}).error(function(t,i){404==i?e.notFound=!0:o.serverError()}),t.getValidationResults(i.modelId,function(t){if(t.err||!t.validations.length)return e.showModelValidations=!1,void(e.loadingValidations=!1);e.validations=t.validations,u(0)}),e.waitinFunction=function(){e.loading=null,e.allYesMax.length||(e.showModelValidations=!1,e.loadingValidations=!1),e.allYesMax=e.allYesMax.sort();for(var t=0,i=0;i<e.allYesMax.length;i++)e.allYesMax[i]>=e.vectorNoMax&&(t=i);if(e.model.maxv=Math.max.apply(null,e.allMax),e.model.minv=Math.min.apply(null,e.allMin),e.suggestedThreshold=Math.round(1e6*e.allYesMax[t])/1e6,(void 0===typeof e.suggestedThreshold||isNaN(e.suggestedThreshold))&&(e.suggestedThreshold=Math.round(1e6*e.allYesMax[0])/1e6),void 0===typeof e.suggestedThreshold||isNaN(e.suggestedThreshold))e.showModelValidations=!1;else{for(var n,a,r,o=e.suggestedThreshold,s=[],c=[],l=[],u=[],d=[],p=[],f=0;o>.01&&f<15;){for(r=0;r<e.validations.length;r++)e.validations[r].threshold=e.validations[r].vmax>o?"yes":"no";e.computeStats(),s.push(o),c.push(e.thres.precision),l.push(e.thres.accuracy),u.push(e.thres.sensitivity),d.push(e.thres.specificity),p.push(e.thres.specificity+e.thres.sensitivity+e.thres.accuracy+e.thres.precision),o-=.001,f+=1}var h=p[0];for(a=1;a<p.length;a++)p[a]>h&&(h=p[a],a);for(h=c[0],a=0;a<c.length;a++)c[a]>=h&&(h=c[a]);var g=[];for(a=0;a<c.length;a++)c[a]==h&&g.push(a);for(h=u[g[0]],n=0;n<g.length;n++)u[g[n]]>=h&&(h=u[g[n]]);var m=[];for(n=0;n<g.length;n++)u[g[n]]==h&&m.push(g[n]);for(h=l[m[0]],n=0;n<m.length;n++)l[m[n]]>=h&&(h=l[m[n]]);var v=[];for(n=0;n<m.length;n++)l[m[n]]==h&&v.push(m[n]);for(h=d[v[0]],n=0;n<v.length;n++)d[v[n]]>=h&&(h=d[v[n]]);var y=[];for(n=0;n<v.length;n++)d[v[n]]==h&&y.push(v[n]);var b=0;for(n=0;n<y.length;n++)b+=s[y[n]];for(b/=y.length,e.currentThreshold="-"!=e.model.threshold?e.model.threshold:b,e.suggestedThreshold=Math.round(1e6*b)/1e6,void 0!==typeof e.suggestedThreshold&&!isNaN(e.suggestedThreshold)&&e.suggestedThreshold||(e.currentThreshold="-"!=e.model.threshold?e.model.threshold:e.allYesMax[0],e.suggestedThreshold=Math.round(1e6*e.allYesMax[0])/1e6),r=0;r<e.validations.length;r++)e.validations[r].threshold=e.validations[r].vmax>e.currentThreshold?"yes":"no";e.computeStats(),e.loadingValidations=!1}},e.computeStats=function(){e.thres={tpos:"-",fpos:"-",tneg:"-",fneg:"-",accuracy:"-",precision:"-",sensitivity:"-",specificity:"-"};for(var t=0,i=0,n=0,a=0,r=0;r<e.validations.length;r++)"yes"==e.validations[r].presence?"yes"==e.validations[r].threshold?t+=1:a+=1:"yes"==e.validations[r].threshold?i+=1:n+=1;e.thres.tpos=t,e.thres.fpos=i,e.thres.tneg=n,e.thres.fneg=a,e.thres.accuracy=Math.round((t+n)/(t+i+n+a)*100)/100,t+i>0&&(e.thres.precision=Math.round(t/(t+i)*100)/100),t+a>0&&(e.thres.sensitivity=Math.round(t/(t+a)*100)/100),n+i>0&&(e.thres.specificity=Math.round(n/(n+i)*100)/100)},e.saveThreshold=function(){e.messageSaved="",e.recalculate(),t.setThreshold(i.modelId,e.currentThreshold).success(function(){e.messageSaved="Threshold saved",e.model.threshold=e.currentThreshold}).error(function(){e.messageSaved="Error saving threshold"})},e.recalculate=function(){e.messageSaved="";var t=parseFloat(e.newthres);if(!isNaN(t)&&t<=1&&t>=0){e.currentThreshold=t;for(var i=0;i<e.validations.length;i++)e.validations[i].threshold=e.validations[i].vmax>e.currentThreshold?"yes":"no";e.computeStats()}else e.messageSaved="Value should be between 0 and 1."},e.zoomout=function(){$("#patternDivMain").css("min-width",210),$("#patternDivMain").css("height",100)},e.zoomin=function(){$("#patternDivMain").css("min-width",420),$("#patternDivMain").css("height",150)},e.isExport=function(){return c.can("export report")||c.isSuper()},e.getValidations=function(){for(var t=[],i=0;i<e.validations.length;i++)t.push({site:e.validations[i].site,date:e.validations[i].date,user:e.validations[i].presence,model:e.validations[i].model,threshold:e.validations[i].threshold,value:e.currentThreshold});return t},e.recDetails=function(t){e.selected=t,e.showValidationsTable=!1},e.closeRecValidationsDetails=function(){e.showValidationsTable=!0,e.selected=null},e.gotoRec=function(){var t="/visualizer/rec/"+e.selected.id;n.path(t)}}]),angular.module("a2.citizen-scientist.admin.classification-stats",["a2.services","a2.directives","ui.bootstrap","a2.srv.citizen-scientist-admin","angularFileUpload","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("citizen-scientist.admin.classification-stats",{url:"/classification-stats/:speciesId?",controller:"A2CitizenScientistAdminClassificationStatsCtrl as controller",templateUrl:"/app/citizen-scientist/admin/classification-stats/index.html"})}]).controller("A2CitizenScientistAdminClassificationStatsCtrl",["$scope","a2CitizenScientistAdminService","$stateParams","$state","Species",function(e,t,i,n,a){this.setSpecies=function(e){this.speciesId=e,n.transitionTo(n.current.name,{speciesId:e},{notify:!1}),this.speciesId&&this.loadForSpecies()},this.speciesId=i.speciesId,this.loadPage=function(){this.loading=!0,t.getClassificationStats().then(function(e){this.loading=!1,this.stats=e.stats}.bind(this))},this.loadForSpecies=function(){this.loadingForSpecies=!0,a.findById(this.speciesId).then(function(e){this.species=e}.bind(this)),t.getClassificationStats(this.speciesId).then(function(e){this.loadingForSpecies=!1,this.speciesStats=e.stats}.bind(this))},this.patternMatchingExportUrl=function(e,i){return t.getCSExportUrl(e.pattern_matching_id,i)},this.loadPage(),this.speciesId&&this.loadForSpecies()}]),angular.module("a2.citizen-scientist.admin.user-stats",["a2.services","a2.directives","ui.bootstrap","a2.srv.citizen-scientist-admin","angularFileUpload","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("citizen-scientist.admin.user-stats",{url:"/user-stats/:userId?",controller:"A2CitizenScientistAdminUserStatsCtrl as controller",templateUrl:"/app/citizen-scientist/admin/user-stats/index.html"})}]).controller("A2CitizenScientistAdminUserStatsCtrl",["$scope","a2CitizenScientistAdminService","$stateParams","$state","Users",function(e,t,i,n,a){this.userStatsExportUrl=t.getUserStatsExportUrl(),this.setUser=function(e){this.userId=e,n.transitionTo(n.current.name,{userId:e},{notify:!1}),this.userId&&this.loadForUser()},this.userId=i.userId,this.loadPage=function(){this.loading=!0,t.getUserStats().then(function(e){this.loading=!1,this.stats=e.stats.filter(function(e){return!!e.user_id})}.bind(this))},this.loadForUser=function(){this.loadingForUser=!0,a.getInfoForId(this.userId).then(function(e){this.user=e}.bind(this)),t.getUserStats(this.userId).then(function(e){this.loadingForUser=!1,this.userStats=e.stats}.bind(this))},this.loadPage(),this.userId&&this.loadForUser()}]),angular.module("a2.citizen-scientist.admin.settings",["a2.services","a2.srv.citizen-scientist-admin","a2.directives","ui.bootstrap","angularFileUpload","humane"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("citizen-scientist.admin.settings",{url:"/settings",controller:"A2CitizenScientistAdminSettingsCtrl as controller",templateUrl:"/app/citizen-scientist/admin/settings/index.html"})}]).controller("A2CitizenScientistAdminSettingsCtrl",["$scope","a2CitizenScientistAdminService","notify",function(e,t,i){this.loadPage=function(){this.loading=!0,t.getSettings().then(function(e){this.loading=!1,this.patternmatchings=e}.bind(this))},this.save=function(){this.saving=!0;var e=this.patternmatchings.filter(function(e){return e.citizen_scientist||e.cs_expert}).map(function(e){return{id:e.id,consensus_number:e.consensus_number,citizen_scientist:e.citizen_scientist,cs_expert:e.cs_expert}});return t.setSettings(e).then(function(e){this.saving=!1,i.log("Settings Saved.")}.bind(this)).catch(function(){this.saving=!1,i.error("An error occured.")}.bind(this))},this.loadPage()}]),angular.module("a2.browser_audio-event-detections",["a2.browser_common","a2.filter.as-csv"]).config(["BrowserVisObjectsProvider","BrowserLOVOsProvider",function(e,t){e.add({type:"audio-event-detection",cardTemplate:"/app/visualizer/browser/audio-event-detections/card.html"}),t.add({name:"audio-event-detection",group:"audio-event-detections",vobject_type:"audio-event-detection",icon:"fa fa-object-group",tooltip:"Show Audio Event Detections",controller:"a2BrowserAudioEventDetectionsController",template:"/app/visualizer/browser/audio-event-detections/audio-event-detections.html"})}]).controller("a2BrowserAudioEventDetectionsController",["a2Browser","AudioEventDetectionService","a2ArrayLOVO","$timeout","$q",function(e,t,i,n,a){var r=this;this.audioEventDetections=[],this.active=!1,this.loading={audioEventDetections:!1},this.audioEventDetection=null,this.lovo=null,this.auto={},this.activate=function(){var n=a.defer();return t.getList({show:"thumbnail-path"}).then(function(t){console.log("audioEventDetections",t),
r.loading.audioEventDetections=!1,r.audioEventDetections=t,r.audioEventDetections_lovo||(r.audioEventDetections_lovo=new i),r.audioEventDetections_lovo.setArray(r.audioEventDetections,"audio-event-detection"),r.audioEventDetections_lovo.update=function(){r.activate()},r.lovo||(r.lovo=r.audioEventDetections_lovo,e.setLOVO(r.lovo)),n.resolve(!1),r.resolve.scd&&r.resolve.scd.resolve(r.audioEventDetections)}),r.loading.audioEventDetections=!0,n.promise},this.resolve={},this.resolve_location=function(e){var t=/(\d+)(\/(\d+))?/.exec(e),i=a.defer();if(t){var n=0|t[1],o=0|t[3],s=a.defer();r.loading.audioEventDetections?r.resolve={scd:s}:s.resolve(r.audioEventDetections),s.promise.then(function(e){var t=r.audioEventDetections.filter(function(e){return e.id==n}).shift();t&&(r.audioEventDetection=t,o&&(r.audioEventDetection.extra||(r.audioEventDetection.extra={}),r.audioEventDetection.extra.region=o)),i.resolve(t)})}else i.resolve();return i.promise},this.get_location=function(e){return"audio-event-detection/"+e.id+(e.extra&&e.extra.region?"/"+e.extra.region:"")}}]),angular.module("a2.browser_recordings",["a2.browser_common","a2.browser_recordings_by_site","a2.browser_recordings_by_playlist"]).config(["BrowserVisObjectsProvider","BrowserLOVOsProvider",function(e,t){e.add({type:"recording",cardTemplate:"/app/visualizer/browser/recordings/card.html"})}]),angular.module("a2.browser_soundscapes",["a2.browser_common"]).config(["BrowserVisObjectsProvider","BrowserLOVOsProvider",function(e,t){e.add({type:"soundscape",cardTemplate:"/app/visualizer/browser/soundscapes/card.html"}),t.add({name:"soundscape",group:"soundscapes",vobject_type:"soundscape",icon:"fa fa-area-chart",tooltip:"Show Soundscapes",controller:"a2BrowserSoundscapesController",template:"/app/visualizer/browser/soundscapes/soundscapes.html"})}]).controller("a2BrowserSoundscapesController",["a2Browser","a2Soundscapes","a2ArrayLOVO","a2UrlUpdate","Project","$q",function(e,t,i,n,a,r){var o=this;this.soundscapes=[],this.active=!1,this.loading={soundscapes:!1},this.soundscape=null,this.lovo=null,this.auto={},this.activate=function(){var a=r.defer();return t.getList({show:"thumbnail-path"},function(t){o.loading.soundscapes=!1,o.soundscapes=t,o.soundscapes.forEach(function(e){n.update(e.thumbnail),e.caption2=e.normalized?"normalized":"scale:"+(null!==e.visual_max_value?e.visual_max_value:e.max_value)}),o.soundscapes_lovo||(o.soundscapes_lovo=new i),o.soundscapes_lovo.setArray(o.soundscapes,"soundscape"),o.soundscapes_lovo.update=function(){o.activate()},o.lovo||(o.lovo=o.soundscapes_lovo,e.setLOVO(o.lovo)),a.resolve(!1),o.resolve.scd&&o.resolve.scd.resolve(o.soundscapes)}),o.loading.soundscapes=!0,a.promise},this.resolve={},this.resolve_location=function(e){var t=/(\d+)(\/(\d+))?/.exec(e),i=r.defer();if(t){var n=0|t[1],a=0|t[3],s=r.defer();o.loading.soundscapes?o.resolve={scd:s}:s.resolve(o.soundscapes),s.promise.then(function(e){var t=o.soundscapes.filter(function(e){return e.id==n}).shift();t&&(o.soundscape=t,a&&(o.soundscape.extra||(o.soundscape.extra={}),o.soundscape.extra.region=a)),i.resolve(t)})}else i.resolve();return i.promise},this.get_location=function(e){return"soundscape/"+e.id+(e.extra&&e.extra.region?"/"+e.extra.region:"")}}]),angular.module("a2.visualizer.layers.annotation-layer",[]).config(["layer_typesProvider",function(e){e.addLayerType({type:"annotation-layer",title:"",controller:"a2VisualizerAnnotationController as controller",require:{type:["recording"],selection:!0},display:{sidebar:!1},visible:!0})}]).controller("a2VisualizerAnnotationController",["$scope",function(e){}]),angular.module("a2.visualizer.layers.audio-events-layer",[]).config(["layer_typesProvider",function(e){e.addLayerType({type:"audio-events-layer",title:"",controller:"a2VisualizerAudioEventsController as audio_events",require:{type:["recording"],selection:!0},visible:!0,hide_visibility:!0})}]).controller("a2VisualizerAudioEventsController",["$scope","a2AudioEventDetectionsClustering","a2ClusteringJobs","$localStorage",function(e,t,i,n){var a=this;const r=["#5340ff33","#008000","#ffcd00","#1F57CC","#53ff40","#5bc0de","#5340ff33"];a.audioEvents=null,a.clusteringEvents=null,a.isAudioEventsPlaylist=null,a.selectedAudioEventJob=null,a.clusterPlaylists=null,a.isPlaylist=!1,a.toggleAudioEvents=function(e,t,i){(e?a.audioEvents:a.clusteringEvents).forEach(function(n){if((e?n.job_id:n.playlist_id)===t&&(n.opacity=!1===i?0:1,e)){const o=Object.keys(a.audioEventJobs).findIndex(function(e){return Number(e)===n.job_id}),s=r[o]||r[0];n.borderColor=a.hexToRGB(s,.6),n.backgroundColor=a.hexToRGB(s,.2)}}),e&&n.setItem("analysis.audioEventJob",null)},a.hexToRGB=function(e,t){return"rgba("+parseInt(e.slice(1,3),16)+", "+parseInt(e.slice(3,5),16)+", "+parseInt(e.slice(5,7),16)+", "+t+")"},a.isHighlightTitle=function(){return!isNaN(n.getItem("analysis.audioEventJob"))},a.fetchAudioEvents=function(){var r=e.visobject&&"recording"==e.visobject_type&&e.visobject.id;if(r){a.isPlaylist=e.visobject.extra&&e.visobject.extra.playlist;try{a.selectedAudioEventJob=n.getItem("analysis.audioEventJob"),a.isAudioEventsPlaylist=!isNaN(a.selectedAudioEventJob)}catch(e){}t.list({rec_id:r,completed:!0}).then(function(t){t&&(a.audioEventJobs={},t.length&&t.forEach(function(e){a.audioEventJobs[e.job_id]||(a.audioEventJobs[e.job_id]={job_id:e.job_id,name:e.name,count:1,parameters:e.parameters,visible:!!a.isAudioEventsPlaylist&&Number(a.selectedAudioEventJob)===e.job_id}),a.audioEventJobs[e.job_id].count+=1}),a.audioEvents=t.map(function(e){return{rec_id:e.rec_id,x1:e.time_min,x2:e.time_max,y1:e.freq_min,y2:e.freq_max,job_id:e.job_id||null,display:e.rec_id===r?"block":"none",opacity:a.isAudioEventsPlaylist&&Number(a.selectedAudioEventJob)===e.job_id?1:0}}),i.getRoisDetails({rec_id:e.visobject.id}).then(function(e){e&&(a.clusterPlaylists={},e.forEach(function(e){a.clusterPlaylists[e.playlist_id]||(a.clusterPlaylists[e.playlist_id]={rec_id:e.recording_id,playlist_name:e.playlist_name,playlist_id:e.playlist_id,count:1,visible:!1}),a.clusterPlaylists[e.playlist_id].count+=1}),a.clusteringEvents=e.map(function(e){return{rec_id:e.recording_id,x1:e.time_min,x2:e.time_max,y1:e.frequency_min,y2:e.frequency_max,playlist_id:e.playlist_id||null,display:e.recording_id===r?"block":"none",opacity:0}}))}))})}},e.$watch("visobject",a.fetchAudioEvents)}]),angular.module("a2.visualizer.layers.base-image-layer",[]).config(["layer_typesProvider",function(e){e.addLayerType({type:"base-image-layer",title:"",require:{type:["recording","soundscape"],selection:!0},display:{sidebar:!1},visible:!0})}]),angular.module("a2.visualizer.layers.recording-soundscape-region-tags",[]).config(["layer_typesProvider",function(e){e.addLayerType({type:"recording-soundscape-region-tags",title:"",controller:"a2VisualizerRecordingSoundscapeRegionTagsLayerController as ctrl",require:{type:"recording",selection:!0,that:function(e){var t=e.visobject&&e.visobject.extra&&e.visobject.extra.playlist;return t&&t.soundscape&&t.region}},sidebar_only:!0,visible:!0,hide_visibility:!1})}]).controller("a2VisualizerRecordingSoundscapeRegionTagsLayerController",["$scope","a2Soundscapes",function(e,t){var i=this;i.loading={},i.tag={name:null,add:function(){var e=this.name;this.name=null,t.addRecordingTag(i.soundscape.id,i.region.id,i.recording.id,e,function(e){var t=0|e.id;i.tags.filter(function(e){return e.id==t}).length||i.tags.push(e)})},remove:function(e){var n=0|e.id;t.removeRecordingTag(i.soundscape.id,i.region.id,i.recording.id,n,function(){i.tags=i.tags.filter(function(e){return e.id!=n})})}},e.$watch("visobject",function(e){i.recording=null,i.playlist=null,i.soundscape=null,i.region=null,i.tags=null,e&&"recording"==e.type&&e.id&&e.extra&&e.extra.playlist&&e.extra.playlist.soundscape&&e.extra.playlist.region&&(i.recording=e,i.playlist=e.extra.playlist,i.loading.soundscape=!0,i.loading.region=!0,i.loading.tags=!0,t.get(i.playlist.soundscape,function(e){i.loading.soundscape=!1,i.soundscape=e,t.getRegion(e.id,i.playlist.region,function(n){i.loading.region=!1,i.region=n,t.getRecordingTags(e.id,n.id,i.recording.id,function(e){i.loading.tags=!1,i.tags=e})})}))})}]),angular.module("a2.visualizer.layers.data-plot-layer",["a2.directive.plotly-plotter","arbimon2.directive.a2-dropdown"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"data-plot-layer",title:"",controller:"a2VisualizerDataPlotLayerController as controller",require:{type:["audio-event-detection"],selection:!0},visible:!0,hide_visibility:!0})}]).controller("a2VisualizerDataPlotLayerController",["$scope",function(e){}]),angular.module("a2.visualizer.layers.soundscapes",["a2.visualizer.layers.soundscapes.info","a2.visualizer.layers.soundscapes.regions"]),angular.module("a2.visualizer.layers.recordings",["a2.filter.round","a2.directive.frequency_filter_range_control"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"recording-layer",title:"",controller:"a2VisualizerRecordingLayerController as controller",require:{type:"recording",selection:!0},visible:!0,hide_visibility:!0})}]).controller("a2VisualizerRecordingLayerController",["$scope","$modal","$location","$window",function(e,t,i,n){this.setGain=function(t){e.audio_player.setGain(t).then(function(){var t=e.audio_player.gain;e.location.updateParams({gain:t>=1?t:void 0})})},this.explorerUrl=function(){return e.visobject?e.visobject.explorerUrl:null},this.openFreqFilterModal=function(){e.visobject&&t.open({templateUrl:"/app/visualizer/layers/recordings/frequency_filter_modal.html",controller:"a2VisualizerFrequencyFilterModalController",size:"sm",resolve:{data:function(){return{recording:e.visobject,filter:e.audio_player.freq_filter}}}}).result.then(e.audio_player.setFrequencyFilter.bind(e.audio_player)).then(function(){var t=e.audio_player.freq_filter;e.location.updateParams({filter:t?t.min+"-"+t.max:void 0})})}}]).controller("a2VisualizerFrequencyFilterModalController",["$scope","$modalInstance","data",function(e,t,i){e.recording=i.recording,e.max_freq=i.recording.sample_rate/2,e.has_previous_filter=!0,e.filter=i.filter?angular.copy(i.filter):{min:0,max:e.max_freq},e.remove_filter=function(){t.close()},e.apply_filter=function(){t.close(e.filter)}}]),angular.module("a2.visualizer.layers.species-presence",[]).config(["layer_typesProvider",function(e){e.addLayerType({type:"species-presence",title:"",controller:"a2VisualizerSpeciesPresenceController as species_presence",require:{type:"recording",selection:!0},visible:!0})}]).controller("a2VisualizerSpeciesPresenceController",["$scope","a2PatternMatching","a2AudioEventDetectionsClustering",function(e,t,i){var n=this;n.speciesPresence=null,n.isRemoving=!1,n.checkSpectroWidth=function(e,t,i){return e+t+200<i},n.togglePopup=function(e){e.isPopupOpened=!e.isPopupOpened},n.confirmPopup=function(e){return n.isRemoving=!0,e.aed_id?i.unvalidate({aed:[e.aed_id]}).then(function(){n.closePopup(e),e.name=""}):t.validateRois(e.pattern_matching_id,e.pattern_matching_roi_id,null).then(function(){n.closePopup(e),e.display="none"})},n.closePopup=function(e){n.isRemoving=!1,e.isPopupOpened=!1},n.fetchSpeciesPresence=function(){var i=e.visobject&&"recording"==e.visobject_type&&e.visobject.id;i&&t.list({rec_id:i,validated:1}).then(function(t){n.speciesPresence=t.map(function(e){return{rec_id:e.recording_id,pattern_matching_id:e.pattern_matching_id,pattern_matching_roi_id:e.pattern_matching_roi_id,name:e.species_name+" "+e.songtype_name,x1:e.x1,x2:e.x2,y1:e.y1,y2:e.y2,display:e.recording_id===i?"block":"none",isPopupOpened:!1}}),e.visobject&&e.visobject.aedValidations&&e.visobject.aedValidations.length&&(n.speciesPresence=n.speciesPresence.concat(e.visobject.aedValidations))})},e.$watch("visobject",n.fetchSpeciesPresence)}]),angular.module("a2.visualizer.layers.training-sets.roi_set",["visualizer-services","a2.permissions","humane"]).config(["training_set_typesProvider",function(e){e.add({type:"roi_set",has_layout:!0,templates:{layer_item:"/app/visualizer/layer-item/training-sets/roi_set.html",new_modal:"/app/visualizer/modal/new_roi_set_tset_partial.html"},action:{collect_new_tset_data:function(e,t,i){e.class?t.class=e.class.id:(i.class="Please select a project class.",i.count++)}},controller:"a2VisualizerSpectrogramTrainingSetRoiSetData"})}]).controller("a2VisualizerTrainingSetLayerRoiSetDataController",["$scope","$timeout","a2TrainingSets","training_set_types","a22PointBBoxEditor","a2UserPermit","notify",function(e,t,i,n,a,r,o){var s=this;s.type="roi_set",s.typedef=n.roi_set,e.getXCoord=function(t,i){return"left"==e.getXSide(t,i)?t:i},e.getXSide=function(t,i){return Math.max(0,Math.min(e.layout.sec2x(i,1)/e.layout.spectrogram.width,1))>.5?"left":"right"},e.getTransform=function(t,i,n,a){return"translate("+("left"==e.getXSide(t,i)?"-100%":"0")+", "+e.getYTranslation((n+a)/2,!0)+")"},e.getYTranslation=function(t,i){var n=Math.max(.1,Math.min(e.layout.hz2y(t,1)/e.layout.spectrogram.height,.9));return i&&(n=-n),(100*n|0)+"%"},s.fetchData=function(e,n){s.tsetId=e,s.recording=n,i.getData(e,n,function(e){t(function(){s.rois=e})})},s.editor=angular.extend(new a,{reset:function(){this.super.reset.call(this),this.roi=null},make_new_bbox:function(){this.super.make_new_bbox.call(this),this.roi=this.bbox},make_new_roi:function(){this.make_new_bbox()},add_tracer_point:function(e){this.super.add_tracer_point.call(this,e.sec,e.hz)},add_point:function(e,t){this.super.add_point.call(this,e.sec,e.hz,t)},submit:function(){if(!r.can("manage training sets"))return void o.error("You do not have permission to add ROIs to training set");i.addData(s.tsetId,{recording:s.recording,roi:this.roi},function(e){t(function(){this.reset(),s.rois.push(e)}.bind(this))}.bind(this))}})}]),angular.module("a2.visualizer.layers.training-sets",["visualizer-services","a2.visualizer.layers.training-sets.roi_set","a2.utils"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"training-data",title:"",controller:"a2VisualizerTrainingSetLayerController as training_data",require:{type:"recording",selection:!0},visible:!0})}]).controller("a2VisualizerTrainingSetLayerController",["$scope","$modal","$controller","$timeout","a2TrainingSets","a2UserPermit","notify",function(e,t,i,n,a,r,o){var s=this;s.tset=null,s.tset_type=null,s.tset_list=[],s.data=null,a.getList(function(e){s.tset_list=e,!s.tset&&e&&e.length>0&&(s.tset=e[0])}),s.add_new_tset=function(){if(!r.can("manage training sets"))return void o.error("You do not have permission to create training sets");t.open({templateUrl:"/app/visualizer/layers/training-data/add_tset_modal.html",controller:"a2VisualizerAddTrainingSetModalController"}).result.then(function(e){e&&e.id&&(s.tset_list.push(e),s.tset||(s.tset=e))})};var c=function(){var t=s.tset&&s.tset.id,n=s.tset&&s.tset.type,a=e.visobject&&"recording"==e.visobject_type&&e.visobject.id;if(t&&a){if(!s.data||s.data.type!=n){var r=n.replace(/(^|-|_)(\w)/g,function(e,t,i,n){return i.toUpperCase()});r="a2VisualizerTrainingSetLayer"+r+"DataController",s.data=i(r,{$scope:e})}s.data.fetchData(t,a)}};e.$watch(function(){return s.tset},c),e.$watch("visobject",c)}]).directive("a2VisualizerSpectrogramTrainingSetData",["training_set_types","$compile","$controller","$templateFetch",function(e,t,i,n){return{restrict:"A",template:'<div class="training-set-data"></div>',replace:!0,link:function(i,a,r){i.$watch(r.a2VisualizerSpectrogramTrainingSetData,function(r){var o=e[r];if(a.attr("data-tset-type",r),o&&o.has_layout){n("/app/visualizer/spectrogram-layer/training-sets/"+r+".html",function(e){a.empty().append(t(e)(i))})}})}}}]).controller("a2VisualizerAddTrainingSetModalController",["$scope","$modalInstance","Project","a2TrainingSets","$state",function(e,t,i,n,a){e.data={name:"",type:null},e.loadingClasses=!0,i.getClasses(function(t){e.project_classes=t,e.loadingClasses=!1}),e.loadingTypes=!0,n.getTypes(function(t){e.tset_types=t,t&&1==t.length&&(e.data.type=t[0],e.loadingTypes=!1)}),e.goToSpeciesPage=function(){a.go("audiodata.species",{})},e.ok=function(){e.creating=!0,e.validation={count:0};var i={};e.data.name?i.name=e.data.name:(e.validation.name="Training set name is required.",e.validation.count++),e.data.type&&e.data.type.id?i.type=e.data.type.identifier:(e.validation.type="Training set type is required.",e.validation.count++),e.data.class?i.class=e.data.class.id:(e.validation.class="Species sound is required.",e.validation.count++),0===e.validation.count?n.add(i,function(i){if(i.error){var n=i.field||"error";return void(e.validation[n]=i.error)}t.close(i)}):e.creating=!1}}]),angular.module("a2.visualizer.layers.zoom-input-layer",[]).config(["layer_typesProvider",function(e){e.addLayerType({type:"zoom-input-layer",title:"",require:{type:["recording","soundscape"],selection:!0,that:function(e){return e.visobject&&e.visobject.zoomable}},display:{sidebar:!1},visible:!0})}]),angular.module("a2.browser_recordings_by_site",["a2.browser_common"]).config(["BrowserLOVOsProvider",function(e){e.add({name:"rec",group:"recordings",vobject_type:"recording",default:!0,icon:"fa fa-map-marker",tooltip:"Browse Recordings by Site",controller:"a2BrowserRecordingsBySiteController",template:"/app/visualizer/browser/recordings/by-site/recordings-by-site.html"})}]).factory("rbDateAvailabilityCache",["$cacheFactory",function(e){return e("recordingsBrowserDateAvailabilityCache")}]).service("a2RecordingsBySiteLOVO",["$q","Project","$filter",function(e,t,i){var n=function(e,t,i,n,a){this.loading=!1,this.initialized=!1,this.site=e,this.date=t,this.object_type="recording",this.recordingsBySite=!0,this.offset=n||0,this.limit=i,this.order="datetime",this.count=0,this.list=[],this.page=0,this.recording_id=a,this.finished=!1};return n.prototype={initialize:function(){var t=e.defer();return this.initialized?(t.resolve(!0),t.promise):this.loadNext()},updateRecording:function(e){this.recording_id=e},getRecordings:function(n,a,r){var o=e.defer();this.limit=n,this.offset=a;var s=this.site,c=this.date,l=["!q:"+s.id,c.getFullYear(),c.getMonth()+1,c.getDate()].join("-"),u={show:"thumbnail-path"};return void 0===r&&(u.limit=n,u.offset=a),void 0!==r&&(u.recording_id=r),this.loading=!0,t.getRecordings(l,u,function(e){e=i("orderBy")(e,"datetime"),e.forEach(function(e){e.caption=[e.site,moment.utc(e.datetime).format("lll")].join(", "),e.vaxis={font:"7px",color:"#333333",range:[0,e.sample_rate/2e3],count:5,unit:""}}),e&&e.length?r?(angular.equals(this.list,e)&&(this.finished=!0),this.list=[],this.list=e):(this.list.push.apply(this.list,e),this.page++):this.finished=!0,this.count+=e.length,this.loading=!1,o.resolve(!1)}.bind(this)),o.promise},loadNext:function(){return this.finished?e.defer().resolve(!1):this.getRecordings(this.limit,this.page*this.limit,this.recording_id)},find:function(t){var i=e.defer(),n=t&&t.id||0|t;return i.resolve(this.list.filter(function(e){return e.id==n}).shift()),i.promise},previous:function(i){console.log("previous : function(recording){ :: ",i);var n=e.defer(),a=i&&i.id||0|i;return t.getPreviousRecording(a,n.resolve),n.promise},next:function(i){var n=e.defer(),a=i&&i.id||0|i;return t.getNextRecording(a,n.resolve),n.promise}},n}]).controller("a2BrowserRecordingsBySiteController",["$scope","a2Browser","rbDateAvailabilityCache","Project","$timeout","$q","a2RecordingsBySiteLOVO",function(e,t,i,n,a,r,o){var s=n,c=this;e.siteInfo={},this.sites=[],this.dates={refreshing:!1,max_date:null,min_date:null,display_year:null,date_counts:[],datepickerMode:"year",cache:i,get_counts_for:function(e){var t=c.site,i=t&&t.id;if(!i)return!0;var n=["!q:"+i,e,"[1:12]"].join("-"),a=c.dates.cache.get(n);a?a.data&&(c.dates.date_counts=a.data):c.dates.fetch_counts(n)},fetch_counts:function(e){c.dates.cache.put(e,{fetching:!0}),c.loading.dates=!0,n.getRecordingAvailability(e,function(t){a(function(){var i={};for(var n in t){var a=t[n];for(var r in a){var o=a[r];for(var s in o){var l=o[s];for(var u in l){var d=r+"-"+(s<10?"0":"")+s+"-"+(u<10?"0":"")+u;i[d]=(0|i[d])+l[u]}}}}c.dates.cache.get(e).data=i||{},c.dates.date_counts=i,c.loading.dates=!1})})},fetch_year_range:function(e,t){var i=e&&e.id;i&&n.getRecordingAvailability("!q:"+i,function(e){a(function(){var i={max:-1/0,min:1/0,count:0};for(var n in e){var a=e[n];for(var r in a)i.count++,i.min=Math.min(r,i.min),i.max=Math.max(r,i.max)}i.count||(i.max=i.min=(new Date).getFullYear()),c.dates.min_date=new Date(i.min,0,1,0,0,0,0),c.dates.max_date=new Date(i.max,11,31,23,59,59,999),c.loading.dates=!1,t(i)})})},fetching:!1,available:{}},this.loading={sites:!1,dates:!1,records:!1},this.auto={},this.site=null,this.date=null,this.lovo=null,e.limit=10,this.activate=function(){var e=r.defer();return c.loading.sites=!0,s.getSites({count:!0,logs:!0},function(t){c.sites=t,c.loading.sites=!1,a(function(){c.active=!0,e.resolve(t)})}),e.promise},this.deactivate=function(){var e=r.defer();return e.resolve(),c.active=!1,e.promise},this.auto_select=function(e){if(e){var i=new Date(e.datetime),n=new Date(i.getTime()+60*i.getTimezoneOffset()*1e3);c.auto={site:c.sites.filter(function(t){return t.name==e.site}).pop(),date:new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0,0)},c.site!=c.auto.site?c.set_site(c.auto.site):c.date!=c.auto.date?c.set_date(c.auto.date):t.setLOVO(l())}},this.resolve_location=function(e){var t=r.defer();if(e){var i=/^site(\/(\d+)(\/([^/]+))?)?/.exec(e);if(i){var a=0|i[2],o=i[4];if(a){var s="!q:"+a+(o?"-"+o:"");n.getRecordings(s,function(e){t.resolve(e&&e.pop())}.bind(this))}else t.resolve()}else n.getOneRecording(e,function(e){t.resolve(e)})}else t.resolve();return t.promise},this.get_location=function(e){return"rec/"+e.id};var l=function(){var t=c.site,i=c.date;return t&&i&&(e.browser.currentRecording?c.lovo=new o(t,i,null,null,Number(e.browser.currentRecording)):c.lovo=new o(t,i,e.limit)),c.lovo};e.onScroll=function(t,i){e.scrollElement=i.scrollElement;var n=i.scrollElement.scrollTop(),a=i.scrollElement[0].scrollHeight;if(n+i.scrollElement.height()>.9*a){if(!c.lovo)return;if(c.lovo&&!0===c.lovo.loading)return;if(e.browser.currentRecording&&e.browser.annotations)return;if(c.lovo.list&&c.lovo.list.length<7)return;c.lovo.loadNext()}},this.set_dates_display_year=function(e){this.dates.display_year=e,this.active&&this.dates.get_counts_for(e)},this.set_site=function(i){if(this.site=e.siteInfo.site=i,this.active){this.recordings=[],this.date=null,t.recording=null;var n=this.auto&&this.auto.date;n&&(this.auto.date=null,this.set_date(n)),this.dates.fetch_year_range(i,function(e){a(function(){c.dates.display_year=e.max,c.dates.get_counts_for(c.dates.display_year)})})}},this.set_date=function(i){if(c.active){this.yearpickOpen=!1;var n=this.site;if(this.date=e.siteInfo.date=i,n&&i){!function(){return this.lovo&&i&&this.lovo.date&&i.getTime()===this.lovo.date.getTime()&&n.id===this.lovo.site.id}()?t.setLOVO(l()).then(function(){e.browser.currentRecording=null,e.browser.annotations=null}):t.setLOVO(c.lovo)}}}}]),angular.module("a2.browser_recordings_by_playlist",["a2.classy","a2.browser_common"]).config(["BrowserLOVOsProvider",function(e){e.add({name:"playlist",group:"recordings",vobject_type:"recording",icon:"fa fa-list",tooltip:"Browse Recordings by Playlist",controller:"a2BrowserRecordingsByPlaylistController",template:"/app/visualizer/browser/recordings/by-playlist/recordings-by-playlist.html"})}]).service("a2PlaylistLOVO",["$q","makeClass","a2Playlists","a2Pager","$state","$localStorage","Project",function(e,t,i,n,a,r,o){return t({static:{PageSize:10,BlockSize:7},constructor:function(e){this.loading=!1,this.playlist=e,this.object_type="recording",this.offset=0,this.count=0,this.list=[],this.whole_list=[];var t=this;this.paging=new n({item_count:e.count,page_size:this.constructor.PageSize,block_size:this.constructor.BlockSize,block_tracks_page:!0,on_page:function(e){return t.load_page(e.offset,e.count)}})},initialize:function(){var t=this,n=e.defer();return this.initialized?n.resolve(!0):this.paging.set_page(0).then(function(){n.resolve(!1)}),t.playlist&&0===t.playlist.id?(n.resolve(!0),n.promise):n.promise.then(function(){i.getInfo(t.playlist.id,function(e){t.playlist=e})}).then(function(){t.whole_list&&t.whole_list.forEach(t.append_extras.bind(t))})},load_page:function(t,n){var o=this,s=e.defer(),c={offset:t,limit:n,show:"thumbnail-path"};if(a.params.clusters){var l=JSON.parse(r.getItem("analysis.clusters"));l&&l.playlist&&l.playlist.recordings&&(c.recordings=l.playlist.recordings.filter(function(e,t,i){return t>=c.offset&&t<c.offset+c.limit}),o.count=l.playlist.recordings.length)}return o.loading=!0,i.getData(o.playlist.id,c,function(e){o.list=e,e.forEach(function(e){e.caption=[e.site,moment.utc(e.datetime).format("lll")].join(", "),e.vaxis={font:"7px",color:"#333333",range:[0,e.sample_rate/2e3],count:5,unit:""},o.append_extras(e)}),o.loading=!1,s.resolve(e)}),s.promise},append_extras:function(e){return e&&(e.extra={playlist:this.playlist}),e},find_local:function(t){var i=t&&t.id||0|t;return e.resolve(this.append_extras(this.list&&this.list.filter(function(e){return e.id==i}).shift()))},find:function(t){var n=this,a=e.defer(),r=t&&t.id||0|t;return n.find_local(t).then(function(e){e?a.resolve(e):i.getRecordingPosition(n.playlist.id,r).then(function(e){return n.paging.set_page(n.paging.page_for(e.data))}).then(function(e){return n.find_local(t)}).then(function(e){a.resolve(e)})}),a.promise},previous:function(t){var n=this,a=e.defer(),r=t&&t.id||0|t;return i.getPreviousRecording(this.playlist.id,r,function(e){a.resolve(n.append_extras(e))}),a.promise},next:function(t){var n=this,a=e.defer(),r=t&&t.id||0|t;return i.getNextRecording(this.playlist.id,r,function(e){a.resolve(n.append_extras(e))}),a.promise}})}]).factory("a2Pager",["makeClass",function(e){return e({constructor:function(e){this.block_size=10,this.last_page=0,this.set_options(e)},resolve_value:function(e,t,i,n){switch(e){case"first":e=i;break;case"previous":e=t-1;break;case"next":e=t+1;break;case"last":e=n}return Math.max(i,Math.min(+e,n))},set_options:function(e){e.item_count&&(this.item_count=e.item_count),e.page_size&&(this.page_size=e.page_size),e.block_size&&(this.block_size=e.block_size),e.last_page&&(this.last_page=e.last_page),void 0!==e.block_tracks_page&&(this.block_tracks_page=!!e.block_tracks_page),void 0!==e.on_page&&(this.on_page=e.on_page),this.update()},page_for:function(e){var t=e/this.page_size|0;return console.log("page_for(%s) :: %s",e,t),t},set_page:function(e){if(this.current_page=0|this.resolve_value(e,this.current_page,0,this.last_page),this.is_at_first_page=0===this.current_page,this.is_at_last_page=this.current_page===this.last_page,this.block_tracks_page?this.show_block((this.current_page-this.block_size/2+this.block_size%2)/this.block_size):this.show_block(this.current_page/this.block_size),this.on_page instanceof Function){var t=this.current_page*this.page_size;return this.on_page({page:this.current_page,offset:t,count:Math.min(this.page_size,this.item_count-t+1)})}},update:function(){this.is_at_first_page=this.current_page<=0,this.last_page=(this.item_count-1)/this.page_size|0,this.last_page_block=this.last_page/this.block_size|0,this.is_at_last_page=this.current_page>=this.last_page,this.show_block(this.block)},show_block:function(e){this.block_tracks_page?this.current_page_block=this.resolve_value(e,this.current_page_block,0,this.last_page_block):this.current_page_block=0|this.resolve_value(e,this.current_page_block,0,this.last_page_block),this.is_at_first_page_block=this.current_page_block<=0,this.is_at_last_page_block=this.current_page_block>=this.last_page_block,this.current_page_block_first_page=this.current_page_block*this.block_size|0,this.current_page_block_last_page=Math.min((this.current_page_block+1)*this.block_size-1|0,this.last_page),this.block=[];for(var t=this.current_page_block_first_page,i=this.current_page_block_last_page;t<=i;++t)this.block.push(t)},has_page:function(e){return 0<=e&&e<=this.last_page}})}]).controller("a2BrowserRecordingsByPlaylistController",["$scope","a2Browser","a2Playlists","$q","a2PlaylistLOVO","$state","$localStorage",function(e,t,i,n,a,r,o){var s=this;this.playlists=[],this.active=!1,this.loading={playlists:!1},this.playlist=null,this.lovo=null,this.auto={},this.activate=function(){return s.loading.playlists=!0,this.getPlaylists=i.getList().then(function(e){if(r.params.clusters){var t=JSON.parse(o.getItem("analysis.clusters"));t&&t.playlist&&e.push(t.playlist)}s.playlists=e,s.loading.playlists=!1}).then(function(){s.active=!0,s.resolve.pld&&(s.resolve.pld.resolve(playlists),delete s.resolve.pld)}).then(function(){return s.playlists}),this.getPlaylists},this.deactivate=function(){s.active=!1},this.resolve={},this.resolve_link=function(e){e.location&&t.set_location(e.location)},this.resolve_location=function(e){var i=/(\d+)(\/(\d+))?/.exec(e);return i?n.resolve().then(function(){var e=0|i[1],n=0|i[3];return s.getPlaylists.then(function(i){var r=s.playlists.filter(function(t){return t.id==e}).shift();if(r)return s.playlist=r,s.lovo=new a(r),s.lovo.initialize().then(function(){return t.setLOVO(s.lovo)}).then(function(){return s.lovo.find(n)}).then(function(e){return e})})}):n.resolve()},this.get_location=function(e){return"playlist/"+(this.lovo?this.lovo.playlist.id+(e?"/"+e.id:""):"")},this.set_playlist=function(i){this.playlist=i,s.active&&(s.lovo&&s.lovo.playlist.id!=i.id&&e.removeFromLocalStorage(),!i||s.lovo&&s.lovo.playlist==i||(s.lovo=new a(i)),t.setLOVO(s.lovo,s.lovo?"playlist/"+s.lovo.playlist.id:""))},e.removeFromLocalStorage=function(){o.setItem("analysis.clusters",null),o.setItem("analysis.clusters.playlist",null),r.params.clusters=""}}]),angular.module("a2.visualizer.layers.soundscapes.regions",["visualizer-services","a2.utils","a2.soundscapeRegionTags"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"soundscape-regions-layer",title:"",controller:"a2VisualizerSoundscapeRegionsLayerController as soundscape",require:{type:"soundscape",browsetype:"soundscape",selection:!0},visible:!0})}]).controller("a2VisualizerSoundscapeRegionsLayerController",["$scope","$modal","$location","a2Soundscapes","a22PointBBoxEditor","a2UserPermit","notify",function(e,t,i,n,a,r,o){var s=this,c=function(e){return(0|e.x1)+","+(0|e.y1)+"-"+(0|e.x2)+","+(0|e.y2)};n.getAmplitudeReferences().then(function(e){this.amplitudeReferences=e.reduce(function(e,t){return e[t.value]=t,e},{})}.bind(this)),this.show={names:!0,tags:!0},this.view_playlist=function(t){console.log("this.view_playlist = function(region){",t),t.playlist&&e.set_location("playlist/"+t.playlist)},this.query=function(e){s.selection.valid&&n.getRecordings(s.soundscape,c(e),{count:1,threshold:1},function(t){e.q=t})},this.submit=function(e,t){if(s.selection.valid)return r.can("manage soundscapes")?void n.addRegion(s.soundscape,c(e),{name:t,threshold:1},function(e){s.regions.push(e),s.selection.bbox=e}):void o.error("You do not have permission to annotate soundscapes")},this.sample=function(e,i){e.id&&t.open({templateUrl:"/app/visualizer/layers/soundscapes/regions/sample_soundscape_region_modal.html",controller:"a2VisualizerSampleSoundscapeRegionModalController",size:"sm",resolve:{data:function(){return{soundscape:s.soundscape,region:e}}}}).result.then(function(e){e&&e.id&&(s.regions.forEach(function(t,i){t.id==e.id&&(s.regions[i]=e)}),s.selection.bbox=e)})},this.selection=angular.extend(new a,{reset:function(){return this.super.reset.call(this),this.percent=100,this},quantize:function(t,i,n){var a=n?Math.ceil:Math.floor,r=e.visobject.domain.x.unit_interval,o=e.visobject.domain.y.unit_interval;return[a(t/r)*r,a(i/o)*o]},add_tracer_point:function(e,t){return this.super.add_tracer_point.apply(this,this.quantize(e,t)),this},add_point:function(e,t){return this.super.add_point.apply(this,this.quantize(e,t)),this},validate:function(e){this.super.validate.call(this,e);var t=this.quantize(this.bbox.x2+.1,this.bbox.y2+.1,!0);this.bbox.y2=t[1],this.selbox={x1:this.bbox.x1,y1:this.bbox.y1,x2:t[0],y2:t[1]}},query:function(){s.query(this.bbox)},
submit:function(){s.submit(this.bbox,this.bbox.name)},sample:function(){s.sample(this.bbox,this.percent)},view_samples:function(){s.view_playlist(this.bbox)},select:function(t){this.bbox=t,e.visobject&&e.visobject.id&&t&&t.id&&e.set_location("soundscape/"+e.visobject.id+"/"+t.id,!0)}}),e.$watch("visobject",function(e){var t=e&&"soundscape"==e.type&&e.id;t?(s.soundscape=t,s.selection.reset(),n.getRegions(t,{view:"tags"},function(t){s.regions=t,e.extra&&e.extra.region&&(s.selection.bbox=s.regions.filter(function(t){return t.id==e.extra.region}).pop())})):s.soundscape=0})}]).controller("a2VisualizerSampleSoundscapeRegionModalController",["$scope","$modalInstance","a2Soundscapes","data",function(e,t,i,n){e.soundscape=n.soundscape,e.region=n.region,e.data={percent:100},e.ok=function(){e.validation={count:0};var n=e.data,a=e.validation,r={};n.percent>100?(a.percent="Percent must be between 0% and 100%.",a.count++):(n.percent*e.region.count|0)<1?(a.percent="You must sample at least 1 recording.",a.count++):r.percent=n.percent,e.form_data=r,0===a.count&&i.sampleRegion(e.soundscape,e.region.id,r,function(e){t.close(e)})}}]),angular.module("a2.visualizer.layers.soundscapes.info",["visualizer-services","a2.utils","a2.soundscapeRegionTags","a2.url-update-service","a2.directives","a2.directive.a2-palette-drawer","a2.service.colorscale-gradients"]).config(["layer_typesProvider",function(e){e.addLayerType({type:"soundscape-info-layer",title:"",controller:"a2VisualizerSoundscapeInfoLayerController as info",require:{type:"soundscape",browsetype:"soundscape",selection:!0},display:{spectrogram:!1},visible:!0,hide_visibility:!0})}]).controller("a2VisualizerSoundscapeInfoLayerController",["$scope","$modal","$location","a2Soundscapes","a2UserPermit","notify",function(e,t,i,n,a,r){n.getAmplitudeReferences().then(function(e){this.amplitudeReferences=e.reduce(function(e,t){return e[t.value]=t,e},{})}.bind(this)),this.edit_visual_scale=function(e){if(!a.can("manage soundscapes"))return void r.error("You do not have permission to edit soundscapes");t.open({templateUrl:"/app/visualizer/layers/soundscapes/info/edit_soundscape_visual_scale_modal.html",controller:"a2VisualizerSampleSoundscapeInfoEditVisualScaleModalController as controller",resolve:{amplitudeReferences:["a2Soundscapes",function(e){return e.getAmplitudeReferences()}],data:function(){return{soundscape:e}}}}).result.then(function(){})}}]).controller("a2VisualizerSampleSoundscapeInfoEditVisualScaleModalController",["$scope","$modalInstance","a2Soundscapes","amplitudeReferences","data","a2UrlUpdate","ColorscaleGradients",function(e,t,i,n,a,r,o){var s=a.soundscape;e.soundscape=s,e.palettes=o.gradients,e.data={palette:s.visual_palette,visual_max:s.visual_max_value||s.max_value,normalized:!!s.normalized,amplitudeThreshold:s.threshold,amplitudeReference:n.reduce(function(e,t){return e||(t.value==s.threshold_type?t:null)},null)},this.amplitudeReferences=n,e.ok=function(){i.setVisualizationOptions(s.id,{max:e.data.visual_max,palette:e.data.palette,normalized:e.data.normalized,amplitude:e.data.amplitudeThreshold,amplitudeReference:e.data.amplitudeReference.value},function(e){s.update&&s.update(e),r.update(s.thumbnail),t.close()})},console.log(e)}]).directive("a2SoundscapeDrawer",["a2Soundscapes",function(e){return{restrict:"E",template:'<canvas class="soundscape"></canvas>',scope:{soundscape:"&",normalized:"&",amplitudeThreshold:"&",amplitudeThresholdType:"&",palette:"&",visualMax:"&"},replace:!0,link:function(t,i,n){var a,r,o,s=function(){if(r&&a){var e=t.visualMax()||r.max_value,n=t.amplitudeThreshold&&t.amplitudeThreshold()||0;if("relative-to-peak-maximum"==t.amplitudeThresholdType()){n*=c()}var s=t.palette();if(s&&s.length){var l=1*(s.length-1),u=function(t){var i=Math.max(0,Math.min(t*l/e|0,l));return s[i]};if(o){e=1;var d=u;u=function(e,t){var i=o[t]||1;return d(e/i)}}var p=a.width,f=a.height;i.attr("width",p),i.attr("height",f);var h=i[0].getContext("2d");h.fillStyle=u(0),h.fillRect(0,0,p,f);for(var g in a.index){var m=a.index[g];for(var v in m){var y=m[v];if(n&&y[1]){for(var b=0,_=y[1],x=0,w=_.length;x<w;++x)_[x]>n&&++b;h.fillStyle=u(b,v)}else h.fillStyle=u(y[0],v);h.fillRect(v,f-g-1,1,1)}}}}},c=function(){return void 0===a.__maxAmplitude&&(a.__maxAmplitude=Object.keys(a.index).reduce(function(e,t){var i=a.index[t];return Object.keys(i).reduce(function(e,t){var n=Math.max.apply(Math,i[t][1]||[0]);return Math.max(n,e)},e)},0),console.log("scidx.__maxAmplitude",a.__maxAmplitude)),a.__maxAmplitude};t.$watch("soundscape()",function(t){(r=t)&&e.getSCIdx(r.id,{count:1}).then(function(e){a=e,s()})}),t.$watch("normalized()",function(t){t?o?s():e.getNormVector(r.id).then(function(e){o=e,s()}):(o=null,s())}),t.$watch("palette()",s),t.$watch("amplitudeThreshold()",s),t.$watch("amplitudeThresholdType()",s),t.$watch("visualMax()",s)}}}]);
//# sourceMappingURL=arbimon2.min.js.map
